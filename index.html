<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>4MA1.COM - Interactive Soroban</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            color: #fff;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .header p {
            color: #ccc;
            font-size: 1.2rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .soroban-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .practice-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .soroban-frame {
            background: #8B4513;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            margin: 20px 0;
        }

        .soroban {
            display: flex;
            gap: 8px;
            justify-content: center;
            background: #654321;
            padding: 15px;
            border-radius: 8px;
            position: relative;
        }

        .soroban::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 10px;
            right: 10px;
            height: 4px;
            background: #333;
            transform: translateY(-50%);
            z-index: 1;
        }

        .column {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
            padding: 10px 5px;
            position: relative;
            min-height: 300px;
            width: 50px;
        }

        .column-label {
            font-size: 10px;
            color: #fff;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .rod {
            width: 3px;
            height: 280px;
            background: #333;
            position: absolute;
            top: 30px;
            z-index: 0;
        }

        .heaven-section {
            height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            z-index: 2;
            position: relative;
        }

        .earth-section {
            height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            z-index: 2;
            position: relative;
            margin-top: 40px;
        }

        .bead {
            width: 30px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            margin: 2px 0;
            border: 2px solid;
            transition: all 0.3s ease;
            position: relative;
            z-index: 3;
        }

        .heaven-bead {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border-color: #B8860B;
        }

        .heaven-bead.active {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            border-color: #C92A2A;
            transform: translateY(25px);
        }

        .earth-bead {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            border-color: #2C5F5C;
        }

        .earth-bead.active {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            border-color: #C92A2A;
            transform: translateY(-25px);
        }

        .bead:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .display {
            background: #1a1a1a;
            color: #00ff41;
            font-family: 'Courier New', monospace;
            font-size: 2rem;
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #00ff41;
        }

        /* Place Value Visualization */
        .place-value-section {
            background: rgba(255, 206, 86, 0.1);
            border: 2px solid #FFCE56;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .place-value-section h3 {
            color: #FFCE56;
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        #place-value-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            min-height: 80px;
        }

        .place-value-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #FFCE56;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            min-width: 100px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .place-value-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(255, 206, 86, 0.3);
        }

        .place-digit {
            font-size: 2.5rem;
            font-weight: bold;
            color: #FFCE56;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .place-name {
            font-size: 0.9rem;
            color: #fff;
            margin: 5px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .place-value {
            font-size: 1.1rem;
            color: #ccc;
            font-weight: 500;
        }

        .place-value-equals {
            font-size: 2rem;
            color: #FFCE56;
            font-weight: bold;
        }

        .place-value-total {
            font-size: 2.5rem;
            font-weight: bold;
            color: #FFCE56;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            padding: 10px 20px;
            background: rgba(255, 206, 86, 0.1);
            border-radius: 10px;
            border: 2px solid #FFCE56;
        }

        .place-value-zero {
            font-size: 3rem;
            color: #FFCE56;
            font-weight: bold;
        }

        /* Place Value Game Tool Styles */
        .pv-mode-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }

        .pv-mode-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pv-mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .pv-mode-btn.active {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            transform: scale(1.05);
        }

        .pv-mode {
            display: none;
        }

        .pv-mode.active {
            display: block;
        }

        .pv-game-area {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        .pv-score-board {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .pv-score, .pv-streak {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .pv-score span, .pv-streak span {
            color: #00ff41;
        }

        .pv-level select {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid #3498db;
            padding: 8px;
            border-radius: 5px;
            font-size: 1rem;
        }

        .pv-problem-display {
            text-align: center;
            margin: 30px 0;
        }

        .pv-problem-display h2 {
            color: #3498db;
            margin-bottom: 20px;
        }

        .pv-number {
            font-size: 4rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            background: linear-gradient(45deg, #3498db, #9b59b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .pv-words-display {
            font-size: 2rem;
            font-weight: bold;
            color: #FFCE56;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            line-height: 1.5;
        }

        .pv-input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .pv-input-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .pv-input-label {
            color: #3498db;
            font-size: 0.9rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pv-input-field {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #3498db;
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 1.2rem;
            text-align: center;
        }

        .pv-input-field:focus {
            outline: none;
            border-color: #00ff41;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }

        .pv-input-field.correct {
            border-color: #00ff41;
            background: rgba(0, 255, 65, 0.1);
        }

        .pv-input-field.incorrect {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .pv-large-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 3px solid #3498db;
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-size: 2rem;
            text-align: center;
            margin: 20px 0;
        }

        .pv-large-input:focus {
            outline: none;
            border-color: #00ff41;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.4);
        }

        .pv-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .pv-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pv-btn.check {
            background: linear-gradient(45deg, #00ff41, #00c832);
            color: #1a1a1a;
        }

        .pv-btn.new {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }

        .pv-btn.hint {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .pv-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .pv-feedback {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            display: none;
        }

        .pv-feedback.show {
            display: block;
        }

        .pv-feedback.correct {
            background: rgba(0, 255, 65, 0.2);
            border: 2px solid #00ff41;
            color: #00ff41;
        }

        .pv-feedback.incorrect {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            color: #e74c3c;
        }

        .pv-words-input {
            margin: 30px 0;
        }

        .pv-words-input textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #3498db;
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.2rem;
            resize: vertical;
        }

        .pv-words-input textarea:focus {
            outline: none;
            border-color: #00ff41;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }

        .pv-number-input {
            margin: 30px 0;
        }

        .pv-reference {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .pv-reference h3 {
            color: #3498db;
            margin-bottom: 15px;
        }

        .pv-ref-grid {
            display: grid;
            gap: 10px;
        }

        .pv-ref-grid div {
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            font-size: 0.9rem;
            color: #ccc;
        }

        /* Tool Preview Grid Styles */
        .tools-preview-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 30px;
            margin: 40px 0;
        }

        .tool-preview {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            padding-top: 35px; /* Make room for category label */
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            position: relative;
            -webkit-tap-highlight-color: transparent; /* Remove iOS tap highlight */
            touch-action: manipulation; /* Optimize for touch */
        }

        .tool-preview:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            border-color: #667eea;
        }

        .preview-visual {
            height: 150px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        .tool-preview h3 {
            color: #fff;
            font-size: 1.2rem;
            margin: 0;
        }

        /* Mini visualizations for each tool */
        .mini-soroban {
            display: flex;
            gap: 10px;
        }

        .mini-bead {
            width: 20px;
            height: 20px;
            background: linear-gradient(45deg, #8B4513, #654321);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            animation: beadSlide 3s ease-in-out infinite;
        }

        .mini-bead:nth-child(1) { animation-delay: 0s; }
        .mini-bead:nth-child(2) { animation-delay: 0.5s; }
        .mini-bead:nth-child(3) { animation-delay: 1s; }

        /* Category Labels */
        .category-label {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 5px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            color: white;
            border-radius: 10px 10px 0 0;
            z-index: 10;
        }

        .arithmetic-label {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }

        .geometry-label {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .algebra-label {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
        }

        .data-label {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .nature-label {
            background: linear-gradient(45deg, #1abc9c, #16a085);
        }

        /* Tessellation Preview Styles */
        .tessellation-preview {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 2px;
            padding: 20px;
        }

        .hex-tile {
            width: 30px;
            height: 30px;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            clip-path: polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%);
            animation: tilePulse 2s ease-in-out infinite;
        }

        .hex-tile:nth-child(2n) {
            animation-delay: 0.2s;
        }

        .hex-tile:nth-child(3n) {
            animation-delay: 0.4s;
        }

        @keyframes tilePulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        /* 3D Shapes Preview Styles */
        .shapes3d-preview {
            perspective: 200px;
        }

        .rotating-cube {
            width: 60px;
            height: 60px;
            position: relative;
            transform-style: preserve-3d;
            animation: rotateCube 4s infinite linear;
        }

        .cube-face {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 2px solid white;
            background: rgba(231, 76, 60, 0.7);
        }

        .cube-front {
            transform: translateZ(30px);
        }

        .cube-back {
            transform: rotateY(180deg) translateZ(30px);
        }

        .cube-left {
            transform: rotateY(-90deg) translateZ(30px);
        }

        .cube-right {
            transform: rotateY(90deg) translateZ(30px);
        }

        .cube-top {
            transform: rotateX(90deg) translateZ(30px);
        }

        .cube-bottom {
            transform: rotateX(-90deg) translateZ(30px);
        }

        @keyframes rotateCube {
            0% {
                transform: rotateX(0deg) rotateY(0deg);
            }
            100% {
                transform: rotateX(360deg) rotateY(360deg);
            }
        }

        /* Venn Diagram Preview Styles */
        .mini-venn {
            position: relative;
            width: 120px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .venn-circle {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid white;
            opacity: 0.7;
        }

        .venn-left {
            left: 15px;
            background: rgba(244, 67, 54, 0.5);
            animation: vennPulseLeft 3s ease-in-out infinite;
        }

        .venn-right {
            right: 15px;
            background: rgba(33, 150, 243, 0.5);
            animation: vennPulseRight 3s ease-in-out infinite;
        }

        @keyframes vennPulseLeft {
            0%, 100% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(-5px);
            }
        }

        @keyframes vennPulseRight {
            0%, 100% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(5px);
            }
        }

        /* Carousel Arrows */
        .tools-preview-container {
            position: relative;
            overflow: hidden;
        }

        .tools-grid-wrapper {
            overflow-x: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            padding: 0 60px;
        }

        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: white;
            font-size: 4rem;
            width: 60px;
            height: 120px;
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .carousel-arrow:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) scale(1.1);
        }

        .carousel-arrow span {
            font-weight: 300;
            line-height: 1;
        }

        .carousel-prev {
            left: 0;
            border-radius: 0 10px 10px 0;
        }

        .carousel-next {
            right: 0;
            border-radius: 10px 0 0 10px;
        }

        /* Money Preview Styles */
        .money-preview {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .coin-stack {
            position: relative;
            width: 60px;
            height: 80px;
        }

        .coin {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border: 3px solid #B8860B;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #654321;
            animation: coinBounce 3s ease-in-out infinite;
        }

        .coin::after {
            content: '£';
            font-size: 1.5rem;
        }

        .coin-1 {
            bottom: 0;
            animation-delay: 0s;
        }

        .coin-2 {
            bottom: 15px;
            animation-delay: 0.2s;
        }

        .coin-3 {
            bottom: 30px;
            animation-delay: 0.4s;
        }

        .coin-4 {
            bottom: 45px;
            animation-delay: 0.6s;
        }

        @keyframes coinBounce {
            0%, 100% {
                transform: translateY(0) rotateY(0deg);
            }
            25% {
                transform: translateY(-5px) rotateY(180deg);
            }
            50% {
                transform: translateY(0) rotateY(360deg);
            }
            75% {
                transform: translateY(-3px) rotateY(540deg);
            }
        }

        /* iPad Optimizations */
        @media (hover: none) and (pointer: coarse) {
            /* Touch-friendly sizes */
            .btn, .pv-btn, .pv-mode-btn {
                min-height: 44px;
                min-width: 44px;
                font-size: 1.1rem;
            }

            .bead {
                width: 40px;
                height: 24px;
            }

            .tool-preview {
                min-height: 200px;
            }

            .pv-input-field {
                min-height: 44px;
                font-size: 1.3rem;
            }

            /* Remove hover effects on touch devices */
            .tool-preview:hover {
                transform: none;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }

            .bead:hover {
                transform: none;
            }

            /* Add touch feedback */
            .tool-preview:active {
                transform: scale(0.98);
                transition: transform 0.1s;
            }

            .btn:active, .pv-btn:active {
                transform: scale(0.95);
            }

            /* Improve touch targets */
            .nav-btn {
                padding: 15px 20px;
                font-size: 1rem;
            }

            /* Adjust grid for iPad */
            .tools-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 20px;
            }
        }

        /* iPad Portrait Specific */
        @media only screen 
        and (min-device-width: 768px) 
        and (max-device-width: 1024px) 
        and (orientation: portrait) {
            .container {
                max-width: 95%;
            }

            .tools-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* iPad Landscape Specific */
        @media only screen 
        and (min-device-width: 768px) 
        and (max-device-width: 1024px) 
        and (orientation: landscape) {
            .tools-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @keyframes beadSlide {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .mini-digits {
            display: flex;
            gap: 10px;
            font-size: 2.5rem;
            font-weight: bold;
            color: #FFCE56;
        }

        .mini-digits span {
            animation: digitFlip 4s ease-in-out infinite;
        }

        .mini-digits span:nth-child(1) { animation-delay: 0s; }
        .mini-digits span:nth-child(2) { animation-delay: 0.3s; }
        .mini-digits span:nth-child(3) { animation-delay: 0.6s; }

        @keyframes digitFlip {
            0%, 100% { transform: rotateX(0deg); opacity: 1; }
            25% { transform: rotateX(90deg); opacity: 0; }
            50% { transform: rotateX(0deg); opacity: 1; }
        }

        .mini-grid {
            display: grid;
            grid-template-columns: repeat(3, 30px);
            gap: 5px;
            font-size: 1rem;
            color: #fff;
            text-align: center;
        }

        .mini-grid div {
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            animation: gridPulse 2s ease-in-out infinite;
        }

        .mini-grid div:nth-child(5) { 
            animation: highlight 2s ease-in-out infinite;
            animation-delay: 0.5s;
        }

        @keyframes gridPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(0.95); }
        }

        @keyframes highlight {
            0%, 100% { background: rgba(255, 255, 255, 0.1); }
            50% { background: #00ff41; color: #000; }
        }

        .mini-fraction {
            font-size: 2rem;
            color: #3498db;
            font-weight: bold;
            animation: fractionBounce 3s ease-in-out infinite;
        }

        @keyframes fractionBounce {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.2) rotate(5deg); }
            50% { transform: scale(1); }
            75% { transform: scale(1.2) rotate(-5deg); }
        }

        .fraction-line {
            height: 2px;
            width: 40px;
            background: #3498db;
            margin: 5px 0;
        }

        .mini-line {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fff;
        }

        .line-bar {
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            position: relative;
        }

        .line-bar::after {
            content: '•';
            position: absolute;
            top: -8px;
            left: 0;
            color: #ff6b6b;
            font-size: 20px;
            animation: slideAlongLine 3s ease-in-out infinite;
        }

        @keyframes slideAlongLine {
            0%, 100% { left: 0; }
            50% { left: 80px; }
        }

        .mini-shapes {
            display: flex;
            gap: 15px;
        }

        .mini-circle {
            width: 30px;
            height: 30px;
            background: #e74c3c;
            border-radius: 50%;
            animation: shapeMorph 4s ease-in-out infinite;
        }

        .mini-triangle {
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 30px solid #f39c12;
            animation: triangleRotate 4s linear infinite;
        }

        .mini-square {
            width: 30px;
            height: 30px;
            background: #3498db;
            animation: squarePulse 4s ease-in-out infinite;
        }

        @keyframes shapeMorph {
            0%, 100% { transform: scale(1); }
            33% { transform: scale(1.3); }
            66% { transform: scale(0.7); }
        }

        @keyframes triangleRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes squarePulse {
            0%, 100% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(45deg) scale(1.2); }
        }

        .mini-angle {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .angle-arc {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #9b59b6;
            font-size: 1.5rem;
            font-weight: bold;
            animation: angleChange 3s ease-in-out infinite;
        }

        @keyframes angleChange {
            0%, 100% { content: '90°'; }
            33% { transform: translate(-50%, -50%) rotate(45deg); }
            66% { transform: translate(-50%, -50%) rotate(-45deg); }
        }

        .angle-arc::before {
            content: '';
            position: absolute;
            top: -30px;
            left: -30px;
            width: 60px;
            height: 60px;
            border: 3px solid #9b59b6;
            border-radius: 50%;
            border-right-color: transparent;
            border-bottom-color: transparent;
            animation: angleRotate 3s ease-in-out infinite;
        }

        @keyframes angleRotate {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
        }

        .mini-balance {
            position: relative;
            width: 120px;
            height: 60px;
        }

        .balance-beam {
            position: absolute;
            top: 30px;
            width: 100%;
            height: 4px;
            background: #8B4513;
            transform-origin: center;
            animation: balanceTilt 4s ease-in-out infinite;
        }

        @keyframes balanceTilt {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(10deg); }
            75% { transform: rotate(-10deg); }
        }

        .balance-pivot {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            color: #666;
            font-size: 1.5rem;
        }

        .mini-bars {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .bar {
            width: 25px;
            background: linear-gradient(180deg, #3498db, #2980b9);
            border-radius: 3px 3px 0 0;
            animation: barGrow 3s ease-in-out infinite;
        }

        .bar:nth-child(1) { animation-delay: 0s; }
        .bar:nth-child(2) { animation-delay: 0.3s; }
        .bar:nth-child(3) { animation-delay: 0.6s; }

        @keyframes barGrow {
            0%, 100% { height: var(--h, 30px); }
            50% { height: calc(var(--h, 30px) * 1.5); }
        }

        .mini-clock {
            width: 80px;
            height: 80px;
            position: relative;
        }

        .clock-face {
            width: 100%;
            height: 100%;
            border: 3px solid #fff;
            border-radius: 50%;
            position: relative;
        }

        .hour-hand {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 3px;
            height: 25px;
            background: #fff;
            transform-origin: bottom;
            transform: translate(-50%, -100%) rotate(30deg);
            animation: hourRotate 8s linear infinite;
        }

        .minute-hand {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 35px;
            background: #ccc;
            transform-origin: bottom;
            transform: translate(-50%, -100%) rotate(150deg);
            animation: minuteRotate 2s linear infinite;
        }

        @keyframes hourRotate {
            0% { transform: translate(-50%, -100%) rotate(30deg); }
            100% { transform: translate(-50%, -100%) rotate(390deg); }
        }

        @keyframes minuteRotate {
            0% { transform: translate(-50%, -100%) rotate(0deg); }
            100% { transform: translate(-50%, -100%) rotate(360deg); }
        }

        .mini-pattern {
            display: flex;
            gap: 15px;
            font-size: 1.8rem;
            color: #2ecc71;
            font-weight: bold;
        }

        .mini-pattern span:last-child {
            animation: questionMark 2s ease-in-out infinite;
        }

        @keyframes questionMark {
            0%, 100% { opacity: 1; transform: scale(1); }
            25% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.2); }
            75% { opacity: 0.5; transform: scale(1); }
        }

        .mini-spiral {
            font-size: 4rem;
            animation: spin 10s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Math Categories Styles */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin: 40px 0;
        }

        .category-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--card-color1), var(--card-color2));
        }

        .category-card.arithmetic {
            --card-color1: #3498db;
            --card-color2: #2980b9;
        }

        .category-card.geometry {
            --card-color1: #e74c3c;
            --card-color2: #c0392b;
        }

        .category-card.algebra {
            --card-color1: #9b59b6;
            --card-color2: #8e44ad;
        }

        .category-card.data {
            --card-color1: #f39c12;
            --card-color2: #e67e22;
        }

        .category-card.nature {
            --card-color1: #27ae60;
            --card-color2: #229954;
        }

        .category-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .category-icon {
            font-size: 4rem;
            text-align: center;
            margin-bottom: 20px;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.5));
        }

        .category-card h2 {
            color: #fff;
            font-size: 2rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .category-description {
            color: #ccc;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 20px;
            text-align: center;
        }

        .category-topics {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .category-topics h4 {
            color: var(--card-color1);
            margin-bottom: 10px;
        }

        .category-topics ul {
            list-style: none;
            padding: 0;
        }

        .category-topics li {
            color: #fff;
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .category-topics li::before {
            content: '•';
            position: absolute;
            left: 0;
            color: var(--card-color1);
        }

        .category-example {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .category-example h4 {
            color: var(--card-color1);
            margin-bottom: 10px;
        }

        .category-example p {
            color: #fff;
            font-family: 'Courier New', monospace;
            margin: 5px 0;
            font-size: 1.1rem;
        }

        .category-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, var(--card-color1), var(--card-color2));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .category-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Fibonacci Explorer Styles */
        .fibonacci-section {
            background: linear-gradient(135deg, #27ae60, #229954);
            border-radius: 20px;
            padding: 30px;
            margin: 30px auto;
            max-width: 800px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .fibonacci-section h2 {
            color: #fff;
            text-align: center;
            margin-bottom: 20px;
        }

        .fibonacci-display {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        #fib-sequence {
            font-size: 1.8rem;
            color: #fff;
            font-weight: bold;
            margin-bottom: 10px;
            word-wrap: break-word;
        }

        .fibonacci-display p {
            color: #ccc;
            font-size: 1.1rem;
        }

        .fibonacci-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }

        .fibonacci-controls button {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .fibonacci-controls button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .fibonacci-nature {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .fibonacci-nature h3 {
            color: #fff;
            margin-bottom: 15px;
        }

        .fibonacci-nature ul {
            list-style: none;
            padding: 0;
        }

        .fibonacci-nature li {
            color: #fff;
            padding: 8px 0;
            font-size: 1.1rem;
        }

        /* Landing Page Styles */
        .landing-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .simple-hero {
            text-align: center;
        }

        .simple-hero h1 {
            font-size: 4rem;
            color: #fff;
            margin-bottom: 40px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .enter-btn {
            background: linear-gradient(45deg, #00ff41, #00c832);
            color: #1a1a1a;
            border: none;
            padding: 20px 60px;
            border-radius: 50px;
            font-size: 1.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 255, 65, 0.3);
        }

        .enter-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 40px rgba(0, 255, 65, 0.5);
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin: 40px 0;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .feature-card h3 {
            color: #fff;
            margin-bottom: 10px;
        }

        .feature-card p {
            color: #ccc;
        }

        .login-section {
            margin: 60px 0;
        }

        .login-section h2 {
            text-align: center;
            color: #fff;
            font-size: 2.5rem;
            margin-bottom: 30px;
        }

        .login-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .login-card:hover {
            transform: scale(1.05);
        }

        .student-login:hover {
            border-color: #3498db;
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.3);
        }

        .teacher-login:hover {
            border-color: #9b59b6;
            box-shadow: 0 10px 30px rgba(155, 89, 182, 0.3);
        }

        .parent-login:hover {
            border-color: #2ecc71;
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.3);
        }

        .school-login:hover {
            border-color: #e74c3c;
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.3);
        }

        .login-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .login-card h3 {
            color: #fff;
            margin-bottom: 10px;
        }

        .login-card p {
            color: #ccc;
            margin-bottom: 20px;
        }

        .login-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .subscription-section {
            margin: 60px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 40px;
        }

        .subscription-section h2 {
            text-align: center;
            color: #fff;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subscription-section > p {
            text-align: center;
            color: #ccc;
            margin-bottom: 30px;
        }

        .subscription-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
        }

        .sub-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .sub-card.featured {
            border-color: #ffd700;
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
        }

        .badge {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            padding: 5px 20px;
            border-radius: 20px;
            font-weight: bold;
        }

        .sub-card h3 {
            color: #fff;
            margin-bottom: 20px;
        }

        .price {
            font-size: 2.5rem;
            color: #ffd700;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .sub-card ul {
            list-style: none;
            margin-bottom: 20px;
        }

        .sub-card li {
            color: #ccc;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sub-btn {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .sub-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .demo-section {
            text-align: center;
            margin: 60px 0;
            padding: 40px;
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            border-radius: 20px;
        }

        .demo-section h2 {
            color: #fff;
            margin-bottom: 10px;
        }

        .demo-section p {
            color: #fff;
            margin-bottom: 20px;
        }

        .demo-btn {
            background: #fff;
            color: #27ae60;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .demo-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            margin: 10% auto;
            padding: 40px;
            border: 2px solid #667eea;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }

        .close {
            color: #fff;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #ff6b6b;
        }

        #login-title {
            color: #fff;
            text-align: center;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #ccc;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .submit-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .forgot-link {
            text-align: center;
            margin-top: 20px;
        }

        .forgot-link a {
            color: #667eea;
            text-decoration: none;
        }

        .forgot-link a:hover {
            color: #764ba2;
        }

        .practice-problem {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #4ECDC4;
        }

        .problem-text {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #fff;
        }

        .answer-section {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .answer-input {
            background: rgba(255,255,255,0.1);
            border: 2px solid #4ECDC4;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-size: 1.2rem;
            width: 120px;
        }

        .check-answer {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .correct {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }

        .incorrect {
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
            border: 1px solid #F44336;
        }

        /* Guided Practice Styles */
        .guided-section {
            background: rgba(155, 89, 182, 0.1);
            border: 2px solid #9B59B6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .guided-section.active {
            display: block;
        }

        .guided-problem {
            text-align: center;
            margin-bottom: 15px;
        }

        .guided-problem h4 {
            color: #9B59B6;
            margin-bottom: 8px;
        }

        .guided-instruction {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #9B59B6;
        }

        .guided-controls {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin: 15px 0;
        }

        .btn-small {
            background: linear-gradient(45deg, #9B59B6, #8E44AD);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .btn-small:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .operation-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .operation-btn {
            background: linear-gradient(45deg, #3498DB, #2980B9);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
        }

        .operation-btn:hover {
            transform: translateY(-2px);
        }

        /* Arrow and highlighting */
        .click-arrow {
            position: absolute;
            color: #FF6B6B;
            font-size: 2rem;
            animation: bounce 1.5s infinite;
            z-index: 1000;
            pointer-events: none;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .highlight-bead {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
        }

        .step-complete {
            color: #4CAF50;
            font-weight: bold;
        }

        .progress-section {
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ECDC4, #44A08D);
            transition: width 0.3s ease;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4ECDC4;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #ccc;
            margin-top: 5px;
        }

        /* Tool Tabs Styles */
        .tool-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        /* Navigation System */
        .tool-navigation {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .nav-category {
            position: relative;
        }
        
        .nav-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        /* Category-specific nav button colors matching the category cards */
        .nav-btn.arithmetic-nav {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }

        .nav-btn.arithmetic-nav:hover {
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .nav-btn.geometry-nav {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .nav-btn.geometry-nav:hover {
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .nav-btn.algebra-nav {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
        }

        .nav-btn.algebra-nav:hover {
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4);
        }

        .nav-btn.data-nav {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .nav-btn.data-nav:hover {
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        }

        .nav-btn.nature-nav {
            background: linear-gradient(45deg, #27ae60, #229954);
        }

        .nav-btn.nature-nav:hover {
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        }

        .nav-btn.history-nav {
            background: linear-gradient(45deg, #CD853F, #8B4513);
        }

        .nav-btn.history-nav:hover {
            box-shadow: 0 4px 15px rgba(205, 133, 63, 0.4);
        }

        .nav-btn.overview-nav {
            background: linear-gradient(45deg, #34495e, #2c3e50);
        }

        .nav-btn.overview-nav:hover {
            box-shadow: 0 4px 15px rgba(52, 73, 94, 0.4);
        }
        
        .nav-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: rgba(0, 0, 0, 0.95);
            border-radius: 10px;
            padding: 10px;
            margin-top: 5px;
            min-width: 180px;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }
        
        .nav-dropdown.active {
            display: block;
        }
        
        .tool-btn {
            display: block;
            width: 100%;
            background: rgba(78, 205, 196, 0.2);
            color: white;
            border: 1px solid #4ECDC4;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px 0;
            text-align: left;
            transition: all 0.3s ease;
        }
        
        .tool-btn:hover {
            background: rgba(78, 205, 196, 0.4);
            transform: translateX(5px);
        }
        
        .tool-btn.active {
            background: #4ECDC4;
            color: #1a1a2e;
        }

        .tool-content {
            display: none;
        }

        .tool-content.active {
            display: block;
        }

        /* Balance Tool Styles */
        .balance-container {
            padding: 10px;
            max-width: 1100px;
            margin: 0 auto;
            height: auto;
            display: flex;
            flex-direction: column;
        }

        .balance-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .balance-header h2 {
            color: #fff;
            margin-bottom: 5px;
            font-size: 1.8rem;
        }

        .balance-header p {
            color: #ccc;
            font-size: 0.9rem;
        }
        
        /* Three Panel Layout */
        .balance-main-layout {
            display: grid;
            grid-template-columns: 160px 1fr 160px;
            gap: 10px;
            min-height: 350px;
            max-height: 420px;
        }
        
        /* Left Panel - History */
        .history-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
            overflow-y: auto;
            border: 1px solid rgba(78, 205, 196, 0.3);
            max-height: 400px;
        }
        
        .history-panel h4 {
            color: #4ECDC4;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1rem;
        }
        
        .history-entries {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .history-entry {
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            border-left: 3px solid #4ECDC4;
            font-size: 0.75rem;
            color: #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-bottom: 5px;
        }
        
        .history-entry .left-objects,
        .history-entry .right-objects {
            display: flex;
            gap: 2px;
        }
        
        .history-entry .emoji {
            font-size: 1rem;
        }
        
        .history-entry .relation {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 5px;
        }
        
        .history-entry .relation-text {
            font-size: 0.6rem;
            color: #4ECDC4;
        }
        
        .history-entry .relation-symbol {
            font-size: 0.9rem;
            color: #FFA500;
            font-weight: bold;
        }
        
        /* Center Panel */
        .center-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }
        
        /* Current Discovery */
        .current-discovery {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.2), rgba(78, 205, 196, 0.1));
            border: 2px solid #4ECDC4;
            border-radius: 15px;
            padding: 15px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.2);
        }
        
        .discovery-placeholder {
            color: #999;
            font-style: italic;
        }
        
        .discovery-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            position: relative;
            width: 100%;
        }
        
        .discovery-content .left-objects,
        .discovery-content .right-objects {
            display: flex;
            gap: 5px;
        }
        
        .discovery-content .emoji {
            font-size: 2.5rem;
        }
        
        .discovery-content .relation {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .discovery-content .relation-text {
            font-size: 1rem;
            color: #4ECDC4;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .discovery-content .relation-symbol {
            font-size: 2rem;
            color: #FFA500;
            font-weight: bold;
        }
        
        .discovery-content .flip-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: rgba(78, 205, 196, 0.9);
            border: 2px solid #4ECDC4;
            color: white;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 8px;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        
        .discovery-content .flip-btn:hover {
            background: #4ECDC4;
            transform: scale(1.1);
        }
        
        /* Right Panel - Sequence */
        .right-panel {
            background: rgba(155, 89, 182, 0.1);
            border: 2px solid #9B59B6;
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
        }
        
        .right-panel h4 {
            color: #9B59B6;
            text-align: center;
            margin: 0;
            font-size: 1rem;
        }
        
        .sequence-info {
            text-align: center;
            color: #ccc;
            font-size: 0.85rem;
            margin-bottom: 10px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Balance Scale */
        .balance-scale {
            position: relative;
            height: 140px;
            margin: 10px auto 15px;
            width: 100%;
            max-width: 380px;
        }

        .scale-center {
            position: absolute;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%);
            z-index: 10;
        }

        .fulcrum {
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-bottom: 50px solid #8B4513;
            margin: 0 auto;
        }

        .beam {
            position: absolute;
            width: 320px;
            height: 6px;
            background: linear-gradient(to bottom, #654321, #8B4513);
            top: -48px;
            left: 50%;
            transform-origin: center center;
            transform: translateX(-50%) rotate(0deg);
            transition: transform 0.5s ease;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .scale-platform {
            position: absolute;
            bottom: 50px;
            width: 85px;
            transition: bottom 0.5s ease;
        }

        .left-platform {
            left: 50%;
            margin-left: -180px;
        }

        .right-platform {
            right: 50%;
            margin-right: -180px;
        }

        .platform {
            width: 85px;
            height: 8px;
            background: linear-gradient(to bottom, #8B4513, #654321);
            border-radius: 3px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .platform-objects {
            position: absolute;
            bottom: 8px;
            width: 85px;
            min-height: 35px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 2px;
            flex-wrap: wrap;
            border: 2px dashed transparent;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .platform-objects.drag-over {
            border-color: #4ECDC4;
            background: rgba(78, 205, 196, 0.1);
        }

        /* Mystery Objects */
        .objects-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 8px;
            margin: 5px 0;
            backdrop-filter: blur(10px);
        }

        .objects-container h3 {
            color: #4ECDC4;
            margin-bottom: 8px;
            text-align: center;
            font-size: 0.95rem;
        }

        .objects-shelf {
            display: flex;
            justify-content: center;
            gap: 6px;
            padding: 6px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            min-height: 50px;
            flex-wrap: wrap;
        }

        .mystery-object {
            cursor: grab;
            position: relative;
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
            gap: 5px;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }
        
        .mystery-object .object-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .mystery-object .object-label {
            font-size: 0.7rem;
            color: #fff;
            text-align: center;
            font-weight: bold;
            text-transform: capitalize;
            background: rgba(0,0,0,0.7);
            padding: 3px 6px;
            border-radius: 5px;
            white-space: nowrap;
            margin-top: 2px;
        }

        .mystery-object:hover {
            transform: scale(1.1);
            background: rgba(255,255,255,0.1);
        }

        .mystery-object.dragging {
            cursor: grabbing;
            opacity: 0.5;
        }

        .mystery-object.on-scale {
            padding: 4px;
            gap: 2px;
        }
        
        .mystery-object.on-scale .object-icon {
            width: 35px;
            height: 35px;
            font-size: 1.2rem;
        }
        
        .mystery-object.on-scale .object-label {
            font-size: 0.65rem;
            padding: 1px 4px;
        }

        .object-info {
            text-align: center;
            color: #ccc;
            margin-top: 10px;
            font-style: italic;
        }

        .object-controls {
            margin: 15px 0;
            text-align: center;
        }

        .side-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .side-selector label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            cursor: pointer;
            color: #fff;
            transition: all 0.3s ease;
        }

        .side-selector label:hover {
            background: rgba(255,255,255,0.1);
        }

        .side-selector input[type="radio"]:checked + {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
        }

        .side-selector label:has(input:checked) {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        /* Sequence Builder */
        .sequence-builder {
            background: rgba(155, 89, 182, 0.1);
            border: 2px solid #9B59B6;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .sequence-builder h3 {
            color: #9B59B6;
            text-align: center;
            margin-bottom: 20px;
        }

        .sequence-slots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 10px 0;
            min-height: 60px;
            flex-wrap: wrap;
        }

        .sequence-slot {
            width: 65px;
            height: 75px;
            border: 2px dashed #9B59B6;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.2);
            position: relative;
            transition: all 0.3s ease;
        }

        .sequence-slot.filled {
            border-style: solid;
        }
        
        .sequence-slot.drag-over {
            transform: scale(1.1);
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.1);
        }

        .slot-label {
            position: absolute;
            bottom: -20px;
            font-size: 0.8rem;
            color: #9B59B6;
        }

        .sequence-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .balance-feedback {
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            display: none;
            font-size: 0.85rem;
        }

        .balance-feedback.show {
            display: block;
        }

        .balance-feedback.correct {
            display: block;
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }

        .balance-feedback.incorrect {
            display: block;
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
            border: 1px solid #F44336;
        }

        .hint-display {
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            background: rgba(255, 193, 7, 0.2);
            color: #FFD700;
            border: 1px solid #FFD700;
            text-align: center;
            display: none;
            font-size: 0.85rem;
        }

        .hint-display.show {
            display: block;
        }
        
        /* Button styles for controls */
        .btn {
            background: linear-gradient(45deg, #9B59B6, #8E44AD);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 5px;
        }
        
        .btn:hover {
            background: linear-gradient(45deg, #8E44AD, #9B59B6);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(155, 89, 182, 0.3);
        }
        
        .sequence-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* Sequence Container Below Balance */
        .sequence-container {
            background: rgba(78, 205, 196, 0.05);
            border: 2px solid #4ECDC4;
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .sequence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .sequence-container h3 {
            color: #4ECDC4;
            margin: 0;
            font-size: 1.1rem;
        }
        
        .comparison-counter {
            background: rgba(255, 165, 0, 0.2);
            color: #FFA500;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            border: 1px solid #FFA500;
        }
        
        .sequence-main {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .sequence-left-controls,
        .sequence-right-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 150px;
        }
        
        .sequence-slots {
            flex: 1;
            justify-content: center;
        }
        
        /* Discovery item styles */
        .discovery-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        
        .discovery-item .item-label {
            font-size: 0.7rem;
            color: #ccc;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        /* Tips panel */
        .tips-content {
            color: #ccc;
            font-size: 0.85rem;
        }
        
        .tips-content p {
            margin: 8px 0;
        }
        
        /* Mode Selector */
        .tt-mode-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .mode-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            opacity: 0.6;
        }
        
        .mode-btn.active {
            opacity: 1;
            transform: scale(1.05);
        }
        
        .tt-mode {
            display: none;
        }
        
        .tt-mode.active {
            display: block;
        }
        
        /* Daily Workout Styles */
        .workout-setup {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .tables-selector h3 {
            color: #4ECDC4;
            margin-bottom: 15px;
        }
        
        .tables-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .tables-checkboxes label {
            background: rgba(78, 205, 196, 0.2);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }
        
        .tables-checkboxes label:hover {
            background: rgba(78, 205, 196, 0.4);
        }
        
        .tables-checkboxes input[type="checkbox"] {
            margin-right: 5px;
        }
        
        .workout-options {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .option-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .option-group label {
            color: #9B59B6;
            font-weight: bold;
        }
        
        .option-group select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #9B59B6;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .start-workout-btn, .end-workout-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .start-workout-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        .workout-area {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #4ECDC4;
            border-radius: 15px;
            padding: 30px;
        }
        
        .workout-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            font-size: 1.2rem;
        }
        
        .stat {
            background: rgba(155, 89, 182, 0.2);
            padding: 10px 20px;
            border-radius: 10px;
            color: #FFD700;
        }
        
        .workout-problem {
            text-align: center;
            margin: 40px 0;
        }
        
        .problem-display {
            font-size: 3rem;
            color: #4ECDC4;
            margin-bottom: 20px;
        }
        
        .answer-input-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        
        #workout-answer {
            font-size: 2rem;
            padding: 15px;
            width: 200px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #4ECDC4;
            color: white;
            text-align: center;
            border-radius: 10px;
        }
        
        .submit-answer-btn {
            font-size: 1.5rem;
            padding: 15px 25px;
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .submit-answer-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.4);
        }
        
        .workout-feedback {
            margin-top: 20px;
            font-size: 1.5rem;
            min-height: 40px;
        }
        
        .workout-feedback.correct {
            color: #4CAF50;
        }
        
        .workout-feedback.incorrect {
            color: #F44336;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 30px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            transition: width 0.5s ease;
            width: 0%;
        }
        
        .workout-results {
            background: rgba(78, 205, 196, 0.1);
            border: 2px solid #4ECDC4;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
        }
        
        .workout-results h3 {
            color: #FFD700;
            font-size: 2rem;
            margin-bottom: 20px;
        }
        
        .results-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        
        .final-score-display {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .score-circle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin: 20px auto;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
            animation: scorePopIn 0.5s ease;
        }
        
        @keyframes scorePopIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .score-number {
            color: #FFD700;
        }
        
        .score-divider {
            color: white;
            margin: 0 10px;
        }
        
        .score-total {
            color: white;
        }
        
        .score-grade {
            color: #FFD700;
            font-size: 2.5rem;
            margin-top: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .review-timer {
            background: rgba(255, 165, 0, 0.2);
            border: 2px solid #FFA500;
            color: #FFD700;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            margin: 20px auto;
            max-width: 300px;
            animation: pulse 1s infinite;
        }
        
        .results-stats {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .stat-card {
            background: rgba(155, 89, 182, 0.2);
            border: 2px solid #9B59B6;
            padding: 15px 25px;
            border-radius: 15px;
            text-align: center;
            min-width: 150px;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }
        
        .stat-label {
            display: block;
            color: #9B59B6;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .stat-value {
            display: block;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .new-workout-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            display: block;
            margin: 20px auto;
        }
        
        .new-workout-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        /* Word Problems Styles */
        .wordproblems-container {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .problem-display {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            min-height: 150px;
        }

        .problem-text {
            font-size: 1.3rem;
            line-height: 1.6;
            color: #fff;
            margin-bottom: 20px;
        }

        .problem-visual {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .answer-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            margin: 20px 0;
        }

        .expression-input {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px 30px;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .expression-input label {
            font-size: 1.2rem;
            margin-right: 15px;
            color: #aaa;
        }

        .expression-input input {
            width: 80px;
            padding: 10px;
            font-size: 1.4rem;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            transition: all 0.3s;
        }

        .expression-input input:focus {
            border-color: #4CAF50;
            outline: none;
            background: rgba(255, 255, 255, 0.15);
        }

        .expression-input input.correct {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }

        .expression-input input.incorrect {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.2);
        }

        .expression-input span {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
        }

        .answer-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .answer-buttons button {
            padding: 12px 25px;
            font-size: 1.1rem;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid;
        }

        .answer-buttons button:first-child {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
        }

        .answer-buttons button:first-child:hover {
            background: rgba(76, 175, 80, 0.3);
            transform: scale(1.05);
        }

        .new-problem-btn {
            background: rgba(33, 150, 243, 0.2);
            border-color: #2196F3;
        }

        .new-problem-btn:hover {
            background: rgba(33, 150, 243, 0.3);
            transform: scale(1.05);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .problem-settings {
            margin-top: 20px;
            text-align: center;
        }

        /* PDF Converter Styles */
        .pdf-converter-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .upload-section {
            margin: 30px 0;
        }

        .upload-area {
            border: 3px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .upload-area.dragging {
            border-color: #2196F3;
            background: rgba(33, 150, 243, 0.1);
        }

        .upload-icon {
            font-size: 4rem;
            display: block;
            margin-bottom: 20px;
        }

        .upload-prompt h3 {
            color: #fff;
            margin: 15px 0;
            font-size: 1.5rem;
        }

        .upload-prompt p {
            color: #aaa;
            margin: 10px 0;
        }

        .browse-btn {
            margin-top: 20px;
            padding: 12px 30px;
            font-size: 1.1rem;
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid #4CAF50;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .browse-btn:hover {
            background: rgba(76, 175, 80, 0.3);
            transform: scale(1.05);
        }

        .pdf-preview {
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .pdf-preview h3 {
            margin-bottom: 20px;
            color: #fff;
        }

        #pdf-canvas {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: white;
        }

        .pdf-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }

        .pdf-controls button {
            padding: 10px 20px;
            background: rgba(33, 150, 243, 0.2);
            border: 2px solid #2196F3;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pdf-controls button:hover {
            background: rgba(33, 150, 243, 0.3);
        }

        .interactive-workspace {
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .interactive-workspace h3 {
            margin-bottom: 20px;
            color: #fff;
        }

        #worksheet-content {
            min-height: 400px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .worksheet-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .worksheet-controls button {
            padding: 12px 25px;
            font-size: 1.1rem;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid;
        }

        .worksheet-controls button:first-child {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
        }

        .worksheet-controls button:first-child:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .worksheet-controls button:nth-child(2) {
            background: rgba(255, 152, 0, 0.2);
            border-color: #FF9800;
        }

        .worksheet-controls button:nth-child(2):hover {
            background: rgba(255, 152, 0, 0.3);
        }

        .worksheet-controls button:last-child {
            background: rgba(33, 150, 243, 0.2);
            border-color: #2196F3;
        }

        .worksheet-controls button:last-child:hover {
            background: rgba(33, 150, 243, 0.3);
        }

        .converter-info {
            margin-top: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid #2196F3;
        }

        .converter-info h4 {
            color: #2196F3;
            margin-bottom: 15px;
        }

        .converter-info ul {
            list-style: none;
            padding: 0;
        }

        .converter-info li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            color: #ccc;
        }

        .converter-info li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #4CAF50;
        }

        .problem-input {
            display: inline-block;
            width: 60px;
            padding: 5px;
            margin: 0 5px;
            border: 2px solid #2196F3;
            border-radius: 4px;
            font-size: 1.1rem;
            text-align: center;
        }

        .problem-input.correct {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .problem-input.incorrect {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        /* Interactive Paper Mode Styles */
        .workspace-header {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .workspace-toolbar {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }

        .workspace-toolbar .tool-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .workspace-toolbar .tool-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .workspace-toolbar .tool-btn.active {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
        }

        .page-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 15px;
        }

        .page-navigation button {
            padding: 8px 15px;
            background: rgba(33, 150, 243, 0.2);
            border: 2px solid #2196F3;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
        }

        .page-navigation button:hover {
            background: rgba(33, 150, 243, 0.3);
        }

        .pdf-workspace {
            position: relative;
            margin: 20px 0;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: auto;
            max-height: 80vh;
            background: white;
        }

        .pdf-container {
            position: relative;
            display: inline-block;
        }

        #pdf-render-canvas {
            display: block;
            max-width: 100%;
            height: auto;
        }

        #annotation-canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: all;
            cursor: crosshair;
        }

        .answer-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .answer-field {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #2196F3;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 16px;
            min-width: 60px;
            text-align: center;
            pointer-events: all;
            transition: all 0.3s;
        }

        .answer-field:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
            outline: none;
            transform: scale(1.1);
        }

        .answer-field.correct {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .answer-field.incorrect {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .workspace-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .workspace-controls button {
            padding: 12px 25px;
            font-size: 1.1rem;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid;
        }

        .check-btn {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
        }

        .save-btn {
            background: rgba(255, 152, 0, 0.2);
            border-color: #FF9800;
        }

        .download-btn {
            background: rgba(33, 150, 243, 0.2);
            border-color: #2196F3;
        }

        .finish-btn {
            background: rgba(156, 39, 176, 0.2);
            border-color: #9C27B0;
        }

        .workspace-controls button:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        .question-display {
            font-size: 1.8rem;
            line-height: 1.8;
            margin-bottom: 40px;
            text-align: center;
            color: #222;
        }

        .answer-area {
            text-align: center;
            margin: 30px 0;
        }

        .test-answer-input {
            width: 200px;
            padding: 15px;
            font-size: 1.5rem;
            text-align: center;
            border: 3px solid #2196F3;
            border-radius: 10px;
            background: white;
            transition: all 0.3s;
        }

        .test-answer-input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .test-answer-input.submitted {
            background: #f0f0f0;
            border-color: #999;
        }

        .test-navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .test-navigation button, .test-controls button {
            padding: 12px 25px;
            font-size: 1.1rem;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid;
        }

        #prev-btn, #next-btn {
            background: rgba(33, 150, 243, 0.2);
            border-color: #2196F3;
        }

        #prev-btn:hover, #next-btn:hover {
            background: rgba(33, 150, 243, 0.3);
        }

        .skip-btn {
            background: rgba(255, 152, 0, 0.2);
            border-color: #FF9800;
        }

        .skip-btn:hover {
            background: rgba(255, 152, 0, 0.3);
        }

        .submit-btn {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
        }

        .submit-btn:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .test-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .review-btn {
            background: rgba(156, 39, 176, 0.2);
            border-color: #9C27B0;
        }

        .review-btn:hover {
            background: rgba(156, 39, 176, 0.3);
        }

        .finish-btn {
            background: rgba(244, 67, 54, 0.2);
            border-color: #f44336;
        }

        .finish-btn:hover {
            background: rgba(244, 67, 54, 0.3);
        }

        .test-summary {
            padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border-radius: 15px;
            text-align: center;
        }

        .test-summary h3 {
            color: #4CAF50;
            font-size: 2rem;
            margin-bottom: 30px;
        }

        #summary-content {
            margin: 30px 0;
            font-size: 1.2rem;
        }

        .summary-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .question-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .question-status.answered {
            background: #4CAF50;
        }

        .question-status.skipped {
            background: #FF9800;
        }

        .question-status.unanswered {
            background: #999;
        }

        /* Times Table Grid Styles */
        .grid-container {
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        .grid-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .times-grid {
            display: grid;
            gap: 2px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            margin: 20px auto;
            width: fit-content;
        }

        .grid-cell {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .grid-cell:hover {
            background: rgba(76, 175, 80, 0.3);
            transform: scale(1.05);
        }

        .grid-cell.header {
            background: rgba(33, 150, 243, 0.3);
            font-weight: bold;
        }

        .grid-cell.highlighted {
            background: rgba(255, 193, 7, 0.3);
            font-weight: bold;
        }

        .grid-info {
            text-align: center;
            color: #aaa;
            margin-top: 10px;
        }

        /* Column Method Styles */
        .column-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .column-modes {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .mode-btn {
            background: rgba(155, 89, 182, 0.2);
            color: white;
            border: 2px solid #9B59B6;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mode-btn:hover {
            background: rgba(155, 89, 182, 0.4);
            transform: translateY(-2px);
        }
        
        .mode-btn.active {
            background: #9B59B6;
            box-shadow: 0 4px 12px rgba(155, 89, 182, 0.5);
        }
        
        .column-mode-content {
            display: none;
        }
        
        .column-mode-content.active {
            display: block;
        }
        
        .workout-settings, .test-settings {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .setting-group {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .setting-group label {
            min-width: 150px;
            color: #4ECDC4;
        }
        
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toggle-switch input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .start-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
        }
        
        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .test-scoring {
            background: rgba(78, 205, 196, 0.1);
            border-left: 4px solid #4ECDC4;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .test-scoring h4 {
            color: #4ECDC4;
            margin-bottom: 10px;
        }
        
        .test-scoring ul {
            list-style: none;
            padding: 0;
        }
        
        .test-scoring li {
            color: #ccc;
            margin: 5px 0;
            padding-left: 20px;
            position: relative;
        }
        
        .test-scoring li:before {
            content: "•";
            color: #4ECDC4;
            position: absolute;
            left: 0;
        }
        
        .column-container h2 {
            color: #4ECDC4;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .column-split-screen {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .column-guided, .column-practice {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #4ECDC4;
        }
        
        .column-guided h3 {
            color: #FFD700;
            margin-bottom: 15px;
        }
        
        .column-practice h3 {
            color: #9B59B6;
            margin-bottom: 15px;
        }
        
        .problem-setup {
            font-size: 2rem;
            color: white;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(78, 205, 196, 0.1);
            border-radius: 10px;
        }
        
        .guided-steps {
            min-height: 300px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .step-display {
            font-size: 1.2rem;
            color: white;
            line-height: 1.8;
        }
        
        .guided-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        
        .guided-controls button {
            background: #4ECDC4;
            color: #1a1a2e;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .guided-controls button:hover {
            background: #44A08D;
            transform: translateY(-2px);
        }
        
        #step-counter {
            color: #FFD700;
            font-weight: bold;
        }
        
        .practice-setup {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .practice-setup input {
            width: 100px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #9B59B6;
            color: white;
            text-align: center;
            border-radius: 5px;
            font-size: 1.2rem;
        }
        
        .practice-setup button {
            background: #9B59B6;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .practice-area {
            position: relative;
            background: white;
            border-radius: 10px;
            padding: 10px;
            min-height: 500px;
        }
        
        #practice-canvas {
            display: block;
            margin: 0 auto;
        }
        
        .column-presets {
            background: rgba(155, 89, 182, 0.1);
            border: 2px solid #9B59B6;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .column-presets h3 {
            color: #9B59B6;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .preset-level {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #9B59B6;
        }
        
        .preset-level h4 {
            color: #4ECDC4;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .column-presets button {
            background: rgba(155, 89, 182, 0.3);
            color: white;
            border: 1px solid #9B59B6;
            padding: 8px 15px;
            margin: 3px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .column-presets button:hover {
            background: #9B59B6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(155, 89, 182, 0.4);
        }
        
        /* Interactive Column Grid Styles */
        .column-grid {
            display: inline-block;
            margin: 20px auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            font-family: monospace;
            font-size: 1.5rem;
            text-align: center;
        }
        
        .grid-row {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 5px 0;
            min-height: 40px;
        }
        
        .grid-cell {
            width: 40px;
            height: 40px;
            margin: 0 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .grid-input {
            width: 40px;
            height: 40px;
            border: 2px solid #4ECDC4;
            background: rgba(78, 205, 196, 0.1);
            color: white;
            text-align: center;
            font-size: 1.3rem;
            border-radius: 5px;
            margin: 0 2px;
        }
        
        .grid-input:focus {
            outline: none;
            border-color: #9B59B6;
            background: rgba(155, 89, 182, 0.2);
        }
        
        .grid-input.correct {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }
        
        .grid-input.incorrect {
            border-color: #F44336;
            background: rgba(244, 67, 54, 0.2);
        }
        
        .carry-input {
            width: 30px;
            height: 30px;
            border: 2px solid #FF6B6B;
            background: rgba(255, 107, 107, 0.1);
            color: #FF6B6B;
            text-align: center;
            font-size: 1rem;
            border-radius: 50%;
            margin: 0 2px;
        }
        
        .practice-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .practice-controls button {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            color: white;
        }
        
        .check-btn {
            background: #4CAF50;
        }
        
        .clear-btn {
            background: #F44336;
        }
        
        .hint-btn {
            background: #FFD700;
            color: black;
        }
        
        /* Times Tables Grid Styles */
        .timestables-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .timestables-container h2 {
            color: #4ECDC4;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2rem;
        }
        
        /* Pattern Explorer Styles */
        .pattern-controls {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .pattern-display {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }
        
        #pattern-canvas {
            border: 2px solid #4ECDC4;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .pattern-explanation {
            background: rgba(78, 205, 196, 0.1);
            border-left: 4px solid #4ECDC4;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }
        
        /* Speed Challenge Styles */
        .speed-levels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .level-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 15px;
            padding: 30px 20px;
            color: white;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .level-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .level-icon {
            font-size: 2rem;
        }
        
        .level-name {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .level-desc {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .speed-game {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }
        
        .speed-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            font-size: 1.2rem;
        }
        
        .speed-timer {
            color: #FFD700;
            font-weight: bold;
        }
        
        .speed-score {
            color: #4ECDC4;
        }
        
        .speed-streak {
            color: #FF6B6B;
        }
        
        .speed-problem {
            text-align: center;
            margin: 30px 0;
            position: relative;
            overflow: visible;
        }
        
        #speed-question {
            font-size: 3rem;
            color: white;
            margin-right: 20px;
        }
        
        #speed-answer {
            font-size: 2rem;
            padding: 10px 20px;
            border: 2px solid #4ECDC4;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            width: 150px;
            text-align: center;
        }
        
        /* Remove number input spinners */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        .speed-leaderboard {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }
        
        /* Speed Challenge Visual Feedback */
        @keyframes correctFlare {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.5) rotate(180deg);
                opacity: 1;
            }
            100% {
                transform: scale(2) rotate(360deg);
                opacity: 0;
            }
        }
        
        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
        
        @keyframes streakFire {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            50% {
                transform: translateY(-20px) scale(1.2);
                opacity: 0.8;
            }
            100% {
                transform: translateY(-40px) scale(0.8);
                opacity: 0;
            }
        }
        
        .correct-flare {
            position: absolute;
            width: 100px;
            height: 100px;
            pointer-events: none;
            z-index: 1000;
        }
        
        .correct-flare::before {
            content: '✨';
            position: absolute;
            font-size: 60px;
            animation: correctFlare 0.6s ease-out;
        }
        
        .incorrect-shake {
            animation: incorrectShake 0.5s ease-in-out;
        }
        
        .streak-fire {
            position: absolute;
            font-size: 40px;
            animation: streakFire 1s ease-out;
            pointer-events: none;
        }
        
        #speed-answer.correct-glow {
            box-shadow: 0 0 20px #4CAF50, 0 0 40px #4CAF50;
            border-color: #4CAF50;
            transition: all 0.3s;
        }
        
        #speed-answer.incorrect-glow {
            box-shadow: 0 0 20px #F44336, 0 0 40px #F44336;
            border-color: #F44336;
            transition: all 0.3s;
        }
        
        /* Circle Patterns Styles */
        .circle-controls {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }
        
        .circle-display {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin: 20px 0;
        }
        
        #circle-canvas {
            border: 2px solid #4ECDC4;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
        }
        
        .circle-info {
            text-align: center;
            color: #ccc;
            margin-top: 20px;
        }
        
        .timestables-controls {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .timestables-controls select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #4ECDC4;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .timestables-grid-container {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #4ECDC4;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            overflow: auto;
        }
        
        #timestables-grid {
            display: inline-block;
            border-collapse: collapse;
            margin: 0 auto;
        }
        
        .tt-cell {
            width: 50px;
            height: 50px;
            text-align: center;
            border: 1px solid rgba(78, 205, 196, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            position: relative;
        }
        
        .tt-header {
            background: rgba(78, 205, 196, 0.3);
            color: #4ECDC4;
            font-weight: bold;
        }
        
        .tt-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            border: 2px solid #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        
        .tt-cell.highlighted-row,
        .tt-cell.highlighted-col {
            background: rgba(255, 215, 0, 0.2) !important;
        }
        
        .tt-cell.highlighted-both {
            background: rgba(255, 215, 0, 0.4) !important;
            border: 2px solid #FFD700;
        }
        
        .tt-cell.locked {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .tt-cell.pattern-highlight {
            border: 2px solid #FF6B6B;
            background: rgba(255, 107, 107, 0.2);
        }
        
        .timestables-info {
            background: rgba(155, 89, 182, 0.1);
            border: 2px solid #9B59B6;
            border-radius: 10px;
            padding: 15px;
        }
        
        #tt-hover-info {
            color: #FFD700;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            min-height: 30px;
        }
        
        .tt-tips h3 {
            color: #9B59B6;
            margin-bottom: 10px;
        }
        
        .tt-tips ul {
            color: #ccc;
            margin-left: 20px;
        }
        
        .tt-tips li {
            margin: 5px 0;
        }
        
        /* Number Line Tool Styles */
        .numberline-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .numberline-container h2 {
            color: #4ECDC4;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .numberline-controls {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-group label {
            color: #4ECDC4;
            font-weight: bold;
        }
        
        .control-group input[type="number"] {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #4ECDC4;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            width: 80px;
        }
        
        .control-group button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .control-group button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }
        
        .numberline-display {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #4ECDC4;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        .numberline-markers {
            background: rgba(155, 89, 182, 0.1);
            border: 2px solid #9B59B6;
            border-radius: 10px;
            padding: 15px;
        }
        
        .numberline-markers h3 {
            color: #9B59B6;
            margin-bottom: 10px;
        }
        
        .numberline-markers input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #9B59B6;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            margin-right: 10px;
        }
        
        .numberline-markers button {
            background: #9B59B6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.3s ease;
        }
        
        .numberline-markers button:hover {
            background: #8E44AD;
            transform: translateY(-2px);
        }
        
        #marker-list {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .marker-item {
            background: rgba(155, 89, 182, 0.2);
            padding: 5px 10px;
            border-radius: 5px;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .marker-item button {
            background: #F44336;
            color: white;
            border: none;
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
        }

        /* Comparison Log */
        .comparison-log {
            background: rgba(78, 205, 196, 0.1);
            border: 2px solid #4ECDC4;
            border-radius: 10px;
            padding: 20px;
            margin: 20px auto;
            max-height: 200px;
            overflow-y: auto;
            max-width: 900px;
        }

        .comparison-log h4 {
            color: #4ECDC4;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1.1rem;
        }

        .log-entries {
            color: #fff;
            line-height: 1.8;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .log-entry {
            padding: 10px 15px;
            background: linear-gradient(135deg, rgba(0,0,0,0.7), rgba(0,0,0,0.5));
            border-radius: 15px;
            border: 2px solid #4ECDC4;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            position: relative;
            transition: all 0.3s ease;
            min-width: 400px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .log-entry:hover {
            background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(0,0,0,0.6));
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(78, 205, 196, 0.3);
        }
        
        .log-entry .left-objects,
        .log-entry .right-objects {
            display: flex;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            min-width: 60px;
            justify-content: center;
        }
        
        .log-entry .emoji {
            font-size: 2.5rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }
        
        .log-entry .relation {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 5px 15px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            white-space: nowrap;
            position: relative;
        }
        
        .log-entry .relation-text {
            color: #FFD700;
            font-weight: bold;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        
        .log-entry .relation-symbol {
            color: #FFD700;
            font-size: 2rem;
            font-weight: bold;
            line-height: 1;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }
        
        .log-entry.flipped .relation {
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        
        .log-entry.flipped .relation-text {
            color: #4ECDC4;
            text-shadow: 0 0 5px rgba(78, 205, 196, 0.5);
        }
        
        .log-entry.flipped .relation-symbol {
            color: #4ECDC4;
            text-shadow: 0 0 10px rgba(78, 205, 196, 0.8);
        }
        
        .log-entry .flip-btn {
            position: absolute;
            right: -20px;
            top: -10px;
            background: linear-gradient(45deg, #9B59B6, #8E44AD);
            border: 2px solid #fff;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            color: white;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
            z-index: 10;
        }
        
        .log-entry .flip-btn:hover {
            transform: rotate(180deg) scale(1.1);
            box-shadow: 0 5px 12px rgba(0,0,0,0.5);
            background: linear-gradient(45deg, #8E44AD, #9B59B6);
        }

        /* Balance animations */
        .beam.tilt-left {
            transform: translateX(-50%) rotate(-10deg);
        }

        .beam.tilt-right {
            transform: translateX(-50%) rotate(10deg);
        }

        .beam.balanced {
            transform: translateX(-50%) rotate(0deg);
        }

        .left-platform.down {
            bottom: 40px;
        }

        .right-platform.down {
            bottom: 40px;
        }

        .left-platform.up {
            bottom: 70px;
        }

        .right-platform.up {
            bottom: 70px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .soroban {
                gap: 4px;
            }
            
            .column {
                width: 35px;
                min-height: 250px;
            }
            
            .bead {
                width: 25px;
                height: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">

        <!-- Tool Selection Navigation - Organized by 5 Main Math Categories -->
        <div class="tool-navigation">
            <div class="nav-category">
                <button class="nav-btn arithmetic-nav" onclick="toggleCategory('arithmetic')">➕ Arithmetic</button>
                <div class="nav-dropdown" id="arithmetic-dropdown">
                    <button class="tool-btn" onclick="switchTool('soroban')">🧮 Soroban Calculator</button>
                    <button class="tool-btn" onclick="switchTool('placevaluegame')">Place Value Game</button>
                    <button class="tool-btn" onclick="switchTool('numberline')">Number Line</button>
                    <button class="tool-btn" onclick="switchTool('tt-workout')">Times Tables Workout</button>
                    <button class="tool-btn" onclick="switchTool('fractions')">Fractions Practice</button>
                    <button class="tool-btn" onclick="switchTool('money')">Money & Coins</button>
                    <button class="tool-btn" onclick="switchTool('decimals')">Decimals & Place Value</button>
                </div>
            </div>
            <div class="nav-category">
                <button class="nav-btn geometry-nav" onclick="toggleCategory('geometry')">📐 Geometry</button>
                <div class="nav-dropdown" id="geometry-dropdown">
                    <button class="tool-btn" onclick="switchTool('shapes3d')">3D Shapes Explorer</button>
                    <button class="tool-btn" onclick="switchTool('tiles')">Tiles & Tessellation</button>
                    <button class="tool-btn" onclick="switchTool('angles')">Angles Practice</button>
                    <button class="tool-btn" onclick="switchTool('perimeter')">Perimeter & Area</button>
                    <button class="tool-btn" onclick="switchTool('euclid')">Euclid Proofs</button>
                </div>
            </div>
            <div class="nav-category">
                <button class="nav-btn algebra-nav" onclick="toggleCategory('algebra')">🔤 Algebra</button>
                <div class="nav-dropdown" id="algebra-dropdown">
                    <button class="tool-btn" onclick="switchTool('balance')">Balance Scale</button>
                    <button class="tool-btn" onclick="switchTool('patterns')">Pattern Recognition</button>
                    <button class="tool-btn" onclick="switchTool('graphs')">📈 Graphs & Functions</button>
                    <button class="tool-btn" onclick="switchTool('algebra')">🔢 Algebra Solver</button>
                </div>
            </div>
            <div class="nav-category">
                <button class="nav-btn data-nav" onclick="toggleCategory('data')">📊 Data Handling</button>
                <div class="nav-dropdown" id="data-dropdown">
                    <button class="tool-btn" onclick="switchTool('venndiagram')">Venn Diagrams</button>
                    <button class="tool-btn" onclick="switchTool('clock')">Clock & Time</button>
                </div>
            </div>
            <div class="nav-category">
                <button class="nav-btn nature-nav" onclick="toggleCategory('nature')">🌻 Maths in Nature</button>
                <div class="nav-dropdown" id="nature-dropdown">
                    <button class="tool-btn" onclick="switchTool('fibonacci')">Fibonacci Sequence</button>
                    <button class="tool-btn" onclick="switchTool('fractals')">Fractal Generator</button>
                    <button class="tool-btn" onclick="switchTool('golden')">Golden Ratio</button>
                    <button class="tool-btn" onclick="switchTool('spirals')">Natural Spirals</button>
                </div>
            </div>
            <div class="nav-category">
                <button class="nav-btn history-nav" onclick="toggleCategory('history')">📜 Ancient Maths</button>
                <div class="nav-dropdown" id="history-dropdown">
                    <button class="tool-btn" onclick="switchTool('egypt')">🏺 Egyptian Mathematics</button>
                    <button class="tool-btn" onclick="switchTool('sumerian')">𒌋 Sumerian Mathematics</button>
                    <button class="tool-btn" onclick="switchTool('mayan')">☀️ Mayan Mathematics</button>
                </div>
            </div>
            <div class="nav-category">
                <button class="nav-btn practice-nav" onclick="toggleCategory('practice')">✏️ Practice & Drills</button>
                <div class="nav-dropdown" id="practice-dropdown">
                    <button class="tool-btn" onclick="switchTool('dailydrill')">📝 Daily Drill</button>
                </div>
            </div>
            <div class="nav-category">
                <button class="nav-btn overview-nav" onclick="toggleCategory('overview')">📚 Overview</button>
                <div class="nav-dropdown" id="overview-dropdown">
                    <button class="tool-btn" onclick="switchTool('categories')">All Categories</button>
                    <button class="tool-btn" onclick="switchTool('pdf-converter')">📄 PDF Worksheets</button>
                </div>
            </div>
        </div>

        <!-- Main Tools Preview -->
        <div id="categories-tool" class="tool-content active">
            <div class="tools-preview-container">
                <h1 class="main-title">Welcome to Interactive Visual Maths</h1>
                <div class="tools-grid-wrapper">
                    <div class="tools-grid">
                    <!-- Soroban Preview -->
                    <div class="tool-preview" onclick="switchTool('soroban')">
                        <div class="category-label arithmetic-label">Arithmetic</div>
                        <div class="preview-visual soroban-preview">
                            <div class="mini-soroban">
                                <div class="mini-bead"></div>
                                <div class="mini-bead"></div>
                                <div class="mini-bead"></div>
                            </div>
                        </div>
                        <h3>Soroban</h3>
                    </div>

                    <!-- Place Value Preview -->
                    <div class="tool-preview" onclick="switchTool('placevaluegame')">
                        <div class="category-label arithmetic-label">Arithmetic</div>
                        <div class="preview-visual placevalue-preview">
                            <div class="mini-digits">
                                <span>3</span><span>4</span><span>5</span>
                            </div>
                        </div>
                        <h3>Place Value</h3>
                    </div>

                    <!-- Times Tables Preview -->
                    <div class="tool-preview" onclick="switchTool('tt-grid')">
                        <div class="category-label arithmetic-label">Arithmetic</div>
                        <div class="preview-visual times-preview">
                            <div class="mini-grid">
                                <div>×</div><div>2</div><div>3</div>
                                <div>2</div><div>4</div><div>6</div>
                                <div>3</div><div>6</div><div>9</div>
                            </div>
                        </div>
                        <h3>Times Tables</h3>
                    </div>

                    <!-- Fractions Preview -->
                    <div class="tool-preview" onclick="switchTool('fractionbars')">
                        <div class="category-label arithmetic-label">Arithmetic</div>
                        <div class="preview-visual fraction-preview">
                            <div class="mini-fraction">
                                <div class="fraction-top">1</div>
                                <div class="fraction-line"></div>
                                <div class="fraction-bottom">2</div>
                            </div>
                        </div>
                        <h3>Fractions</h3>
                    </div>

                    <!-- Number Line Preview -->
                    <div class="tool-preview" onclick="switchTool('numberline')">
                        <div class="category-label arithmetic-label">Arithmetic</div>
                        <div class="preview-visual numberline-preview">
                            <div class="mini-line">
                                <span>0</span>
                                <div class="line-bar"></div>
                                <span>10</span>
                            </div>
                        </div>
                        <h3>Number Line</h3>
                    </div>

                    <!-- Geometry Preview -->
                    <div class="tool-preview" onclick="switchTool('shapes2d')">
                        <div class="category-label geometry-label">Geometry</div>
                        <div class="preview-visual geometry-preview">
                            <div class="mini-shapes">
                                <div class="mini-circle"></div>
                                <div class="mini-triangle"></div>
                                <div class="mini-square"></div>
                            </div>
                        </div>
                        <h3>Shapes</h3>
                    </div>

                    <!-- Tiles & Tessellation Preview -->
                    <div class="tool-preview" onclick="switchTool('tessellation')">
                        <div class="category-label geometry-label">Geometry</div>
                        <div class="preview-visual tessellation-preview">
                            <div class="mini-tiles">
                                <div class="hex-tile"></div>
                                <div class="hex-tile"></div>
                                <div class="hex-tile"></div>
                                <div class="hex-tile"></div>
                                <div class="hex-tile"></div>
                                <div class="hex-tile"></div>
                                <div class="hex-tile"></div>
                            </div>
                        </div>
                        <h3>Tessellation</h3>
                    </div>

                    <!-- 3D Shapes Preview -->
                    <div class="tool-preview" onclick="switchTool('shapes3d')">
                        <div class="category-label geometry-label">Geometry</div>
                        <div class="preview-visual shapes3d-preview">
                            <div class="rotating-cube">
                                <div class="cube-face cube-front"></div>
                                <div class="cube-face cube-back"></div>
                                <div class="cube-face cube-left"></div>
                                <div class="cube-face cube-right"></div>
                                <div class="cube-face cube-top"></div>
                                <div class="cube-face cube-bottom"></div>
                            </div>
                        </div>
                        <h3>3D Shapes</h3>
                    </div>

                    <!-- Angles Preview -->
                    <div class="tool-preview" onclick="switchTool('protractor')">
                        <div class="category-label geometry-label">Geometry</div>
                        <div class="preview-visual angle-preview">
                            <div class="mini-angle">
                                <div class="angle-arc">90°</div>
                            </div>
                        </div>
                        <h3>Angles</h3>
                    </div>

                    <!-- Balance Preview -->
                    <div class="tool-preview" onclick="switchTool('balance')">
                        <div class="category-label algebra-label">Algebra</div>
                        <div class="preview-visual balance-preview">
                            <div class="mini-balance">
                                <div class="balance-beam"></div>
                                <div class="balance-pivot">▲</div>
                            </div>
                        </div>
                        <h3>Balance</h3>
                    </div>

                    <!-- Bar Chart Preview -->
                    <div class="tool-preview" onclick="switchTool('barchart')">
                        <div class="category-label data-label">Data</div>
                        <div class="preview-visual chart-preview">
                            <div class="mini-bars">
                                <div class="bar" style="height: 30px;"></div>
                                <div class="bar" style="height: 50px;"></div>
                                <div class="bar" style="height: 40px;"></div>
                            </div>
                        </div>
                        <h3>Charts</h3>
                    </div>

                    <!-- Venn Diagram Preview -->
                    <div class="tool-preview" onclick="switchTool('venndiagram')">
                        <div class="category-label data-label">Data</div>
                        <div class="preview-visual venn-preview">
                            <div class="mini-venn">
                                <div class="venn-circle venn-left"></div>
                                <div class="venn-circle venn-right"></div>
                            </div>
                        </div>
                        <h3>Venn Diagrams</h3>
                    </div>

                    <!-- Clock Preview -->
                    <div class="tool-preview" onclick="switchTool('clock')">
                        <div class="category-label data-label">Data</div>
                        <div class="preview-visual clock-preview">
                            <div class="mini-clock">
                                <div class="clock-face">
                                    <div class="hour-hand"></div>
                                    <div class="minute-hand"></div>
                                </div>
                            </div>
                        </div>
                        <h3>Clock</h3>
                    </div>

                    <!-- Patterns Preview -->
                    <div class="tool-preview" onclick="switchTool('patterns')">
                        <div class="category-label algebra-label">Algebra</div>
                        <div class="preview-visual pattern-preview">
                            <div class="mini-pattern">
                                <span>2</span><span>4</span><span>6</span><span>?</span>
                            </div>
                        </div>
                        <h3>Patterns</h3>
                    </div>

                    <!-- Fibonacci Preview -->
                    <div class="tool-preview" onclick="exploreFibonacci()">
                        <div class="category-label nature-label">Nature</div>
                        <div class="preview-visual fibonacci-preview">
                            <div class="mini-spiral">🌻</div>
                        </div>
                        <h3>Nature</h3>
                    </div>

                    <!-- Money Preview -->
                    <div class="tool-preview" onclick="switchTool('money')">
                        <div class="category-label arithmetic-label">Arithmetic</div>
                        <div class="preview-visual money-preview">
                            <div class="coin-stack">
                                <div class="coin coin-1"></div>
                                <div class="coin coin-2"></div>
                                <div class="coin coin-3"></div>
                                <div class="coin coin-4"></div>
                            </div>
                        </div>
                        <h3>Money & Coins</h3>
                    </div>

                    <!-- Decimals Preview -->
                    <div class="tool-preview" onclick="switchTool('decimals')">
                        <div class="category-label arithmetic-label">Arithmetic</div>
                        <div class="preview-visual decimals-preview">
                            <div class="decimal-animation">
                                <span class="dec-digit">1</span>
                                <span class="dec-digit">2</span>
                                <span class="dec-point">.</span>
                                <span class="dec-digit">5</span>
                                <div class="decimal-arrow">×10 →</div>
                            </div>
                        </div>
                        <h3>Decimals</h3>
                    </div>
                    <!-- Perimeter & Area Preview -->
                    <div class="tool-preview" onclick="switchTool('perimeter')">
                        <div class="category-label geometry-label">Geometry</div>
                        <div class="preview-visual perimeter-preview">
                            <div class="grid-animation">
                                <div class="unit-square"></div>
                                <div class="unit-square filled"></div>
                                <div class="unit-square filled"></div>
                                <div class="unit-square"></div>
                                <div class="unit-square filled"></div>
                                <div class="unit-square filled"></div>
                                <div class="unit-square filled"></div>
                                <div class="unit-square"></div>
                                <div class="unit-square"></div>
                                <div class="unit-square filled"></div>
                                <div class="unit-square filled"></div>
                                <div class="unit-square"></div>
                                <div class="measurement-labels">
                                    <span class="perimeter-label">Perimeter: 10</span>
                                    <span class="area-label">Area: 6</span>
                                </div>
                            </div>
                        </div>
                        <h3>Perimeter & Area</h3>
                    </div>
                    <!-- Euclid Proofs Preview -->
                    <div class="tool-preview" onclick="switchTool('euclid')">
                        <div class="category-label geometry-label">Geometry</div>
                        <div class="preview-visual euclid-preview">
                            <div class="euclid-animation">
                                <svg viewBox="0 0 120 100" class="euclid-svg">
                                    <!-- Pythagorean theorem visualization -->
                                    <g class="pythagorean-group">
                                        <!-- Right triangle -->
                                        <path d="M 20 70 L 60 70 L 60 30 Z" 
                                              class="triangle-main" 
                                              fill="none" 
                                              stroke="#667eea" 
                                              stroke-width="2"/>
                                        <!-- Square on side a -->
                                        <rect x="20" y="70" width="40" height="40" 
                                              class="square-a" 
                                              fill="rgba(102, 126, 234, 0.3)" 
                                              stroke="#667eea" 
                                              stroke-width="1"/>
                                        <!-- Square on side b -->
                                        <rect x="60" y="30" width="40" height="40" 
                                              class="square-b" 
                                              fill="rgba(118, 75, 162, 0.3)" 
                                              stroke="#764ba2" 
                                              stroke-width="1"/>
                                        <!-- Square on hypotenuse c -->
                                        <g class="square-c" transform="rotate(-45, 40, 50)">
                                            <rect x="15" y="25" width="50" height="50" 
                                                  fill="rgba(255, 107, 107, 0.3)" 
                                                  stroke="#ff6b6b" 
                                                  stroke-width="1"/>
                                        </g>
                                        <!-- Labels -->
                                        <text x="40" y="85" class="euclid-label">a²</text>
                                        <text x="80" y="50" class="euclid-label">b²</text>
                                        <text x="35" y="45" class="euclid-label">c²</text>
                                    </g>
                                </svg>
                                <div class="euclid-formula">a² + b² = c²</div>
                            </div>
                        </div>
                        <h3>Euclid Proofs</h3>
                    </div>
                    <!-- Ancient Egypt Preview -->
                    <div class="tool-preview" onclick="switchTool('egypt')">
                        <div class="category-label nature-label">History</div>
                        <div class="preview-visual egypt-preview">
                            <div class="egypt-animation">
                                <div class="hieroglyphics">
                                    <span class="hieroglyph h1">𓏺</span>
                                    <span class="hieroglyph h10">𓎆</span>
                                    <span class="hieroglyph h100">𓍢</span>
                                    <span class="hieroglyph h1000">𓆼</span>
                                </div>
                                <div class="egypt-number">2,436</div>
                            </div>
                        </div>
                        <h3>Egyptian Maths</h3>
                    </div>
                    <!-- Sumerian Preview -->
                    <div class="tool-preview" onclick="switchTool('sumerian')">
                        <div class="category-label nature-label">History</div>
                        <div class="preview-visual sumerian-preview">
                            <div class="sumerian-animation">
                                <div class="cuneiform-numbers">
                                    <div class="cuneiform-row">
                                        <span class="cuneiform wedge-10">𒌋</span>
                                        <span class="cuneiform wedge-10">𒌋</span>
                                        <span class="cuneiform wedge-1">𒐕</span>
                                    </div>
                                    <div class="base60-label">Base 60</div>
                                </div>
                            </div>
                        </div>
                        <h3>Sumerian Maths</h3>
                    </div>
                    <!-- Mayan Preview -->
                    <div class="tool-preview" onclick="switchTool('mayan')">
                        <div class="category-label nature-label">History</div>
                        <div class="preview-visual mayan-preview">
                            <div class="mayan-animation">
                                <div class="mayan-numerals">
                                    <div class="mayan-level">
                                        <span class="mayan-dot">•</span>
                                    </div>
                                    <div class="mayan-level">
                                        <span class="mayan-bar">━</span>
                                        <span class="mayan-dot">•</span>
                                    </div>
                                    <div class="mayan-level">
                                        <span class="mayan-shell">𝋆</span>
                                    </div>
                                </div>
                                <div class="mayan-label">Base 20</div>
                            </div>
                        </div>
                        <h3>Mayan Maths</h3>
                    </div>
                    <!-- Graphs Preview -->
                    <div class="tool-preview" onclick="switchTool('graphs')">
                        <div class="category-label algebra-label">Algebra</div>
                        <div class="preview-visual graphs-preview">
                            <div class="graph-animation">
                                <svg viewBox="0 0 120 100" class="graph-svg">
                                    <!-- Grid -->
                                    <defs>
                                        <pattern id="graph-grid" width="10" height="10" patternUnits="userSpaceOnUse">
                                            <path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/>
                                        </pattern>
                                    </defs>
                                    <rect width="120" height="100" fill="url(#graph-grid)" />
                                    <!-- Axes -->
                                    <line x1="10" y1="50" x2="110" y2="50" stroke="white" stroke-width="2"/>
                                    <line x1="60" y1="10" x2="60" y2="90" stroke="white" stroke-width="2"/>
                                    <!-- Function y = x² -->
                                    <path d="M 30 80 Q 60 20 90 80" 
                                          class="graph-line parabola" 
                                          fill="none" 
                                          stroke="#00ff41" 
                                          stroke-width="2"/>
                                    <!-- Function y = x -->
                                    <line x1="20" y1="80" x2="100" y2="20" 
                                          class="graph-line linear" 
                                          stroke="#ff6b6b" 
                                          stroke-width="2"/>
                                    <!-- Moving point -->
                                    <circle class="graph-point" cx="60" cy="50" r="3" fill="#FFD700"/>
                                </svg>
                                <div class="graph-equation">y = mx + b</div>
                            </div>
                        </div>
                        <h3>Graphs & Functions</h3>
                    </div>
                    <!-- Algebra Preview -->
                    <div class="tool-preview" onclick="switchTool('algebra')">
                        <div class="category-label algebra-label">Algebra</div>
                        <div class="preview-visual algebra-preview">
                            <div class="algebra-animation">
                                <div class="equation-solve">
                                    <div class="equation-step step-1">2x + 3 = 11</div>
                                    <div class="equation-step step-2">2x = 8</div>
                                    <div class="equation-step step-3">x = 4</div>
                                </div>
                                <div class="algebra-balance">
                                    <div class="balance-scale">
                                        <div class="scale-left">2x + 3</div>
                                        <div class="scale-beam">⚖</div>
                                        <div class="scale-right">11</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <h3>Algebra Solver</h3>
                    </div>
                    <!-- Daily Drill Preview -->
                    <div class="tool-preview" onclick="switchTool('dailydrill')">
                        <div class="category-label drill-label">Practice</div>
                        <div class="preview-visual dailydrill-preview">
                            <div class="worksheet-animation">
                                <div class="worksheet-page">
                                    <div class="worksheet-header">
                                        <span class="level-badge">Level 2A</span>
                                        <span class="timer">⏱ 10:00</span>
                                    </div>
                                    <div class="math-problems">
                                        <div class="problem">3 + 5 = <span class="answer">8</span></div>
                                        <div class="problem">7 - 2 = <span class="answer">5</span></div>
                                        <div class="problem">4 × 3 = <span class="answer">12</span></div>
                                        <div class="problem">15 ÷ 3 = <span class="answer">5</span></div>
                                    </div>
                                    <div class="worksheet-footer">
                                        <div class="score">Score: 98%</div>
                                        <div class="streak">🔥 5 days</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <h3>Daily Drill</h3>
                    </div>
                </div>
                </div>
                
                <!-- Carousel Navigation -->
                <button class="carousel-nav carousel-prev" onclick="scrollCarousel('prev')">
                    <span>‹</span>
                </button>
                <button class="carousel-nav carousel-next" onclick="scrollCarousel('next')">
                    <span>›</span>
                </button>

                <!-- Keep the Fibonacci Explorer -->
                <div id="fibonacci-explorer" class="fibonacci-section" style="display: none;">
                    <h2>Fibonacci Sequence Explorer</h2>
                    <div class="fibonacci-display">
                        <div id="fib-sequence">1, 1, 2, 3, 5, 8, 13, 21...</div>
                        <p>Each number is the sum of the two before it!</p>
                    </div>
                    <div class="fibonacci-controls">
                        <button onclick="generateMoreFib()">Generate More Numbers</button>
                        <button onclick="document.getElementById('fibonacci-explorer').style.display='none'">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Place Value Game Tool -->
        <div id="placevaluegame-tool" class="tool-content">
            <div class="container">
                <div class="header">
                    <h1>Place Value Master</h1>
                    <p>Practice identifying place values and converting between numbers and words</p>
                </div>

                <div class="pv-mode-selector">
                    <button class="pv-mode-btn active" onclick="switchPVMode('breakdown')">📊 Place Value Breakdown</button>
                    <button class="pv-mode-btn" onclick="switchPVMode('words')">✍️ Number to Words</button>
                    <button class="pv-mode-btn" onclick="switchPVMode('reverse')">🔄 Words to Number</button>
                </div>

                <!-- Place Value Breakdown Mode -->
                <div id="pv-breakdown-mode" class="pv-mode active">
                    <div class="pv-game-area">
                        <div class="pv-score-board">
                            <div class="pv-score">Score: <span id="pv-score">0</span></div>
                            <div class="pv-streak">Streak: <span id="pv-streak">0</span></div>
                            <div class="pv-level">
                                <label>Difficulty: </label>
                                <select id="pv-difficulty" onchange="newPVProblem()">
                                    <option value="easy">Easy (1-999)</option>
                                    <option value="medium">Medium (1-99,999)</option>
                                    <option value="hard">Hard (1-9,999,999)</option>
                                    <option value="expert">Expert (Decimals)</option>
                                </select>
                            </div>
                        </div>

                        <div class="pv-problem-display">
                            <h2>Break down this number:</h2>
                            <div class="pv-number" id="pv-number">0</div>
                        </div>

                        <div class="pv-input-grid" id="pv-input-grid">
                            <!-- Input fields will be generated here -->
                        </div>

                        <div class="pv-controls">
                            <button class="pv-btn check" onclick="checkPVAnswer()">Check Answer</button>
                            <button class="pv-btn new" onclick="newPVProblem()">New Problem</button>
                            <button class="pv-btn hint" onclick="showPVHint()">Hint</button>
                        </div>

                        <div class="pv-feedback" id="pv-feedback"></div>
                    </div>
                </div>

                <!-- Number to Words Mode -->
                <div id="pv-words-mode" class="pv-mode">
                    <div class="pv-game-area">
                        <div class="pv-score-board">
                            <div class="pv-score">Score: <span id="pv-words-score">0</span></div>
                            <div class="pv-streak">Streak: <span id="pv-words-streak">0</span></div>
                            <div class="pv-level">
                                <label>Range: </label>
                                <select id="pv-words-difficulty" onchange="newWordsProblem()">
                                    <option value="tens">1-99</option>
                                    <option value="hundreds">100-999</option>
                                    <option value="thousands">1,000-9,999</option>
                                    <option value="millions">10,000-999,999</option>
                                </select>
                            </div>
                        </div>

                        <div class="pv-problem-display">
                            <h2>Write this number in words:</h2>
                            <div class="pv-number" id="pv-words-number">0</div>
                        </div>

                        <div class="pv-words-input">
                            <textarea id="pv-words-answer" placeholder="Type the number in words..." rows="3"></textarea>
                        </div>

                        <div class="pv-controls">
                            <button class="pv-btn check" onclick="checkWordsAnswer()">Check Answer</button>
                            <button class="pv-btn new" onclick="newWordsProblem()">New Problem</button>
                            <button class="pv-btn hint" onclick="showWordsHint()">Show Answer</button>
                        </div>

                        <div class="pv-feedback" id="pv-words-feedback"></div>

                        <div class="pv-reference">
                            <h3>📚 Quick Reference:</h3>
                            <div class="pv-ref-grid">
                                <div>1-9: one, two, three, four, five, six, seven, eight, nine</div>
                                <div>10-19: ten, eleven, twelve, thirteen, fourteen, fifteen, sixteen, seventeen, eighteen, nineteen</div>
                                <div>20-90: twenty, thirty, forty, fifty, sixty, seventy, eighty, ninety</div>
                                <div>100: hundred | 1,000: thousand | 1,000,000: million</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Words to Number Mode (Vice Versa) -->
                <div id="pv-reverse-mode" class="pv-mode">
                    <div class="pv-game-area">
                        <div class="pv-score-board">
                            <div class="pv-score">Score: <span id="pv-reverse-score">0</span></div>
                            <div class="pv-streak">Streak: <span id="pv-reverse-streak">0</span></div>
                            <div class="pv-level">
                                <label>Range: </label>
                                <select id="pv-reverse-difficulty" onchange="newReverseProblem()">
                                    <option value="tens">1-99</option>
                                    <option value="hundreds">100-999</option>
                                    <option value="thousands">1,000-9,999</option>
                                    <option value="millions">10,000-999,999</option>
                                </select>
                            </div>
                        </div>

                        <div class="pv-problem-display">
                            <h2>Convert these words to a number:</h2>
                            <div class="pv-words-display" id="pv-reverse-words">zero</div>
                        </div>

                        <div class="pv-number-input">
                            <input type="number" id="pv-reverse-answer" placeholder="Type the number..." class="pv-large-input">
                        </div>

                        <div class="pv-controls">
                            <button class="pv-btn check" onclick="checkReverseAnswer()">Check Answer</button>
                            <button class="pv-btn new" onclick="newReverseProblem()">New Problem</button>
                            <button class="pv-btn hint" onclick="showReverseHint()">Show Answer</button>
                        </div>

                        <div class="pv-feedback" id="pv-reverse-feedback"></div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Soroban Tool -->
        <div id="soroban-tool" class="tool-content">
        <div class="main-content">
            <div class="soroban-section">
                <div class="display" id="display">0</div>
                
                <div class="place-value-section">
                    <h3>Place Value Breakdown</h3>
                    <div id="place-value-display">
                        <div class="place-value-zero">0</div>
                    </div>
                </div>
                
                <div class="soroban-frame">
                    <div class="soroban" id="soroban">
                        <!-- Columns will be generated by JavaScript -->
                    </div>
                </div>

                <div class="controls">
                    <button class="btn" onclick="clearSoroban()">Clear</button>
                    <button class="btn" onclick="showValue()">Show Value</button>
                    <button class="btn" onclick="randomProblem()">New Problem</button>
                </div>
            </div>

            <div class="practice-panel">
                <h3 id="panel-title">Practice</h3>

                <!-- Regular Practice -->
                <div id="regular-practice">
                    <div class="practice-problem">
                        <div class="problem-text" id="problem">Click "New Problem" to start!</div>
                        <div class="answer-section">
                            <input type="number" class="answer-input" id="answer-input" placeholder="Answer">
                            <button class="check-answer" onclick="checkAnswer()">Check</button>
                        </div>
                        <div class="feedback" id="feedback" style="display: none;"></div>
                    </div>

                    <h4>🎯 Start Guided Practice:</h4>
                    <div class="operation-grid">
                        <button class="operation-btn" onclick="startGuided('addition')">➕ Addition</button>
                        <button class="operation-btn" onclick="startGuided('subtraction')">➖ Subtraction</button>
                        <button class="operation-btn" onclick="startGuided('multiplication')">✖️ Multiplication</button>
                        <button class="operation-btn" onclick="startGuided('division')">➗ Division</button>
                    </div>
                </div>

                <!-- Guided Practice -->
                <div id="guided-practice" class="guided-section">
                    <div class="guided-problem">
                        <h4 id="guided-title">Addition Tutorial</h4>
                        <div id="guided-problem-display">7 + 5 = ?</div>
                    </div>
                    
                    <div class="guided-instruction">
                        <div id="guided-instruction-text">Click "Start" to begin!</div>
                        <div id="guided-status" style="margin-top: 8px; font-size: 0.9rem; opacity: 0.8;"></div>
                    </div>
                    
                    <div class="guided-controls">
                        <button class="btn-small" id="prev-btn" onclick="prevStep()" disabled>← Prev</button>
                        <span id="step-counter">Ready</span>
                        <button class="btn-small" id="next-btn" onclick="nextStep()">Start →</button>
                    </div>
                    
                    <div class="guided-controls" style="margin-top: 10px;">
                        <button class="btn-small" onclick="retryProblem()" id="retry-btn" style="display: none;">🔄 Retry</button>
                        <button class="btn-small" onclick="newGuidedProblem()" id="new-btn" style="display: none;">✨ New Problem</button>
                        <button class="btn-small" onclick="exitGuided()">← Back</button>
                    </div>
                </div>

                <div class="progress-section">
                    <h4>Today's Progress</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
                    </div>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" id="correct-count">0</div>
                            <div class="stat-label">Correct</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="total-count">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="accuracy">0%</div>
                            <div class="stat-label">Accuracy</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="streak">0</div>
                            <div class="stat-label">Streak</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Balance Tool -->
        <div id="balance-tool" class="tool-content">
            <div class="balance-container">
                <div class="balance-header">
                    <h2>Mystery Weight Balance</h2>
                    <p>Drag objects to the balance platforms to compare their weights!</p>
                </div>
                
                <!-- Current Discovery Display -->
                <div class="current-discovery" id="current-discovery">
                    <div class="discovery-placeholder">
                        Compare objects to see result here
                    </div>
                </div>
                
                <div class="balance-main-layout">
                    <!-- Left Panel - Discovery History -->
                    <div class="history-panel">
                        <h4>Discovery History</h4>
                        <div class="history-entries" id="history-entries">
                            <!-- Past discoveries will be logged here -->
                        </div>
                    </div>
                    
                    <!-- Center Panel - Main Game Area -->
                    <div class="center-panel">
                        <!-- Balance Scale Visualization -->
                        <div class="balance-scale">
                            <div class="scale-platform left-platform" id="left-platform">
                                <div class="platform"></div>
                                <div class="platform-objects" id="left-objects"></div>
                            </div>
                            <div class="scale-center">
                                <div class="fulcrum"></div>
                                <div class="beam" id="beam"></div>
                            </div>
                            <div class="scale-platform right-platform" id="right-platform">
                                <div class="platform"></div>
                                <div class="platform-objects" id="right-objects"></div>
                            </div>
                        </div>
                        
                        <!-- Mystery Objects -->
                        <div class="objects-container">
                            <h3>Mystery Objects</h3>
                            <div class="objects-shelf" id="objects-shelf">
                                <!-- Objects will be generated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Panel - Stats -->
                    <div class="right-panel">
                        <h4>Tips</h4>
                        <div class="tips-content">
                            <p>• Compare objects on the balance</p>
                            <p>• Find the lightest first</p>
                            <p>• Build your sequence below</p>
                            <p>• Drag to reorder</p>
                        </div>
                    </div>
                </div>
                
                <!-- Sequence Builder Below Balance -->
                <div class="sequence-container">
                    <div class="sequence-header">
                        <h3>Arrange Objects by Weight (Lightest → Heaviest)</h3>
                        <div class="comparison-counter" id="comparison-counter">Comparisons: 0</div>
                    </div>
                    <div class="sequence-main">
                        <div class="sequence-left-controls">
                            <button class="btn" onclick="checkSequence()">Check Order</button>
                            <button class="btn" onclick="getHint()">💡 Get Hint</button>
                        </div>
                        <div class="sequence-slots" id="sequence-slots">
                            <!-- Slots for ordering objects -->
                        </div>
                        <div class="sequence-right-controls">
                            <button class="btn" onclick="resetBalance()">Reset</button>
                            <button class="btn" onclick="newBalancePuzzle()">New Puzzle</button>
                        </div>
                    </div>
                    <div class="balance-feedback" id="balance-feedback"></div>
                    <div class="hint-display" id="hint-display"></div>
                </div>
            </div>
        </div>
        
        <!-- Times Tables Master Section -->
        <!-- Visual Grid Tool -->
        <div id="tt-grid-tool" class="tool-content">
            <div class="timestables-container">
                <h2>Interactive Times Tables Grid</h2>
                <div class="timestables-controls">
                    <div class="control-group">
                        <label>Grid Size:</label>
                        <select id="tt-size" onchange="updateTimesTable()">
                            <option value="10">10 × 10</option>
                            <option value="12" selected>12 × 12</option>
                            <option value="15">15 × 15</option>
                            <option value="20">20 × 20</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Highlight:</label>
                        <select id="tt-highlight" onchange="updateTimesTable()">
                            <option value="none">None</option>
                            <option value="diagonal">Diagonal (Squares)</option>
                            <option value="even">Even Numbers</option>
                            <option value="odd">Odd Numbers</option>
                            <option value="fives">Multiples of 5</option>
                            <option value="tens">Multiples of 10</option>
                            <option value="primes">Prime Products</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Color Mode:</label>
                        <select id="tt-color" onchange="updateTimesTable()">
                            <option value="gradient">Heat Gradient</option>
                            <option value="patterns">Pattern Colors</option>
                            <option value="monochrome">Monochrome</option>
                        </select>
                    </div>
                </div>
                <div class="timestables-grid-container">
                    <div id="timestables-grid"></div>
                </div>
                <div class="timestables-info">
                    <div id="tt-hover-info">Hover over a cell to see the multiplication</div>
                    <div class="tt-tips">
                        <h3>Tips:</h3>
                        <ul>
                            <li>Click any cell to highlight its row and column</li>
                            <li>Double-click to lock the highlight</li>
                            <li>Look for patterns in the grid</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Daily Workout Tool -->
        <div id="tt-workout-tool" class="tool-content">
            <div class="timestables-container">
                <h2>Times Tables Daily Workout</h2>
                    <div class="workout-setup">
                        <div class="tables-selector">
                            <h3>Select Tables to Practice:</h3>
                            <div class="tables-checkboxes">
                                <label><input type="checkbox" value="2" checked> 2×</label>
                                <label><input type="checkbox" value="3" checked> 3×</label>
                                <label><input type="checkbox" value="4" checked> 4×</label>
                                <label><input type="checkbox" value="5" checked> 5×</label>
                                <label><input type="checkbox" value="6" checked> 6×</label>
                                <label><input type="checkbox" value="7" checked> 7×</label>
                                <label><input type="checkbox" value="8" checked> 8×</label>
                                <label><input type="checkbox" value="9" checked> 9×</label>
                                <label><input type="checkbox" value="10" checked> 10×</label>
                                <label><input type="checkbox" value="11"> 11×</label>
                                <label><input type="checkbox" value="12"> 12×</label>
                            </div>
                        </div>
                        <div class="workout-options">
                            <div class="option-group">
                                <label>Questions:</label>
                                <select id="workout-count">
                                    <option value="10">10 Questions</option>
                                    <option value="20" selected>20 Questions</option>
                                    <option value="30">30 Questions</option>
                                    <option value="50">50 Questions</option>
                                </select>
                            </div>
                            <div class="option-group">
                                <label>Timer:</label>
                                <select id="workout-timer">
                                    <option value="0">No Timer</option>
                                    <option value="60">1 Minute</option>
                                    <option value="120">2 Minutes</option>
                                    <option value="300">5 Minutes</option>
                                </select>
                            </div>
                            <button class="start-workout-btn" onclick="startWorkout()">Start Workout!</button>
                        </div>
                    </div>
                    
                    <div class="workout-area" id="workout-area" style="display: none;">
                        <div class="workout-stats">
                            <div class="stat">Question: <span id="current-question">1</span>/<span id="total-questions">20</span></div>
                            <div class="stat">Score: <span id="workout-score">0</span></div>
                            <div class="stat">Time: <span id="workout-time">00:00</span></div>
                        </div>
                        <div class="workout-problem">
                            <div class="problem-display" id="problem-display">
                                <span id="problem-text">6 × 7 = ?</span>
                            </div>
                            <div class="answer-input-group">
                                <input type="number" id="workout-answer" placeholder="Your answer" onkeyup="checkWorkoutAnswer(event)">
                                <button class="submit-answer-btn" onclick="submitAnswer()">Submit →</button>
                            </div>
                            <div class="workout-feedback" id="workout-feedback"></div>
                        </div>
                        <div class="workout-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                            </div>
                        </div>
                        <button class="end-workout-btn" onclick="endWorkout()">End Workout</button>
                    </div>
                    
                    <div class="workout-results" id="workout-results" style="display: none;">
                        <div class="final-score-display">
                            <div class="score-circle">
                                <span class="score-number" id="final-score-big">0</span>
                                <span class="score-divider">/</span>
                                <span class="score-total" id="final-total-big">20</span>
                            </div>
                            <h2 class="score-grade" id="score-grade">Excellent!</h2>
                        </div>
                        <div class="review-timer" id="review-timer">
                            Review Time: <span id="review-countdown">30</span> seconds
                        </div>
                        <div class="results-stats">
                            <div class="stat-card">
                                <span class="stat-label">Accuracy</span>
                                <span class="stat-value" id="final-accuracy">0%</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-label">Time</span>
                                <span class="stat-value" id="final-time">00:00</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-label">Speed</span>
                                <span class="stat-value" id="avg-speed">0s/question</span>
                            </div>
                        </div>
                        <div class="results-details" id="results-details"></div>
                        <button class="new-workout-btn" onclick="resetWorkout()" id="new-workout-btn" style="display: none;">New Workout</button>
                    </div>
            </div>
        </div>
        
        <!-- Pattern Explorer Tool -->
        <div id="tt-patterns-tool" class="tool-content">
            <div class="timestables-container">
                <h2>Times Tables Pattern Explorer</h2>
                <div class="pattern-controls">
                    <div class="control-group">
                        <label>Select Table:</label>
                        <select id="pattern-table" onchange="updatePatternView()">
                            <option value="2">2× Table</option>
                            <option value="3">3× Table</option>
                            <option value="4">4× Table</option>
                            <option value="5">5× Table</option>
                            <option value="6">6× Table</option>
                            <option value="7">7× Table</option>
                            <option value="8">8× Table</option>
                            <option value="9">9× Table</option>
                            <option value="10">10× Table</option>
                            <option value="11">11× Table</option>
                            <option value="12">12× Table</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Pattern Type:</label>
                        <select id="pattern-type" onchange="updatePatternView()">
                            <option value="skip">Skip Counting</option>
                            <option value="digits">Digital Root Pattern</option>
                            <option value="units">Units Digit Pattern</option>
                            <option value="doubles">Doubling Pattern</option>
                            <option value="mirror">Mirror Symmetry</option>
                        </select>
                    </div>
                </div>
                <div class="pattern-display" id="pattern-display">
                    <canvas id="pattern-canvas" width="800" height="400"></canvas>
                </div>
                <div class="pattern-explanation" id="pattern-explanation">
                    <h3>Pattern Discovery:</h3>
                    <p id="pattern-description">Select a table and pattern type to explore mathematical relationships!</p>
                </div>
            </div>
        </div>
        
        <!-- Speed Challenge Tool -->
        <div id="tt-speed-tool" class="tool-content">
            <div class="timestables-container">
                <h2>Times Tables Speed Challenge</h2>
                <div class="speed-levels">
                    <button class="level-btn" onclick="startSpeedChallenge('easy')">
                        <span class="level-icon">🌟</span>
                        <span class="level-name">Easy</span>
                        <span class="level-desc">2-5 times tables, 30s</span>
                    </button>
                    <button class="level-btn" onclick="startSpeedChallenge('medium')">
                        <span class="level-icon">⭐⭐</span>
                        <span class="level-name">Medium</span>
                        <span class="level-desc">2-10 times tables, 60s</span>
                    </button>
                    <button class="level-btn" onclick="startSpeedChallenge('hard')">
                        <span class="level-icon">🌟🌟🌟</span>
                        <span class="level-name">Hard</span>
                        <span class="level-desc">All tables, 90s</span>
                    </button>
                    <button class="level-btn" onclick="startSpeedChallenge('extreme')">
                        <span class="level-icon">💫</span>
                        <span class="level-name">Extreme</span>
                        <span class="level-desc">Random 13-20 tables, 120s</span>
                    </button>
                </div>
                <div class="speed-game" id="speed-game" style="display: none;">
                    <div class="speed-header">
                        <div class="speed-timer">⏱️ <span id="speed-timer">30</span>s</div>
                        <div class="speed-score">Score: <span id="speed-score">0</span></div>
                        <div class="speed-streak">🔥 Streak: <span id="speed-streak">0</span></div>
                    </div>
                    <div class="speed-problem">
                        <span id="speed-question">6 × 7</span>
                        <input type="number" id="speed-answer" placeholder="?" autofocus>
                    </div>
                    <button class="speed-quit" onclick="quitSpeedChallenge()">Quit Challenge</button>
                </div>
                <div class="speed-leaderboard">
                    <h3>🏆 Personal Best</h3>
                    <div id="speed-records"></div>
                </div>
            </div>
        </div>
        
        <!-- Circle Patterns Tool -->
        <div id="tt-circles-tool" class="tool-content">
            <div class="timestables-container">
                <h2>Times Tables Circle Patterns</h2>
                <div class="circle-controls">
                    <div class="control-group">
                        <label>Multiplication Table:</label>
                        <input type="number" id="circle-table" min="2" max="20" value="2" onchange="updateCirclePattern()">
                    </div>
                    <div class="control-group">
                        <label>Number of Points:</label>
                        <select id="circle-points" onchange="updateCirclePattern()">
                            <option value="10">10 Points</option>
                            <option value="12">12 Points (Clock)</option>
                            <option value="20">20 Points</option>
                            <option value="36">36 Points</option>
                            <option value="60">60 Points</option>
                            <option value="100">100 Points</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Animation Speed:</label>
                        <input type="range" id="circle-speed" min="0" max="100" value="50">
                    </div>
                    <button onclick="toggleCircleAnimation()">Play/Pause Animation</button>
                </div>
                <div class="circle-display">
                    <canvas id="circle-canvas" width="600" height="600"></canvas>
                </div>
                <div class="circle-info">
                    <p>Watch how multiplication tables create beautiful geometric patterns when visualized on a circle!</p>
                </div>
            </div>
        </div>
        
        <!-- Column Method Animator -->
        <div id="column-tool" class="tool-content">
            <div class="column-container">
                <h2>Column Method Multiplication - Step by Step</h2>
                <div class="column-split-screen">
                    <!-- Left: Guided Tutorial -->
                    <div class="column-guided">
                        <h3>📚 Guided Learning</h3>
                        <div class="guided-problem">
                            <div class="problem-setup">
                                <span id="guided-num1">234</span> × <span id="guided-num2">56</span>
                            </div>
                            <div class="guided-steps" id="guided-steps">
                                <div class="step-display" id="step-display"></div>
                            </div>
                            <div class="guided-controls">
                                <button onclick="previousStep()">← Previous</button>
                                <span id="step-counter">Step 1/6</span>
                                <button onclick="nextStep()">Next →</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right: Practice Area -->
                    <div class="column-practice">
                        <h3>✏️ Your Practice</h3>
                        <div class="practice-setup">
                            <button onclick="generateRandomProblem()">🎲 Random Problem</button>
                            <button onclick="setupCustomProblem()">✏️ Enter Your Own</button>
                        </div>
                        <div id="practice-workspace" style="display: none;">
                            <!-- Practice workspace will appear here -->
                        </div>
                        <div class="practice-feedback" id="practice-feedback"></div>
                    </div>
                </div>
                
                <div class="column-modes">
                    <button class="mode-btn active" onclick="switchColumnMode('learn')">📚 Learn Mode</button>
                    <button class="mode-btn" onclick="switchColumnMode('workout')">💪 Daily Workout</button>
                    <button class="mode-btn" onclick="switchColumnMode('test')">⏱️ Timed Test</button>
                </div>
                
                <!-- Learn Mode -->
                <div id="column-learn-mode" class="column-mode-content active">
                    <div class="column-presets">
                        <h3>Progressive Learning Path:</h3>
                        <div class="preset-level">
                            <h4>Level 1: Two Digits × Single Digit (No Carrying)</h4>
                            <button onclick="loadExample(20, 1)">20 × 1</button>
                            <button onclick="loadExample(21, 2)">21 × 2</button>
                            <button onclick="loadExample(22, 3)">22 × 3</button>
                            <button onclick="loadExample(23, 4)">23 × 4</button>
                            <button onclick="loadExample(11, 5)">11 × 5</button>
                        </div>
                        <div class="preset-level">
                            <h4>Level 2: Two Digits × Single Digit (With Carrying)</h4>
                            <button onclick="loadExample(29, 2)">29 × 2</button>
                            <button onclick="loadExample(37, 3)">37 × 3</button>
                            <button onclick="loadExample(48, 4)">48 × 4</button>
                            <button onclick="loadExample(56, 5)">56 × 5</button>
                            <button onclick="loadExample(67, 6)">67 × 6</button>
                        </div>
                        <div class="preset-level">
                            <h4>Level 3: Three Digits × Single Digit</h4>
                            <button onclick="loadExample(123, 2)">123 × 2</button>
                            <button onclick="loadExample(234, 3)">234 × 3</button>
                            <button onclick="loadExample(345, 4)">345 × 4</button>
                            <button onclick="loadExample(456, 5)">456 × 5</button>
                            <button onclick="loadExample(567, 6)">567 × 6</button>
                        </div>
                        <div class="preset-level">
                            <h4>Level 4: Two Digits × Two Digits</h4>
                            <button onclick="loadExample(23, 11)">23 × 11</button>
                            <button onclick="loadExample(34, 12)">34 × 12</button>
                            <button onclick="loadExample(45, 23)">45 × 23</button>
                            <button onclick="loadExample(56, 34)">56 × 34</button>
                            <button onclick="loadExample(67, 45)">67 × 45</button>
                        </div>
                        <div class="preset-level">
                            <h4>Level 5: Three Digits × Two Digits</h4>
                            <button onclick="loadExample(123, 12)">123 × 12</button>
                            <button onclick="loadExample(234, 23)">234 × 23</button>
                            <button onclick="loadExample(345, 34)">345 × 34</button>
                            <button onclick="loadExample(456, 45)">456 × 45</button>
                            <button onclick="loadExample(567, 56)">567 × 56</button>
                        </div>
                    </div>
                </div>
                
                <!-- Daily Workout Mode -->
                <div id="column-workout-mode" class="column-mode-content">
                    <div class="column-workout-setup">
                        <h3>Column Method Daily Workout</h3>
                        <div class="workout-settings">
                            <div class="setting-group">
                                <label>Difficulty Level:</label>
                                <select id="column-difficulty">
                                    <option value="1">Level 1 (2 digits × 1 digit, no carry)</option>
                                    <option value="2">Level 2 (2 digits × 1 digit, with carry)</option>
                                    <option value="3">Level 3 (3 digits × 1 digit)</option>
                                    <option value="4">Level 4 (2 digits × 2 digits)</option>
                                    <option value="5">Level 5 (3 digits × 2 digits)</option>
                                </select>
                            </div>
                            <div class="setting-group">
                                <label>Number of Problems:</label>
                                <select id="column-problem-count">
                                    <option value="5">5 Problems</option>
                                    <option value="10" selected>10 Problems</option>
                                    <option value="15">15 Problems</option>
                                    <option value="20">20 Problems</option>
                                </select>
                            </div>
                            <div class="setting-group">
                                <label>Guided Learning:</label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="guided-toggle" checked>
                                    <label for="guided-toggle">Show step-by-step help</label>
                                </div>
                            </div>
                            <button class="start-btn" onclick="startColumnWorkout()">Start Workout!</button>
                        </div>
                    </div>
                    <div id="column-workout-area" style="display: none;">
                        <!-- Workout problems will appear here -->
                    </div>
                </div>
                
                <!-- Timed Test Mode -->
                <div id="column-test-mode" class="column-mode-content">
                    <div class="column-test-setup">
                        <h3>Timed Test Challenge</h3>
                        <p>Solve column method problems step-by-step. You get points for each correct step!</p>
                        <div class="test-settings">
                            <div class="setting-group">
                                <label>Test Level:</label>
                                <select id="test-level">
                                    <option value="1">Level 1-2 (Single digit multiplier)</option>
                                    <option value="2">Level 3-4 (Mixed difficulty)</option>
                                    <option value="3">Level 5 (Advanced)</option>
                                </select>
                            </div>
                            <div class="setting-group">
                                <label>Time Limit:</label>
                                <select id="test-time">
                                    <option value="300">5 minutes</option>
                                    <option value="600" selected>10 minutes</option>
                                    <option value="900">15 minutes</option>
                                </select>
                            </div>
                            <button class="start-btn" onclick="startColumnTest()">Start Test!</button>
                        </div>
                        <div class="test-scoring">
                            <h4>Scoring System:</h4>
                            <ul>
                                <li>Writing numbers correctly: 1 point</li>
                                <li>Each multiplication step: 2 points</li>
                                <li>Carrying correctly: 1 point</li>
                                <li>Final addition: 2 points</li>
                                <li>Speed bonus: Extra points for quick completion</li>
                            </ul>
                        </div>
                    </div>
                    <div id="column-test-area" style="display: none;">
                        <!-- Test interface will appear here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Times Tables Word Problems Tool -->
        <div id="tt-wordproblems-tool" class="tool-content">
            <div class="wordproblems-container">
                <h2>Times Tables Word Problems</h2>
                <div class="problem-display">
                    <div id="problem-text" class="problem-text"></div>
                    <div class="problem-visual" id="problem-visual"></div>
                </div>
                <div class="answer-section">
                    <div class="expression-input">
                        <label>Write the multiplication:</label>
                        <input type="number" id="word-num1" placeholder="?" min="0" max="99">
                        <span>×</span>
                        <input type="number" id="word-num2" placeholder="?" min="0" max="99">
                        <span>=</span>
                        <input type="number" id="word-answer" placeholder="?" min="0" max="999">
                    </div>
                    <div class="answer-buttons">
                        <button onclick="checkWordProblem()">Check Answer</button>
                        <button onclick="generateWordProblem()" class="new-problem-btn">New Problem</button>
                    </div>
                </div>
                <div id="word-feedback" class="feedback"></div>
                <div class="problem-settings">
                    <label>Difficulty: 
                        <select id="word-difficulty" onchange="generateWordProblem()">
                            <option value="easy">Easy (2-5 times tables)</option>
                            <option value="medium">Medium (2-9 times tables)</option>
                            <option value="hard">Hard (2-12 times tables)</option>
                        </select>
                    </label>
                </div>
            </div>
        </div>

        <!-- Times Table Grid Tool -->
        <div id="tt-grid-tool" class="tool-content">
            <div class="grid-container">
                <h2>Times Table Grid</h2>
                <div class="grid-controls">
                    <label>Table Size: 
                        <select id="grid-size" onchange="generateTimesGrid()">
                            <option value="10">10 × 10</option>
                            <option value="12">12 × 12</option>
                            <option value="15">15 × 15</option>
                        </select>
                    </label>
                    <label>
                        <input type="checkbox" id="show-patterns" onchange="togglePatterns()">
                        Show Patterns
                    </label>
                </div>
                <div id="times-grid" class="times-grid"></div>
                <div class="grid-info">
                    <p>Click any cell to highlight its row and column</p>
                </div>
            </div>
        </div>
        
        <!-- PDF to Interactive Converter Tool -->
        <div id="pdf-converter-tool" class="tool-content">
            <div class="pdf-converter-container">
                <h2>📄 Convert PDF Worksheets to Interactive Exercises</h2>
                
                <div class="upload-section">
                    <div class="upload-area" id="upload-area">
                        <input type="file" id="pdf-input" accept=".pdf" style="display: none;">
                        <div class="upload-prompt">
                            <span class="upload-icon">📁</span>
                            <h3>Drop PDF here or click to browse</h3>
                            <p>Upload a math worksheet PDF to make it interactive</p>
                            <button class="browse-btn" onclick="document.getElementById('pdf-input').click()">
                                Choose PDF File
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="pdf-preview" class="pdf-preview" style="display: none;">
                    <h3>PDF Preview</h3>
                    <canvas id="pdf-canvas"></canvas>
                    <div class="pdf-controls">
                        <button onclick="previousPage()">← Previous</button>
                        <span id="page-info">Page 1 of 1</span>
                        <button onclick="nextPage()">Next →</button>
                    </div>
                </div>
                
                <div id="interactive-workspace" class="interactive-workspace" style="display: none;">
                    <div class="workspace-header">
                        <h3>Interactive Paper Mode</h3>
                        <div class="workspace-toolbar">
                            <button onclick="toggleDrawMode()" class="tool-btn" id="draw-btn">✏️ Draw</button>
                            <button onclick="toggleEraseMode()" class="tool-btn" id="erase-btn">🧹 Erase</button>
                            <button onclick="clearAnnotations()" class="tool-btn">🗑️ Clear</button>
                            <input type="color" id="pen-color" value="#FF0000" style="width: 40px; height: 30px;">
                            <select id="pen-width">
                                <option value="2">Thin</option>
                                <option value="4" selected>Normal</option>
                                <option value="8">Thick</option>
                            </select>
                        </div>
                        <div class="page-navigation">
                            <button onclick="previousPDFPage()" id="prev-page-btn">← Previous Page</button>
                            <span id="page-indicator">Page 1 of 1</span>
                            <button onclick="nextPDFPage()" id="next-page-btn">Next Page →</button>
                        </div>
                    </div>
                    
                    <div id="pdf-workspace" class="pdf-workspace">
                        <div class="pdf-container">
                            <canvas id="pdf-render-canvas"></canvas>
                            <canvas id="annotation-canvas"></canvas>
                            <div id="answer-overlay" class="answer-overlay"></div>
                        </div>
                    </div>
                    
                    <div class="workspace-controls">
                        <button onclick="checkAllAnswers()" class="check-btn">✓ Check Answers</button>
                        <button onclick="saveWork()" class="save-btn">💾 Save Work</button>
                        <button onclick="downloadAnnotated()" class="download-btn">📥 Download</button>
                        <button onclick="finishPaper()" class="finish-btn">Complete Paper</button>
                    </div>
                </div>
                
                <div id="test-summary" class="test-summary" style="display: none;">
                    <h3>Test Complete!</h3>
                    <div id="summary-content"></div>
                    <div class="summary-controls">
                        <button onclick="reviewMistakes()">Review Mistakes</button>
                        <button onclick="downloadResults()">Download Results</button>
                        <button onclick="startNewTest()">New Test</button>
                    </div>
                </div>
                
                <div class="converter-info">
                    <h4>How it works:</h4>
                    <ul>
                        <li>Upload a PDF math worksheet</li>
                        <li>The system detects math problems automatically</li>
                        <li>Fill in answers in the interactive fields</li>
                        <li>Get instant feedback on your answers</li>
                        <li>Download your completed worksheet</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Number Line Tool -->
        <div id="numberline-tool" class="tool-content">
            <div class="numberline-container">
                <h2>Interactive Number Line</h2>
                <div class="numberline-controls">
                    <div class="control-group">
                        <label>Range:</label>
                        <input type="number" id="nl-min" value="-10" onchange="updateNumberLine()">
                        <span>to</span>
                        <input type="number" id="nl-max" value="10" onchange="updateNumberLine()">
                    </div>
                    <div class="control-group">
                        <label>Step:</label>
                        <input type="number" id="nl-step" value="1" min="0.1" step="0.1" onchange="updateNumberLine()">
                    </div>
                    <div class="control-group">
                        <button onclick="zoomNumberLine(2)">Zoom In</button>
                        <button onclick="zoomNumberLine(0.5)">Zoom Out</button>
                        <button onclick="resetNumberLine()">Reset</button>
                    </div>
                </div>
                <div class="numberline-display">
                    <svg id="numberline-svg" width="100%" height="200">
                        <!-- Number line will be drawn here -->
                    </svg>
                </div>
                <div class="numberline-markers">
                    <h3>Mark Points:</h3>
                    <input type="number" id="marker-value" placeholder="Enter value">
                    <button onclick="addMarker()">Add Marker</button>
                    <button onclick="clearMarkers()">Clear All</button>
                    <div id="marker-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Soroban state - 10 columns (no decimals), each with [heaven_bead_active, earth_beads_active_count]
        let sorobanState = Array(10).fill(null).map(() => [false, 0]);
        let currentProblem = null;
        let guidedActive = false;
        let currentStep = 0;
        let guidedSteps = [];
        let expectedState = null;
        let clickArrow = null;
        let currentOperation = null;
        
        // Load stats from localStorage
        let stats = JSON.parse(localStorage.getItem('soroban-stats')) || {
            correct: 0,
            total: 0,
            streak: 0,
            maxStreak: 0,
            lastDate: new Date().toDateString()
        };

        // Reset daily stats if new day
        if (stats.lastDate !== new Date().toDateString()) {
            stats.correct = 0;
            stats.total = 0;
            stats.streak = 0;
            stats.lastDate = new Date().toDateString();
            saveStats();
        }

        function saveStats() {
            localStorage.setItem('soroban-stats', JSON.stringify(stats));
            updateStatsDisplay();
        }

        function updateStatsDisplay() {
            document.getElementById('correct-count').textContent = stats.correct;
            document.getElementById('total-count').textContent = stats.total;
            document.getElementById('accuracy').textContent = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) + '%' : '0%';
            document.getElementById('streak').textContent = stats.streak;
            document.getElementById('progress-fill').style.width = Math.min((stats.correct / 20) * 100, 100) + '%';
        }

        // Operation tutorials
        const tutorials = {
            addition: {
                problem: { num1: 7, num2: 5, operation: '+', answer: 12 },
                steps: [
                    {
                        instruction: "First, set 7 on the soroban. Click the heaven bead (worth 5) in the '1' column.",
                        expectedState: [[false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [true, 0]],
                        targetColumn: 9, targetBead: 'heaven', targetIndex: 0,
                        status: "Setting first number: 7 = 5 + ?"
                    },
                    {
                        instruction: "Now click the 2nd earth bead to add 2 more. This completes 7 (5+2).",
                        expectedState: [[false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [true, 2]],
                        targetColumn: 9, targetBead: 'earth', targetIndex: 1,
                        status: "First number complete: 7"
                    },
                    {
                        instruction: "To add 5 to 7, we need to carry over. Click the earth bead in the '10' column to add 10.",
                        expectedState: [[false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 1], [true, 2]],
                        targetColumn: 8, targetBead: 'earth', targetIndex: 0,
                        status: "Added 10 to tens column. Now we have 17."
                    },
                    {
                        instruction: "Now subtract 5 from ones to balance. Click the heaven bead in '1' column to remove 5.",
                        expectedState: [[false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 1], [false, 2]],
                        targetColumn: 9, targetBead: 'heaven', targetIndex: 0,
                        status: "Perfect! 17 - 5 = 12. We have our answer!"
                    }
                ]
            },
            subtraction: {
                problem: { num1: 12, num2: 5, operation: '-', answer: 7 },
                steps: [
                    {
                        instruction: "Set 12 on the soroban. Click the earth bead in the '10' column.",
                        expectedState: [[false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 1], [false, 0]],
                        targetColumn: 8, targetBead: 'earth', targetIndex: 0,
                        status: "Set 10 in tens column"
                    },
                    {
                        instruction: "Click the 2nd earth bead in '1' column to add 2, making 12.",
                        expectedState: [[false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 1], [false, 2]],
                        targetColumn: 9, targetBead: 'earth', targetIndex: 1,
                        status: "Now we have 12 on the soroban"
                    },
                    {
                        instruction: "To subtract 5, subtract 10 from tens column first. Click the earth bead in '10' column to remove it.",
                        expectedState: [[false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 2]],
                        targetColumn: 8, targetBead: 'earth', targetIndex: 0,
                        status: "Removed 10, now we have 2"
                    },
                    {
                        instruction: "Add 5 to ones column by clicking the heaven bead. This gives us 2 + 5 = 7.",
                        expectedState: [[false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [true, 2]],
                        targetColumn: 9, targetBead: 'heaven', targetIndex: 0,
                        status: "Perfect! 12 - 5 = 7"
                    }
                ]
            },
            multiplication: {
                problem: { num1: 6, num2: 4, operation: '×', answer: 24 },
                steps: [
                    {
                        instruction: "Calculate 6 × 4 using repeated addition. First, set 6 by clicking heaven bead in '1' column.",
                        expectedState: [[false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [true, 0]],
                        targetColumn: 9, targetBead: 'heaven', targetIndex: 0,
                        status: "Set 5, now add 1 more"
                    },
                    {
                        instruction: "Click 1st earth bead to complete 6 (5+1).",
                        expectedState: [[false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [true, 1]],
                        targetColumn: 9, targetBead: 'earth', targetIndex: 0,
                        status: "First 6 is set. Now add 6 three more times."
                    },
                    {
                        instruction: "Add another 6. Since 6+6=12, carry over. Click earth bead in '10' column to add 10.",
                        expectedState: [[false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 1], [true, 1]],
                        targetColumn: 8, targetBead: 'earth', targetIndex: 0,
                        status: "Added 10, now we have 16"
                    },
                    {
                        instruction: "Remove 4 from ones to balance (16-4=12). Remove heaven bead first.",
                        expectedState: [[false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 1], [false, 1]],
                        targetColumn: 9, targetBead: 'heaven', targetIndex: 0,
                        status: "Removed 5, now have 11. Remove 1 more."
                    },
                    {
                        instruction: "Remove 1 more by clicking earth bead to deactivate it. Now we have 12.",
                        expectedState: [[false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 1], [false, 2]],
                        targetColumn: 9, targetBead: 'earth', targetIndex: 1,
                        status: "We have 12. Two more 6's to add!"
                    },
                    {
                        instruction: "Continue adding. We'll skip to the final result. Click heaven bead and 4th earth bead to get 24.",
                        expectedState: [[false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 2], [true, 1]],
                        targetColumn: 9, targetBead: 'heaven', targetIndex: 0,
                        status: "Complete! 6 × 4 = 24"
                    }
                ]
            },
            division: {
                problem: { num1: 24, num2: 6, operation: '÷', answer: 4 },
                steps: [
                    {
                        instruction: "Calculate 24 ÷ 6. First, set 24. Click 2nd earth bead in '10' column.",
                        expectedState: [[false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 2], [false, 0]],
                        targetColumn: 8, targetBead: 'earth', targetIndex: 1,
                        status: "Set 20 in tens column"
                    },
                    {
                        instruction: "Add 4 to ones column by clicking 4th earth bead. This gives us 24.",
                        expectedState: [[false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 2], [false, 4]],
                        targetColumn: 9, targetBead: 'earth', targetIndex: 3,
                        status: "We have 24 on the soroban"
                    },
                    {
                        instruction: "To divide by 6, we'll simplify. Remove all and set the answer 4 directly.",
                        expectedState: [[false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 0], [false, 4]],
                        targetColumn: 9, targetBead: 'earth', targetIndex: 3,
                        status: "24 ÷ 6 = 4"
                    }
                ]
            }
        };

        function initializeSoroban() {
            const soroban = document.getElementById('soroban');
            const columnLabels = ['1000M', '100M', '10M', '1M', '100K', '10K', '1K', '100', '10', '1'];
            
            soroban.innerHTML = '';
            
            for (let i = 0; i < 10; i++) {
                const column = document.createElement('div');
                column.className = 'column';
                column.innerHTML = `
                    <div class="column-label">${columnLabels[i]}</div>
                    <div class="rod"></div>
                    <div class="heaven-section">
                        <div class="bead heaven-bead" onclick="toggleHeavenBead(${i})"></div>
                    </div>
                    <div class="earth-section">
                        ${Array(5).fill(0).map((_, j) => `<div class="bead earth-bead" onclick="toggleEarthBead(${i}, ${j})"></div>`).join('')}
                    </div>
                `;
                soroban.appendChild(column);
            }
            
            updateDisplay();
            updateStatsDisplay();
        }

        function toggleHeavenBead(columnIndex) {
            sorobanState[columnIndex][0] = !sorobanState[columnIndex][0];
            updateBeadVisuals();
            updateDisplay();
            checkGuidedProgress();
        }

        function toggleEarthBead(columnIndex, beadIndex) {
            const currentActive = sorobanState[columnIndex][1];
            if (beadIndex < currentActive) {
                sorobanState[columnIndex][1] = beadIndex;
            } else {
                sorobanState[columnIndex][1] = beadIndex + 1;
            }
            updateBeadVisuals();
            updateDisplay();
            checkGuidedProgress();
        }

        function updateBeadVisuals() {
            const columns = document.querySelectorAll('.column');
            
            columns.forEach((column, columnIndex) => {
                const heavenBead = column.querySelector('.heaven-bead');
                const earthBeads = column.querySelectorAll('.earth-bead');
                
                heavenBead.classList.toggle('active', sorobanState[columnIndex][0]);
                
                earthBeads.forEach((bead, beadIndex) => {
                    bead.classList.toggle('active', beadIndex < sorobanState[columnIndex][1]);
                });
            });
        }

        function calculateValue() {
            let total = 0;
            const multipliers = [1000000000, 100000000, 10000000, 1000000, 100000, 10000, 1000, 100, 10, 1];
            
            for (let i = 0; i < 10; i++) {
                const heavenValue = sorobanState[i][0] ? 5 : 0;
                const earthValue = sorobanState[i][1];
                const columnValue = (heavenValue + earthValue) * multipliers[i];
                total += columnValue;
            }
            
            return Math.round(total);
        }

        function updateDisplay() {
            const value = calculateValue();
            document.getElementById('display').textContent = value.toLocaleString();
            updatePlaceValueVisualization(value);
        }

        function updatePlaceValueVisualization(value) {
            const placeValueDisplay = document.getElementById('place-value-display');
            if (!placeValueDisplay) return;
            
            // Convert to string and pad if necessary
            const valueStr = value.toString().padStart(1, '0');
            const digits = valueStr.split('').reverse();
            
            // Place value names and values
            const placeNames = ['Ones', 'Tens', 'Hundreds', 'Thousands', 'Ten Thousands', 
                                'Hundred Thousands', 'Millions', 'Ten Millions', 
                                'Hundred Millions', 'Billions'];
            const placeValues = [1, 10, 100, 1000, 10000, 100000, 1000000, 10000000, 100000000, 1000000000];
            
            // Clear existing visualization
            placeValueDisplay.innerHTML = '';
            
            // Create place value breakdown
            const breakdown = [];
            digits.forEach((digit, index) => {
                if (digit !== '0' && index < placeNames.length) {
                    const placeValue = parseInt(digit) * placeValues[index];
                    breakdown.push({
                        digit: digit,
                        place: placeNames[index],
                        value: placeValue,
                        position: index
                    });
                }
            });
            
            // Display the breakdown
            if (breakdown.length === 0) {
                placeValueDisplay.innerHTML = '<div class="place-value-zero">0</div>';
            } else {
                // Reverse to show largest place value first
                breakdown.reverse().forEach(item => {
                    const placeCard = document.createElement('div');
                    placeCard.className = 'place-value-card';
                    placeCard.innerHTML = `
                        <div class="place-digit">${item.digit}</div>
                        <div class="place-name">${item.place}</div>
                        <div class="place-value">${item.value.toLocaleString()}</div>
                    `;
                    placeValueDisplay.appendChild(placeCard);
                });
                
                // Add equals sign and total
                if (breakdown.length > 1) {
                    const equals = document.createElement('div');
                    equals.className = 'place-value-equals';
                    equals.textContent = '=';
                    placeValueDisplay.appendChild(equals);
                    
                    const total = document.createElement('div');
                    total.className = 'place-value-total';
                    total.textContent = value.toLocaleString();
                    placeValueDisplay.appendChild(total);
                }
            }
        }

        function clearSoroban() {
            sorobanState = Array(10).fill(null).map(() => [false, 0]);
            updateBeadVisuals();
            updateDisplay();
        }

        function showValue() {
            const value = calculateValue();
            alert(`Current value: ${value.toLocaleString()}`);
        }

        function generateProblem() {
            const operations = ['+', '-', '×'];
            const operation = operations[Math.floor(Math.random() * operations.length)];
            
            let num1, num2, answer;
            
            switch(operation) {
                case '+':
                    num1 = Math.floor(Math.random() * 500) + 1;
                    num2 = Math.floor(Math.random() * 500) + 1;
                    answer = num1 + num2;
                    break;
                case '-':
                    num1 = Math.floor(Math.random() * 500) + 100;
                    num2 = Math.floor(Math.random() * (num1 - 1)) + 1;
                    answer = num1 - num2;
                    break;
                case '×':
                    num1 = Math.floor(Math.random() * 20) + 1;
                    num2 = Math.floor(Math.random() * 20) + 1;
                    answer = num1 * num2;
                    break;
            }
            
            return {
                question: `${num1} ${operation} ${num2}`,
                answer: answer
            };
        }

        function randomProblem() {
            currentProblem = generateProblem();
            document.getElementById('problem').textContent = `Calculate: ${currentProblem.question}`;
            document.getElementById('answer-input').value = '';
            document.getElementById('feedback').style.display = 'none';
            clearSoroban();
        }

        function checkAnswer() {
            if (!currentProblem) {
                alert('Generate a problem first!');
                return;
            }
            
            const userAnswer = parseInt(document.getElementById('answer-input').value);
            const sorobanValue = calculateValue();
            const feedback = document.getElementById('feedback');
            
            stats.total++;
            
            if (userAnswer === currentProblem.answer && sorobanValue === currentProblem.answer) {
                feedback.textContent = `Correct! Well done! Answer: ${currentProblem.answer}`;
                feedback.className = 'feedback correct';
                stats.correct++;
                stats.streak++;
            } else {
                let message = `Incorrect. The correct answer is ${currentProblem.answer}.`;
                if (userAnswer !== currentProblem.answer) {
                    message += ` You entered: ${userAnswer}.`;
                }
                if (sorobanValue !== currentProblem.answer) {
                    message += ` Soroban shows: ${sorobanValue}.`;
                }
                feedback.textContent = message;
                feedback.className = 'feedback incorrect';
                stats.streak = 0;
            }
            
            feedback.style.display = 'block';
            saveStats();
            
            setTimeout(() => {
                randomProblem();
            }, 3000);
        }

        // Guided Practice Functions
        function startGuided(operation) {
            guidedActive = true;
            currentOperation = operation;
            currentStep = 0;
            guidedSteps = tutorials[operation].steps;
            
            document.getElementById('regular-practice').style.display = 'none';
            document.getElementById('guided-practice').classList.add('active');
            document.getElementById('panel-title').textContent = 'Guided Practice';
            
            const problem = tutorials[operation].problem;
            document.getElementById('guided-title').textContent = operation.charAt(0).toUpperCase() + operation.slice(1) + ' Tutorial';
            document.getElementById('guided-problem-display').textContent = `${problem.num1} ${problem.operation} ${problem.num2} = ?`;
            
            clearSoroban();
            updateGuidedDisplay();
        }

        function exitGuided() {
            guidedActive = false;
            clearHighlights();
            clearSoroban();
            
            document.getElementById('regular-practice').style.display = 'block';
            document.getElementById('guided-practice').classList.remove('active');
            document.getElementById('panel-title').textContent = 'Practice';
            
            document.getElementById('retry-btn').style.display = 'none';
            document.getElementById('new-btn').style.display = 'none';
        }

        function nextStep() {
            if (currentStep === -1) {
                // Start the first step
                currentStep = 0;
                showGuidedStep(0);
            } else if (currentStep < guidedSteps.length) {
                if (isStepComplete() || currentStep === 0) {
                    currentStep++;
                    if (currentStep < guidedSteps.length) {
                        showGuidedStep(currentStep);
                    } else {
                        showComplete();
                    }
                } else {
                    // Show what still needs to be done
                    highlightAction();
                    document.getElementById('guided-status').innerHTML = 
                        `❌ Please complete this step first: ${guidedSteps[currentStep].status || ''}`;
                }
            }
        }

        function prevStep() {
            if (currentStep > 0) {
                currentStep--;
                showGuidedStep(currentStep);
            }
        }

        function showGuidedStep(stepIndex) {
            const step = guidedSteps[stepIndex];
            document.getElementById('guided-instruction-text').innerHTML = step.instruction;
            document.getElementById('guided-status').innerHTML = step.status || '';
            document.getElementById('step-counter').textContent = `Step ${stepIndex + 1} / ${guidedSteps.length}`;
            
            expectedState = step.expectedState;
            highlightAction();
            
            document.getElementById('prev-btn').disabled = stepIndex === 0;
            document.getElementById('next-btn').disabled = false;
            
            if (stepIndex === guidedSteps.length - 1) {
                document.getElementById('next-btn').textContent = 'Complete!';
            } else {
                document.getElementById('next-btn').textContent = 'Next →';
            }
        }

        function updateGuidedDisplay() {
            currentStep = -1; // Reset to before first step
            document.getElementById('guided-instruction-text').innerHTML = "Click 'Start' to begin!";
            document.getElementById('guided-status').innerHTML = "Follow the arrows and instructions.";
            document.getElementById('step-counter').textContent = 'Ready';
            document.getElementById('next-btn').textContent = 'Start →';
            document.getElementById('prev-btn').disabled = true;
            document.getElementById('next-btn').disabled = false;
        }

        function highlightAction() {
            clearHighlights();
            
            if (currentStep < guidedSteps.length) {
                const step = guidedSteps[currentStep];
                const columnIndex = step.targetColumn;
                const beadType = step.targetBead;
                const beadIndex = step.targetIndex;
                
                const columns = document.querySelectorAll('.column');
                if (columns[columnIndex]) {
                    let targetBead;
                    if (beadType === 'heaven') {
                        targetBead = columns[columnIndex].querySelector('.heaven-bead');
                    } else {
                        const earthBeads = columns[columnIndex].querySelectorAll('.earth-bead');
                        targetBead = earthBeads[beadIndex];
                    }
                    
                    if (targetBead) {
                        targetBead.classList.add('highlight-bead');
                        addArrow(targetBead);
                    }
                }
            }
        }

        function addArrow(element) {
            removeArrow();
            clickArrow = document.createElement('div');
            clickArrow.className = 'click-arrow';
            clickArrow.innerHTML = '👆';
            
            const rect = element.getBoundingClientRect();
            const sorobanRect = document.getElementById('soroban').getBoundingClientRect();
            
            clickArrow.style.position = 'absolute';
            clickArrow.style.left = (rect.left - sorobanRect.left + rect.width/2 - 15) + 'px';
            clickArrow.style.top = (rect.top - sorobanRect.top - 30) + 'px';
            
            document.getElementById('soroban').appendChild(clickArrow);
        }

        function removeArrow() {
            if (clickArrow) {
                clickArrow.remove();
                clickArrow = null;
            }
        }

        function clearHighlights() {
            const highlighted = document.querySelectorAll('.highlight-bead');
            highlighted.forEach(bead => bead.classList.remove('highlight-bead'));
            removeArrow();
        }

        function isStepComplete() {
            if (!expectedState || currentStep >= guidedSteps.length) return true;
            
            let matches = true;
            for (let i = 0; i < sorobanState.length; i++) {
                if (sorobanState[i][0] !== expectedState[i][0] || 
                    sorobanState[i][1] !== expectedState[i][1]) {
                    matches = false;
                    break;
                }
            }
            
            // Debug log
            if (guidedActive) {
                console.log('Step', currentStep, 'complete:', matches);
                console.log('Current state:', JSON.stringify(sorobanState));
                console.log('Expected state:', JSON.stringify(expectedState));
            }
            
            return matches;
        }

        function showComplete() {
            const problem = tutorials[currentOperation].problem;
            document.getElementById('guided-instruction-text').innerHTML = 
                `🎉 <strong>Congratulations!</strong> You completed ${problem.num1} ${problem.operation} ${problem.num2} = ${problem.answer}`;
            document.getElementById('guided-status').innerHTML = 
                "Great job! Try the options below.";
            document.getElementById('step-counter').textContent = 'Complete!';
            document.getElementById('next-btn').style.display = 'none';
            clearHighlights();
            
            document.getElementById('retry-btn').style.display = 'inline-block';
            document.getElementById('new-btn').style.display = 'inline-block';
        }

        function checkGuidedProgress() {
            if (guidedActive && currentStep >= 0 && currentStep < guidedSteps.length && expectedState) {
                if (isStepComplete()) {
                    const step = guidedSteps[currentStep];
                    document.getElementById('guided-status').innerHTML = 
                        `✅ <span class="step-complete">Step completed!</span> ${step.status || ''}`;
                    clearHighlights();
                    document.getElementById('next-btn').disabled = false;
                    document.getElementById('next-btn').textContent = 'Next Step →';
                } else {
                    document.getElementById('next-btn').disabled = true;
                    document.getElementById('next-btn').textContent = 'Complete Step First';
                }
            }
        }

        function retryProblem() {
            currentStep = 0;
            clearSoroban();
            clearHighlights();
            updateGuidedDisplay();
            document.getElementById('retry-btn').style.display = 'none';
            document.getElementById('new-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'inline-block';
        }

        function newGuidedProblem() {
            const operations = Object.keys(tutorials);
            let newOp;
            if (Math.random() > 0.5) {
                newOp = currentOperation;
            } else {
                do {
                    newOp = operations[Math.floor(Math.random() * operations.length)];
                } while (newOp === currentOperation && operations.length > 1);
            }
            startGuided(newOp);
        }

        // Place Value Game Functions
        let pvScore = 0;
        let pvStreak = 0;
        let pvCurrentNumber = 0;
        let pvCurrentMode = 'breakdown';
        let wordsScore = 0;
        let wordsStreak = 0;
        let reverseScore = 0;
        let reverseStreak = 0;
        let reverseCurrentNumber = 0;

        function switchPVMode(mode) {
            document.querySelectorAll('.pv-mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.pv-mode').forEach(m => m.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`pv-${mode}-mode`).classList.add('active');
            pvCurrentMode = mode;
            
            if (mode === 'breakdown') {
                newPVProblem();
            } else if (mode === 'words') {
                newWordsProblem();
            } else if (mode === 'reverse') {
                newReverseProblem();
            }
        }

        function newPVProblem() {
            const difficulty = document.getElementById('pv-difficulty').value;
            let min, max, includeDecimals = false;
            
            switch(difficulty) {
                case 'easy':
                    min = 1; max = 999;
                    break;
                case 'medium':
                    min = 1000; max = 99999;
                    break;
                case 'hard':
                    min = 100000; max = 9999999;
                    break;
                case 'expert':
                    min = 1; max = 9999;
                    includeDecimals = true;
                    break;
            }
            
            if (includeDecimals) {
                pvCurrentNumber = (Math.random() * (max - min) + min).toFixed(2);
            } else {
                pvCurrentNumber = Math.floor(Math.random() * (max - min + 1)) + min;
            }
            
            document.getElementById('pv-number').textContent = pvCurrentNumber.toLocaleString();
            generatePVInputs();
            document.getElementById('pv-feedback').className = 'pv-feedback';
        }

        function generatePVInputs() {
            const grid = document.getElementById('pv-input-grid');
            grid.innerHTML = '';
            
            const numStr = pvCurrentNumber.toString();
            const parts = numStr.split('.');
            const wholePart = parts[0];
            const decimalPart = parts[1] || '';
            
            const placeNames = ['Ones', 'Tens', 'Hundreds', 'Thousands', 'Ten Thousands', 
                               'Hundred Thousands', 'Millions', 'Ten Millions'];
            
            // Add whole number places
            const digits = wholePart.split('').reverse();
            const activePositions = [];
            
            digits.forEach((digit, index) => {
                if (index < placeNames.length) {
                    activePositions.push({
                        name: placeNames[index],
                        value: digit,
                        position: index
                    });
                }
            });
            
            // Reverse to show largest first
            activePositions.reverse().forEach(pos => {
                const item = document.createElement('div');
                item.className = 'pv-input-item';
                item.innerHTML = `
                    <div class="pv-input-label">${pos.name}</div>
                    <input type="number" class="pv-input-field" 
                           data-place="${pos.name}" 
                           data-correct="${pos.value}"
                           min="0" max="9">
                `;
                grid.appendChild(item);
            });
            
            // Add decimal places if present
            if (decimalPart) {
                const decimalNames = ['Tenths', 'Hundredths', 'Thousandths'];
                decimalPart.split('').forEach((digit, index) => {
                    if (index < decimalNames.length) {
                        const item = document.createElement('div');
                        item.className = 'pv-input-item';
                        item.innerHTML = `
                            <div class="pv-input-label">${decimalNames[index]}</div>
                            <input type="number" class="pv-input-field" 
                                   data-place="${decimalNames[index]}" 
                                   data-correct="${digit}"
                                   min="0" max="9">
                        `;
                        grid.appendChild(item);
                    }
                });
            }
        }

        function checkPVAnswer() {
            const inputs = document.querySelectorAll('.pv-input-field');
            let allCorrect = true;
            
            inputs.forEach(input => {
                const userAnswer = input.value;
                const correctAnswer = input.dataset.correct;
                
                if (userAnswer === correctAnswer) {
                    input.classList.remove('incorrect');
                    input.classList.add('correct');
                } else {
                    input.classList.remove('correct');
                    input.classList.add('incorrect');
                    allCorrect = false;
                }
            });
            
            const feedback = document.getElementById('pv-feedback');
            if (allCorrect) {
                pvScore++;
                pvStreak++;
                feedback.textContent = '🎉 Excellent! All place values are correct!';
                feedback.className = 'pv-feedback correct show';
                document.getElementById('pv-score').textContent = pvScore;
                document.getElementById('pv-streak').textContent = pvStreak;
                
                setTimeout(() => {
                    newPVProblem();
                }, 2000);
            } else {
                pvStreak = 0;
                feedback.textContent = '❌ Some values are incorrect. Try again!';
                feedback.className = 'pv-feedback incorrect show';
                document.getElementById('pv-streak').textContent = pvStreak;
            }
        }

        function showPVHint() {
            const inputs = document.querySelectorAll('.pv-input-field');
            const emptyInputs = Array.from(inputs).filter(input => !input.value);
            
            if (emptyInputs.length > 0) {
                const randomInput = emptyInputs[Math.floor(Math.random() * emptyInputs.length)];
                randomInput.value = randomInput.dataset.correct;
                randomInput.classList.add('correct');
            }
        }

        // Number to Words Functions
        function numberToWords(num) {
            if (num === 0) return 'zero';
            
            const ones = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
            const teens = ['ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 
                          'sixteen', 'seventeen', 'eighteen', 'nineteen'];
            const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
            
            function convertHundreds(n) {
                let result = '';
                
                if (n >= 100) {
                    result += ones[Math.floor(n / 100)] + ' hundred';
                    n %= 100;
                    if (n > 0) result += ' ';
                }
                
                if (n >= 20) {
                    result += tens[Math.floor(n / 10)];
                    n %= 10;
                    if (n > 0) result += '-' + ones[n];
                } else if (n >= 10) {
                    result += teens[n - 10];
                } else if (n > 0) {
                    result += ones[n];
                }
                
                return result;
            }
            
            if (num < 1000) {
                return convertHundreds(num);
            } else if (num < 1000000) {
                const thousands = Math.floor(num / 1000);
                const remainder = num % 1000;
                let result = convertHundreds(thousands) + ' thousand';
                if (remainder > 0) {
                    result += ' ' + convertHundreds(remainder);
                }
                return result;
            } else {
                const millions = Math.floor(num / 1000000);
                const remainder = num % 1000000;
                let result = convertHundreds(millions) + ' million';
                if (remainder > 0) {
                    result += ' ' + numberToWords(remainder);
                }
                return result;
            }
        }

        function newWordsProblem() {
            const difficulty = document.getElementById('pv-words-difficulty').value;
            let min, max;
            
            switch(difficulty) {
                case 'tens':
                    min = 1; max = 99;
                    break;
                case 'hundreds':
                    min = 100; max = 999;
                    break;
                case 'thousands':
                    min = 1000; max = 9999;
                    break;
                case 'millions':
                    min = 10000; max = 999999;
                    break;
            }
            
            pvCurrentNumber = Math.floor(Math.random() * (max - min + 1)) + min;
            document.getElementById('pv-words-number').textContent = pvCurrentNumber.toLocaleString();
            document.getElementById('pv-words-answer').value = '';
            document.getElementById('pv-words-feedback').className = 'pv-feedback';
        }

        function checkWordsAnswer() {
            const userAnswer = document.getElementById('pv-words-answer').value.trim().toLowerCase();
            const correctAnswer = numberToWords(pvCurrentNumber);
            const feedback = document.getElementById('pv-words-feedback');
            
            // Normalize both answers for comparison
            // Remove hyphens, extra spaces, and the word "and"
            const normalizeAnswer = (str) => {
                return str
                    .replace(/-/g, ' ')  // Replace hyphens with spaces
                    .replace(/\band\b/g, '')  // Remove the word "and"
                    .replace(/\s+/g, ' ')  // Replace multiple spaces with single space
                    .trim();
            };
            
            const normalizedUser = normalizeAnswer(userAnswer);
            const normalizedCorrect = normalizeAnswer(correctAnswer);
            
            if (normalizedUser === normalizedCorrect) {
                wordsScore++;
                wordsStreak++;
                feedback.textContent = '🎉 Perfect! That\'s exactly right!';
                feedback.className = 'pv-feedback correct show';
                document.getElementById('pv-words-score').textContent = wordsScore;
                document.getElementById('pv-words-streak').textContent = wordsStreak;
                
                setTimeout(() => {
                    newWordsProblem();
                }, 2000);
            } else {
                wordsStreak = 0;
                feedback.textContent = `❌ Not quite. The correct answer is: "${correctAnswer}" (but "${userAnswer}" is also acceptable if spelled correctly)`;
                feedback.className = 'pv-feedback incorrect show';
                document.getElementById('pv-words-streak').textContent = wordsStreak;
            }
        }

        function showWordsHint() {
            const correctAnswer = numberToWords(pvCurrentNumber);
            document.getElementById('pv-words-answer').value = correctAnswer;
        }

        // Words to Number Functions (Reverse Mode)
        function newReverseProblem() {
            const difficulty = document.getElementById('pv-reverse-difficulty').value;
            let min, max;
            
            switch(difficulty) {
                case 'tens':
                    min = 1; max = 99;
                    break;
                case 'hundreds':
                    min = 100; max = 999;
                    break;
                case 'thousands':
                    min = 1000; max = 9999;
                    break;
                case 'millions':
                    min = 10000; max = 999999;
                    break;
            }
            
            reverseCurrentNumber = Math.floor(Math.random() * (max - min + 1)) + min;
            const wordsDisplay = numberToWords(reverseCurrentNumber);
            document.getElementById('pv-reverse-words').textContent = wordsDisplay;
            document.getElementById('pv-reverse-answer').value = '';
            document.getElementById('pv-reverse-feedback').className = 'pv-feedback';
        }

        function checkReverseAnswer() {
            // Remove commas and spaces from user input before parsing
            const userInput = document.getElementById('pv-reverse-answer').value
                .replace(/,/g, '')  // Remove commas
                .replace(/\s/g, '')  // Remove spaces
                .trim();
            
            const userAnswer = parseInt(userInput);
            const feedback = document.getElementById('pv-reverse-feedback');
            
            // Check if the input is a valid number
            if (isNaN(userAnswer)) {
                feedback.textContent = '❌ Please enter a valid number';
                feedback.className = 'pv-feedback incorrect show';
                return;
            }
            
            if (userAnswer === reverseCurrentNumber) {
                reverseScore++;
                reverseStreak++;
                feedback.textContent = '🎉 Excellent! That\'s the correct number!';
                feedback.className = 'pv-feedback correct show';
                document.getElementById('pv-reverse-score').textContent = reverseScore;
                document.getElementById('pv-reverse-streak').textContent = reverseStreak;
                
                setTimeout(() => {
                    newReverseProblem();
                }, 2000);
            } else {
                reverseStreak = 0;
                feedback.textContent = `❌ Not quite. The correct answer is: ${reverseCurrentNumber.toLocaleString()}`;
                feedback.className = 'pv-feedback incorrect show';
                document.getElementById('pv-reverse-streak').textContent = reverseStreak;
            }
        }

        function showReverseHint() {
            document.getElementById('pv-reverse-answer').value = reverseCurrentNumber;
        }

        // Math Categories Functions
        let fibSequence = [1, 1];

        function exploreFibonacci() {
            document.getElementById('fibonacci-explorer').style.display = 'block';
            fibSequence = [1, 1];
            updateFibDisplay();
        }

        function generateMoreFib() {
            const maxTerms = 15;
            while (fibSequence.length < maxTerms) {
                const nextNum = fibSequence[fibSequence.length - 1] + fibSequence[fibSequence.length - 2];
                fibSequence.push(nextNum);
            }
            updateFibDisplay();
        }

        function updateFibDisplay() {
            const display = document.getElementById('fib-sequence');
            display.textContent = fibSequence.join(', ');
            if (fibSequence.length >= 15) {
                display.textContent += '...';
            }
        }


        // Carousel Navigation
        function scrollCarousel(direction) {
            const wrapper = document.querySelector('.tools-grid-wrapper');
            const scrollAmount = 300;
            
            if (direction === 'prev') {
                wrapper.scrollLeft -= scrollAmount;
            } else {
                wrapper.scrollLeft += scrollAmount;
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Navigation is always visible now
            
            initializeSoroban();
            initializeBalance();
            initializeNumberLine();
            initializeTimesTable();
            initializeColumnMethod();
            
            // iPad and touch optimizations
            initializeTouchSupport();
        });
        
        // Touch support for iPad and mobile devices
        function initializeTouchSupport() {
            // Detect if device has touch capability
            const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            
            if (hasTouch) {
                // Add class for touch-specific styles
                document.body.classList.add('touch-device');
                
                // Optimize bead interactions for touch
                const beads = document.querySelectorAll('.bead');
                beads.forEach(bead => {
                    bead.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        this.classList.toggle('active');
                        updateDisplay();
                    }, {passive: false});
                });
                
                // Prevent double-tap zoom on interactive elements
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(e) {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        e.preventDefault();
                    }
                    lastTouchEnd = now;
                }, {passive: false});
                
                // Improve scrolling performance
                const scrollableElements = document.querySelectorAll('.tool-content');
                scrollableElements.forEach(el => {
                    el.style.webkitOverflowScrolling = 'touch';
                });
            }
        }
        
        // Number Line Tool
        let numberLineMarkers = [];
        
        function initializeNumberLine() {
            updateNumberLine();
        }
        
        function updateNumberLine() {
            const min = parseFloat(document.getElementById('nl-min').value);
            const max = parseFloat(document.getElementById('nl-max').value);
            const step = parseFloat(document.getElementById('nl-step').value);
            
            if (min >= max) {
                alert('Minimum must be less than maximum');
                return;
            }
            
            drawNumberLine(min, max, step);
        }
        
        function drawNumberLine(min, max, step) {
            const svg = document.getElementById('numberline-svg');
            const width = svg.clientWidth || 800;
            const height = 200;
            const padding = 50;
            
            svg.innerHTML = '';
            
            // Create main line
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', padding);
            line.setAttribute('y1', height/2);
            line.setAttribute('x2', width - padding);
            line.setAttribute('y2', height/2);
            line.setAttribute('stroke', '#4ECDC4');
            line.setAttribute('stroke-width', '3');
            svg.appendChild(line);
            
            // Add arrow heads
            const arrowLeft = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            arrowLeft.setAttribute('points', `${padding},${height/2} ${padding+10},${height/2-5} ${padding+10},${height/2+5}`);
            arrowLeft.setAttribute('fill', '#4ECDC4');
            svg.appendChild(arrowLeft);
            
            const arrowRight = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            arrowRight.setAttribute('points', `${width-padding},${height/2} ${width-padding-10},${height/2-5} ${width-padding-10},${height/2+5}`);
            arrowRight.setAttribute('fill', '#4ECDC4');
            svg.appendChild(arrowRight);
            
            // Calculate scale
            const range = max - min;
            const scale = (width - 2*padding) / range;
            
            // Draw tick marks and labels
            for (let value = min; value <= max; value += step) {
                const x = padding + (value - min) * scale;
                
                // Tick mark
                const tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                tick.setAttribute('x1', x);
                tick.setAttribute('y1', height/2 - 10);
                tick.setAttribute('x2', x);
                tick.setAttribute('y2', height/2 + 10);
                tick.setAttribute('stroke', '#4ECDC4');
                tick.setAttribute('stroke-width', value === 0 ? '3' : '2');
                svg.appendChild(tick);
                
                // Label
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x);
                text.setAttribute('y', height/2 + 30);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', 'white');
                text.setAttribute('font-size', '14');
                text.textContent = value % 1 === 0 ? value : value.toFixed(1);
                svg.appendChild(text);
            }
            
            // Draw markers
            numberLineMarkers.forEach(marker => {
                if (marker >= min && marker <= max) {
                    const x = padding + (marker - min) * scale;
                    
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', x);
                    circle.setAttribute('cy', height/2);
                    circle.setAttribute('r', '8');
                    circle.setAttribute('fill', '#FF6B6B');
                    circle.setAttribute('stroke', 'white');
                    circle.setAttribute('stroke-width', '2');
                    svg.appendChild(circle);
                    
                    const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    label.setAttribute('x', x);
                    label.setAttribute('y', height/2 - 15);
                    label.setAttribute('text-anchor', 'middle');
                    label.setAttribute('fill', '#FF6B6B');
                    label.setAttribute('font-size', '12');
                    label.setAttribute('font-weight', 'bold');
                    label.textContent = marker;
                    svg.appendChild(label);
                }
            });
        }
        
        function zoomNumberLine(factor) {
            const minInput = document.getElementById('nl-min');
            const maxInput = document.getElementById('nl-max');
            const min = parseFloat(minInput.value);
            const max = parseFloat(maxInput.value);
            const center = (min + max) / 2;
            const range = (max - min) / factor;
            
            minInput.value = center - range/2;
            maxInput.value = center + range/2;
            
            updateNumberLine();
        }
        
        function resetNumberLine() {
            document.getElementById('nl-min').value = -10;
            document.getElementById('nl-max').value = 10;
            document.getElementById('nl-step').value = 1;
            numberLineMarkers = [];
            updateMarkerList();
            updateNumberLine();
        }
        
        function addMarker() {
            const input = document.getElementById('marker-value');
            const value = parseFloat(input.value);
            
            if (!isNaN(value)) {
                numberLineMarkers.push(value);
                updateMarkerList();
                updateNumberLine();
                input.value = '';
            }
        }
        
        function clearMarkers() {
            numberLineMarkers = [];
            updateMarkerList();
            updateNumberLine();
        }
        
        function removeMarker(index) {
            numberLineMarkers.splice(index, 1);
            updateMarkerList();
            updateNumberLine();
        }
        
        function updateMarkerList() {
            const list = document.getElementById('marker-list');
            list.innerHTML = '';
            
            numberLineMarkers.forEach((marker, index) => {
                const item = document.createElement('div');
                item.className = 'marker-item';
                item.innerHTML = `
                    <span>${marker}</span>
                    <button onclick="removeMarker(${index})">×</button>
                `;
                list.appendChild(item);
            });
        }
        
        // Times Tables Grid Tool
        let ttLockedCell = null;
        
        // Daily Workout Variables
        let workoutProblems = [];
        let currentProblemIndex = 0;
        let workoutScore = 0;
        let workoutTimer = null;
        let workoutStartTime = null;
        
        // Speed Challenge Variables
        let speedTimer = null;
        let speedScore = 0;
        let speedStreak = 0;
        let speedLevel = 'easy';
        let speedTimeLeft = 30;
        let speedCurrentProblem = null;
        
        // Circle Pattern Variables
        let circleAnimationFrame = null;
        let circleAnimating = false;
        let circleStep = 0;
        
        // Pattern Explorer Variables
        let patternTable = 2;
        let patternType = 'skip';
        let workoutAnswers = [];
        
        function switchTTMode(mode) {
            document.querySelectorAll('.tt-mode').forEach(m => m.classList.remove('active'));
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            
            if (mode === 'grid') {
                document.getElementById('tt-grid-mode').classList.add('active');
                document.querySelector('[onclick*="grid"]').classList.add('active');
            } else {
                document.getElementById('tt-workout-mode').classList.add('active');
                document.querySelector('[onclick*="workout"]').classList.add('active');
            }
        }
        
        function startWorkout() {
            // Get selected tables
            const selectedTables = [];
            document.querySelectorAll('.tables-checkboxes input:checked').forEach(cb => {
                selectedTables.push(parseInt(cb.value));
            });
            
            if (selectedTables.length === 0) {
                alert('Please select at least one times table!');
                return;
            }
            
            // Generate problems
            const questionCount = parseInt(document.getElementById('workout-count').value);
            workoutProblems = [];
            const usedPairs = new Set();
            
            while (workoutProblems.length < questionCount) {
                const table = selectedTables[Math.floor(Math.random() * selectedTables.length)];
                const multiplier = Math.floor(Math.random() * 12) + 1;
                const pair = `${table}x${multiplier}`;
                
                if (!usedPairs.has(pair)) {
                    usedPairs.add(pair);
                    workoutProblems.push({
                        num1: table,
                        num2: multiplier,
                        answer: table * multiplier,
                        userAnswer: null,
                        time: 0
                    });
                }
            }
            
            // Shuffle problems
            workoutProblems.sort(() => Math.random() - 0.5);
            
            // Reset variables
            currentProblemIndex = 0;
            workoutScore = 0;
            workoutAnswers = [];
            workoutStartTime = Date.now();
            
            // Setup timer if needed
            const timerDuration = parseInt(document.getElementById('workout-timer').value);
            if (timerDuration > 0) {
                let timeLeft = timerDuration;
                workoutTimer = setInterval(() => {
                    timeLeft--;
                    updateWorkoutTime(timerDuration - timeLeft);
                    if (timeLeft <= 0) {
                        endWorkout();
                    }
                }, 1000);
            } else {
                workoutTimer = setInterval(() => {
                    updateWorkoutTime(Math.floor((Date.now() - workoutStartTime) / 1000));
                }, 1000);
            }
            
            // Show workout area
            document.querySelector('.workout-setup').style.display = 'none';
            document.getElementById('workout-area').style.display = 'block';
            document.getElementById('workout-results').style.display = 'none';
            
            // Display first problem
            displayWorkoutProblem();
        }
        
        function displayWorkoutProblem() {
            if (currentProblemIndex >= workoutProblems.length) {
                endWorkout();
                return;
            }
            
            const problem = workoutProblems[currentProblemIndex];
            document.getElementById('problem-text').textContent = `${problem.num1} × ${problem.num2} = ?`;
            document.getElementById('current-question').textContent = currentProblemIndex + 1;
            document.getElementById('total-questions').textContent = workoutProblems.length;
            document.getElementById('workout-answer').value = '';
            document.getElementById('workout-answer').focus();
            document.getElementById('workout-feedback').textContent = '';
            
            // Update progress bar
            const progress = (currentProblemIndex / workoutProblems.length) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
        }
        
        function checkWorkoutAnswer(event) {
            if (event.key === 'Enter') {
                submitAnswer();
            }
        }
        
        function submitAnswer() {
            const userAnswer = parseInt(document.getElementById('workout-answer').value);
            const problem = workoutProblems[currentProblemIndex];
            
            if (isNaN(userAnswer)) {
                document.getElementById('workout-answer').focus();
                return;
            }
            
            problem.userAnswer = userAnswer;
            problem.time = Date.now() - workoutStartTime;
            
            const feedback = document.getElementById('workout-feedback');
            if (userAnswer === problem.answer) {
                workoutScore++;
                feedback.textContent = '✓ Correct!';
                feedback.className = 'workout-feedback correct';
            } else {
                feedback.textContent = `✗ Answer: ${problem.answer}`;
                feedback.className = 'workout-feedback incorrect';
            }
            
            document.getElementById('workout-score').textContent = workoutScore;
            
            // Disable input and button during feedback
            document.getElementById('workout-answer').disabled = true;
            document.querySelector('.submit-answer-btn').disabled = true;
            
            // Move to next problem after short delay
            setTimeout(() => {
                document.getElementById('workout-answer').disabled = false;
                document.querySelector('.submit-answer-btn').disabled = false;
                currentProblemIndex++;
                displayWorkoutProblem();
            }, 1500);
        }
        
        function updateWorkoutTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById('workout-time').textContent = 
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function endWorkout() {
            clearInterval(workoutTimer);
            
            // Show results
            document.getElementById('workout-area').style.display = 'none';
            document.getElementById('workout-results').style.display = 'block';
            
            // Calculate stats
            const totalAnswered = workoutProblems.filter(p => p.userAnswer !== null).length;
            const finalScore = workoutScore;
            const accuracy = totalAnswered > 0 ? Math.round((workoutScore / totalAnswered) * 100) : 0;
            
            // Display big score
            document.getElementById('final-score-big').textContent = finalScore;
            document.getElementById('final-total-big').textContent = workoutProblems.length;
            
            // Determine grade
            let grade = '';
            if (accuracy >= 95) grade = 'Outstanding! 🌟';
            else if (accuracy >= 85) grade = 'Excellent! 🎉';
            else if (accuracy >= 75) grade = 'Good Job! 👍';
            else if (accuracy >= 60) grade = 'Keep Practicing! 💪';
            else grade = 'Try Again! 📚';
            document.getElementById('score-grade').textContent = grade;
            
            // Display accuracy
            document.getElementById('final-accuracy').textContent = accuracy + '%';
            
            // Display time
            const totalTime = Math.floor((Date.now() - workoutStartTime) / 1000);
            const mins = Math.floor(totalTime / 60);
            const secs = totalTime % 60;
            document.getElementById('final-time').textContent = 
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            
            // Calculate average speed
            const avgSpeed = totalAnswered > 0 ? Math.round(totalTime / totalAnswered) : 0;
            document.getElementById('avg-speed').textContent = `${avgSpeed}s/question`;
            
            // Show detailed results
            const details = document.getElementById('results-details');
            details.innerHTML = '<h4 style="color: #4ECDC4; margin-top: 20px;">Problem Review:</h4>';
            details.innerHTML += '<div style="max-height: 300px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 10px;">';
            
            workoutProblems.forEach((p, i) => {
                if (p.userAnswer !== null) {
                    const correct = p.userAnswer === p.answer;
                    details.innerHTML += `
                        <div style="padding: 8px; margin: 5px 0; background: ${correct ? 'rgba(76, 175, 80, 0.2)' : 'rgba(244, 67, 54, 0.2)'}; border-radius: 5px; border-left: 4px solid ${correct ? '#4CAF50' : '#F44336'};">
                            <span style="color: #999; margin-right: 10px;">#${i+1}</span>
                            <span style="color: white; font-weight: bold;">${p.num1} × ${p.num2} = ${p.answer}</span>
                            ${correct ? '<span style="color: #4CAF50; margin-left: 10px;">✓</span>' : `<span style="color: #F44336; margin-left: 10px;">Your answer: ${p.userAnswer}</span>`}
                        </div>
                    `;
                }
            });
            details.innerHTML += '</div>';
            
            // Start 30-second review timer
            let reviewTime = 30;
            const reviewInterval = setInterval(() => {
                reviewTime--;
                document.getElementById('review-countdown').textContent = reviewTime;
                
                if (reviewTime <= 0) {
                    clearInterval(reviewInterval);
                    document.getElementById('review-timer').style.display = 'none';
                    document.getElementById('new-workout-btn').style.display = 'block';
                }
            }, 1000);
        }
        
        function resetWorkout() {
            document.querySelector('.workout-setup').style.display = 'block';
            document.getElementById('workout-area').style.display = 'none';
            document.getElementById('workout-results').style.display = 'none';
        }
        
        // Speed Challenge Functions
        function startSpeedChallenge(level) {
            speedLevel = level;
            speedScore = 0;
            speedStreak = 0;
            
            // Set time based on level
            switch(level) {
                case 'easy': speedTimeLeft = 30; break;
                case 'medium': speedTimeLeft = 60; break;
                case 'hard': speedTimeLeft = 90; break;
                case 'extreme': speedTimeLeft = 120; break;
            }
            
            // Hide levels, show game
            document.querySelector('.speed-levels').style.display = 'none';
            document.getElementById('speed-game').style.display = 'block';
            
            // Initialize display
            document.getElementById('speed-timer').textContent = speedTimeLeft;
            document.getElementById('speed-score').textContent = '0';
            document.getElementById('speed-streak').textContent = '0';
            
            // Generate first problem
            generateSpeedProblem();
            
            // Start timer
            speedTimer = setInterval(() => {
                speedTimeLeft--;
                document.getElementById('speed-timer').textContent = speedTimeLeft;
                
                if (speedTimeLeft <= 0) {
                    endSpeedChallenge();
                }
            }, 1000);
            
            // Focus answer input
            document.getElementById('speed-answer').focus();
            
            // Add enter key listener
            document.getElementById('speed-answer').onkeyup = (e) => {
                if (e.key === 'Enter') {
                    checkSpeedAnswer();
                }
            };
        }
        
        function generateSpeedProblem() {
            let num1, num2;
            
            switch(speedLevel) {
                case 'easy':
                    num1 = Math.floor(Math.random() * 4) + 2; // 2-5
                    num2 = Math.floor(Math.random() * 10) + 1; // 1-10
                    break;
                case 'medium':
                    num1 = Math.floor(Math.random() * 9) + 2; // 2-10
                    num2 = Math.floor(Math.random() * 10) + 1; // 1-10
                    break;
                case 'hard':
                    num1 = Math.floor(Math.random() * 11) + 2; // 2-12
                    num2 = Math.floor(Math.random() * 12) + 1; // 1-12
                    break;
                case 'extreme':
                    num1 = Math.floor(Math.random() * 8) + 13; // 13-20
                    num2 = Math.floor(Math.random() * 20) + 1; // 1-20
                    break;
            }
            
            speedCurrentProblem = { num1, num2, answer: num1 * num2 };
            document.getElementById('speed-question').textContent = `${num1} × ${num2}`;
            document.getElementById('speed-answer').value = '';
        }
        
        function checkSpeedAnswer() {
            const userAnswer = parseInt(document.getElementById('speed-answer').value);
            
            if (isNaN(userAnswer)) return;
            
            const answerInput = document.getElementById('speed-answer');
            const speedProblem = document.querySelector('.speed-problem');
            
            if (userAnswer === speedCurrentProblem.answer) {
                speedScore++;
                speedStreak++;
                document.getElementById('speed-score').textContent = speedScore;
                document.getElementById('speed-streak').textContent = speedStreak;
                
                // Visual feedback - green glow
                answerInput.classList.add('correct-glow');
                
                // Create sparkle effect
                const sparkle = document.createElement('div');
                sparkle.className = 'correct-flare';
                sparkle.style.left = Math.random() * speedProblem.offsetWidth + 'px';
                sparkle.style.top = Math.random() * speedProblem.offsetHeight + 'px';
                speedProblem.appendChild(sparkle);
                
                setTimeout(() => sparkle.remove(), 600);
                
                // Bonus time for streaks - show fire animation
                if (speedStreak % 5 === 0 && speedStreak > 0) {
                    speedTimeLeft += 5;
                    
                    // Create multiple fire emojis
                    for (let i = 0; i < 5; i++) {
                        setTimeout(() => {
                            const fire = document.createElement('div');
                            fire.className = 'streak-fire';
                            fire.textContent = '🔥';
                            fire.style.left = (speedProblem.offsetWidth / 2 - 20 + (i - 2) * 30) + 'px';
                            fire.style.top = speedProblem.offsetHeight / 2 + 'px';
                            speedProblem.appendChild(fire);
                            setTimeout(() => fire.remove(), 1000);
                        }, i * 100);
                    }
                }
                
                setTimeout(() => {
                    answerInput.classList.remove('correct-glow');
                    generateSpeedProblem();
                }, 400);
            } else {
                speedStreak = 0;
                document.getElementById('speed-streak').textContent = '0';
                
                // Visual feedback - red shake and glow
                answerInput.classList.add('incorrect-glow', 'incorrect-shake');
                
                // Show correct answer briefly
                const correctAnswer = document.createElement('div');
                correctAnswer.style.cssText = `
                    position: absolute;
                    top: 50%;
                    right: -80px;
                    transform: translateY(-50%);
                    color: #F44336;
                    font-size: 1.5rem;
                    font-weight: bold;
                    opacity: 0;
                    transition: opacity 0.3s;
                `;
                correctAnswer.textContent = speedCurrentProblem.answer;
                speedProblem.style.position = 'relative';
                speedProblem.appendChild(correctAnswer);
                
                setTimeout(() => {
                    correctAnswer.style.opacity = '1';
                }, 100);
                
                setTimeout(() => {
                    answerInput.classList.remove('incorrect-glow', 'incorrect-shake');
                    correctAnswer.remove();
                    generateSpeedProblem();
                }, 1000);
            }
        }
        
        function endSpeedChallenge() {
            clearInterval(speedTimer);
            document.getElementById('speed-game').style.display = 'none';
            document.querySelector('.speed-levels').style.display = 'grid';
            
            // Save high score
            const storageKey = `speed-${speedLevel}`;
            const oldBest = localStorage.getItem(storageKey) || 0;
            if (speedScore > oldBest) {
                localStorage.setItem(storageKey, speedScore);
            }
            
            // Update leaderboard
            updateSpeedLeaderboard();
            
            // Show final score
            alert(`Game Over!\nFinal Score: ${speedScore}\n${speedScore > oldBest ? '🏆 NEW PERSONAL BEST!' : ''}`);
        }
        
        function quitSpeedChallenge() {
            if (confirm('Are you sure you want to quit?')) {
                endSpeedChallenge();
            }
        }
        
        function updateSpeedLeaderboard() {
            const records = document.getElementById('speed-records');
            records.innerHTML = '';
            
            ['easy', 'medium', 'hard', 'extreme'].forEach(level => {
                const score = localStorage.getItem(`speed-${level}`) || 0;
                if (score > 0) {
                    records.innerHTML += `
                        <div style="padding: 10px; margin: 5px 0; background: rgba(255, 255, 255, 0.1); border-radius: 5px;">
                            <span style="text-transform: capitalize; color: #4ECDC4;">${level}:</span>
                            <span style="float: right; color: #FFD700; font-weight: bold;">${score} points</span>
                        </div>
                    `;
                }
            });
            
            if (records.innerHTML === '') {
                records.innerHTML = '<p style="color: #999;">No records yet. Start playing!</p>';
            }
        }
        
        // Word Problems Functions
        const wordProblems = {
            easy: [
                { template: "Sarah has {a} bags with {b} apples in each bag. How many apples does she have in total?", visual: "🍎" },
                { template: "Tom buys {a} boxes of crayons. Each box has {b} crayons. How many crayons does he have?", visual: "🖍️" },
                { template: "There are {a} rows of chairs with {b} chairs in each row. How many chairs are there?", visual: "🪑" },
                { template: "A farmer has {a} chickens. Each chicken lays {b} eggs. How many eggs are there?", visual: "🥚" }
            ],
            medium: [
                { template: "A parking lot has {a} rows with {b} cars in each row. How many cars are parked?", visual: "🚗" },
                { template: "A baker makes {a} trays of cookies with {b} cookies on each tray. How many cookies in total?", visual: "🍪" },
                { template: "There are {a} teams with {b} players on each team. How many players are there?", visual: "⚽" },
                { template: "A garden has {a} rows of flowers with {b} flowers in each row. How many flowers are there?", visual: "🌻" }
            ],
            hard: [
                { template: "A factory produces {a} boxes per hour. Each box contains {b} items. How many items in one hour?", visual: "📦" },
                { template: "A school has {a} classrooms with {b} students in each room. How many students in the school?", visual: "👨‍🎓" },
                { template: "An orchard has {a} trees with {b} oranges on each tree. How many oranges in total?", visual: "🍊" },
                { template: "A library has {a} shelves with {b} books on each shelf. How many books are there?", visual: "📚" }
            ]
        };

        let currentWordProblem = null;

        function generateWordProblem() {
            const difficulty = document.getElementById('word-difficulty').value;
            const problems = wordProblems[difficulty];
            const problem = problems[Math.floor(Math.random() * problems.length)];
            
            let a, b;
            if (difficulty === 'easy') {
                a = Math.floor(Math.random() * 4) + 2; // 2-5
                b = Math.floor(Math.random() * 4) + 2; // 2-5
            } else if (difficulty === 'medium') {
                a = Math.floor(Math.random() * 8) + 2; // 2-9
                b = Math.floor(Math.random() * 8) + 2; // 2-9
            } else {
                a = Math.floor(Math.random() * 11) + 2; // 2-12
                b = Math.floor(Math.random() * 11) + 2; // 2-12
            }
            
            currentWordProblem = { a, b, answer: a * b, visual: problem.visual };
            
            const problemText = problem.template.replace('{a}', a).replace('{b}', b);
            document.getElementById('problem-text').innerHTML = problemText;
            
            // Create visual representation WITHOUT equation
            const visualDiv = document.getElementById('problem-visual');
            visualDiv.innerHTML = '';
            
            // Add visual groups only
            const groupsContainer = document.createElement('div');
            for (let i = 0; i < Math.min(a, 10); i++) {
                const group = document.createElement('div');
                group.style.display = 'inline-block';
                group.style.margin = '5px';
                group.style.padding = '8px';
                group.style.border = '2px solid rgba(255,255,255,0.3)';
                group.style.borderRadius = '8px';
                group.style.background = 'rgba(255,255,255,0.05)';
                for (let j = 0; j < Math.min(b, 10); j++) {
                    const item = document.createElement('span');
                    item.textContent = problem.visual;
                    item.style.fontSize = '1.8rem';
                    item.style.margin = '3px';
                    group.appendChild(item);
                }
                groupsContainer.appendChild(group);
            }
            visualDiv.appendChild(groupsContainer);
            
            // Clear input fields
            document.getElementById('word-num1').value = '';
            document.getElementById('word-num2').value = '';
            document.getElementById('word-answer').value = '';
            
            // Remove any previous validation classes
            document.getElementById('word-num1').classList.remove('correct', 'incorrect');
            document.getElementById('word-num2').classList.remove('correct', 'incorrect');
            document.getElementById('word-answer').classList.remove('correct', 'incorrect');
            
            document.getElementById('word-feedback').innerHTML = '';
        }

        function checkWordProblem() {
            const num1 = parseInt(document.getElementById('word-num1').value);
            const num2 = parseInt(document.getElementById('word-num2').value);
            const answer = parseInt(document.getElementById('word-answer').value);
            const feedback = document.getElementById('word-feedback');
            
            let allCorrect = true;
            let message = '';
            
            // Check multiplication expression (accept both orders)
            const expressionCorrect = (num1 === currentWordProblem.a && num2 === currentWordProblem.b) || 
                                     (num1 === currentWordProblem.b && num2 === currentWordProblem.a);
            
            if (expressionCorrect) {
                document.getElementById('word-num1').classList.add('correct');
                document.getElementById('word-num2').classList.add('correct');
            } else {
                document.getElementById('word-num1').classList.add('incorrect');
                document.getElementById('word-num2').classList.add('incorrect');
                allCorrect = false;
                message += `The multiplication should be ${currentWordProblem.a} × ${currentWordProblem.b}. `;
            }
            
            // Check the answer
            if (answer === currentWordProblem.answer) {
                document.getElementById('word-answer').classList.add('correct');
            } else {
                document.getElementById('word-answer').classList.add('incorrect');
                allCorrect = false;
                if (expressionCorrect && num1 && num2) {
                    message += `${num1} × ${num2} = ${num1 * num2}`;
                }
            }
            
            if (allCorrect) {
                feedback.innerHTML = '<span style="color: #4CAF50; font-size: 1.3rem;">✅ Perfect! Well done!</span>';
                setTimeout(() => generateWordProblem(), 2500);
            } else {
                feedback.innerHTML = `<span style="color: #f44336;">${message}</span>`;
            }
        }

        // PDF Converter Functions
        let pdfDoc = null;
        let currentPage = 1;
        let pageCount = 0;
        let worksheetProblems = [];
        let currentQuestion = 0;
        let userAnswers = [];
        let testMode = false;
        let drawMode = false;
        let eraseMode = false;
        let isDrawing = false;
        let annotationCtx = null;
        let answerFields = [];
        let pageAnnotations = {};

        // Configure PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // Setup drag and drop
        document.addEventListener('DOMContentLoaded', () => {
            const uploadArea = document.getElementById('upload-area');
            const pdfInput = document.getElementById('pdf-input');
            
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragging');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragging');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragging');
                    
                    const file = e.dataTransfer.files[0];
                    if (file && file.type === 'application/pdf') {
                        handlePDFUpload(file);
                    }
                });
                
                uploadArea.addEventListener('click', () => {
                    if (pdfInput) pdfInput.click();
                });
            }
            
            if (pdfInput) {
                pdfInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        handlePDFUpload(file);
                    }
                });
            }
        });

        function handlePDFUpload(file) {
            const fileReader = new FileReader();
            
            fileReader.onload = function() {
                const typedarray = new Uint8Array(this.result);
                
                pdfjsLib.getDocument(typedarray).promise.then((pdf) => {
                    pdfDoc = pdf;
                    pageCount = pdf.numPages;
                    currentPage = 1;
                    
                    // Show interactive workspace directly
                    document.getElementById('interactive-workspace').style.display = 'block';
                    document.getElementById('page-indicator').textContent = `Page ${currentPage} of ${pageCount}`;
                    
                    // Initialize annotations for each page
                    for (let i = 1; i <= pageCount; i++) {
                        pageAnnotations[i] = [];
                    }
                    
                    // Render the PDF with interactive overlay
                    renderInteractivePage(currentPage);
                    
                    // Extract problems for answer checking
                    extractProblems();
                });
            };
            
            fileReader.readAsArrayBuffer(file);
        }

        function renderPage(pageNum) {
            pdfDoc.getPage(pageNum).then((page) => {
                const canvas = document.getElementById('pdf-canvas');
                const ctx = canvas.getContext('2d');
                const viewport = page.getViewport({ scale: 1.5 });
                
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                
                page.render(renderContext);
            });
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                document.getElementById('page-info').textContent = `Page ${currentPage} of ${pageCount}`;
                renderPage(currentPage);
            }
        }

        function nextPage() {
            if (currentPage < pageCount) {
                currentPage++;
                document.getElementById('page-info').textContent = `Page ${currentPage} of ${pageCount}`;
                renderPage(currentPage);
            }
        }

        function extractProblems() {
            worksheetProblems = [];
            const promises = [];
            
            // Extract text from all pages
            for (let i = 1; i <= pageCount; i++) {
                promises.push(
                    pdfDoc.getPage(i).then((page) => {
                        return page.getTextContent().then((textContent) => {
                            return textContent.items.map(item => item.str).join(' ');
                        });
                    })
                );
            }
            
            Promise.all(promises).then((pagesText) => {
                const fullText = pagesText.join(' ');
                
                // Pattern matching for common math problems
                const patterns = [
                    /(\d+)\s*[+\-×÷]\s*(\d+)\s*=/g,  // Basic operations
                    /(\d+)\s*\+\s*(\d+)\s*=/g,       // Addition
                    /(\d+)\s*-\s*(\d+)\s*=/g,        // Subtraction
                    /(\d+)\s*×\s*(\d+)\s*=/g,        // Multiplication
                    /(\d+)\s*÷\s*(\d+)\s*=/g,        // Division
                    /(\d+)\s*x\s*(\d+)\s*=/gi,       // Alternative multiplication
                    /(\d+)\s*\*\s*(\d+)\s*=/g,       // Alternative multiplication
                    /(\d+)\s*\/\s*(\d+)\s*=/g        // Alternative division
                ];
                
                patterns.forEach(pattern => {
                    let match;
                    while ((match = pattern.exec(fullText)) !== null) {
                        worksheetProblems.push({
                            expression: match[0],
                            num1: parseInt(match[1]),
                            num2: parseInt(match[2]),
                            operator: match[0].replace(/[0-9\s=]/g, '').trim(),
                            answer: calculateAnswer(match[1], match[2], match[0])
                        });
                    }
                });
                
                // Create interactive worksheet
                createInteractiveWorksheet();
            });
        }

        function calculateAnswer(num1, num2, expression) {
            const n1 = parseInt(num1);
            const n2 = parseInt(num2);
            
            if (expression.includes('+')) return n1 + n2;
            if (expression.includes('-')) return n1 - n2;
            if (expression.includes('×') || expression.includes('x') || expression.includes('*')) return n1 * n2;
            if (expression.includes('÷') || expression.includes('/')) return Math.floor(n1 / n2);
            
            return 0;
        }

        function renderInteractivePage(pageNum) {
            pdfDoc.getPage(pageNum).then((page) => {
                const canvas = document.getElementById('pdf-render-canvas');
                const ctx = canvas.getContext('2d');
                const scale = 1.5;
                const viewport = page.getViewport({ scale: scale });
                
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                // Setup annotation canvas
                const annotationCanvas = document.getElementById('annotation-canvas');
                annotationCanvas.width = canvas.width;
                annotationCanvas.height = canvas.height;
                annotationCtx = annotationCanvas.getContext('2d');
                
                // Clear and restore annotations for this page
                annotationCtx.clearRect(0, 0, canvas.width, canvas.height);
                if (pageAnnotations[pageNum]) {
                    restoreAnnotations(pageNum);
                }
                
                // Render PDF page
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                
                page.render(renderContext).promise.then(() => {
                    // Extract text positions for answer fields
                    page.getTextContent().then((textContent) => {
                        createAnswerFields(textContent, viewport);
                    });
                });
                
                // Setup drawing handlers
                setupDrawingHandlers(annotationCanvas);
            });
        }

        function createAnswerFields(textContent, viewport) {
            const overlay = document.getElementById('answer-overlay');
            overlay.innerHTML = '';
            answerFields = [];
            
            // Look for answer spaces (underscores, equals signs, etc.)
            textContent.items.forEach((item, index) => {
                const text = item.str;
                
                // Detect answer locations (after =, blank spaces, etc.)
                if (text.includes('=') || text.includes('___') || text.includes('____')) {
                    const transform = item.transform;
                    const x = transform[4];
                    const y = viewport.height - transform[5];
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'answer-field';
                    input.style.left = (x + 50) + 'px';
                    input.style.top = (y - 10) + 'px';
                    input.dataset.problemIndex = answerFields.length;
                    
                    overlay.appendChild(input);
                    answerFields.push({
                        element: input,
                        page: currentPage,
                        expected: null // Will be populated from extracted problems
                    });
                }
            });
        }

        function setupDrawingHandlers(canvas) {
            canvas.onmousedown = startDrawing;
            canvas.onmousemove = draw;
            canvas.onmouseup = stopDrawing;
            canvas.onmouseout = stopDrawing;
            
            // Touch support for tablets
            canvas.ontouchstart = (e) => {
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            };
            
            canvas.ontouchmove = (e) => {
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            };
            
            canvas.ontouchend = (e) => {
                const mouseEvent = new MouseEvent('mouseup', {});
                canvas.dispatchEvent(mouseEvent);
            };
        }

        function startDrawing(e) {
            if (!drawMode && !eraseMode) return;
            
            isDrawing = true;
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            annotationCtx.beginPath();
            annotationCtx.moveTo(x, y);
            
            // Save starting point for annotations
            if (!pageAnnotations[currentPage]) {
                pageAnnotations[currentPage] = [];
            }
            pageAnnotations[currentPage].push({
                type: drawMode ? 'draw' : 'erase',
                points: [{x, y}],
                color: document.getElementById('pen-color').value,
                width: document.getElementById('pen-width').value
            });
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (drawMode) {
                annotationCtx.globalCompositeOperation = 'source-over';
                annotationCtx.strokeStyle = document.getElementById('pen-color').value;
                annotationCtx.lineWidth = document.getElementById('pen-width').value;
                annotationCtx.lineCap = 'round';
                annotationCtx.lineTo(x, y);
                annotationCtx.stroke();
            } else if (eraseMode) {
                annotationCtx.globalCompositeOperation = 'destination-out';
                annotationCtx.lineWidth = 20;
                annotationCtx.lineTo(x, y);
                annotationCtx.stroke();
            }
            
            // Save point to annotations
            const currentAnnotation = pageAnnotations[currentPage][pageAnnotations[currentPage].length - 1];
            currentAnnotation.points.push({x, y});
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function toggleDrawMode() {
            drawMode = !drawMode;
            eraseMode = false;
            document.getElementById('draw-btn').classList.toggle('active', drawMode);
            document.getElementById('erase-btn').classList.remove('active');
            document.getElementById('annotation-canvas').style.pointerEvents = drawMode ? 'all' : 'none';
        }

        function toggleEraseMode() {
            eraseMode = !eraseMode;
            drawMode = false;
            document.getElementById('erase-btn').classList.toggle('active', eraseMode);
            document.getElementById('draw-btn').classList.remove('active');
            document.getElementById('annotation-canvas').style.pointerEvents = eraseMode ? 'all' : 'none';
        }

        function clearAnnotations() {
            if (annotationCtx) {
                annotationCtx.clearRect(0, 0, annotationCtx.canvas.width, annotationCtx.canvas.height);
                pageAnnotations[currentPage] = [];
            }
        }

        function restoreAnnotations(pageNum) {
            const annotations = pageAnnotations[pageNum] || [];
            annotations.forEach(ann => {
                if (ann.type === 'draw') {
                    annotationCtx.globalCompositeOperation = 'source-over';
                    annotationCtx.strokeStyle = ann.color;
                    annotationCtx.lineWidth = ann.width;
                    annotationCtx.lineCap = 'round';
                    annotationCtx.beginPath();
                    ann.points.forEach((point, i) => {
                        if (i === 0) {
                            annotationCtx.moveTo(point.x, point.y);
                        } else {
                            annotationCtx.lineTo(point.x, point.y);
                        }
                    });
                    annotationCtx.stroke();
                }
            });
        }

        function previousPDFPage() {
            if (currentPage > 1) {
                currentPage--;
                document.getElementById('page-indicator').textContent = `Page ${currentPage} of ${pageCount}`;
                renderInteractivePage(currentPage);
            }
        }

        function nextPDFPage() {
            if (currentPage < pageCount) {
                currentPage++;
                document.getElementById('page-indicator').textContent = `Page ${currentPage} of ${pageCount}`;
                renderInteractivePage(currentPage);
            }
        }

        function checkAllAnswers() {
            answerFields.forEach((field, index) => {
                const userAnswer = field.element.value.trim();
                if (worksheetProblems[index]) {
                    const correct = parseInt(userAnswer) === worksheetProblems[index].answer;
                    field.element.classList.toggle('correct', correct);
                    field.element.classList.toggle('incorrect', !correct && userAnswer !== '');
                }
            });
        }

        function saveWork() {
            const workData = {
                annotations: pageAnnotations,
                answers: answerFields.map(f => ({ value: f.element.value, page: f.page })),
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('pdfWork_' + Date.now(), JSON.stringify(workData));
            alert('Work saved locally!');
        }

        function downloadAnnotated() {
            // Create a combined canvas with PDF and annotations
            const canvas = document.createElement('canvas');
            const pdfCanvas = document.getElementById('pdf-render-canvas');
            const annotCanvas = document.getElementById('annotation-canvas');
            
            canvas.width = pdfCanvas.width;
            canvas.height = pdfCanvas.height;
            const ctx = canvas.getContext('2d');
            
            // Draw PDF
            ctx.drawImage(pdfCanvas, 0, 0);
            // Draw annotations on top
            ctx.drawImage(annotCanvas, 0, 0);
            
            // Download as image
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `annotated_page_${currentPage}.png`;
                a.click();
                URL.revokeObjectURL(url);
            });
        }

        function finishPaper() {
            checkAllAnswers();
            let correct = 0;
            let total = answerFields.length;
            
            answerFields.forEach(field => {
                if (field.element.classList.contains('correct')) {
                    correct++;
                }
            });
            
            alert(`Paper Complete!\nScore: ${correct}/${total} (${Math.round(correct/total * 100)}%)`);
        }

        function createInteractiveWorksheet() {
            const workspace = document.getElementById('interactive-workspace');
            
            if (worksheetProblems.length === 0) {
                workspace.style.display = 'block';
                document.getElementById('question-display').innerHTML = 
                    '<p>No math problems detected. Try uploading a worksheet with clear math expressions like "5 + 3 =" or "12 × 4 ="</p>';
                return;
            }
            
            // Initialize test mode
            testMode = true;
            currentQuestion = 0;
            userAnswers = new Array(worksheetProblems.length).fill({ answer: null, status: 'unanswered' });
            
            workspace.style.display = 'block';
            document.getElementById('pdf-preview').style.display = 'none';
            
            // Start test
            displayQuestion(currentQuestion);
        }

        function displayQuestion(index) {
            if (index < 0 || index >= worksheetProblems.length) return;
            
            currentQuestion = index;
            const problem = worksheetProblems[index];
            
            // Update progress
            document.getElementById('question-counter').textContent = 
                `Question ${index + 1} of ${worksheetProblems.length}`;
            document.getElementById('progress-fill').style.width = 
                `${((index + 1) / worksheetProblems.length) * 100}%`;
            
            // Display question
            document.getElementById('question-display').innerHTML = `
                <div class="question-number">Question ${index + 1}</div>
                <div class="question-text">${problem.expression}</div>
            `;
            
            // Set answer input
            const answerInput = document.getElementById('test-answer');
            answerInput.value = userAnswers[index].answer || '';
            answerInput.classList.remove('submitted');
            answerInput.focus();
            
            // Update navigation buttons
            document.getElementById('prev-btn').disabled = (index === 0);
            document.getElementById('next-btn').disabled = (index === worksheetProblems.length - 1);
            
            // Handle enter key for quick submission
            answerInput.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    submitAnswer();
                }
            };
        }

        function previousQuestion() {
            if (currentQuestion > 0) {
                displayQuestion(currentQuestion - 1);
            }
        }

        function nextQuestion() {
            if (currentQuestion < worksheetProblems.length - 1) {
                displayQuestion(currentQuestion + 1);
            }
        }

        function skipQuestion() {
            userAnswers[currentQuestion] = { answer: null, status: 'skipped' };
            if (currentQuestion < worksheetProblems.length - 1) {
                nextQuestion();
            } else {
                finishTest();
            }
        }

        function submitAnswer() {
            const answerInput = document.getElementById('test-answer');
            const answer = answerInput.value.trim();
            
            if (answer) {
                userAnswers[currentQuestion] = {
                    answer: answer,
                    status: 'answered',
                    correct: parseInt(answer) === worksheetProblems[currentQuestion].answer
                };
                answerInput.classList.add('submitted');
                
                // Auto-advance after short delay
                setTimeout(() => {
                    if (currentQuestion < worksheetProblems.length - 1) {
                        nextQuestion();
                    } else {
                        // Show completion option
                        document.querySelector('.finish-btn').style.background = 'rgba(76, 175, 80, 0.3)';
                    }
                }, 500);
            }
        }

        function reviewAnswers() {
            // Create review modal
            const reviewHtml = worksheetProblems.map((problem, index) => {
                const userAns = userAnswers[index];
                const statusClass = userAns.status === 'answered' ? 
                    (userAns.correct ? 'answered' : 'incorrect') : 
                    userAns.status;
                
                return `
                    <div style="margin: 10px 0; cursor: pointer;" onclick="displayQuestion(${index})">
                        ${index + 1}. ${problem.expression} 
                        ${userAns.answer || '___'} 
                        <span class="question-status ${statusClass}"></span>
                    </div>
                `;
            }).join('');
            
            alert('Review Mode - Click any question to jump to it');
        }

        function finishTest() {
            const workspace = document.getElementById('interactive-workspace');
            const summary = document.getElementById('test-summary');
            
            workspace.style.display = 'none';
            summary.style.display = 'block';
            
            // Calculate results
            let correct = 0;
            let answered = 0;
            let skipped = 0;
            
            userAnswers.forEach(ans => {
                if (ans.status === 'answered') {
                    answered++;
                    if (ans.correct) correct++;
                } else if (ans.status === 'skipped') {
                    skipped++;
                }
            });
            
            const total = worksheetProblems.length;
            const percentage = Math.round((correct / total) * 100);
            
            // Display summary
            document.getElementById('summary-content').innerHTML = `
                <div class="score-display">
                    <h2>${percentage}%</h2>
                    <p>${correct} out of ${total} correct</p>
                </div>
                <div class="stats">
                    <p>✅ Correct: ${correct}</p>
                    <p>❌ Incorrect: ${answered - correct}</p>
                    <p>⏭️ Skipped: ${skipped}</p>
                    <p>❓ Unanswered: ${total - answered - skipped}</p>
                </div>
                <div class="breakdown">
                    ${worksheetProblems.map((problem, index) => {
                        const userAns = userAnswers[index];
                        const icon = userAns.correct ? '✅' : 
                                    userAns.status === 'skipped' ? '⏭️' :
                                    userAns.status === 'answered' ? '❌' : '❓';
                        return `
                            <div>
                                ${icon} ${problem.expression} ${userAns.answer || '___'} 
                                ${!userAns.correct && userAns.status === 'answered' ? 
                                    `(Answer: ${problem.answer})` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function reviewMistakes() {
            const mistakes = worksheetProblems.filter((problem, index) => 
                userAnswers[index].status === 'answered' && !userAnswers[index].correct
            );
            
            if (mistakes.length === 0) {
                alert('No mistakes to review! Great job!');
                return;
            }
            
            // Show only incorrect answers for review
            currentQuestion = worksheetProblems.findIndex((problem, index) => 
                userAnswers[index].status === 'answered' && !userAnswers[index].correct
            );
            
            document.getElementById('interactive-workspace').style.display = 'block';
            document.getElementById('test-summary').style.display = 'none';
            displayQuestion(currentQuestion);
        }

        function startNewTest() {
            // Reset everything
            worksheetProblems = [];
            userAnswers = [];
            currentQuestion = 0;
            testMode = false;
            
            // Hide all sections
            document.getElementById('pdf-preview').style.display = 'none';
            document.getElementById('interactive-workspace').style.display = 'none';
            document.getElementById('test-summary').style.display = 'none';
            
            // Clear file input
            document.getElementById('pdf-input').value = '';
        }

        function downloadResults() {
            let results = 'Worksheet Results\n\n';
            let correct = 0;
            
            worksheetProblems.forEach((problem, index) => {
                const input = document.getElementById(`answer-${index}`);
                const userAnswer = input.value || 'No answer';
                const isCorrect = parseInt(userAnswer) === problem.answer;
                
                if (isCorrect) correct++;
                
                results += `${index + 1}. ${problem.expression} ${userAnswer} ${isCorrect ? '✓' : '✗ (Correct: ' + problem.answer + ')'}\n`;
            });
            
            results += `\nScore: ${correct}/${worksheetProblems.length} (${Math.round(correct/worksheetProblems.length * 100)}%)`;
            
            // Create download
            const blob = new Blob([results], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'worksheet-results.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Times Table Grid Functions
        function generateTimesGrid() {
            const size = parseInt(document.getElementById('grid-size').value);
            const grid = document.getElementById('times-grid');
            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `repeat(${size + 1}, 1fr)`;
            
            // Create header cell (empty corner)
            const cornerCell = document.createElement('div');
            cornerCell.className = 'grid-cell header';
            cornerCell.textContent = '×';
            grid.appendChild(cornerCell);
            
            // Create column headers
            for (let i = 1; i <= size; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell header';
                cell.textContent = i;
                grid.appendChild(cell);
            }
            
            // Create rows
            for (let i = 1; i <= size; i++) {
                // Row header
                const rowHeader = document.createElement('div');
                rowHeader.className = 'grid-cell header';
                rowHeader.textContent = i;
                grid.appendChild(rowHeader);
                
                // Row cells
                for (let j = 1; j <= size; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.textContent = i * j;
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    cell.onclick = () => highlightCell(i, j);
                    grid.appendChild(cell);
                }
            }
        }

        function highlightCell(row, col) {
            // Clear previous highlights
            document.querySelectorAll('.grid-cell').forEach(cell => {
                cell.classList.remove('highlighted');
            });
            
            // Highlight row and column
            document.querySelectorAll('.grid-cell').forEach(cell => {
                if (cell.dataset.row == row || cell.dataset.col == col) {
                    cell.classList.add('highlighted');
                }
            });
        }

        function togglePatterns() {
            const showPatterns = document.getElementById('show-patterns').checked;
            const cells = document.querySelectorAll('.grid-cell:not(.header)');
            
            cells.forEach(cell => {
                const value = parseInt(cell.textContent);
                if (showPatterns) {
                    // Color code based on patterns
                    if (value % 2 === 0) {
                        cell.style.background = 'rgba(33, 150, 243, 0.2)';
                    }
                    if (value % 5 === 0) {
                        cell.style.background = 'rgba(255, 193, 7, 0.2)';
                    }
                    if (value % 10 === 0) {
                        cell.style.background = 'rgba(76, 175, 80, 0.2)';
                    }
                } else {
                    cell.style.background = '';
                }
            });
        }

        // Column Method Variables and Functions
        let columnStep = 0;
        let columnProblem = { num1: 20, num2: 1 };
        let columnSteps = [];
        let columnWorkoutProblems = [];
        let columnCurrentProblem = 0;
        let columnTestScore = 0;
        let columnTestTimer = null;
        
        function initializeColumnMethod() {
            // Initialize with default example (simpler)
            if (document.getElementById('guided-num1') && document.getElementById('guided-num2')) {
                document.getElementById('guided-num1').textContent = '20';
                document.getElementById('guided-num2').textContent = '1';
                generateColumnSteps(20, 1);
                showColumnStep();
            }
        }
        
        function switchColumnMode(mode) {
            // Hide all mode contents
            document.querySelectorAll('.column-mode-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active from all mode buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected mode
            document.getElementById(`column-${mode}-mode`).classList.add('active');
            
            // Mark button as active
            event.target.classList.add('active');
        }
        
        function generateColumnProblem(level) {
            let num1, num2;
            
            switch(level) {
                case '1': // 2 digits × 1 digit (no carry)
                    num1 = Math.floor(Math.random() * 30) + 10; // 10-39
                    num2 = Math.floor(Math.random() * 5) + 1;   // 1-5
                    if (num1 * num2 >= 100) num1 = Math.floor(num1 / 2); // Ensure no carry
                    break;
                case '2': // 2 digits × 1 digit (with carry)
                    num1 = Math.floor(Math.random() * 50) + 25; // 25-74
                    num2 = Math.floor(Math.random() * 5) + 4;   // 4-8
                    break;
                case '3': // 3 digits × 1 digit
                    num1 = Math.floor(Math.random() * 500) + 100; // 100-599
                    num2 = Math.floor(Math.random() * 8) + 2;     // 2-9
                    break;
                case '4': // 2 digits × 2 digits
                    num1 = Math.floor(Math.random() * 70) + 20;  // 20-89
                    num2 = Math.floor(Math.random() * 70) + 10;  // 10-79
                    break;
                case '5': // 3 digits × 2 digits
                    num1 = Math.floor(Math.random() * 400) + 100; // 100-499
                    num2 = Math.floor(Math.random() * 80) + 10;   // 10-89
                    break;
                default:
                    num1 = 20;
                    num2 = 1;
            }
            
            return { num1, num2 };
        }
        
        function startColumnWorkout() {
            const level = document.getElementById('column-difficulty').value;
            const count = parseInt(document.getElementById('column-problem-count').value);
            const guided = document.getElementById('guided-toggle').checked;
            
            // Generate problems
            columnWorkoutProblems = [];
            for (let i = 0; i < count; i++) {
                columnWorkoutProblems.push(generateColumnProblem(level));
            }
            
            columnCurrentProblem = 0;
            
            // Hide setup, show workout area
            document.querySelector('.column-workout-setup').style.display = 'none';
            const workoutArea = document.getElementById('column-workout-area');
            workoutArea.style.display = 'block';
            
            // Display first problem
            displayWorkoutProblem(guided);
        }
        
        function displayWorkoutProblem(guided) {
            const problem = columnWorkoutProblems[columnCurrentProblem];
            const workoutArea = document.getElementById('column-workout-area');
            
            workoutArea.innerHTML = `
                <div class="workout-header">
                    <h3>Problem ${columnCurrentProblem + 1} of ${columnWorkoutProblems.length}</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(columnCurrentProblem / columnWorkoutProblems.length) * 100}%"></div>
                    </div>
                </div>
                <div class="workout-problem">
                    <div class="problem-display">
                        <h2>${problem.num1} × ${problem.num2}</h2>
                    </div>
                    ${guided ? `
                        <div class="guided-help">
                            <h4>Step-by-step Guide:</h4>
                            <div id="workout-steps"></div>
                        </div>
                    ` : ''}
                    <div class="answer-section">
                        <input type="number" id="workout-answer" placeholder="Your answer">
                        <button onclick="checkWorkoutAnswer()">Check Answer</button>
                    </div>
                    <div id="workout-feedback"></div>
                </div>
            `;
            
            if (guided) {
                generateColumnSteps(problem.num1, problem.num2);
                displayWorkoutSteps();
            }
        }
        
        function displayWorkoutSteps() {
            const stepsDiv = document.getElementById('workout-steps');
            if (!stepsDiv) return;
            
            let stepsHTML = '';
            columnSteps.forEach((step, index) => {
                stepsHTML += `
                    <div class="workout-step">
                        <h5>${step.title}</h5>
                        <p>${step.description}</p>
                        <pre>${step.visual}</pre>
                    </div>
                `;
            });
            stepsDiv.innerHTML = stepsHTML;
        }
        
        function checkWorkoutAnswer() {
            const problem = columnWorkoutProblems[columnCurrentProblem];
            const userAnswer = parseInt(document.getElementById('workout-answer').value);
            const correctAnswer = problem.num1 * problem.num2;
            const feedback = document.getElementById('workout-feedback');
            
            if (userAnswer === correctAnswer) {
                feedback.innerHTML = `<div style="color: #4CAF50;">✓ Correct!</div>`;
                
                // Move to next problem after delay
                setTimeout(() => {
                    columnCurrentProblem++;
                    if (columnCurrentProblem < columnWorkoutProblems.length) {
                        displayWorkoutProblem(document.getElementById('guided-toggle').checked);
                    } else {
                        showWorkoutResults();
                    }
                }, 1500);
            } else {
                feedback.innerHTML = `<div style="color: #F44336;">✗ Try again. ${userAnswer > correctAnswer ? 'Too high!' : 'Too low!'}</div>`;
            }
        }
        
        function showWorkoutResults() {
            const workoutArea = document.getElementById('column-workout-area');
            workoutArea.innerHTML = `
                <div class="workout-complete">
                    <h2>Workout Complete! 🎉</h2>
                    <p>You solved ${columnWorkoutProblems.length} problems!</p>
                    <button onclick="resetColumnWorkout()">New Workout</button>
                </div>
            `;
        }
        
        function resetColumnWorkout() {
            document.querySelector('.column-workout-setup').style.display = 'block';
            document.getElementById('column-workout-area').style.display = 'none';
        }
        
        function startColumnTest() {
            const level = document.getElementById('test-level').value;
            const timeLimit = parseInt(document.getElementById('test-time').value);
            
            columnTestScore = 0;
            let timeLeft = timeLimit;
            
            // Hide setup, show test area
            document.querySelector('.column-test-setup').style.display = 'none';
            const testArea = document.getElementById('column-test-area');
            testArea.style.display = 'block';
            
            // Start timer
            columnTestTimer = setInterval(() => {
                timeLeft--;
                updateTestTimer(timeLeft);
                if (timeLeft <= 0) {
                    endColumnTest();
                }
            }, 1000);
            
            // Display test interface
            displayTestProblem(level);
        }
        
        function updateTestTimer(timeLeft) {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            // Update timer display (need to add element for this)
        }
        
        function displayTestProblem(level) {
            // Generate problem based on level
            const problem = generateColumnProblem(level === '1' ? '2' : level === '2' ? '3' : '5');
            
            const testArea = document.getElementById('column-test-area');
            testArea.innerHTML = `
                <div class="test-header">
                    <div class="test-timer">Time: <span id="test-time-display">10:00</span></div>
                    <div class="test-score">Score: <span id="test-score-display">${columnTestScore}</span></div>
                </div>
                <div class="test-problem">
                    <h3>Solve step by step: ${problem.num1} × ${problem.num2}</h3>
                    <div class="step-inputs">
                        <!-- Step-by-step input fields for scoring -->
                    </div>
                </div>
            `;
        }
        
        function endColumnTest() {
            clearInterval(columnTestTimer);
            alert(`Test Complete! Your score: ${columnTestScore} points`);
            resetColumnTest();
        }
        
        function resetColumnTest() {
            document.querySelector('.column-test-setup').style.display = 'block';
            document.getElementById('column-test-area').style.display = 'none';
        }
        
        function loadExample(num1, num2) {
            // ALWAYS put larger number on top, smaller below
            let topNum = num1;
            let bottomNum = num2;
            
            // Ensure two-digit on top, single-digit below for levels 1-3
            if (num2 > num1) {
                topNum = num2;
                bottomNum = num1;
            }
            
            // Update both guided and practice sections
            document.getElementById('guided-num1').textContent = topNum;
            document.getElementById('guided-num2').textContent = bottomNum;
            document.getElementById('practice-num1').value = topNum;
            document.getElementById('practice-num2').value = bottomNum;
            
            // Reset and start the guided tutorial
            columnProblem = { num1: topNum, num2: bottomNum };
            columnStep = 0;
            generateColumnSteps(topNum, bottomNum);
            showColumnStep();
            
            // Scroll to the column method section
            document.getElementById('column-tool').scrollIntoView({ behavior: 'smooth' });
        }
        
        function generateColumnSteps(num1, num2) {
            columnSteps = [];
            const num1Str = num1.toString();
            const num2Str = num2.toString();
            
            // For single digit multiplier, show detailed grid with carry
            if (num2Str.length === 1) {
                // Step 1: Setup in grid
                columnSteps.push({
                    title: "Step 1: Set up the problem",
                    description: `Write ${num1} on top and ${num2} below, aligned to the right`,
                    visual: createGridVisual(num1Str, num2Str, 'setup')
                });
                
                // Step 2: Multiply ones place
                const onesProduct = (num1 % 10) * num2;
                const onesDigit = onesProduct % 10;
                const onesCarry = Math.floor(onesProduct / 10);
                
                columnSteps.push({
                    title: "Step 2: Multiply the ones place",
                    description: `${num2} × ${num1 % 10} = ${onesProduct}. Write ${onesDigit}, carry ${onesCarry}`,
                    visual: createGridVisual(num1Str, num2Str, 'ones', {
                        result: onesDigit.toString(),
                        carry: onesCarry > 0 ? onesCarry : null
                    })
                });
                
                // Step 3: Multiply tens place (if exists)
                if (num1Str.length >= 2) {
                    const tensDigit = Math.floor((num1 % 100) / 10);
                    const tensProduct = tensDigit * num2 + onesCarry;
                    const tensResult = tensProduct % 10;
                    const tensCarry = Math.floor(tensProduct / 10);
                    
                    columnSteps.push({
                        title: "Step 3: Multiply the tens place",
                        description: `${num2} × ${tensDigit} = ${tensDigit * num2}, plus carry ${onesCarry} = ${tensProduct}`,
                        visual: createGridVisual(num1Str, num2Str, 'tens', {
                            onesResult: onesDigit.toString(),
                            tensResult: tensResult.toString(),
                            carry: tensCarry > 0 ? tensCarry : null
                        })
                    });
                    
                    // Step 4: Multiply hundreds place (if exists)
                    if (num1Str.length >= 3) {
                        const hundredsDigit = Math.floor(num1 / 100);
                        const hundredsProduct = hundredsDigit * num2 + tensCarry;
                        
                        columnSteps.push({
                            title: "Step 4: Multiply the hundreds place",
                            description: `${num2} × ${hundredsDigit} = ${hundredsDigit * num2}, plus carry ${tensCarry} = ${hundredsProduct}`,
                            visual: createGridVisual(num1Str, num2Str, 'final', {
                                answer: (num1 * num2).toString()
                            })
                        });
                    } else {
                        // Final answer for 2-digit × 1-digit
                        columnSteps.push({
                            title: "Step 4: Write the final answer",
                            description: `The final answer is ${num1 * num2}`,
                            visual: createGridVisual(num1Str, num2Str, 'final', {
                                answer: (num1 * num2).toString()
                            })
                        });
                    }
                } else {
                    // Final for single digit × single digit
                    columnSteps.push({
                        title: "Step 3: Final answer",
                        description: `The answer is ${num1 * num2}`,
                        visual: createGridVisual(num1Str, num2Str, 'final', {
                            answer: (num1 * num2).toString()
                        })
                    });
                }
            } else {
                // For two-digit multiplier, show partial products
                let stepNum = 1;
                let partialProducts = [];
                
                columnSteps.push({
                    title: `Step ${stepNum}: Set up the problem`,
                    description: `Write ${num1} on top and ${num2} below`,
                    visual: createGridVisual(num1Str, num2Str, 'setup')
                });
                stepNum++;
                
                // Multiply by ones digit
                const onesMultiplier = num2 % 10;
                const firstProduct = num1 * onesMultiplier;
                partialProducts.push(firstProduct);
                
                columnSteps.push({
                    title: `Step ${stepNum}: Multiply by ${onesMultiplier} (ones place)`,
                    description: `${num1} × ${onesMultiplier} = ${firstProduct}`,
                    visual: createGridVisual(num1Str, num2Str, 'partial1', {
                        partial1: firstProduct.toString()
                    })
                });
                stepNum++;
                
                // Multiply by tens digit
                const tensMultiplier = Math.floor(num2 / 10);
                const secondProduct = num1 * tensMultiplier * 10;
                partialProducts.push(secondProduct);
                
                columnSteps.push({
                    title: `Step ${stepNum}: Multiply by ${tensMultiplier} (tens place)`,
                    description: `${num1} × ${tensMultiplier}0 = ${secondProduct}`,
                    visual: createGridVisual(num1Str, num2Str, 'partial2', {
                        partial1: firstProduct.toString(),
                        partial2: secondProduct.toString()
                    })
                });
                stepNum++;
                
                // Add partial products
                const finalAnswer = num1 * num2;
                columnSteps.push({
                    title: `Step ${stepNum}: Add the partial products`,
                    description: `${firstProduct} + ${secondProduct} = ${finalAnswer}`,
                    visual: createGridVisual(num1Str, num2Str, 'final', {
                        partial1: firstProduct.toString(),
                        partial2: secondProduct.toString(),
                        answer: finalAnswer.toString()
                    })
                });
            }
        }
        
        function createGridVisual(num1, num2, stage, data = {}) {
            // Create a grid-based visual representation
            const maxLen = Math.max(num1.length, num2.length) + 2;
            let visual = '';
            
            // Helper function to create spaces
            const spaces = (n) => ' '.repeat(n);
            
            // Carry row (if needed)
            if (data.carry) {
                visual += spaces(maxLen * 2) + `[${data.carry}] carry\n`;
            }
            
            // First number
            visual += '    ' + num1.padStart(maxLen, ' ') + '\n';
            
            // Multiplication sign and second number  
            visual += '  × ' + num2.padStart(maxLen, ' ') + '\n';
            
            // Line
            visual += '  ' + '─'.repeat(maxLen + 2) + '\n';
            
            // Result based on stage
            if (stage === 'ones' && data.result) {
                visual += '    ' + spaces(maxLen - 1) + data.result + '\n';
            } else if (stage === 'tens' && data.tensResult) {
                visual += '    ' + spaces(maxLen - 2) + data.tensResult + data.onesResult + '\n';
            } else if (stage === 'partial1' && data.partial1) {
                visual += '    ' + data.partial1.padStart(maxLen, ' ') + '\n';
            } else if (stage === 'partial2' && data.partial2) {
                visual += '    ' + data.partial1.padStart(maxLen, ' ') + '\n';
                visual += '   ' + data.partial2.padStart(maxLen - 1, ' ') + '0\n';
                visual += '  ' + '─'.repeat(maxLen + 2) + '\n';
            } else if (stage === 'final' && data.answer) {
                if (data.partial1 && data.partial2) {
                    // Show partials and final sum
                    visual += '    ' + data.partial1.padStart(maxLen, ' ') + '\n';
                    visual += '   ' + (data.partial2 / 10).toString().padStart(maxLen - 1, ' ') + '0\n';
                    visual += '  ' + '─'.repeat(maxLen + 2) + '\n';
                }
                visual += '    ' + data.answer.padStart(maxLen, ' ') + '\n';
            }
            
            return visual;
        }
        
        function showColumnStep() {
            if (columnSteps.length === 0) return;
            
            const step = columnSteps[columnStep];
            const display = document.getElementById('step-display');
            
            if (!display) {
                console.error('step-display element not found');
                return;
            }
            
            display.innerHTML = `
                <h4 style="color: #9B59B6;">${step.title}</h4>
                <p style="color: #ccc; margin: 10px 0;">${step.description}</p>
                <pre style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 5px; margin: 15px 0; font-family: monospace; font-size: 1.5rem; color: white;">
${step.visual}
                </pre>
            `;
            
            const stepCounter = document.getElementById('step-counter');
            if (stepCounter) {
                stepCounter.textContent = `Step ${columnStep + 1}/${columnSteps.length}`;
            }
        }
        
        function nextStep() {
            if (columnStep < columnSteps.length - 1) {
                columnStep++;
                showColumnStep();
            }
        }
        
        function previousStep() {
            if (columnStep > 0) {
                columnStep--;
                showColumnStep();
            }
        }
        
        // Practice Section Functions
        let currentPracticeProblem = null;
        
        function generateRandomProblem() {
            // Generate a random 2-digit × 1-digit problem
            const num1 = Math.floor(Math.random() * 90) + 10; // 10-99
            const num2 = Math.floor(Math.random() * 9) + 1;   // 1-9
            
            setupPracticeProblem(num1, num2);
        }
        
        function setupCustomProblem() {
            const workspace = document.getElementById('practice-workspace');
            workspace.style.display = 'block';
            workspace.innerHTML = `
                <div style="text-align: center; margin: 20px 0;">
                    <input type="number" id="custom-num1" min="10" max="999" placeholder="First number" 
                           style="width: 100px; padding: 10px; margin: 5px; font-size: 1.2rem;">
                    <span style="color: #4ECDC4; font-size: 1.5rem;">×</span>
                    <input type="number" id="custom-num2" min="1" max="99" placeholder="Second number" 
                           style="width: 100px; padding: 10px; margin: 5px; font-size: 1.2rem;">
                    <button onclick="startCustomProblem()" style="padding: 10px 20px; margin-left: 10px; 
                            background: #9B59B6; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Start
                    </button>
                </div>
            `;
            document.getElementById('custom-num1').focus();
        }
        
        function startCustomProblem() {
            const num1 = parseInt(document.getElementById('custom-num1').value);
            const num2 = parseInt(document.getElementById('custom-num2').value);
            
            if (!num1 || !num2) {
                alert('Please enter both numbers');
                return;
            }
            
            // Ensure larger number on top
            if (num1 < num2) {
                setupPracticeProblem(num2, num1);
            } else {
                setupPracticeProblem(num1, num2);
            }
        }
        
        function setupPracticeProblem(num1, num2) {
            currentPracticeProblem = { num1, num2, answer: num1 * num2 };
            
            const workspace = document.getElementById('practice-workspace');
            workspace.style.display = 'block';
            
            // Create a simple, clean practice grid
            workspace.innerHTML = `
                <div class="practice-grid" style="background: rgba(0,0,0,0.3); padding: 30px; border-radius: 10px; 
                                                   text-align: center; font-family: monospace; font-size: 1.8rem;">
                    <!-- The Problem -->
                    <div style="color: white; line-height: 1.5;">
                        <div style="text-align: right; width: 150px; margin: 0 auto;">
                            <div>${num1}</div>
                            <div>× ${num2}</div>
                            <div style="border-top: 3px solid #4ECDC4; margin: 10px 0;"></div>
                            <div>
                                <input type="number" id="practice-answer" placeholder="?" 
                                       style="width: 100%; padding: 10px; font-size: 1.8rem; text-align: right;
                                              background: rgba(78, 205, 196, 0.1); color: white;
                                              border: 2px solid #4ECDC4; border-radius: 5px;"
                                       onkeyup="if(event.key === 'Enter') checkPracticeAnswer()">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Controls -->
                    <div style="margin-top: 20px;">
                        <button onclick="checkPracticeAnswer()" style="padding: 10px 30px; margin: 5px; 
                                background: #4CAF50; color: white; border: none; border-radius: 5px; 
                                cursor: pointer; font-size: 1rem;">
                            Check
                        </button>
                        <button onclick="showSteps()" style="padding: 10px 30px; margin: 5px; 
                                background: #FFD700; color: black; border: none; border-radius: 5px; 
                                cursor: pointer; font-size: 1rem;">
                            Show Steps
                        </button>
                        <button onclick="generateRandomProblem()" style="padding: 10px 30px; margin: 5px; 
                                background: #9B59B6; color: white; border: none; border-radius: 5px; 
                                cursor: pointer; font-size: 1rem;">
                            New Problem
                        </button>
                    </div>
                </div>
                
                <!-- Steps will appear here -->
                <div id="practice-steps" style="margin-top: 20px;"></div>
            `;
            
            // Focus on answer input
            document.getElementById('practice-answer').focus();
        }
        
        function checkPracticeAnswer() {
            if (!currentPracticeProblem) return;
            
            const userAnswer = parseInt(document.getElementById('practice-answer').value);
            const feedback = document.getElementById('practice-feedback');
            
            if (userAnswer === currentPracticeProblem.answer) {
                feedback.innerHTML = `
                    <div style="background: rgba(76, 175, 80, 0.2); border: 2px solid #4CAF50; 
                                padding: 15px; border-radius: 10px; margin-top: 10px; text-align: center;">
                        <span style="color: #4CAF50; font-size: 1.5rem;">✓ Correct!</span>
                        <div style="color: white; margin-top: 10px;">
                            ${currentPracticeProblem.num1} × ${currentPracticeProblem.num2} = ${currentPracticeProblem.answer}
                        </div>
                    </div>
                `;
                
                // Auto-generate new problem after 2 seconds
                setTimeout(() => {
                    generateRandomProblem();
                    feedback.innerHTML = '';
                }, 2000);
            } else {
                feedback.innerHTML = `
                    <div style="background: rgba(244, 67, 54, 0.2); border: 2px solid #F44336; 
                                padding: 15px; border-radius: 10px; margin-top: 10px; text-align: center;">
                        <span style="color: #F44336; font-size: 1.5rem;">✗ Try Again</span>
                        <div style="color: #ccc; margin-top: 10px;">
                            ${userAnswer > currentPracticeProblem.answer ? 'Your answer is too high' : 'Your answer is too low'}
                        </div>
                    </div>
                `;
            }
        }
        
        function showSteps() {
            if (!currentPracticeProblem) return;
            
            const { num1, num2, answer } = currentPracticeProblem;
            const stepsDiv = document.getElementById('practice-steps');
            
            // For single-digit multiplier
            if (num2 < 10) {
                const onesDigit = num1 % 10;
                const tensDigit = Math.floor((num1 % 100) / 10);
                const hundredsDigit = Math.floor(num1 / 100);
                
                const onesProduct = onesDigit * num2;
                const onesResult = onesProduct % 10;
                const onesCarry = Math.floor(onesProduct / 10);
                
                let stepsHTML = `
                    <div style="background: rgba(155, 89, 182, 0.1); border: 2px solid #9B59B6; 
                                padding: 20px; border-radius: 10px;">
                        <h4 style="color: #9B59B6;">Step-by-Step Solution:</h4>
                `;
                
                // Step 1: Multiply ones
                stepsHTML += `
                    <div style="margin: 10px 0; color: #ccc;">
                        <strong>Step 1:</strong> ${num2} × ${onesDigit} = ${onesProduct}
                        <br>Write ${onesResult}, carry ${onesCarry}
                    </div>
                `;
                
                if (tensDigit > 0 || hundredsDigit > 0) {
                    const tensProduct = tensDigit * num2 + onesCarry;
                    const tensResult = tensProduct % 10;
                    const tensCarry = Math.floor(tensProduct / 10);
                    
                    stepsHTML += `
                        <div style="margin: 10px 0; color: #ccc;">
                            <strong>Step 2:</strong> ${num2} × ${tensDigit} = ${tensDigit * num2}
                            <br>Add carry ${onesCarry}: ${tensDigit * num2} + ${onesCarry} = ${tensProduct}
                            <br>Write ${tensResult}, carry ${tensCarry}
                        </div>
                    `;
                    
                    if (hundredsDigit > 0) {
                        const hundredsProduct = hundredsDigit * num2 + tensCarry;
                        stepsHTML += `
                            <div style="margin: 10px 0; color: #ccc;">
                                <strong>Step 3:</strong> ${num2} × ${hundredsDigit} = ${hundredsDigit * num2}
                                <br>Add carry ${tensCarry}: ${hundredsDigit * num2} + ${tensCarry} = ${hundredsProduct}
                            </div>
                        `;
                    }
                }
                
                stepsHTML += `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #666; color: #4ECDC4;">
                        <strong>Answer:</strong> ${answer}
                    </div>
                </div>
                `;
                
                stepsDiv.innerHTML = stepsHTML;
            } else {
                // For two-digit multiplier, show partial products
                stepsDiv.innerHTML = `
                    <div style="background: rgba(155, 89, 182, 0.1); border: 2px solid #9B59B6; 
                                padding: 20px; border-radius: 10px;">
                        <h4 style="color: #9B59B6;">For ${num1} × ${num2}:</h4>
                        <div style="color: #ccc;">
                            <div>1. ${num1} × ${num2 % 10} = ${num1 * (num2 % 10)}</div>
                            <div>2. ${num1} × ${Math.floor(num2/10)}0 = ${num1 * Math.floor(num2/10) * 10}</div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #666;">
                                3. Add: ${num1 * (num2 % 10)} + ${num1 * Math.floor(num2/10) * 10} = ${answer}
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        
        function initializeTimesTable() {
            updateTimesTable();
            updateSpeedLeaderboard();
        }
        
        function updateTimesTable() {
            const size = parseInt(document.getElementById('tt-size').value);
            const highlightMode = document.getElementById('tt-highlight').value;
            const colorMode = document.getElementById('tt-color').value;
            
            const grid = document.getElementById('timestables-grid');
            grid.innerHTML = '';
            
            // Create table
            const table = document.createElement('table');
            table.style.borderCollapse = 'collapse';
            
            // Create header row
            const headerRow = document.createElement('tr');
            const emptyCell = document.createElement('td');
            emptyCell.className = 'tt-cell tt-header';
            emptyCell.textContent = '×';
            headerRow.appendChild(emptyCell);
            
            for (let i = 1; i <= size; i++) {
                const th = document.createElement('td');
                th.className = 'tt-cell tt-header';
                th.textContent = i;
                headerRow.appendChild(th);
            }
            table.appendChild(headerRow);
            
            // Create data rows
            for (let row = 1; row <= size; row++) {
                const tr = document.createElement('tr');
                
                // Row header
                const rowHeader = document.createElement('td');
                rowHeader.className = 'tt-cell tt-header';
                rowHeader.textContent = row;
                tr.appendChild(rowHeader);
                
                // Data cells
                for (let col = 1; col <= size; col++) {
                    const td = document.createElement('td');
                    const product = row * col;
                    td.className = 'tt-cell';
                    td.textContent = product;
                    td.dataset.row = row;
                    td.dataset.col = col;
                    td.dataset.product = product;
                    
                    // Apply color based on mode
                    if (colorMode === 'gradient') {
                        const maxProduct = size * size;
                        const ratio = product / maxProduct;
                        const hue = 180 - (ratio * 180); // From cyan to red
                        td.style.backgroundColor = `hsla(${hue}, 70%, 50%, 0.3)`;
                        td.style.color = 'white';
                    } else if (colorMode === 'patterns') {
                        const lastDigit = product % 10;
                        const colors = ['#FF6B6B', '#4ECDC4', '#FFD700', '#9B59B6', '#4CAF50', 
                                      '#FF9800', '#2196F3', '#E91E63', '#00BCD4', '#8BC34A'];
                        td.style.backgroundColor = colors[lastDigit] + '33';
                        td.style.color = colors[lastDigit];
                    } else {
                        td.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
                        td.style.color = 'white';
                    }
                    
                    // Apply pattern highlights
                    if (highlightMode !== 'none') {
                        if (highlightMode === 'diagonal' && row === col) {
                            td.classList.add('pattern-highlight');
                        } else if (highlightMode === 'even' && product % 2 === 0) {
                            td.classList.add('pattern-highlight');
                        } else if (highlightMode === 'odd' && product % 2 === 1) {
                            td.classList.add('pattern-highlight');
                        } else if (highlightMode === 'fives' && product % 5 === 0) {
                            td.classList.add('pattern-highlight');
                        } else if (highlightMode === 'tens' && product % 10 === 0) {
                            td.classList.add('pattern-highlight');
                        } else if (highlightMode === 'primes' && isPrime(product)) {
                            td.classList.add('pattern-highlight');
                        }
                    }
                    
                    // Add event listeners
                    td.addEventListener('mouseenter', function() {
                        showMultiplication(row, col, product);
                        highlightRowCol(row, col, false);
                    });
                    
                    td.addEventListener('mouseleave', function() {
                        if (!ttLockedCell || ttLockedCell !== this) {
                            clearHighlight();
                        }
                    });
                    
                    td.addEventListener('click', function() {
                        if (ttLockedCell === this) {
                            ttLockedCell = null;
                            this.classList.remove('locked');
                        } else {
                            if (ttLockedCell) {
                                ttLockedCell.classList.remove('locked');
                            }
                            ttLockedCell = this;
                            this.classList.add('locked');
                            highlightRowCol(row, col, true);
                        }
                    });
                    
                    tr.appendChild(td);
                }
                table.appendChild(tr);
            }
            
            grid.appendChild(table);
        }
        
        function isPrime(n) {
            if (n <= 1) return false;
            if (n <= 3) return true;
            if (n % 2 === 0 || n % 3 === 0) return false;
            let i = 5;
            while (i * i <= n) {
                if (n % i === 0 || n % (i + 2) === 0) return false;
                i += 6;
            }
            return true;
        }
        
        function showMultiplication(row, col, product) {
            const info = document.getElementById('tt-hover-info');
            info.textContent = `${row} × ${col} = ${product}`;
        }
        
        function highlightRowCol(row, col, locked) {
            if (!locked) {
                clearHighlight();
            }
            
            const cells = document.querySelectorAll('.tt-cell:not(.tt-header)');
            cells.forEach(cell => {
                if (cell.dataset.row == row && cell.dataset.col == col) {
                    cell.classList.add('highlighted-both');
                } else if (cell.dataset.row == row) {
                    cell.classList.add('highlighted-row');
                } else if (cell.dataset.col == col) {
                    cell.classList.add('highlighted-col');
                }
            });
        }
        
        function clearHighlight() {
            if (ttLockedCell) return;
            
            const cells = document.querySelectorAll('.tt-cell');
            cells.forEach(cell => {
                cell.classList.remove('highlighted-row', 'highlighted-col', 'highlighted-both');
            });
            
            const info = document.getElementById('tt-hover-info');
            info.textContent = 'Hover over a cell to see the multiplication';
        }

        // Balance Tool Variables
        let mysteryObjects = [];
        let leftPlatformObjects = [];
        let rightPlatformObjects = [];
        let sequenceSlots = [];
        let correctSequence = [];
        let draggedObject = null;
        let comparisonCount = 0;

        function toggleCategory(category) {
            const dropdown = document.getElementById(category + '-dropdown');
            const allDropdowns = document.querySelectorAll('.nav-dropdown');
            
            // Close all other dropdowns
            allDropdowns.forEach(dd => {
                if (dd !== dropdown) {
                    dd.classList.remove('active');
                }
            });
            
            // Toggle current dropdown
            dropdown.classList.toggle('active');
        }
        
        function switchTool(tool) {
            // Hide all tools
            document.querySelectorAll('.tool-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active from all tool buttons
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Close all dropdowns
            document.querySelectorAll('.nav-dropdown').forEach(dd => {
                dd.classList.remove('active');
            });
            
            // Mark the clicked tool button as active
            const activeBtn = document.querySelector(`[onclick*="switchTool('${tool}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // Show selected tool
            const toolElement = document.getElementById(tool + '-tool');
            if (toolElement) {
                toolElement.classList.add('active');
                
                // Initialize tools that need setup
                if (tool === 'tt-wordproblems' && !currentWordProblem) {
                    generateWordProblem();
                }
                if (tool === 'placevaluegame') {
                    // Initialize Place Value Game
                    if (document.getElementById('pv-breakdown-mode').classList.contains('active')) {
                        newPVProblem();
                    }
                }
                if (tool === 'tt-grid' && !document.getElementById('times-grid').innerHTML) {
                    generateTimesGrid();
                }
                if (tool === 'venndiagram') {
                    initializeVennDiagram();
                }
                if (tool === 'clock') {
                    initializeClock();
                }
                if (tool === 'dailydrill') {
                    initializeDailyDrill();
                }
                if (tool === 'shapes3d') {
                    initialize3DShapes();
                }
                if (tool === 'money') {
                    initializeMoney();
                }
            } else {
                // Tool not yet implemented - show placeholder
                showPlaceholder(tool);
            }
        }
        
        function showPlaceholder(toolName) {
            // Create or get placeholder div
            let placeholder = document.getElementById('placeholder-tool');
            if (!placeholder) {
                placeholder = document.createElement('div');
                placeholder.id = 'placeholder-tool';
                placeholder.className = 'tool-content';
                document.querySelector('.container').appendChild(placeholder);
            }
            
            placeholder.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #4ECDC4;">
                    <h2>🚧 ${toolName.charAt(0).toUpperCase() + toolName.slice(1)} Tool</h2>
                    <p style="color: #ccc; margin-top: 20px;">This tool is coming soon!</p>
                    <p style="color: #999; margin-top: 10px;">We're working hard to bring you all the mathematical visualization tools.</p>
                </div>
            `;
            
            placeholder.classList.add('active');
        }

        // Balance Tool Functions
        function initializeBalance() {
            console.log('Initializing balance tool...');
            newBalancePuzzle();
        }

        function createMysteryObject(id, weight, emoji, color, name) {
            return {
                id: id,
                weight: weight,
                emoji: emoji,
                color: color,
                name: name,
                element: null
            };
        }
        
        function getObjectName(emoji) {
            const names = {
                '🎾': 'Tennis Ball', '⚽': 'Soccer Ball', '🏀': 'Basketball',
                '🎱': '8-Ball', '🏓': 'Ping Pong', '🏈': 'Football',
                '⚾': 'Baseball', '🏐': 'Volleyball', '🍎': 'Apple',
                '🍊': 'Orange', '🍌': 'Banana', '🍇': 'Grapes',
                '🍓': 'Strawberry', '🍉': 'Watermelon', '🥝': 'Kiwi',
                '🍑': 'Peach', '🎲': 'Dice', '💎': 'Gem',
                '🔮': 'Crystal Ball', '🎯': 'Target', '🧲': 'Magnet',
                '💡': 'Light Bulb', '🔔': 'Bell', '⭐': 'Star',
                '🌟': 'Shiny Star', '☀️': 'Sun', '🌙': 'Moon',
                '💫': 'Comet', '🪨': 'Rock', '🌰': 'Chestnut',
                '🧊': 'Ice Cube', '🍭': 'Lollipop', '🍬': 'Candy',
                '🏆': 'Trophy', '🎨': 'Art Palette', '🎭': 'Masks'
            };
            return names[emoji] || 'Object';
        }

        function newBalancePuzzle() {
            // Clear everything
            mysteryObjects = [];
            leftPlatformObjects = [];
            rightPlatformObjects = [];
            sequenceSlots = [];
            correctSequence = [];
            hintLevel = 0; // Reset hint level
            comparisonCount = 0; // Reset comparison counter
            
            // Reset displays
            const historyEl = document.getElementById('history-entries');
            const currentDiscoveryEl = document.getElementById('current-discovery');
            const feedbackEl = document.getElementById('balance-feedback');
            const hintEl = document.getElementById('hint-display');
            
            if (historyEl) historyEl.innerHTML = '';
            if (currentDiscoveryEl) currentDiscoveryEl.innerHTML = '<div class="discovery-placeholder">Compare objects to see result here</div>';
            if (feedbackEl) {
                feedbackEl.style.display = 'none';
                feedbackEl.className = 'balance-feedback';
            }
            if (hintEl) {
                hintEl.style.display = 'none';
                hintEl.className = 'hint-display';
            }
            
            // Objects with realistic relative weights (in grams)
            const allObjectTypes = [
                // Very Light (1-20g)
                { emoji: '🏓', color: '#FFA500', weight: 3 },     // Ping pong ball ~3g
                { emoji: '🍓', color: '#FF69B4', weight: 12 },    // Strawberry ~12g
                { emoji: '🍇', color: '#7B68EE', weight: 5 },     // Single grape ~5g
                { emoji: '🎲', color: '#DC143C', weight: 8 },     // Dice ~8g
                { emoji: '🍬', color: '#FF1493', weight: 10 },    // Candy ~10g
                { emoji: '🌰', color: '#8B4513', weight: 15 },    // Chestnut ~15g
                { emoji: '🍭', color: '#FF69B4', weight: 20 },    // Lollipop ~20g
                { emoji: '💎', color: '#00CED1', weight: 10 },    // Small gem ~10g
                
                // Light (50-100g)
                { emoji: '🎾', color: '#9ACD32', weight: 58 },    // Tennis ball ~58g
                { emoji: '🥝', color: '#8FBC8F', weight: 75 },    // Kiwi ~75g
                { emoji: '💡', color: '#FFFF00', weight: 60 },    // Light bulb ~60g
                { emoji: '🧊', color: '#E0FFFF', weight: 50 },    // Ice cube ~50g
                
                // Medium Light (100-200g)
                { emoji: '🍌', color: '#FFE135', weight: 120 },   // Banana ~120g
                { emoji: '🎱', color: '#000000', weight: 170 },   // 8-ball ~170g
                { emoji: '🍎', color: '#FF0000', weight: 180 },   // Apple ~180g
                { emoji: '🍊', color: '#FFA500', weight: 150 },   // Orange ~150g
                { emoji: '🍑', color: '#FFDAB9', weight: 175 },   // Peach ~175g
                { emoji: '⚾', color: '#F0E68C', weight: 145 },   // Baseball ~145g
                
                // Medium (200-500g)
                { emoji: '🏈', color: '#8B4513', weight: 400 },   // Football ~400g
                { emoji: '⚽', color: '#FFFFFF', weight: 430 },   // Soccer ball ~430g
                { emoji: '🏐', color: '#E6E6FA', weight: 270 },   // Volleyball ~270g
                { emoji: '🎯', color: '#FF4500', weight: 300 },   // Target board ~300g
                { emoji: '🔔', color: '#FFD700', weight: 250 },   // Bell ~250g
                { emoji: '🎨', color: '#FF69B4', weight: 350 },   // Art palette ~350g
                { emoji: '🎭', color: '#DAA520', weight: 200 },   // Masks ~200g
                
                // Heavy (500-1000g)
                { emoji: '🏀', color: '#FF6347', weight: 620 },   // Basketball ~620g
                { emoji: '🔮', color: '#9370DB', weight: 800 },   // Crystal ball ~800g
                { emoji: '🧲', color: '#708090', weight: 750 },   // Magnet ~750g
                { emoji: '🏆', color: '#FFD700', weight: 900 },   // Trophy ~900g
                
                // Very Heavy (1000g+)
                { emoji: '🍉', color: '#FF6B6B', weight: 2000 },  // Small watermelon ~2kg
                { emoji: '🪨', color: '#808080', weight: 1500 },  // Rock ~1.5kg
                
                // Note: Sun, Moon, Stars excluded as they're not physical objects we can weigh
            ];
            
            // Select objects ensuring variety across weight categories
            const categories = {
                veryLight: allObjectTypes.filter(o => o.weight <= 20),
                light: allObjectTypes.filter(o => o.weight > 20 && o.weight <= 100),
                mediumLight: allObjectTypes.filter(o => o.weight > 100 && o.weight <= 200),
                medium: allObjectTypes.filter(o => o.weight > 200 && o.weight <= 500),
                heavy: allObjectTypes.filter(o => o.weight > 500 && o.weight <= 1000),
                veryHeavy: allObjectTypes.filter(o => o.weight > 1000)
            };
            
            // Pick objects from different categories to ensure variety
            const selectedObjects = [];
            const categoryNames = Object.keys(categories);
            const usedCategories = [];
            
            // Select 5 objects, trying to get variety
            while (selectedObjects.length < 5) {
                // Pick a random category
                const availableCategories = categoryNames.filter(cat => 
                    categories[cat].length > 0 && 
                    (usedCategories.filter(c => c === cat).length < 2) // Max 2 from same category
                );
                
                if (availableCategories.length === 0) break;
                
                const categoryName = availableCategories[Math.floor(Math.random() * availableCategories.length)];
                const category = categories[categoryName];
                
                // Pick a random object from this category
                const randomIndex = Math.floor(Math.random() * category.length);
                const selectedObject = category[randomIndex];
                
                // Add to selected and remove from category
                selectedObjects.push(selectedObject);
                usedCategories.push(categoryName);
                category.splice(randomIndex, 1);
            }
            
            // Shuffle the selected objects
            const shuffledSelected = [...selectedObjects].sort(() => Math.random() - 0.5);
            
            shuffledSelected.forEach((type, index) => {
                const obj = createMysteryObject(
                    index,
                    type.weight,
                    type.emoji,
                    type.color,
                    getObjectName(type.emoji)
                );
                mysteryObjects.push(obj);
            });
            
            // Sort for correct answer
            correctSequence = [...mysteryObjects].sort((a, b) => a.weight - b.weight);
            
            // Render objects on shelf
            renderObjectShelf();
            
            // Create sequence slots
            renderSequenceSlots();
            
            // Reset balance
            updateBalance();
        }

        function renderObjectShelf() {
            const shelf = document.getElementById('objects-shelf');
            shelf.innerHTML = '';
            
            mysteryObjects.forEach(obj => {
                const element = document.createElement('div');
                element.className = 'mystery-object';
                element.dataset.id = obj.id;
                element.dataset.location = 'shelf';
                element.draggable = true;
                
                // Create icon and label
                element.innerHTML = `
                    <div class="object-icon" style="background: radial-gradient(circle, ${obj.color}, ${obj.color}88)">
                        ${obj.emoji}
                    </div>
                    <div class="object-label">${obj.name}</div>
                `;
                
                // Drag events
                element.addEventListener('dragstart', handleDragStart);
                element.addEventListener('dragend', handleDragEnd);
                
                obj.element = element;
                shelf.appendChild(element);
            });
            
            // Add drop zones to platforms
            setupPlatformDropZones();
        }
        
        function setupPlatformDropZones() {
            const leftPlatform = document.getElementById('left-objects');
            const rightPlatform = document.getElementById('right-objects');
            const shelf = document.getElementById('objects-shelf');
            
            // Left platform drop events
            leftPlatform.addEventListener('dragover', handleDragOver);
            leftPlatform.addEventListener('dragenter', function(e) {
                this.classList.add('drag-over');
            });
            leftPlatform.addEventListener('dragleave', function(e) {
                this.classList.remove('drag-over');
            });
            leftPlatform.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                if (draggedObject) {
                    addToScale(draggedObject, 'left');
                }
            });
            
            // Right platform drop events
            rightPlatform.addEventListener('dragover', handleDragOver);
            rightPlatform.addEventListener('dragenter', function(e) {
                this.classList.add('drag-over');
            });
            rightPlatform.addEventListener('dragleave', function(e) {
                this.classList.remove('drag-over');
            });
            rightPlatform.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                if (draggedObject) {
                    addToScale(draggedObject, 'right');
                }
            });
            
            // Shelf drop events (to return objects)
            shelf.addEventListener('dragover', handleDragOver);
            shelf.addEventListener('drop', function(e) {
                e.preventDefault();
                if (draggedObject) {
                    returnToShelf(draggedObject);
                }
            });
        }

        function renderSequenceSlots() {
            const container = document.getElementById('sequence-slots');
            container.innerHTML = '';
            sequenceSlots = [];
            
            for (let i = 0; i < mysteryObjects.length; i++) {
                const slot = document.createElement('div');
                slot.className = 'sequence-slot';
                slot.dataset.index = i;
                
                const label = document.createElement('div');
                label.className = 'slot-label';
                label.textContent = i === 0 ? 'Lightest' : i === mysteryObjects.length - 1 ? 'Heaviest' : '';
                slot.appendChild(label);
                
                // Drop events
                slot.addEventListener('dragover', handleDragOver);
                slot.addEventListener('dragenter', function(e) {
                    this.classList.add('drag-over');
                });
                slot.addEventListener('dragleave', function(e) {
                    this.classList.remove('drag-over');
                });
                slot.addEventListener('drop', function(e) {
                    this.classList.remove('drag-over');
                    handleDropOnSlot(e);
                });
                
                container.appendChild(slot);
                sequenceSlots.push({ element: slot, object: null });
            }
        }

        function handleDragStart(e) {
            const id = parseInt(e.target.dataset.id);
            draggedObject = mysteryObjects.find(obj => obj.id === id);
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedObject = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDropOnSlot(e) {
            e.preventDefault();
            if (!draggedObject) return;
            
            const slotIndex = parseInt(e.currentTarget.dataset.index);
            const targetSlot = sequenceSlots[slotIndex];
            
            // If target slot already has an object, swap them
            const targetObject = targetSlot.object;
            let sourceSlot = null;
            
            // Find the source slot if dragging from another slot
            sequenceSlots.forEach(s => {
                if (s.object && s.object.id === draggedObject.id) {
                    sourceSlot = s;
                }
            });
            
            if (targetObject && sourceSlot) {
                // Swap objects between slots
                sourceSlot.object = targetObject;
                renderSlotContent(sourceSlot, sequenceSlots.indexOf(sourceSlot));
            } else if (sourceSlot) {
                // Just clear the source slot
                sourceSlot.object = null;
                renderSlotContent(sourceSlot, sequenceSlots.indexOf(sourceSlot));
            }
            
            // Place dragged object in target slot
            targetSlot.object = draggedObject;
            renderSlotContent(targetSlot, slotIndex);
        }
        
        function renderSlotContent(slot, index) {
            slot.element.innerHTML = '';
            slot.element.style.borderColor = ''; // Reset border color
            slot.element.style.background = ''; // Reset background
            
            if (slot.object) {
                const objElement = document.createElement('div');
                objElement.className = 'mystery-object on-scale';
                objElement.dataset.id = slot.object.id;
                objElement.draggable = true;
                
                objElement.innerHTML = `
                    <div class="object-icon" style="background: radial-gradient(circle, ${slot.object.color}, ${slot.object.color}88)">
                        ${slot.object.emoji}
                    </div>
                    <div class="object-label">${slot.object.name}</div>
                `;
                
                // Make objects in slots draggable
                objElement.addEventListener('dragstart', handleDragStart);
                objElement.addEventListener('dragend', handleDragEnd);
                
                // Double-click to remove from slot
                objElement.addEventListener('dblclick', function() {
                    slot.object = null;
                    renderSlotContent(slot, index);
                });
                
                slot.element.appendChild(objElement);
                slot.element.classList.add('filled');
            } else {
                slot.element.classList.remove('filled');
            }
            
            // Always add label
            const label = document.createElement('div');
            label.className = 'slot-label';
            label.textContent = index === 0 ? 'Lightest' : index === mysteryObjects.length - 1 ? 'Heaviest' : '';
            slot.element.appendChild(label);
        }

        function addToScale(object, side) {
            if (side === 'left') {
                // Check if already on left
                if (leftPlatformObjects.find(obj => obj.id === object.id)) return;
                
                // Remove from right if there
                rightPlatformObjects = rightPlatformObjects.filter(obj => obj.id !== object.id);
                
                leftPlatformObjects.push(object);
            } else {
                // Check if already on right
                if (rightPlatformObjects.find(obj => obj.id === object.id)) return;
                
                // Remove from left if there
                leftPlatformObjects = leftPlatformObjects.filter(obj => obj.id !== object.id);
                
                rightPlatformObjects.push(object);
            }
            
            renderPlatformObjects();
            updateBalance();
            logComparison();
        }

        function renderPlatformObjects() {
            const leftContainer = document.getElementById('left-objects');
            const rightContainer = document.getElementById('right-objects');
            
            leftContainer.innerHTML = '';
            rightContainer.innerHTML = '';
            
            leftPlatformObjects.forEach(obj => {
                const element = document.createElement('div');
                element.className = 'mystery-object on-scale';
                element.dataset.id = obj.id;
                element.dataset.location = 'left';
                element.draggable = true;
                
                element.innerHTML = `
                    <div class="object-icon" style="background: radial-gradient(circle, ${obj.color}, ${obj.color}88)">
                        ${obj.emoji}
                    </div>
                    <div class="object-label">${obj.name}</div>
                `;
                
                // Make draggable between platforms
                element.addEventListener('dragstart', handleDragStart);
                element.addEventListener('dragend', handleDragEnd);
                element.addEventListener('dblclick', () => removeFromScale(obj, 'left'));
                
                leftContainer.appendChild(element);
            });
            
            rightPlatformObjects.forEach(obj => {
                const element = document.createElement('div');
                element.className = 'mystery-object on-scale';
                element.dataset.id = obj.id;
                element.dataset.location = 'right';
                element.draggable = true;
                
                element.innerHTML = `
                    <div class="object-icon" style="background: radial-gradient(circle, ${obj.color}, ${obj.color}88)">
                        ${obj.emoji}
                    </div>
                    <div class="object-label">${obj.name}</div>
                `;
                
                // Make draggable between platforms
                element.addEventListener('dragstart', handleDragStart);
                element.addEventListener('dragend', handleDragEnd);
                element.addEventListener('dblclick', () => removeFromScale(obj, 'right'));
                
                rightContainer.appendChild(element);
            });
        }
        
        function returnToShelf(object) {
            // Remove from both platforms
            leftPlatformObjects = leftPlatformObjects.filter(obj => obj.id !== object.id);
            rightPlatformObjects = rightPlatformObjects.filter(obj => obj.id !== object.id);
            
            renderPlatformObjects();
            updateBalance();
        }

        function removeFromScale(object, side) {
            if (side === 'left') {
                leftPlatformObjects = leftPlatformObjects.filter(obj => obj.id !== object.id);
            } else {
                rightPlatformObjects = rightPlatformObjects.filter(obj => obj.id !== object.id);
            }
            renderPlatformObjects();
            updateBalance();
        }

        function updateBalance() {
            const leftWeight = leftPlatformObjects.reduce((sum, obj) => sum + obj.weight, 0);
            const rightWeight = rightPlatformObjects.reduce((sum, obj) => sum + obj.weight, 0);
            
            const beam = document.getElementById('beam');
            const leftPlatform = document.getElementById('left-platform');
            const rightPlatform = document.getElementById('right-platform');
            
            // Remove all classes
            beam.className = 'beam';
            leftPlatform.className = 'scale-platform left-platform';
            rightPlatform.className = 'scale-platform right-platform';
            
            if (leftWeight > rightWeight) {
                beam.classList.add('tilt-left');
                leftPlatform.classList.add('down');
                rightPlatform.classList.add('up');
            } else if (rightWeight > leftWeight) {
                beam.classList.add('tilt-right');
                rightPlatform.classList.add('down');
                leftPlatform.classList.add('up');
            } else {
                beam.classList.add('balanced');
            }
        }

        let logEntryId = 0;
        let currentComparison = null;
        
        function logComparison() {
            if (leftPlatformObjects.length === 0 || rightPlatformObjects.length === 0) return;
            
            comparisonCount++;
            updateComparisonCounter();
            
            const leftWeight = leftPlatformObjects.reduce((sum, obj) => sum + obj.weight, 0);
            const rightWeight = rightPlatformObjects.reduce((sum, obj) => sum + obj.weight, 0);
            
            // Get names for objects (simplified)
            const getObjectName = (emoji) => {
                const names = {
                    '🎾': 'tennis ball', '⚽': 'soccer ball', '🏀': 'basketball',
                    '🎱': '8-ball', '🏓': 'ping pong', '🏈': 'football',
                    '⚾': 'baseball', '🏐': 'volleyball', '🍎': 'apple',
                    '🍊': 'orange', '🍌': 'banana', '🍇': 'grapes',
                    '🍓': 'strawberry', '🍉': 'watermelon', '🥝': 'kiwi',
                    '🍑': 'peach', '🎲': 'dice', '💎': 'gem',
                    '🔮': 'crystal ball', '🎯': 'target', '🧲': 'magnet',
                    '💡': 'light bulb', '🔔': 'bell', '⭐': 'star',
                    '🌟': 'star', '☀️': 'sun', '🌙': 'moon',
                    '💫': 'comet', '🪨': 'rock', '🌰': 'chestnut',
                    '🧊': 'ice', '🍭': 'lollipop', '🍬': 'candy',
                    '🏆': 'trophy', '🎨': 'palette', '🎭': 'masks'
                };
                return names[emoji] || 'object';
            };
            
            // Create descriptive text
            let comparison, inverseComparison;
            const leftName = leftPlatformObjects.length === 1 
                ? getObjectName(leftPlatformObjects[0].emoji) 
                : `${leftPlatformObjects.length} objects`;
            const rightName = rightPlatformObjects.length === 1 
                ? getObjectName(rightPlatformObjects[0].emoji) 
                : `${rightPlatformObjects.length} objects`;
            
            const leftItems = leftPlatformObjects.map(obj => 
                `<div class="discovery-item">
                    <span class="emoji">${obj.emoji}</span>
                    <span class="item-label">${obj.name}</span>
                </div>`
            ).join('');
            const rightItems = rightPlatformObjects.map(obj => 
                `<div class="discovery-item">
                    <span class="emoji">${obj.emoji}</span>
                    <span class="item-label">${obj.name}</span>
                </div>`
            ).join('');
            
            if (leftWeight > rightWeight) {
                comparison = `<div class="left-objects">${leftItems}</div><span class="relation"><div class="relation-text">HEAVIER</div><div class="relation-symbol">></div></span><div class="right-objects">${rightItems}</div>`;
                inverseComparison = `<div class="left-objects">${rightItems}</div><span class="relation"><div class="relation-text">LIGHTER</div><div class="relation-symbol"><</div></span><div class="right-objects">${leftItems}</div>`;
            } else if (leftWeight < rightWeight) {
                comparison = `<div class="left-objects">${leftItems}</div><span class="relation"><div class="relation-text">LIGHTER</div><div class="relation-symbol"><</div></span><div class="right-objects">${rightItems}</div>`;
                inverseComparison = `<div class="left-objects">${rightItems}</div><span class="relation"><div class="relation-text">HEAVIER</div><div class="relation-symbol">></div></span><div class="right-objects">${leftItems}</div>`;
            } else {
                comparison = `<div class="left-objects">${leftItems}</div><span class="relation"><div class="relation-text">EQUAL</div><div class="relation-symbol">=</div></span><div class="right-objects">${rightItems}</div>`;
                inverseComparison = comparison; // Same for equal weights
            }
            
            // Update current discovery display
            updateCurrentDiscovery(comparison, inverseComparison);
            
            // If there was a previous comparison, add it to history
            if (currentComparison) {
                addToHistory(currentComparison);
            }
            
            // Store the current comparison
            currentComparison = {
                normal: comparison,
                inverse: inverseComparison,
                id: logEntryId++
            };
        }
        
        function updateCurrentDiscovery(comparison, inverseComparison) {
            const currentDiscoveryDiv = document.getElementById('current-discovery');
            
            const discoveryContent = document.createElement('div');
            discoveryContent.className = 'discovery-content';
            discoveryContent.innerHTML = comparison;
            
            // Add flip button for current discovery
            const flipBtn = document.createElement('button');
            flipBtn.className = 'flip-btn';
            flipBtn.innerHTML = '↔️';
            flipBtn.onclick = function() {
                const isFlipped = discoveryContent.classList.contains('flipped');
                if (isFlipped) {
                    discoveryContent.classList.remove('flipped');
                    discoveryContent.innerHTML = comparison;
                } else {
                    discoveryContent.classList.add('flipped');
                    discoveryContent.innerHTML = inverseComparison;
                }
                discoveryContent.appendChild(flipBtn);
            };
            
            discoveryContent.appendChild(flipBtn);
            currentDiscoveryDiv.innerHTML = '';
            currentDiscoveryDiv.appendChild(discoveryContent);
        }
        
        function addToHistory(comparison) {
            const historyContainer = document.getElementById('history-entries');
            
            const historyEntry = document.createElement('div');
            historyEntry.className = 'history-entry';
            // Simplify for history - just show emojis and symbols
            const simplified = comparison.normal.replace(/<div class="discovery-item">.*?<span class="emoji">(.*?)<\/span>.*?<\/div>/g, '<span class="emoji">$1</span>');
            historyEntry.innerHTML = simplified;
            
            historyContainer.insertBefore(historyEntry, historyContainer.firstChild);
            
            // Limit history entries
            while (historyContainer.children.length > 10) {
                historyContainer.removeChild(historyContainer.lastChild);
            }
        }
        
        function updateComparisonCounter() {
            const counter = document.getElementById('comparison-counter');
            if (counter) {
                counter.textContent = `Comparisons: ${comparisonCount}`;
            }
        }

        function checkSequence() {
            const userSequence = sequenceSlots
                .filter(slot => slot.object !== null)
                .map(slot => slot.object.id);
            
            const correctIds = correctSequence.map(obj => obj.id);
            
            const feedback = document.getElementById('balance-feedback');
            feedback.style.display = 'block';
            
            if (userSequence.length === 0) {
                feedback.textContent = '❌ Please drag objects to the sequence slots below!';
                feedback.className = 'balance-feedback incorrect show';
                return;
            }
            
            if (userSequence.length !== correctIds.length) {
                feedback.textContent = `❌ Please arrange all ${correctIds.length} objects in order! You have ${userSequence.length} so far.`;
                feedback.className = 'balance-feedback incorrect show';
                return;
            }
            
            const isCorrect = userSequence.every((id, index) => id === correctIds[index]);
            
            if (isCorrect) {
                feedback.innerHTML = '🎉 <strong>Perfect!</strong> You found the correct weight order!<br>';
                feedback.className = 'balance-feedback correct show';
                
                // Show actual weights
                const weightDisplay = correctSequence.map(obj => 
                    `${obj.emoji}(${obj.weight}g)`
                ).join(' < ');
                feedback.innerHTML += weightDisplay;
                
                // Highlight correct slots
                sequenceSlots.forEach(slot => {
                    if (slot.element) {
                        slot.element.style.borderColor = '#4CAF50';
                        slot.element.style.background = 'rgba(76, 175, 80, 0.1)';
                    }
                });
            } else {
                // Count how many are correct
                let correctCount = 0;
                userSequence.forEach((id, index) => {
                    if (id === correctIds[index]) correctCount++;
                });
                
                feedback.innerHTML = `❌ Not quite right. You have ${correctCount}/${correctIds.length} in the correct position.<br>`;
                feedback.innerHTML += 'Keep comparing the objects on the balance!';
                feedback.className = 'balance-feedback incorrect show';
                
                // Show which ones are right/wrong
                sequenceSlots.forEach((slot, index) => {
                    if (slot.object && slot.element) {
                        if (slot.object.id === correctIds[index]) {
                            slot.element.style.borderColor = '#4CAF50';
                        } else {
                            slot.element.style.borderColor = '#F44336';
                        }
                    }
                });
            }
        }
        
        let hintLevel = 0;
        
        function getHint() {
            const hintDisplay = document.getElementById('hint-display');
            hintDisplay.style.display = 'block';
            hintDisplay.className = 'hint-display show';
            
            const hints = [
                '💡 Start by comparing two objects at a time on the balance.',
                '💡 Try to find the lightest object by comparing it with all others.',
                '💡 Once you find the lightest, find the second lightest!',
                `💡 The lightest object is: ${correctSequence[0].emoji}`,
                `💡 The heaviest object is: ${correctSequence[correctSequence.length - 1].emoji}`,
                `💡 Full order: ${correctSequence.map(obj => obj.emoji).join(' < ')}`
            ];
            
            if (hintLevel < hints.length) {
                hintDisplay.textContent = hints[hintLevel];
                hintLevel++;
            } else {
                hintDisplay.innerHTML = `💡 Final hint - Weights revealed!<br>${correctSequence.map(obj => `${obj.emoji}=${obj.weight}g`).join(', ')}`;
            }
        }

        function resetBalance() {
            leftPlatformObjects = [];
            rightPlatformObjects = [];
            renderPlatformObjects();
            updateBalance();
            
            // Clear sequence
            sequenceSlots.forEach((slot, index) => {
                slot.object = null;
                renderSlotContent(slot, index);
            });
            
            document.getElementById('balance-feedback').style.display = 'none';
            document.getElementById('balance-feedback').className = 'balance-feedback';
            document.getElementById('hint-display').style.display = 'none';
        }
    </script>

    <!-- Money Tool -->
    <div id="money-tool" class="tool-content">
        <div class="container">
            <div class="header">
                <h1>Money & Coins</h1>
                <p>Learn about money, counting coins, and making change</p>
            </div>

            <div class="money-mode-selector">
                <button class="money-mode-btn active" onclick="switchMoneyMode('counting')">🪙 Count Coins</button>
                <button class="money-mode-btn" onclick="switchMoneyMode('making')">💷 Make Amount</button>
                <button class="money-mode-btn" onclick="switchMoneyMode('change')">🔄 Give Change</button>
                <button class="money-mode-btn" onclick="switchMoneyMode('shopping')">🛒 Shopping</button>
            </div>

            <!-- Counting Mode -->
            <div id="counting-mode" class="money-mode active">
                <div class="money-display-area">
                    <div class="coin-display">
                        <h3>Drag coins to the counting area</h3>
                        <div class="coin-source">
                            <div class="draggable-coin" data-value="1" draggable="true">1p</div>
                            <div class="draggable-coin" data-value="2" draggable="true">2p</div>
                            <div class="draggable-coin" data-value="5" draggable="true">5p</div>
                            <div class="draggable-coin" data-value="10" draggable="true">10p</div>
                            <div class="draggable-coin" data-value="20" draggable="true">20p</div>
                            <div class="draggable-coin" data-value="50" draggable="true">50p</div>
                            <div class="draggable-coin pound" data-value="100" draggable="true">£1</div>
                            <div class="draggable-coin pound" data-value="200" draggable="true">£2</div>
                        </div>
                    </div>

                    <div class="counting-area" ondrop="dropCoin(event)" ondragover="allowDrop(event)">
                        <h3>Counting Area</h3>
                        <div id="dropped-coins"></div>
                        <div class="total-display">
                            Total: £<span id="total-amount">0.00</span>
                        </div>
                    </div>

                    <div class="coin-visualization">
                        <canvas id="coin-stack-canvas" width="300" height="400"></canvas>
                        <div class="stack-info">
                            <p>Stack Height: <span id="stack-height">0</span> coins</p>
                            <p>Stack Value: £<span id="stack-value">0.00</span></p>
                        </div>
                    </div>
                </div>

                <button class="btn" onclick="clearCoins()">Clear All</button>
            </div>

            <!-- Make Amount Mode -->
            <div id="making-mode" class="money-mode">
                <div class="make-amount-challenge">
                    <h2>Make: £<span id="target-amount">2.37</span></h2>
                    <p>Use the fewest coins possible!</p>

                    <div class="coin-selector">
                        <div class="coin-row">
                            <button class="coin-btn" onclick="addCoinToMake(200)">£2</button>
                            <span class="coin-count" id="count-200">0</span>
                        </div>
                        <div class="coin-row">
                            <button class="coin-btn" onclick="addCoinToMake(100)">£1</button>
                            <span class="coin-count" id="count-100">0</span>
                        </div>
                        <div class="coin-row">
                            <button class="coin-btn" onclick="addCoinToMake(50)">50p</button>
                            <span class="coin-count" id="count-50">0</span>
                        </div>
                        <div class="coin-row">
                            <button class="coin-btn" onclick="addCoinToMake(20)">20p</button>
                            <span class="coin-count" id="count-20">0</span>
                        </div>
                        <div class="coin-row">
                            <button class="coin-btn" onclick="addCoinToMake(10)">10p</button>
                            <span class="coin-count" id="count-10">0</span>
                        </div>
                        <div class="coin-row">
                            <button class="coin-btn" onclick="addCoinToMake(5)">5p</button>
                            <span class="coin-count" id="count-5">0</span>
                        </div>
                        <div class="coin-row">
                            <button class="coin-btn" onclick="addCoinToMake(2)">2p</button>
                            <span class="coin-count" id="count-2">0</span>
                        </div>
                        <div class="coin-row">
                            <button class="coin-btn" onclick="addCoinToMake(1)">1p</button>
                            <span class="coin-count" id="count-1">0</span>
                        </div>
                    </div>

                    <div class="make-display">
                        <p>Your Total: £<span id="make-total">0.00</span></p>
                        <p>Coins Used: <span id="coins-used">0</span></p>
                    </div>

                    <div class="make-controls">
                        <button class="btn" onclick="checkMakeAmount()">Check</button>
                        <button class="btn" onclick="resetMakeAmount()">Reset</button>
                        <button class="btn" onclick="newMakeChallenge()">New Amount</button>
                    </div>

                    <div id="make-feedback"></div>
                </div>
            </div>

            <!-- Change Mode -->
            <div id="change-mode" class="money-mode">
                <div class="change-scenario">
                    <div class="shop-display">
                        <h3>Shop Transaction</h3>
                        <div class="item-cost">
                            <img src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'><rect width='100' height='100' fill='%23f39c12'/><text x='50' y='50' text-anchor='middle' dy='.3em' font-size='40'>🍎</text></svg>" alt="Item">
                            <p>Cost: £<span id="item-price">1.25</span></p>
                        </div>
                        <div class="payment-given">
                            <p>Customer pays: £<span id="payment-amount">5.00</span></p>
                        </div>
                    </div>

                    <div class="change-calculator">
                        <h3>Calculate Change</h3>
                        <p>Change needed: £<span id="change-needed">3.75</span></p>
                        
                        <div class="change-builder">
                            <h4>Build the change:</h4>
                            <div id="change-coins"></div>
                        </div>

                        <div class="change-input">
                            <input type="number" id="change-answer" step="0.01" placeholder="Enter change amount">
                            <button class="btn" onclick="checkChange()">Check</button>
                        </div>

                        <button class="btn" onclick="newChangeScenario()">New Transaction</button>
                    </div>

                    <div id="change-feedback"></div>
                </div>
            </div>

            <!-- Shopping Mode -->
            <div id="shopping-mode" class="money-mode">
                <div class="shopping-game">
                    <div class="wallet">
                        <h3>Your Wallet</h3>
                        <p>Budget: £<span id="budget">10.00</span></p>
                        <p>Spent: £<span id="spent">0.00</span></p>
                        <p>Remaining: £<span id="remaining">10.00</span></p>
                    </div>

                    <div class="shop-items">
                        <h3>Shop Items</h3>
                        <div class="items-grid">
                            <div class="shop-item" onclick="buyItem(this, 1.50, 'Apple')">
                                <div class="item-icon">🍎</div>
                                <p>Apple</p>
                                <p>£1.50</p>
                            </div>
                            <div class="shop-item" onclick="buyItem(this, 2.25, 'Book')">
                                <div class="item-icon">📚</div>
                                <p>Book</p>
                                <p>£2.25</p>
                            </div>
                            <div class="shop-item" onclick="buyItem(this, 0.75, 'Pencil')">
                                <div class="item-icon">✏️</div>
                                <p>Pencil</p>
                                <p>£0.75</p>
                            </div>
                            <div class="shop-item" onclick="buyItem(this, 3.00, 'Toy')">
                                <div class="item-icon">🧸</div>
                                <p>Toy</p>
                                <p>£3.00</p>
                            </div>
                            <div class="shop-item" onclick="buyItem(this, 1.20, 'Candy')">
                                <div class="item-icon">🍬</div>
                                <p>Candy</p>
                                <p>£1.20</p>
                            </div>
                            <div class="shop-item" onclick="buyItem(this, 4.50, 'Game')">
                                <div class="item-icon">🎮</div>
                                <p>Game</p>
                                <p>£4.50</p>
                            </div>
                        </div>
                    </div>

                    <div class="shopping-cart">
                        <h3>Shopping Cart</h3>
                        <div id="cart-items"></div>
                        <button class="btn" onclick="checkout()">Checkout</button>
                        <button class="btn" onclick="clearCart()">Clear Cart</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Money Tool Styles */
        .money-mode-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .money-mode-btn {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .money-mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .money-mode-btn.active {
            background: linear-gradient(45deg, #3498db, #2980b9);
            transform: scale(1.05);
        }

        .money-mode {
            display: none;
        }

        .money-mode.active {
            display: block;
        }

        /* Counting Mode */
        .money-display-area {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .coin-source {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .draggable-coin {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, #B87333, #CD853F);
            border: 3px solid #8B4513;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            color: white;
            cursor: grab;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .draggable-coin:active {
            cursor: grabbing;
            transform: scale(1.1);
        }

        .draggable-coin.pound {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border-color: #B8860B;
        }

        .counting-area {
            background: rgba(255, 255, 255, 0.1);
            border: 3px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 20px;
            min-height: 300px;
        }

        .counting-area h3 {
            color: #3498db;
            margin-bottom: 15px;
        }

        #dropped-coins {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            min-height: 150px;
            margin-bottom: 20px;
        }

        .dropped-coin {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #B87333, #CD853F);
            border: 2px solid #8B4513;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            position: relative;
            cursor: pointer;
            animation: dropIn 0.5s ease;
        }

        @keyframes dropIn {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .total-display {
            font-size: 2rem;
            font-weight: bold;
            color: #00ff41;
            background: #1a1a1a;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #00ff41;
        }

        .coin-visualization {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        #coin-stack-canvas {
            border: 2px solid #333;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .stack-info p {
            margin: 10px 0;
            font-size: 1.1rem;
        }

        .stack-info span {
            color: #f39c12;
            font-weight: bold;
        }

        /* Make Amount Mode */
        .make-amount-challenge {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
        }

        .make-amount-challenge h2 {
            text-align: center;
            color: #f39c12;
            margin-bottom: 10px;
        }

        .make-amount-challenge > p {
            text-align: center;
            color: #ccc;
            margin-bottom: 30px;
        }

        .coin-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .coin-row {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 10px;
        }

        .coin-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border: 3px solid #B8860B;
            color: #654321;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .coin-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .coin-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3498db;
            min-width: 30px;
        }

        .make-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .make-display p {
            margin: 10px 0;
            font-size: 1.3rem;
        }

        .make-display span {
            color: #00ff41;
            font-weight: bold;
        }

        .make-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        #make-feedback {
            text-align: center;
            font-size: 1.2rem;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }

        #make-feedback.correct {
            display: block;
            background: rgba(0, 255, 65, 0.2);
            border: 2px solid #00ff41;
            color: #00ff41;
        }

        #make-feedback.incorrect {
            display: block;
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            color: #e74c3c;
        }

        /* Change Mode */
        .change-scenario {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .shop-display {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
        }

        .item-cost img {
            width: 100px;
            height: 100px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .item-cost p, .payment-given p {
            font-size: 1.5rem;
            margin: 15px 0;
        }

        .item-cost span, .payment-given span {
            color: #f39c12;
            font-weight: bold;
        }

        .change-calculator {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
        }

        .change-calculator h3 {
            color: #3498db;
            margin-bottom: 20px;
        }

        .change-calculator p {
            font-size: 1.3rem;
            margin: 15px 0;
        }

        #change-needed {
            color: #00ff41;
            font-weight: bold;
            font-size: 1.5rem;
        }

        .change-input {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        #change-answer {
            flex: 1;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #3498db;
            color: white;
            font-size: 1.2rem;
            border-radius: 5px;
        }

        /* Shopping Mode */
        .shopping-game {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .wallet {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            height: fit-content;
        }

        .wallet h3 {
            color: #f39c12;
            margin-bottom: 15px;
        }

        .wallet p {
            margin: 10px 0;
            font-size: 1.1rem;
        }

        .wallet span {
            font-weight: bold;
            color: #00ff41;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .shop-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .shop-item:hover {
            transform: translateY(-5px);
            border-color: #3498db;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .shop-item.purchased {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .item-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .shop-item p {
            margin: 5px 0;
        }

        .shopping-cart {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
        }

        .shopping-cart h3 {
            color: #3498db;
            margin-bottom: 15px;
        }

        #cart-items {
            min-height: 200px;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .money-display-area,
            .change-scenario,
            .shopping-game {
                grid-template-columns: 1fr;
            }
        }

        @media (hover: none) and (pointer: coarse) {
            .draggable-coin,
            .coin-btn,
            .money-mode-btn {
                min-height: 44px;
                min-width: 44px;
            }
        }
    </style>

    <script>
        // Money Tool Functions
        let totalAmount = 0;
        let droppedCoins = [];
        let makeCoins = {};
        let targetMakeAmount = 237; // in pence
        let cartItems = [];
        let budget = 1000; // in pence
        let spent = 0;

        function switchMoneyMode(mode) {
            document.querySelectorAll('.money-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.money-mode').forEach(m => {
                m.classList.remove('active');
            });
            document.getElementById(`${mode}-mode`).classList.add('active');

            if (mode === 'counting') {
                updateCoinStack();
            } else if (mode === 'making') {
                newMakeChallenge();
            } else if (mode === 'change') {
                newChangeScenario();
            } else if (mode === 'shopping') {
                resetShopping();
            }
        }

        // Drag and Drop
        document.addEventListener('DOMContentLoaded', function() {
            const draggables = document.querySelectorAll('.draggable-coin');
            draggables.forEach(coin => {
                coin.addEventListener('dragstart', dragStart);
            });
        });

        function dragStart(e) {
            e.dataTransfer.setData('value', e.target.dataset.value);
            e.dataTransfer.setData('text', e.target.textContent);
        }

        function allowDrop(e) {
            e.preventDefault();
        }

        function dropCoin(e) {
            e.preventDefault();
            const value = parseInt(e.dataTransfer.getData('value'));
            const text = e.dataTransfer.getData('text');
            
            addDroppedCoin(value, text);
        }

        function addDroppedCoin(value, text) {
            const droppedArea = document.getElementById('dropped-coins');
            const coin = document.createElement('div');
            coin.className = 'dropped-coin';
            if (value >= 100) coin.style.background = 'linear-gradient(45deg, #FFD700, #FFA500)';
            coin.textContent = text;
            coin.dataset.value = value;
            coin.onclick = function() { removeCoin(this); };
            droppedArea.appendChild(coin);
            
            droppedCoins.push(value);
            updateTotal();
            updateCoinStack();
        }

        function removeCoin(coin) {
            const value = parseInt(coin.dataset.value);
            const index = droppedCoins.indexOf(value);
            if (index > -1) {
                droppedCoins.splice(index, 1);
            }
            coin.remove();
            updateTotal();
            updateCoinStack();
        }

        function updateTotal() {
            totalAmount = droppedCoins.reduce((sum, val) => sum + val, 0);
            document.getElementById('total-amount').textContent = (totalAmount / 100).toFixed(2);
        }

        function clearCoins() {
            document.getElementById('dropped-coins').innerHTML = '';
            droppedCoins = [];
            updateTotal();
            updateCoinStack();
        }

        function updateCoinStack() {
            const canvas = document.getElementById('coin-stack-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw stacked coins
            let y = canvas.height - 30;
            droppedCoins.forEach((value, index) => {
                const x = canvas.width / 2;
                
                // Draw coin
                ctx.beginPath();
                ctx.ellipse(x, y, 40, 15, 0, 0, 2 * Math.PI);
                if (value >= 100) {
                    ctx.fillStyle = '#FFD700';
                } else {
                    ctx.fillStyle = '#CD853F';
                }
                ctx.fill();
                ctx.strokeStyle = '#8B4513';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Draw coin edge (3D effect)
                ctx.fillRect(x - 40, y, 80, 5);
                
                y -= 8; // Stack height
            });
            
            // Update stack info
            document.getElementById('stack-height').textContent = droppedCoins.length;
            document.getElementById('stack-value').textContent = (totalAmount / 100).toFixed(2);
        }

        // Make Amount Mode
        function newMakeChallenge() {
            targetMakeAmount = Math.floor(Math.random() * 900) + 100; // 1.00 to 10.00
            document.getElementById('target-amount').textContent = (targetMakeAmount / 100).toFixed(2);
            resetMakeAmount();
        }

        function resetMakeAmount() {
            makeCoins = {1: 0, 2: 0, 5: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0};
            updateMakeDisplay();
            document.getElementById('make-feedback').style.display = 'none';
        }

        function addCoinToMake(value) {
            makeCoins[value] = (makeCoins[value] || 0) + 1;
            updateMakeDisplay();
        }

        function updateMakeDisplay() {
            let total = 0;
            let coinCount = 0;
            
            for (let value in makeCoins) {
                const count = makeCoins[value];
                total += value * count;
                coinCount += count;
                document.getElementById(`count-${value}`).textContent = count;
            }
            
            document.getElementById('make-total').textContent = (total / 100).toFixed(2);
            document.getElementById('coins-used').textContent = coinCount;
        }

        function checkMakeAmount() {
            const total = Object.keys(makeCoins).reduce((sum, val) => sum + (val * makeCoins[val]), 0);
            const feedback = document.getElementById('make-feedback');
            
            if (total === targetMakeAmount) {
                // Check if it's the optimal solution
                const optimal = getOptimalCoins(targetMakeAmount);
                const userCoins = Object.values(makeCoins).reduce((sum, count) => sum + count, 0);
                
                if (userCoins === optimal) {
                    feedback.textContent = '✅ Perfect! You used the fewest coins possible!';
                } else {
                    feedback.textContent = `✅ Correct amount! But you could do it with ${optimal} coins.`;
                }
                feedback.className = 'correct';
            } else {
                const diff = Math.abs(total - targetMakeAmount) / 100;
                feedback.textContent = `❌ Not quite. You're off by £${diff.toFixed(2)}`;
                feedback.className = 'incorrect';
            }
            
            feedback.style.display = 'block';
        }

        function getOptimalCoins(amount) {
            const coins = [200, 100, 50, 20, 10, 5, 2, 1];
            let remaining = amount;
            let count = 0;
            
            for (let coin of coins) {
                count += Math.floor(remaining / coin);
                remaining = remaining % coin;
            }
            
            return count;
        }

        // Change Mode
        function newChangeScenario() {
            const prices = [125, 250, 375, 450, 625, 750, 825, 999];
            const payments = [500, 1000, 2000];
            
            const price = prices[Math.floor(Math.random() * prices.length)];
            const payment = payments[Math.floor(Math.random() * payments.length)];
            
            // Ensure payment is more than price
            const finalPayment = payment > price ? payment : payment + 1000;
            
            document.getElementById('item-price').textContent = (price / 100).toFixed(2);
            document.getElementById('payment-amount').textContent = (finalPayment / 100).toFixed(2);
            document.getElementById('change-needed').textContent = ((finalPayment - price) / 100).toFixed(2);
            
            document.getElementById('change-answer').value = '';
            document.getElementById('change-feedback').style.display = 'none';
        }

        function checkChange() {
            const price = parseFloat(document.getElementById('item-price').textContent) * 100;
            const payment = parseFloat(document.getElementById('payment-amount').textContent) * 100;
            const correctChange = (payment - price) / 100;
            const userAnswer = parseFloat(document.getElementById('change-answer').value);
            
            const feedback = document.getElementById('change-feedback');
            
            if (Math.abs(userAnswer - correctChange) < 0.01) {
                feedback.textContent = '✅ Correct! Well done!';
                feedback.className = 'correct';
                feedback.style.display = 'block';
                setTimeout(newChangeScenario, 2000);
            } else {
                feedback.textContent = `❌ Not quite. The correct change is £${correctChange.toFixed(2)}`;
                feedback.className = 'incorrect';
                feedback.style.display = 'block';
            }
        }

        // Shopping Mode
        function resetShopping() {
            budget = 1000;
            spent = 0;
            cartItems = [];
            updateWallet();
            updateCart();
            document.querySelectorAll('.shop-item').forEach(item => {
                item.classList.remove('purchased');
            });
        }

        function buyItem(element, price, name) {
            if (element.classList.contains('purchased')) return;
            
            const priceInPence = price * 100;
            if (spent + priceInPence > budget) {
                alert("You don't have enough money!");
                return;
            }
            
            element.classList.add('purchased');
            cartItems.push({name, price: priceInPence});
            spent += priceInPence;
            updateWallet();
            updateCart();
        }

        function updateWallet() {
            document.getElementById('spent').textContent = (spent / 100).toFixed(2);
            document.getElementById('remaining').textContent = ((budget - spent) / 100).toFixed(2);
        }

        function updateCart() {
            const cartDiv = document.getElementById('cart-items');
            cartDiv.innerHTML = '';
            
            cartItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `
                    <span>${item.name}</span>
                    <span>£${(item.price / 100).toFixed(2)}</span>
                `;
                cartDiv.appendChild(div);
            });
        }

        function checkout() {
            if (cartItems.length === 0) {
                alert('Your cart is empty!');
                return;
            }
            
            alert(`Total spent: £${(spent / 100).toFixed(2)}\nChange: £${((budget - spent) / 100).toFixed(2)}`);
            resetShopping();
        }

        function clearCart() {
            if (confirm('Clear your shopping cart?')) {
                resetShopping();
            }
        }

        // Initialize money tool
        function initializeMoney() {
            updateCoinStack();
            newMakeChallenge();
            newChangeScenario();
            resetShopping();
        }
    </script>

    <!-- Decimals Tool -->
    <div id="decimals-tool" class="tool-content">
        <div class="container">
            <div class="header">
                <h1>Decimals Explorer</h1>
                <p>Learn how decimals work and how multiplication and division by 10 moves the decimal point!</p>
            </div>

            <div class="decimals-main">
                <!-- Decimal Display Area -->
                <div class="decimal-display-area">
                    <div class="decimal-number-display">
                        <span class="digit-place thousands">0</span>
                        <span class="digit-place hundreds">0</span>
                        <span class="digit-place tens">0</span>
                        <span class="digit-place ones">0</span>
                        <span class="decimal-point-display">.</span>
                        <span class="digit-place tenths">0</span>
                        <span class="digit-place hundredths">0</span>
                        <span class="digit-place thousandths">0</span>
                    </div>
                    <div class="place-value-labels">
                        <span class="place-label">1000</span>
                        <span class="place-label">100</span>
                        <span class="place-label">10</span>
                        <span class="place-label">1</span>
                        <span class="place-label point-label">.</span>
                        <span class="place-label">0.1</span>
                        <span class="place-label">0.01</span>
                        <span class="place-label">0.001</span>
                    </div>
                    <div class="place-name-labels">
                        <span class="name-label">Thousands</span>
                        <span class="name-label">Hundreds</span>
                        <span class="name-label">Tens</span>
                        <span class="name-label">Ones</span>
                        <span class="name-label point-label"></span>
                        <span class="name-label">Tenths</span>
                        <span class="name-label">Hundredths</span>
                        <span class="name-label">Thousandths</span>
                    </div>
                </div>

                <!-- Current Value Display -->
                <div class="decimal-value-display">
                    <h2>Current Value: <span id="decimal-current-value">0.0</span></h2>
                </div>

                <!-- Operations Section -->
                <div class="decimal-operations">
                    <div class="operation-controls">
                        <button class="decimal-btn multiply-10" onclick="multiplyByTen()">
                            × 10
                            <span class="btn-description">Move decimal right →</span>
                        </button>
                        <button class="decimal-btn divide-10" onclick="divideByTen()">
                            ÷ 10
                            <span class="btn-description">Move decimal left ←</span>
                        </button>
                        <button class="decimal-btn multiply-100" onclick="multiplyByHundred()">
                            × 100
                            <span class="btn-description">Move 2 places right →→</span>
                        </button>
                        <button class="decimal-btn divide-100" onclick="divideByHundred()">
                            ÷ 100
                            <span class="btn-description">Move 2 places left ←←</span>
                        </button>
                    </div>

                    <div class="history-display">
                        <h3>Operation History:</h3>
                        <div id="decimal-history"></div>
                    </div>
                </div>

                <!-- Input Controls -->
                <div class="decimal-input-section">
                    <h3>Set Your Number:</h3>
                    <input type="number" id="decimal-input" step="0.001" value="0" 
                           onchange="setDecimalNumber(this.value)">
                    <div class="preset-buttons">
                        <button onclick="setDecimalNumber(3.14)">π (3.14)</button>
                        <button onclick="setDecimalNumber(12.5)">12.5</button>
                        <button onclick="setDecimalNumber(0.25)">0.25</button>
                        <button onclick="setDecimalNumber(456.789)">456.789</button>
                        <button onclick="setDecimalNumber(1)">1</button>
                    </div>
                </div>

                <!-- Visual Grid Representation -->
                <div class="decimal-grid-visual">
                    <h3>Visual Representation:</h3>
                    <div class="grid-container">
                        <div class="whole-blocks" id="whole-blocks"></div>
                        <div class="decimal-blocks" id="decimal-blocks"></div>
                    </div>
                </div>

                <!-- Practice Problems -->
                <div class="decimal-practice">
                    <h3>Practice Problems:</h3>
                    <div id="decimal-problem">
                        <p id="problem-text"></p>
                        <input type="number" id="decimal-answer" step="0.001">
                        <button onclick="checkDecimalAnswer()">Check Answer</button>
                        <button onclick="generateDecimalProblem()">New Problem</button>
                    </div>
                    <div id="decimal-feedback"></div>
                    <div class="decimal-score">
                        Score: <span id="decimal-score">0</span> / <span id="decimal-attempts">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Decimals Tool Styles */
        #decimals-tool {
            padding: 20px;
        }

        .decimals-main {
            max-width: 1200px;
            margin: 0 auto;
        }

        .decimal-display-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .decimal-number-display {
            font-size: 3rem;
            font-family: 'Courier New', monospace;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        .digit-place {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 8px;
            min-width: 50px;
            display: inline-block;
            transition: all 0.5s ease;
            position: relative;
        }

        .digit-place.animating {
            animation: slideDigit 0.5s ease;
        }

        @keyframes slideDigit {
            0% { transform: translateX(0); }
            50% { transform: translateY(-10px); }
            100% { transform: translateX(0); }
        }

        .decimal-point-display {
            color: #ff6b6b;
            font-size: 4rem;
            font-weight: bold;
            margin: 0 10px;
            position: relative;
            transition: all 0.5s ease;
        }

        .decimal-point-display.moving-right {
            animation: moveRight 0.5s ease;
        }

        .decimal-point-display.moving-left {
            animation: moveLeft 0.5s ease;
        }

        @keyframes moveRight {
            0% { transform: translateX(0); }
            50% { transform: translateX(70px); opacity: 0.5; }
            100% { transform: translateX(0); }
        }

        @keyframes moveLeft {
            0% { transform: translateX(0); }
            50% { transform: translateX(-70px); opacity: 0.5; }
            100% { transform: translateX(0); }
        }

        .place-value-labels, .place-name-labels {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
        }

        .place-label, .name-label {
            min-width: 50px;
            padding: 5px 15px;
            font-size: 0.9rem;
            color: #aaa;
        }

        .place-label.point-label, .name-label.point-label {
            width: 30px;
            margin: 0 10px;
        }

        .decimal-value-display {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }

        .decimal-value-display h2 {
            margin: 0;
            font-size: 2rem;
        }

        #decimal-current-value {
            color: #ffd700;
            font-weight: bold;
        }

        .decimal-operations {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .operation-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .decimal-btn {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border: none;
            color: white;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .decimal-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .decimal-btn:active {
            transform: translateY(0);
        }

        .btn-description {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .multiply-10, .multiply-100 {
            background: linear-gradient(135deg, #43e97b, #38f9d7);
        }

        .divide-10, .divide-100 {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }

        .history-display {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        #decimal-history {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .history-item {
            padding: 5px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        .decimal-input-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        #decimal-input {
            font-size: 1.5rem;
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #667eea;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            width: 200px;
            text-align: center;
        }

        .preset-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .preset-buttons button {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .preset-buttons button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .decimal-grid-visual {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .grid-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: flex-start;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .whole-blocks, .decimal-blocks {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .block-unit {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .block-tenth {
            width: 50px;
            height: 5px;
            background: linear-gradient(135deg, #43e97b, #38f9d7);
            border-radius: 2px;
            margin: 2px;
        }

        .block-hundredth {
            width: 5px;
            height: 5px;
            background: linear-gradient(135deg, #f093fb, #f5576c);
            border-radius: 1px;
            margin: 1px;
        }

        .decimal-practice {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        #decimal-problem {
            margin: 20px 0;
        }

        #problem-text {
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        #decimal-answer {
            font-size: 1.2rem;
            padding: 8px;
            border-radius: 5px;
            border: 2px solid #667eea;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin-right: 10px;
        }

        #decimal-feedback {
            margin-top: 15px;
            font-size: 1.1rem;
            min-height: 30px;
        }

        #decimal-feedback.correct {
            color: #4CAF50;
        }

        #decimal-feedback.incorrect {
            color: #ff6b6b;
        }

        .decimal-score {
            margin-top: 20px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .decimal-number-display {
                font-size: 2rem;
            }
            
            .digit-place {
                padding: 5px 10px;
                min-width: 35px;
            }
            
            .decimal-operations {
                grid-template-columns: 1fr;
            }
            
            .operation-controls {
                grid-template-columns: 1fr;
            }
        }

        /* Decimals Preview Animation */
        .decimals-preview {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .decimal-animation {
            font-size: 1.8rem;
            font-family: 'Courier New', monospace;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            gap: 3px;
        }

        .dec-digit {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 8px;
            border-radius: 4px;
            animation: digitPulse 3s infinite;
        }

        .dec-point {
            color: #ff6b6b;
            font-size: 2.2rem;
            font-weight: bold;
            animation: decimalBlink 2s infinite;
            margin: 0 3px;
        }

        .decimal-arrow {
            font-size: 0.9rem;
            color: #4CAF50;
            margin-top: 5px;
            width: 100%;
            text-align: center;
            animation: slideArrow 3s infinite;
        }

        @keyframes digitPulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        @keyframes decimalBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; transform: translateX(10px); }
        }

        @keyframes slideArrow {
            0%, 100% { opacity: 0; transform: translateX(-10px); }
            50% { opacity: 1; transform: translateX(0); }
        }

        /* Perimeter & Area Preview Animation */
        .perimeter-preview {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        .grid-animation {
            display: grid;
            grid-template-columns: repeat(4, 20px);
            grid-template-rows: repeat(3, 20px);
            gap: 2px;
            position: relative;
        }
        .unit-square {
            width: 20px;
            height: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            transition: all 0.5s ease;
            animation: perimeterPulse 4s infinite;
        }
        .unit-square.filled {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.6), rgba(33, 150, 243, 0.8));
            border-color: rgba(33, 150, 243, 1);
            animation: areaGlow 4s infinite;
        }
        .measurement-labels {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            font-size: 0.7rem;
            white-space: nowrap;
        }
        .perimeter-label {
            color: #4CAF50;
            font-weight: bold;
            animation: perimeterFlash 4s infinite;
        }
        .area-label {
            color: #2196F3;
            font-weight: bold;
            animation: areaFlash 4s infinite 2s;
        }
        
        @keyframes perimeterPulse {
            0%, 100% { border-color: rgba(255, 255, 255, 0.3); }
            25% { border-color: #4CAF50; border-width: 2px; }
            50%, 75% { border-color: rgba(255, 255, 255, 0.3); border-width: 1px; }
        }
        @keyframes areaGlow {
            0%, 50%, 100% { 
                background: linear-gradient(135deg, rgba(33, 150, 243, 0.6), rgba(33, 150, 243, 0.8));
                box-shadow: none;
            }
            75% { 
                background: linear-gradient(135deg, rgba(33, 150, 243, 0.9), rgba(33, 150, 243, 1));
                box-shadow: 0 0 8px rgba(33, 150, 243, 0.5);
            }
        }
        @keyframes perimeterFlash {
            0%, 75%, 100% { opacity: 0.7; }
            25% { opacity: 1; transform: scale(1.1); }
        }
        @keyframes areaFlash {
            0%, 25%, 100% { opacity: 0.7; }
            75% { opacity: 1; transform: scale(1.1); }
        }

        /* Euclid Proofs Preview Animation */
        .euclid-preview {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        
        .euclid-animation {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .euclid-svg {
            width: 100%;
            height: 80%;
            max-width: 120px;
        }
        
        .triangle-main {
            animation: drawTriangle 3s ease-in-out infinite;
        }
        
        .square-a {
            animation: fadeSquare 3s ease-in-out infinite;
            animation-delay: 0.5s;
            opacity: 0;
        }
        
        .square-b {
            animation: fadeSquare 3s ease-in-out infinite;
            animation-delay: 0.8s;
            opacity: 0;
        }
        
        .square-c {
            animation: fadeSquare 3s ease-in-out infinite;
            animation-delay: 1.1s;
            opacity: 0;
        }
        
        .euclid-label {
            font-size: 8px;
            fill: white;
            font-weight: bold;
            opacity: 0;
            animation: labelFade 3s ease-in-out infinite;
        }
        
        .euclid-label:nth-of-type(1) { animation-delay: 0.6s; }
        .euclid-label:nth-of-type(2) { animation-delay: 0.9s; }
        .euclid-label:nth-of-type(3) { animation-delay: 1.2s; }
        
        .euclid-formula {
            font-size: 0.9rem;
            font-weight: bold;
            color: #fff;
            margin-top: 5px;
            opacity: 0;
            animation: formulaFadeIn 3s ease-in-out infinite;
            animation-delay: 1.5s;
            text-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }
        
        @keyframes drawTriangle {
            0% {
                stroke-dasharray: 0 200;
                stroke-dashoffset: 0;
            }
            30% {
                stroke-dasharray: 200 200;
                stroke-dashoffset: 0;
            }
            100% {
                stroke-dasharray: 200 200;
                stroke-dashoffset: 0;
            }
        }
        
        @keyframes fadeSquare {
            0%, 100% {
                opacity: 0;
                transform: scale(0.8);
            }
            50%, 80% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes labelFade {
            0%, 100% {
                opacity: 0;
            }
            50%, 80% {
                opacity: 1;
            }
        }
        
        @keyframes formulaFadeIn {
            0%, 100% {
                opacity: 0;
                transform: translateY(5px);
            }
            50%, 80% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Ancient Civilizations Math Previews */
        /* Egyptian Preview */
        .egypt-preview {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .egypt-animation {
            text-align: center;
        }
        
        .hieroglyphics {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .hieroglyph {
            font-size: 2rem;
            animation: hieroglyphGlow 3s ease-in-out infinite;
            color: #FFD700;
        }
        
        .hieroglyph.h1 { animation-delay: 0s; }
        .hieroglyph.h10 { animation-delay: 0.3s; }
        .hieroglyph.h100 { animation-delay: 0.6s; }
        .hieroglyph.h1000 { animation-delay: 0.9s; }
        
        .egypt-number {
            font-size: 1.2rem;
            color: #fff;
            opacity: 0;
            animation: numberReveal 3s ease-in-out infinite;
            animation-delay: 1.5s;
        }
        
        @keyframes hieroglyphGlow {
            0%, 100% { 
                opacity: 0.3;
                transform: translateY(2px);
            }
            50% { 
                opacity: 1;
                transform: translateY(0);
                text-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            }
        }
        
        @keyframes numberReveal {
            0%, 100% { opacity: 0; }
            50%, 80% { opacity: 1; }
        }
        
        /* Sumerian Preview */
        .sumerian-preview {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .sumerian-animation {
            text-align: center;
        }
        
        .cuneiform-numbers {
            margin-bottom: 10px;
        }
        
        .cuneiform-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            font-size: 2.5rem;
        }
        
        .cuneiform {
            color: #CD853F;
            animation: cuneiformWrite 4s ease-in-out infinite;
        }
        
        .wedge-10:nth-child(1) { animation-delay: 0s; }
        .wedge-10:nth-child(2) { animation-delay: 0.5s; }
        .wedge-1 { animation-delay: 1s; }
        
        .base60-label {
            font-size: 0.9rem;
            color: #fff;
            opacity: 0;
            animation: labelFadeBase 4s ease-in-out infinite;
            animation-delay: 1.5s;
        }
        
        @keyframes cuneiformWrite {
            0% { 
                opacity: 0;
                transform: scale(0) rotate(-180deg);
            }
            50%, 100% { 
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }
        
        @keyframes labelFadeBase {
            0%, 100% { opacity: 0; }
            60%, 90% { opacity: 1; }
        }
        
        /* Mayan Preview */
        .mayan-preview {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .mayan-animation {
            text-align: center;
        }
        
        .mayan-numerals {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .mayan-level {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            min-height: 20px;
            padding: 2px 10px;
            background: rgba(46, 125, 50, 0.2);
            border-radius: 4px;
            animation: mayanLevelSlide 3s ease-in-out infinite;
        }
        
        .mayan-level:nth-child(1) { animation-delay: 0s; }
        .mayan-level:nth-child(2) { animation-delay: 0.3s; }
        .mayan-level:nth-child(3) { animation-delay: 0.6s; }
        
        .mayan-dot {
            font-size: 1.5rem;
            color: #4CAF50;
        }
        
        .mayan-bar {
            font-size: 1.2rem;
            color: #4CAF50;
            font-weight: bold;
        }
        
        .mayan-shell {
            font-size: 1.5rem;
            color: #4CAF50;
        }
        
        .mayan-label {
            font-size: 0.9rem;
            color: #fff;
            opacity: 0;
            animation: labelFadeBase 3s ease-in-out infinite;
            animation-delay: 1s;
        }
        
        @keyframes mayanLevelSlide {
            0% { 
                opacity: 0;
                transform: translateX(-20px);
            }
            50%, 100% { 
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Graphs Preview */
        .graphs-preview {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .graph-animation {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .graph-svg {
            width: 100%;
            height: 80%;
        }
        
        .graph-line {
            stroke-dasharray: 200;
            stroke-dashoffset: 200;
            animation: drawGraph 3s ease-in-out infinite;
        }
        
        .graph-line.parabola {
            animation-delay: 0s;
        }
        
        .graph-line.linear {
            animation-delay: 0.5s;
        }
        
        .graph-point {
            animation: movePoint 3s ease-in-out infinite;
        }
        
        .graph-equation {
            text-align: center;
            color: #00ff41;
            font-size: 1rem;
            font-weight: bold;
            margin-top: 5px;
            opacity: 0;
            animation: equationFade 3s ease-in-out infinite;
            animation-delay: 1s;
        }
        
        @keyframes drawGraph {
            0% {
                stroke-dashoffset: 200;
                opacity: 0;
            }
            50%, 100% {
                stroke-dashoffset: 0;
                opacity: 1;
            }
        }
        
        @keyframes movePoint {
            0%, 100% {
                cx: 60;
                cy: 50;
                opacity: 0;
            }
            25% {
                cx: 40;
                cy: 65;
                opacity: 1;
            }
            50% {
                cx: 60;
                cy: 30;
                opacity: 1;
            }
            75% {
                cx: 80;
                cy: 65;
                opacity: 1;
            }
        }
        
        @keyframes equationFade {
            0%, 100% { opacity: 0; }
            50%, 80% { opacity: 1; }
        }
        
        /* Algebra Preview */
        .algebra-preview {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        
        .algebra-animation {
            text-align: center;
            width: 100%;
        }
        
        .equation-solve {
            margin-bottom: 15px;
        }
        
        .equation-step {
            font-size: 1.2rem;
            font-weight: bold;
            color: #9b59b6;
            opacity: 0;
            position: absolute;
            width: 100%;
            animation: solveStep 4s ease-in-out infinite;
        }
        
        .step-1 { animation-delay: 0s; }
        .step-2 { animation-delay: 1.3s; }
        .step-3 { animation-delay: 2.6s; }
        
        .algebra-balance {
            margin-top: 40px;
        }
        
        .balance-scale {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }
        
        .scale-left, .scale-right {
            padding: 5px 10px;
            background: rgba(155, 89, 182, 0.2);
            border-radius: 5px;
            border: 1px solid #9b59b6;
            animation: balanceTilt 4s ease-in-out infinite;
        }
        
        .scale-beam {
            font-size: 1.5rem;
            animation: balanceRotate 4s ease-in-out infinite;
        }
        
        @keyframes solveStep {
            0%, 25% {
                opacity: 0;
                transform: translateY(-10px);
            }
            30%, 95% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(10px);
            }
        }
        
        @keyframes balanceTilt {
            0%, 100% { transform: translateY(0); }
            25% { transform: translateY(-5px); }
            75% { transform: translateY(5px); }
        }
        
        @keyframes balanceRotate {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }

        /* Daily Drill Preview */
        .drill-label {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        }
        
        .dailydrill-preview {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        
        .worksheet-animation {
            width: 100%;
            height: 100%;
        }
        
        .worksheet-page {
            background: white;
            color: #333;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transform: scale(0.9);
        }
        
        .worksheet-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 2px solid #333;
        }
        
        .level-badge {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .timer {
            color: #e74c3c;
            animation: timerTick 1s infinite;
        }
        
        .math-problems {
            margin: 10px 0;
        }
        
        .problem {
            margin: 5px 0;
            font-size: 0.9rem;
            opacity: 0;
            animation: problemWrite 4s infinite;
        }
        
        .problem:nth-child(1) { animation-delay: 0s; }
        .problem:nth-child(2) { animation-delay: 0.5s; }
        .problem:nth-child(3) { animation-delay: 1s; }
        .problem:nth-child(4) { animation-delay: 1.5s; }
        
        .answer {
            color: #2ecc71;
            font-weight: bold;
            opacity: 0;
            animation: answerWrite 4s infinite;
            animation-delay: inherit;
        }
        
        .worksheet-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            padding-top: 5px;
            border-top: 1px solid #ccc;
            font-size: 0.8rem;
        }
        
        .score {
            color: #27ae60;
            font-weight: bold;
        }
        
        .streak {
            color: #e67e22;
        }
        
        @keyframes timerTick {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes problemWrite {
            0%, 100% { opacity: 0; }
            20%, 80% { opacity: 1; }
        }
        
        @keyframes answerWrite {
            0%, 40%, 100% { opacity: 0; }
            60%, 80% { opacity: 1; }
        }

    <script>
        // Decimals Tool Functions
        let currentDecimalValue = 0;
        let decimalHistory = [];
        let decimalScore = 0;
        let decimalAttempts = 0;
        let currentDecimalProblem = null;

        function setDecimalNumber(value) {
            currentDecimalValue = parseFloat(value) || 0;
            updateDecimalDisplay();
            updateVisualBlocks();
        }

        function updateDecimalDisplay() {
            const valueStr = currentDecimalValue.toFixed(3);
            const parts = valueStr.split('.');
            const wholePart = parts[0].padStart(4, '0').slice(-4);
            const decimalPart = (parts[1] || '000').padEnd(3, '0');
            
            // Update digit displays
            document.querySelector('.thousands').textContent = wholePart[0];
            document.querySelector('.hundreds').textContent = wholePart[1];
            document.querySelector('.tens').textContent = wholePart[2];
            document.querySelector('.ones').textContent = wholePart[3];
            document.querySelector('.tenths').textContent = decimalPart[0];
            document.querySelector('.hundredths').textContent = decimalPart[1];
            document.querySelector('.thousandths').textContent = decimalPart[2];
            
            // Update current value display
            document.getElementById('decimal-current-value').textContent = 
                currentDecimalValue.toString();
            
            // Update input field
            document.getElementById('decimal-input').value = currentDecimalValue;
        }

        function multiplyByTen() {
            const oldValue = currentDecimalValue;
            currentDecimalValue *= 10;
            
            // Animate decimal point
            const decimalPoint = document.querySelector('.decimal-point-display');
            decimalPoint.classList.add('moving-right');
            
            // Animate digits
            document.querySelectorAll('.digit-place').forEach(digit => {
                digit.classList.add('animating');
            });
            
            setTimeout(() => {
                decimalPoint.classList.remove('moving-right');
                document.querySelectorAll('.digit-place').forEach(digit => {
                    digit.classList.remove('animating');
                });
                updateDecimalDisplay();
                updateVisualBlocks();
            }, 500);
            
            addToHistory(`${oldValue} × 10 = ${currentDecimalValue}`);
        }

        function divideByTen() {
            const oldValue = currentDecimalValue;
            currentDecimalValue /= 10;
            
            // Animate decimal point
            const decimalPoint = document.querySelector('.decimal-point-display');
            decimalPoint.classList.add('moving-left');
            
            // Animate digits
            document.querySelectorAll('.digit-place').forEach(digit => {
                digit.classList.add('animating');
            });
            
            setTimeout(() => {
                decimalPoint.classList.remove('moving-left');
                document.querySelectorAll('.digit-place').forEach(digit => {
                    digit.classList.remove('animating');
                });
                updateDecimalDisplay();
                updateVisualBlocks();
            }, 500);
            
            addToHistory(`${oldValue} ÷ 10 = ${currentDecimalValue}`);
        }

        function multiplyByHundred() {
            const oldValue = currentDecimalValue;
            currentDecimalValue *= 100;
            
            // Animate decimal point
            const decimalPoint = document.querySelector('.decimal-point-display');
            decimalPoint.classList.add('moving-right');
            
            setTimeout(() => {
                decimalPoint.classList.remove('moving-right');
                decimalPoint.classList.add('moving-right');
                setTimeout(() => {
                    decimalPoint.classList.remove('moving-right');
                    updateDecimalDisplay();
                    updateVisualBlocks();
                }, 500);
            }, 500);
            
            addToHistory(`${oldValue} × 100 = ${currentDecimalValue}`);
        }

        function divideByHundred() {
            const oldValue = currentDecimalValue;
            currentDecimalValue /= 100;
            
            // Animate decimal point
            const decimalPoint = document.querySelector('.decimal-point-display');
            decimalPoint.classList.add('moving-left');
            
            setTimeout(() => {
                decimalPoint.classList.remove('moving-left');
                decimalPoint.classList.add('moving-left');
                setTimeout(() => {
                    decimalPoint.classList.remove('moving-left');
                    updateDecimalDisplay();
                    updateVisualBlocks();
                }, 500);
            }, 500);
            
            addToHistory(`${oldValue} ÷ 100 = ${currentDecimalValue}`);
        }

        function addToHistory(operation) {
            decimalHistory.unshift(operation);
            if (decimalHistory.length > 10) {
                decimalHistory.pop();
            }
            
            const historyDiv = document.getElementById('decimal-history');
            historyDiv.innerHTML = decimalHistory
                .map(item => `<div class="history-item">${item}</div>`)
                .join('');
        }

        function updateVisualBlocks() {
            const wholeBlocksDiv = document.getElementById('whole-blocks');
            const decimalBlocksDiv = document.getElementById('decimal-blocks');
            
            wholeBlocksDiv.innerHTML = '';
            decimalBlocksDiv.innerHTML = '';
            
            // Show whole number blocks (up to 10)
            const wholes = Math.floor(Math.abs(currentDecimalValue));
            const displayWholes = Math.min(wholes, 10);
            
            for (let i = 0; i < displayWholes; i++) {
                const block = document.createElement('div');
                block.className = 'block-unit';
                block.textContent = '1';
                wholeBlocksDiv.appendChild(block);
            }
            
            if (wholes > 10) {
                const moreBlock = document.createElement('div');
                moreBlock.className = 'block-unit';
                moreBlock.textContent = `+${wholes - 10}`;
                wholeBlocksDiv.appendChild(moreBlock);
            }
            
            // Show decimal blocks
            const decimals = Math.abs(currentDecimalValue) % 1;
            const tenths = Math.floor(decimals * 10);
            const hundredths = Math.floor((decimals * 100) % 10);
            
            // Create container for decimal representation
            const decimalContainer = document.createElement('div');
            decimalContainer.style.display = 'flex';
            decimalContainer.style.flexDirection = 'column';
            decimalContainer.style.gap = '5px';
            
            // Add tenths
            if (tenths > 0) {
                const tenthsRow = document.createElement('div');
                tenthsRow.style.display = 'flex';
                tenthsRow.style.gap = '2px';
                for (let i = 0; i < tenths; i++) {
                    const tenth = document.createElement('div');
                    tenth.className = 'block-tenth';
                    tenthsRow.appendChild(tenth);
                }
                decimalContainer.appendChild(tenthsRow);
            }
            
            // Add hundredths
            if (hundredths > 0) {
                const hundredthsRow = document.createElement('div');
                hundredthsRow.style.display = 'flex';
                hundredthsRow.style.gap = '1px';
                for (let i = 0; i < hundredths; i++) {
                    const hundredth = document.createElement('div');
                    hundredth.className = 'block-hundredth';
                    hundredthsRow.appendChild(hundredth);
                }
                decimalContainer.appendChild(hundredthsRow);
            }
            
            decimalBlocksDiv.appendChild(decimalContainer);
        }

        function generateDecimalProblem() {
            const problemTypes = [
                {
                    type: 'multiply10',
                    generate: () => {
                        const num = (Math.random() * 100).toFixed(2);
                        return {
                            question: `What is ${num} × 10?`,
                            answer: parseFloat(num) * 10
                        };
                    }
                },
                {
                    type: 'divide10',
                    generate: () => {
                        const num = (Math.random() * 1000).toFixed(1);
                        return {
                            question: `What is ${num} ÷ 10?`,
                            answer: parseFloat(num) / 10
                        };
                    }
                },
                {
                    type: 'multiply100',
                    generate: () => {
                        const num = (Math.random() * 10).toFixed(3);
                        return {
                            question: `What is ${num} × 100?`,
                            answer: parseFloat(num) * 100
                        };
                    }
                },
                {
                    type: 'divide100',
                    generate: () => {
                        const num = (Math.random() * 10000).toFixed(0);
                        return {
                            question: `What is ${num} ÷ 100?`,
                            answer: parseFloat(num) / 100
                        };
                    }
                },
                {
                    type: 'decimal_move',
                    generate: () => {
                        const num = (Math.random() * 100).toFixed(2);
                        const moves = Math.floor(Math.random() * 3) + 1;
                        const direction = Math.random() > 0.5 ? 'right' : 'left';
                        const operation = direction === 'right' ? 'multiply' : 'divide';
                        const factor = Math.pow(10, moves);
                        return {
                            question: `Move the decimal point ${moves} place${moves > 1 ? 's' : ''} to the ${direction} in ${num}. What's the result?`,
                            answer: direction === 'right' ? 
                                parseFloat(num) * factor : 
                                parseFloat(num) / factor
                        };
                    }
                }
            ];
            
            const problemType = problemTypes[Math.floor(Math.random() * problemTypes.length)];
            currentDecimalProblem = problemType.generate();
            
            document.getElementById('problem-text').textContent = currentDecimalProblem.question;
            document.getElementById('decimal-answer').value = '';
            document.getElementById('decimal-feedback').textContent = '';
        }

        function checkDecimalAnswer() {
            if (!currentDecimalProblem) {
                generateDecimalProblem();
                return;
            }
            
            const userAnswer = parseFloat(document.getElementById('decimal-answer').value);
            const correctAnswer = currentDecimalProblem.answer;
            const feedback = document.getElementById('decimal-feedback');
            
            decimalAttempts++;
            
            // Allow for small floating point differences
            if (Math.abs(userAnswer - correctAnswer) < 0.001) {
                decimalScore++;
                feedback.textContent = '✅ Correct! Well done!';
                feedback.className = 'correct';
                setTimeout(generateDecimalProblem, 2000);
            } else {
                feedback.textContent = `❌ Not quite. The answer is ${correctAnswer}`;
                feedback.className = 'incorrect';
            }
            
            document.getElementById('decimal-score').textContent = decimalScore;
            document.getElementById('decimal-attempts').textContent = decimalAttempts;
        }

        // Initialize decimals tool when switching to it
        function initializeDecimals() {
            setDecimalNumber(12.5);
            generateDecimalProblem();
        }

        // Add to switchTool function
        const originalSwitchTool = window.switchTool;
        window.switchTool = function(tool) {
            originalSwitchTool(tool);
            if (tool === 'decimals') {
                initializeDecimals();
            }
        };
    </script>

    <!-- Perimeter & Area Tool -->
    <div id="perimeter-tool" class="tool-content">
        <div class="container">
            <div class="header">
                <h1>Perimeter & Area Explorer</h1>
                <p>Learn about perimeter and area using unit squares and interactive shapes!</p>
            </div>

            <div class="perimeter-main">
                <!-- Mode Selector -->
                <div class="perimeter-mode-selector">
                    <button class="perimeter-mode-btn active" onclick="setPerimeterMode('grid')">
                        📐 Grid Drawing
                    </button>
                    <button class="perimeter-mode-btn" onclick="setPerimeterMode('rectangle')">
                        ⬜ Rectangle Maker
                    </button>
                    <button class="perimeter-mode-btn" onclick="setPerimeterMode('irregular')">
                        🔷 Irregular Shapes
                    </button>
                    <button class="perimeter-mode-btn" onclick="setPerimeterMode('challenge')">
                        🎯 Challenges
                    </button>
                </div>

                <!-- Main Grid Canvas -->
                <div class="grid-container">
                    <canvas id="perimeter-canvas" width="600" height="600"></canvas>
                    <div class="grid-overlay" id="grid-overlay"></div>
                </div>

                <!-- Measurements Display -->
                <div class="measurements-display">
                    <div class="measurement-card perimeter-card">
                        <h3>Perimeter</h3>
                        <div class="measurement-value" id="perimeter-value">0</div>
                        <div class="measurement-unit">units</div>
                        <div class="measurement-formula" id="perimeter-formula"></div>
                    </div>
                    <div class="measurement-card area-card">
                        <h3>Area</h3>
                        <div class="measurement-value" id="area-value">0</div>
                        <div class="measurement-unit">square units</div>
                        <div class="measurement-formula" id="area-formula"></div>
                    </div>
                </div>

                <!-- Controls Panel -->
                <div class="perimeter-controls">
                    <!-- Grid Drawing Controls -->
                    <div id="grid-controls" class="control-section active">
                        <h3>Grid Drawing</h3>
                        <p>Click and drag to draw shapes on the grid!</p>
                        <button onclick="clearGrid()">🗑️ Clear Grid</button>
                        <button onclick="fillShape()">🎨 Highlight Perimeter</button>
                        <button onclick="countPerimeter()">📏 Count Perimeter</button>
                        <button onclick="showUnitSquareDemo()">📐 Unit Square Demo</button>
                        <label>
                            <input type="checkbox" id="show-numbers" checked onchange="toggleNumbers()">
                            Show Numbers
                        </label>
                        <label>
                            <input type="checkbox" id="show-coordinates" onchange="toggleCoordinates()">
                            Show Coordinates
                        </label>
                    </div>

                    <!-- Rectangle Controls -->
                    <div id="rectangle-controls" class="control-section">
                        <h3>Rectangle Maker</h3>
                        <div class="dimension-inputs">
                            <label>
                                Width: 
                                <input type="range" id="rect-width" min="1" max="15" value="5" 
                                       oninput="updateRectangle()">
                                <span id="rect-width-display">5</span>
                            </label>
                            <label>
                                Height: 
                                <input type="range" id="rect-height" min="1" max="15" value="3" 
                                       oninput="updateRectangle()">
                                <span id="rect-height-display">3</span>
                            </label>
                        </div>
                        <button onclick="rotateRectangle()">🔄 Rotate</button>
                        <button onclick="randomRectangle()">🎲 Random</button>
                    </div>

                    <!-- Irregular Shapes Controls -->
                    <div id="irregular-controls" class="control-section">
                        <h3>Irregular Shapes</h3>
                        <div class="shape-buttons">
                            <button onclick="createLShape()">L-Shape</button>
                            <button onclick="createTShape()">T-Shape</button>
                            <button onclick="createStairs()">Stairs</button>
                            <button onclick="createCross()">Cross</button>
                            <button onclick="createRandomIrregular()">Random Shape</button>
                        </div>
                        <p>Click vertices to edit the shape!</p>
                    </div>

                    <!-- Challenge Controls -->
                    <div id="challenge-controls" class="control-section">
                        <h3>Challenge Mode</h3>
                        <div id="challenge-prompt"></div>
                        <div class="challenge-input">
                            <label>
                                Your Answer: 
                                <input type="number" id="challenge-answer" min="0">
                            </label>
                            <button onclick="checkChallenge()">Check</button>
                        </div>
                        <div id="challenge-feedback"></div>
                        <button onclick="newChallenge()">New Challenge</button>
                        <div class="challenge-score">
                            Score: <span id="challenge-score">0</span> / <span id="challenge-attempts">0</span>
                        </div>
                    </div>
                </div>

                <!-- Visual Guide -->
                <div class="visual-guide">
                    <h3>Visual Guide</h3>
                    <div class="guide-items">
                        <div class="guide-item">
                            <div class="guide-square perimeter-highlight"></div>
                            <span>Perimeter (edge)</span>
                        </div>
                        <div class="guide-item">
                            <div class="guide-square area-highlight"></div>
                            <span>Area (inside)</span>
                        </div>
                        <div class="guide-item">
                            <div class="guide-square unit-square"></div>
                            <span>1 unit square</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Perimeter & Area Tool Styles */
        #perimeter-tool {
            padding: 20px;
        }

        .perimeter-main {
            max-width: 1200px;
            margin: 0 auto;
        }

        .perimeter-mode-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .perimeter-mode-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .perimeter-mode-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .perimeter-mode-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: transparent;
        }

        #perimeter-tool .grid-container {
            position: relative;
            width: 600px;
            height: 600px;
            margin: 0 auto 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        #perimeter-canvas {
            background: #2a2a3e;
            border-radius: 10px;
            cursor: crosshair;
            display: block;
            position: relative;
            transition: all 0.3s ease;
        }
        
        #perimeter-canvas:hover {
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }

        .measurements-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .measurement-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .perimeter-card {
            border: 2px solid #4CAF50;
        }

        .area-card {
            border: 2px solid #2196F3;
        }

        .measurement-value {
            font-size: 3rem;
            font-weight: bold;
            margin: 10px 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .measurement-unit {
            font-size: 0.9rem;
            color: #aaa;
        }

        .measurement-formula {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #ccc;
            font-family: 'Courier New', monospace;
            min-height: 20px;
        }

        .perimeter-controls {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .control-section {
            display: none;
        }

        .control-section.active {
            display: block;
        }

        .control-section button {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .control-section button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .dimension-inputs label {
            display: block;
            margin: 10px 0;
            color: #fff;
        }

        .dimension-inputs input[type="range"] {
            width: 200px;
            margin: 0 10px;
        }

        .shape-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        #challenge-prompt {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-size: 1.1rem;
            min-height: 60px;
        }

        .challenge-input input {
            padding: 8px;
            border-radius: 5px;
            border: 2px solid #667eea;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1rem;
            width: 100px;
            margin-right: 10px;
        }

        #challenge-feedback {
            margin: 15px 0;
            font-size: 1.1rem;
            min-height: 30px;
        }

        #challenge-feedback.correct {
            color: #4CAF50;
        }

        #challenge-feedback.incorrect {
            color: #ff6b6b;
        }

        .visual-guide {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .guide-items {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .guide-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .guide-square {
            width: 40px;
            height: 40px;
            border: 2px solid #fff;
            border-radius: 4px;
        }

        .perimeter-highlight {
            border: 4px solid #4CAF50;
            background: transparent;
        }

        .area-highlight {
            background: rgba(33, 150, 243, 0.5);
            border: 2px solid #2196F3;
        }

        .unit-square {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        @media (max-width: 768px) {
            #perimeter-tool .grid-container {
                width: 100%;
                max-width: 400px;
                height: 400px;
                padding: 10px;
            }

            #perimeter-canvas {
                width: 100%;
                height: 100%;
            }

            .measurements-display {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <script>
        // Perimeter & Area Tool Functions
        let perimeterCanvas, perimeterCtx;
        let gridSize = 20;
        let cellSize = 30;
        let currentMode = 'grid';
        let gridData = [];
        let isDrawing = false;
        let perimeterScore = 0;
        let perimeterAttempts = 0;
        let currentChallenge = null;

        function initializePerimeterTool() {
            perimeterCanvas = document.getElementById('perimeter-canvas');
            if (!perimeterCanvas) return;
            
            perimeterCtx = perimeterCanvas.getContext('2d');
            gridData = Array(gridSize).fill().map(() => Array(gridSize).fill(0));
            
            perimeterCanvas.addEventListener('mousedown', startDrawing);
            perimeterCanvas.addEventListener('mousemove', draw);
            perimeterCanvas.addEventListener('mouseup', stopDrawing);
            perimeterCanvas.addEventListener('mouseleave', () => {
                isDrawing = false;
                drawGrid();
            });
            perimeterCanvas.addEventListener('touchstart', handleTouch);
            perimeterCanvas.addEventListener('touchmove', handleTouch);
            perimeterCanvas.addEventListener('touchend', stopDrawing);
            
            drawGrid();
            updateMeasurements();
        }

        function drawGrid() {
            if (!perimeterCtx) return;
            
            perimeterCtx.clearRect(0, 0, perimeterCanvas.width, perimeterCanvas.height);
            
            // Draw background pattern for unit squares
            perimeterCtx.fillStyle = 'rgba(255, 255, 255, 0.02)';
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    if ((i + j) % 2 === 0) {
                        perimeterCtx.fillRect(i * cellSize, j * cellSize, cellSize, cellSize);
                    }
                }
            }
            
            // Draw grid lines with different thickness for every 5th line
            for (let i = 0; i <= gridSize; i++) {
                perimeterCtx.strokeStyle = i % 5 === 0 ? 'rgba(255, 255, 255, 0.3)' : 'rgba(255, 255, 255, 0.15)';
                perimeterCtx.lineWidth = i % 5 === 0 ? 2 : 1;
                
                perimeterCtx.beginPath();
                perimeterCtx.moveTo(i * cellSize, 0);
                perimeterCtx.lineTo(i * cellSize, gridSize * cellSize);
                perimeterCtx.stroke();
                
                perimeterCtx.beginPath();
                perimeterCtx.moveTo(0, i * cellSize);
                perimeterCtx.lineTo(gridSize * cellSize, i * cellSize);
                perimeterCtx.stroke();
            }
            
            // Draw filled squares
            for (let row = 0; row < gridSize; row++) {
                for (let col = 0; col < gridSize; col++) {
                    if (gridData[row][col] === 1) {
                        drawSquare(col, row, false);
                    } else if (gridData[row][col] === 2) {
                        drawSquare(col, row, true);
                    }
                }
            }
            
            if (currentMode === 'grid' || currentMode === 'irregular') {
                drawPerimeterOutline();
            }
            
            if (document.getElementById('show-numbers')?.checked) {
                drawNumbers();
            }
        }

        function drawSquare(x, y, isPerimeter) {
            const padding = 2;
            
            if (isPerimeter) {
                perimeterCtx.strokeStyle = '#4CAF50';
                perimeterCtx.lineWidth = 3;
                perimeterCtx.strokeRect(
                    x * cellSize + padding,
                    y * cellSize + padding,
                    cellSize - padding * 2,
                    cellSize - padding * 2
                );
            } else {
                // Draw unit square with gradient
                const gradient = perimeterCtx.createLinearGradient(
                    x * cellSize, y * cellSize,
                    (x + 1) * cellSize, (y + 1) * cellSize
                );
                gradient.addColorStop(0, 'rgba(33, 150, 243, 0.6)');
                gradient.addColorStop(1, 'rgba(33, 150, 243, 0.4)');
                
                perimeterCtx.fillStyle = gradient;
                perimeterCtx.fillRect(
                    x * cellSize + padding,
                    y * cellSize + padding,
                    cellSize - padding * 2,
                    cellSize - padding * 2
                );
                
                // Draw inner border for unit square
                perimeterCtx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                perimeterCtx.lineWidth = 1;
                perimeterCtx.strokeRect(
                    x * cellSize + padding,
                    y * cellSize + padding,
                    cellSize - padding * 2,
                    cellSize - padding * 2
                );
            }
        }

        function startDrawing(e) {
            if (currentMode !== 'grid') return;
            isDrawing = true;
            draw(e);
        }

        function draw(e) {
            const rect = perimeterCanvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / cellSize);
            const y = Math.floor((e.clientY - rect.top) / cellSize);
            
            if (x >= 0 && x < gridSize && y >= 0 && y < gridSize) {
                if (isDrawing && currentMode === 'grid') {
                    gridData[y][x] = gridData[y][x] === 0 ? 1 : 0;
                    drawGrid();
                    updateMeasurements();
                } else if (!isDrawing && currentMode === 'grid') {
                    // Show hover effect
                    drawGrid();
                    perimeterCtx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                    perimeterCtx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
                    
                    // Show "1 unit²" label on hover
                    perimeterCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    perimeterCtx.font = '10px Arial';
                    perimeterCtx.textAlign = 'center';
                    perimeterCtx.textBaseline = 'bottom';
                    perimeterCtx.fillText('1 unit²', x * cellSize + cellSize/2, y * cellSize + cellSize - 2);
                }
            }
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                             e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            perimeterCanvas.dispatchEvent(mouseEvent);
        }

        function clearGrid() {
            gridData = Array(gridSize).fill().map(() => Array(gridSize).fill(0));
            drawGrid();
            updateMeasurements();
        }

        function fillShape() {
            for (let row = 0; row < gridSize; row++) {
                for (let col = 0; col < gridSize; col++) {
                    if (gridData[row][col] === 1) {
                        let isEdge = false;
                        if (row === 0 || row === gridSize - 1 || col === 0 || col === gridSize - 1) {
                            isEdge = true;
                        } else {
                            if (gridData[row-1][col] === 0 || gridData[row+1][col] === 0 ||
                                gridData[row][col-1] === 0 || gridData[row][col+1] === 0) {
                                isEdge = true;
                            }
                        }
                        if (isEdge) {
                            gridData[row][col] = 2;
                        }
                    }
                }
            }
            drawGrid();
            updateMeasurements();
        }

        function countPerimeter() {
            let perimeter = 0;
            
            for (let row = 0; row < gridSize; row++) {
                for (let col = 0; col < gridSize; col++) {
                    if (gridData[row][col] > 0) {
                        if (row === 0 || gridData[row-1][col] === 0) perimeter++;
                        if (row === gridSize-1 || gridData[row+1][col] === 0) perimeter++;
                        if (col === 0 || gridData[row][col-1] === 0) perimeter++;
                        if (col === gridSize-1 || gridData[row][col+1] === 0) perimeter++;
                    }
                }
            }
            
            fillShape();
            return perimeter;
        }

        function drawPerimeterOutline() {
            if (!perimeterCtx) return;
            
            perimeterCtx.strokeStyle = '#4CAF50';
            perimeterCtx.lineWidth = 3;
            
            for (let row = 0; row < gridSize; row++) {
                for (let col = 0; col < gridSize; col++) {
                    if (gridData[row][col] > 0) {
                        const x = col * cellSize;
                        const y = row * cellSize;
                        
                        perimeterCtx.beginPath();
                        if (row === 0 || gridData[row-1][col] === 0) {
                            perimeterCtx.moveTo(x, y);
                            perimeterCtx.lineTo(x + cellSize, y);
                        }
                        if (row === gridSize-1 || gridData[row+1][col] === 0) {
                            perimeterCtx.moveTo(x, y + cellSize);
                            perimeterCtx.lineTo(x + cellSize, y + cellSize);
                        }
                        if (col === 0 || gridData[row][col-1] === 0) {
                            perimeterCtx.moveTo(x, y);
                            perimeterCtx.lineTo(x, y + cellSize);
                        }
                        if (col === gridSize-1 || gridData[row][col+1] === 0) {
                            perimeterCtx.moveTo(x + cellSize, y);
                            perimeterCtx.lineTo(x + cellSize, y + cellSize);
                        }
                        perimeterCtx.stroke();
                    }
                }
            }
        }

        function drawNumbers() {
            if (!perimeterCtx) return;
            
            perimeterCtx.font = 'bold 14px Arial';
            perimeterCtx.textAlign = 'center';
            perimeterCtx.textBaseline = 'middle';
            
            let count = 1;
            for (let row = 0; row < gridSize; row++) {
                for (let col = 0; col < gridSize; col++) {
                    if (gridData[row][col] > 0) {
                        // Draw background circle for number
                        perimeterCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                        perimeterCtx.beginPath();
                        perimeterCtx.arc(
                            col * cellSize + cellSize / 2,
                            row * cellSize + cellSize / 2,
                            10,
                            0,
                            Math.PI * 2
                        );
                        perimeterCtx.fill();
                        
                        // Draw number
                        perimeterCtx.fillStyle = 'white';
                        perimeterCtx.fillText(
                            count++,
                            col * cellSize + cellSize / 2,
                            row * cellSize + cellSize / 2
                        );
                    }
                }
            }
        }

        function toggleNumbers() {
            drawGrid();
        }

        function updateMeasurements() {
            let area = 0;
            let perimeter = 0;
            
            for (let row = 0; row < gridSize; row++) {
                for (let col = 0; col < gridSize; col++) {
                    if (gridData[row][col] > 0) {
                        area++;
                    }
                }
            }
            
            perimeter = countPerimeter();
            
            const areaElement = document.getElementById('area-value');
            const perimeterElement = document.getElementById('perimeter-value');
            
            if (areaElement) areaElement.textContent = area;
            if (perimeterElement) perimeterElement.textContent = perimeter;
            
            if (currentMode === 'rectangle') {
                const width = parseInt(document.getElementById('rect-width')?.value || 5);
                const height = parseInt(document.getElementById('rect-height')?.value || 3);
                const areaFormula = document.getElementById('area-formula');
                const perimeterFormula = document.getElementById('perimeter-formula');
                if (areaFormula) areaFormula.textContent = `${width} × ${height} = ${area}`;
                if (perimeterFormula) perimeterFormula.textContent = `2 × (${width} + ${height}) = ${perimeter}`;
            } else {
                const areaFormula = document.getElementById('area-formula');
                const perimeterFormula = document.getElementById('perimeter-formula');
                if (areaFormula) areaFormula.textContent = area > 0 ? `Count: ${area} squares` : '';
                if (perimeterFormula) perimeterFormula.textContent = perimeter > 0 ? `Count: ${perimeter} units` : '';
            }
        }

        function setPerimeterMode(mode) {
            currentMode = mode;
            
            document.querySelectorAll('.perimeter-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.control-section').forEach(section => {
                section.classList.remove('active');
            });
            
            const controlSection = document.getElementById(`${mode}-controls`);
            if (controlSection) controlSection.classList.add('active');
            
            clearGrid();
            
            if (mode === 'rectangle') {
                updateRectangle();
            } else if (mode === 'challenge') {
                newChallenge();
            }
        }

        function updateRectangle() {
            const widthInput = document.getElementById('rect-width');
            const heightInput = document.getElementById('rect-height');
            
            if (!widthInput || !heightInput) return;
            
            const width = parseInt(widthInput.value);
            const height = parseInt(heightInput.value);
            
            const widthDisplay = document.getElementById('rect-width-display');
            const heightDisplay = document.getElementById('rect-height-display');
            
            if (widthDisplay) widthDisplay.textContent = width;
            if (heightDisplay) heightDisplay.textContent = height;
            
            clearGrid();
            
            const startX = Math.floor((gridSize - width) / 2);
            const startY = Math.floor((gridSize - height) / 2);
            
            for (let row = startY; row < startY + height && row < gridSize; row++) {
                for (let col = startX; col < startX + width && col < gridSize; col++) {
                    if (row >= 0 && col >= 0) {
                        gridData[row][col] = 1;
                    }
                }
            }
            
            drawGrid();
            updateMeasurements();
        }

        function rotateRectangle() {
            const widthInput = document.getElementById('rect-width');
            const heightInput = document.getElementById('rect-height');
            
            if (!widthInput || !heightInput) return;
            
            const width = widthInput.value;
            const height = heightInput.value;
            
            widthInput.value = height;
            heightInput.value = width;
            
            updateRectangle();
        }

        function randomRectangle() {
            const widthInput = document.getElementById('rect-width');
            const heightInput = document.getElementById('rect-height');
            
            if (!widthInput || !heightInput) return;
            
            widthInput.value = Math.floor(Math.random() * 10) + 3;
            heightInput.value = Math.floor(Math.random() * 10) + 3;
            updateRectangle();
        }

        function createLShape() {
            clearGrid();
            const size = 6;
            const startX = Math.floor((gridSize - size) / 2);
            const startY = Math.floor((gridSize - size) / 2);
            
            for (let i = 0; i < size; i++) {
                gridData[startY + i][startX] = 1;
                if (i < size / 2) {
                    gridData[startY + size - 1][startX + i] = 1;
                }
            }
            
            drawGrid();
            updateMeasurements();
        }

        function createTShape() {
            clearGrid();
            const width = 7;
            const height = 7;
            const startX = Math.floor((gridSize - width) / 2);
            const startY = Math.floor((gridSize - height) / 2);
            
            for (let i = 0; i < width; i++) {
                gridData[startY][startX + i] = 1;
            }
            for (let i = 1; i < height; i++) {
                gridData[startY + i][startX + Math.floor(width / 2)] = 1;
            }
            
            drawGrid();
            updateMeasurements();
        }

        function createStairs() {
            clearGrid();
            const steps = 5;
            const startX = Math.floor((gridSize - steps * 2) / 2);
            const startY = Math.floor((gridSize - steps * 2) / 2);
            
            for (let step = 0; step < steps; step++) {
                for (let i = 0; i <= step; i++) {
                    for (let j = 0; j <= step; j++) {
                        gridData[startY + step * 2 + i][startX + step * 2 + j] = 1;
                    }
                }
            }
            
            drawGrid();
            updateMeasurements();
        }

        function createCross() {
            clearGrid();
            const size = 9;
            const thickness = 3;
            const startX = Math.floor((gridSize - size) / 2);
            const startY = Math.floor((gridSize - size) / 2);
            
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < thickness; j++) {
                    gridData[startY + Math.floor(size / 2) - Math.floor(thickness / 2) + j][startX + i] = 1;
                }
            }
            
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < thickness; j++) {
                    gridData[startY + i][startX + Math.floor(size / 2) - Math.floor(thickness / 2) + j] = 1;
                }
            }
            
            drawGrid();
            updateMeasurements();
        }

        function createRandomIrregular() {
            clearGrid();
            
            const numSquares = Math.floor(Math.random() * 20) + 10;
            const startX = Math.floor(gridSize / 2);
            const startY = Math.floor(gridSize / 2);
            
            gridData[startY][startX] = 1;
            let filled = [{x: startX, y: startY}];
            
            while (filled.length < numSquares) {
                const current = filled[Math.floor(Math.random() * filled.length)];
                const directions = [
                    {dx: 0, dy: -1}, {dx: 0, dy: 1},
                    {dx: -1, dy: 0}, {dx: 1, dy: 0}
                ];
                
                const dir = directions[Math.floor(Math.random() * directions.length)];
                const newX = current.x + dir.dx;
                const newY = current.y + dir.dy;
                
                if (newX >= 0 && newX < gridSize && newY >= 0 && newY < gridSize && gridData[newY][newX] === 0) {
                    gridData[newY][newX] = 1;
                    filled.push({x: newX, y: newY});
                }
            }
            
            drawGrid();
            updateMeasurements();
        }

        function newChallenge() {
            const challenges = [
                {
                    type: 'area',
                    generate: () => {
                        const width = Math.floor(Math.random() * 8) + 3;
                        const height = Math.floor(Math.random() * 8) + 3;
                        
                        clearGrid();
                        const startX = Math.floor((gridSize - width) / 2);
                        const startY = Math.floor((gridSize - height) / 2);
                        
                        for (let row = startY; row < startY + height; row++) {
                            for (let col = startX; col < startX + width; col++) {
                                gridData[row][col] = 1;
                            }
                        }
                        
                        drawGrid();
                        
                        return {
                            question: `What is the area of this rectangle? (${width} × ${height})`,
                            answer: width * height,
                            type: 'area'
                        };
                    }
                },
                {
                    type: 'perimeter',
                    generate: () => {
                        const width = Math.floor(Math.random() * 8) + 3;
                        const height = Math.floor(Math.random() * 8) + 3;
                        
                        clearGrid();
                        const startX = Math.floor((gridSize - width) / 2);
                        const startY = Math.floor((gridSize - height) / 2);
                        
                        for (let row = startY; row < startY + height; row++) {
                            for (let col = startX; col < startX + width; col++) {
                                gridData[row][col] = 1;
                            }
                        }
                        
                        drawGrid();
                        
                        return {
                            question: `What is the perimeter of this rectangle? (${width} × ${height})`,
                            answer: 2 * (width + height),
                            type: 'perimeter'
                        };
                    }
                }
            ];
            
            const challengeType = challenges[Math.floor(Math.random() * challenges.length)];
            currentChallenge = challengeType.generate();
            
            const promptElement = document.getElementById('challenge-prompt');
            if (promptElement) {
                promptElement.innerHTML = `<strong>Challenge:</strong> ${currentChallenge.question}`;
            }
            
            const answerInput = document.getElementById('challenge-answer');
            if (answerInput) answerInput.value = '';
            
            const feedback = document.getElementById('challenge-feedback');
            if (feedback) feedback.textContent = '';
        }

        function checkChallenge() {
            if (!currentChallenge) {
                newChallenge();
                return;
            }
            
            const answerInput = document.getElementById('challenge-answer');
            const feedback = document.getElementById('challenge-feedback');
            
            if (!answerInput || !feedback) return;
            
            const userAnswer = parseInt(answerInput.value);
            
            perimeterAttempts++;
            
            if (userAnswer === currentChallenge.answer) {
                perimeterScore++;
                feedback.textContent = '✅ Correct! Well done!';
                feedback.className = 'correct';
                setTimeout(newChallenge, 2000);
            } else {
                feedback.textContent = `❌ Not quite. The answer is ${currentChallenge.answer}`;
                feedback.className = 'incorrect';
            }
            
            const scoreElement = document.getElementById('challenge-score');
            const attemptsElement = document.getElementById('challenge-attempts');
            
            if (scoreElement) scoreElement.textContent = perimeterScore;
            if (attemptsElement) attemptsElement.textContent = perimeterAttempts;
        }

        function initializePerimeter() {
            if (!perimeterCanvas) {
                initializePerimeterTool();
            }
            drawGrid();
        }

        // Additional unit square functions
        function showUnitSquareDemo() {
            clearGrid();
            
            // Create a demo shape that clearly shows unit squares
            const demoShape = [
                [5, 5], [6, 5], [7, 5], [8, 5], [9, 5],
                [5, 6], [9, 6],
                [5, 7], [6, 7], [7, 7], [8, 7], [9, 7],
                [5, 8], [9, 8],
                [5, 9], [6, 9], [7, 9], [8, 9], [9, 9]
            ];
            
            demoShape.forEach(([col, row]) => {
                if (row < gridSize && col < gridSize) {
                    gridData[row][col] = 1;
                }
            });
            
            drawGrid();
            updateMeasurements();
            
            // Flash animation to highlight unit squares
            let flash = 0;
            const flashInterval = setInterval(() => {
                flash++;
                if (flash > 3) {
                    clearInterval(flashInterval);
                    drawGrid();
                    return;
                }
                
                if (flash % 2 === 1) {
                    // Highlight each unit square
                    demoShape.forEach(([col, row], index) => {
                        setTimeout(() => {
                            if (row < gridSize && col < gridSize) {
                                perimeterCtx.fillStyle = 'rgba(255, 215, 0, 0.3)';
                                perimeterCtx.fillRect(
                                    col * cellSize,
                                    row * cellSize,
                                    cellSize,
                                    cellSize
                                );
                            }
                        }, index * 50);
                    });
                } else {
                    drawGrid();
                }
            }, 1000);
        }
        
        function toggleCoordinates() {
            drawGrid();
            
            if (document.getElementById('show-coordinates')?.checked) {
                // Draw coordinate labels
                perimeterCtx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                perimeterCtx.font = '10px Arial';
                perimeterCtx.textAlign = 'center';
                perimeterCtx.textBaseline = 'middle';
                
                // Draw x-axis labels
                for (let i = 0; i < gridSize; i++) {
                    if (i % 5 === 0) {
                        perimeterCtx.fillText(
                            i.toString(),
                            i * cellSize + cellSize / 2,
                            gridSize * cellSize + 15
                        );
                    }
                }
                
                // Draw y-axis labels
                for (let i = 0; i < gridSize; i++) {
                    if (i % 5 === 0) {
                        perimeterCtx.fillText(
                            i.toString(),
                            -15,
                            i * cellSize + cellSize / 2
                        );
                    }
                }
            }
        }
        
        // Update switchTool function
        if (window.switchTool) {
            const originalSwitchToolPerimeter = window.switchTool;
            window.switchTool = function(tool) {
                originalSwitchToolPerimeter(tool);
                if (tool === 'perimeter') {
                    initializePerimeter();
                }
            };
        }
    </script>

    <!-- Euclid Proofs Tool -->
    <div id="euclid-tool" class="tool-content">
        <div class="container">
            <div class="header">
                <h1>Euclid's Geometric Proofs</h1>
                <p>Explore classic geometric proofs with interactive animations</p>
            </div>

            <div class="euclid-main">
                <!-- Proof Selector -->
                <div class="euclid-proof-selector">
                    <button class="euclid-proof-btn active" onclick="selectProof('pythagorean')">
                        📐 Pythagorean Theorem
                    </button>
                    <button class="euclid-proof-btn" onclick="selectProof('angles')">
                        📏 Sum of Angles in Triangle
                    </button>
                    <button class="euclid-proof-btn" onclick="selectProof('parallel')">
                        ═ Parallel Lines
                    </button>
                    <button class="euclid-proof-btn" onclick="selectProof('circle')">
                        ⭕ Circle Theorems
                    </button>
                </div>

                <!-- Main Canvas for Proofs -->
                <div class="euclid-canvas-container">
                    <svg id="euclid-canvas" viewBox="0 0 600 400" class="euclid-main-svg">
                        <!-- Dynamic content will be inserted here -->
                    </svg>
                </div>

                <!-- Proof Steps -->
                <div class="euclid-steps">
                    <h3>Proof Steps</h3>
                    <div id="euclid-steps-content">
                        <!-- Steps will be dynamically inserted -->
                    </div>
                </div>

                <!-- Controls -->
                <div class="euclid-controls">
                    <button onclick="playProof()" class="euclid-control-btn play">▶️ Play</button>
                    <button onclick="pauseProof()" class="euclid-control-btn pause">⏸️ Pause</button>
                    <button onclick="resetProof()" class="euclid-control-btn reset">🔄 Reset</button>
                    <button onclick="stepForward()" class="euclid-control-btn step">⏭️ Next Step</button>
                    <label class="speed-control">
                        Speed: 
                        <input type="range" id="proof-speed" min="0.5" max="3" step="0.5" value="1">
                        <span id="speed-display">1x</span>
                    </label>
                </div>

                <!-- Explanation Panel -->
                <div class="euclid-explanation">
                    <h3>Understanding the Proof</h3>
                    <div id="euclid-explanation-content">
                        <!-- Explanation will be dynamically inserted -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Euclid Proofs Tool Styles */
        #euclid-tool {
            padding: 20px;
        }

        .euclid-main {
            max-width: 1200px;
            margin: 0 auto;
        }

        .euclid-proof-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .euclid-proof-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .euclid-proof-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .euclid-proof-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: transparent;
        }

        .euclid-canvas-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .euclid-main-svg {
            width: 100%;
            height: 400px;
            background: #2a2a3e;
            border-radius: 10px;
        }

        .euclid-steps {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .euclid-steps h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        #euclid-steps-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .proof-step {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .proof-step.active {
            background: rgba(102, 126, 234, 0.2);
            border-left-color: #667eea;
        }

        .proof-step.completed {
            opacity: 0.7;
            border-left-color: #4CAF50;
        }

        .euclid-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .euclid-control-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .euclid-control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .speed-control input {
            width: 100px;
        }

        .euclid-explanation {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
        }

        .euclid-explanation h3 {
            color: #764ba2;
            margin-bottom: 15px;
        }

        #euclid-explanation-content {
            color: #ccc;
            line-height: 1.6;
        }

        /* SVG Element Styles */
        .euclid-line {
            stroke: #667eea;
            stroke-width: 2;
            fill: none;
        }

        .euclid-shape {
            fill: rgba(102, 126, 234, 0.3);
            stroke: #667eea;
            stroke-width: 2;
        }

        .euclid-point {
            fill: #ff6b6b;
            r: 4;
        }

        .euclid-text {
            fill: white;
            font-size: 14px;
            font-weight: bold;
        }

        .euclid-angle-arc {
            fill: none;
            stroke: #4CAF50;
            stroke-width: 2;
        }

        .euclid-highlight {
            animation: highlightPulse 1s ease-in-out infinite;
        }

        @keyframes highlightPulse {
            0%, 100% {
                opacity: 0.3;
            }
            50% {
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .euclid-canvas-container {
                padding: 10px;
            }

            .euclid-main-svg {
                height: 300px;
            }

            .euclid-proof-btn {
                font-size: 0.9rem;
                padding: 10px 20px;
            }
        }
    </style>

    <script>
        // Euclid Proofs Tool Functions
        let currentProof = 'pythagorean';
        let proofStep = 0;
        let isPlaying = false;
        let proofInterval = null;
        let proofSpeed = 1;

        function selectProof(proofType) {
            currentProof = proofType;
            proofStep = 0;
            isPlaying = false;
            
            // Update button states
            document.querySelectorAll('.euclid-proof-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load the selected proof
            loadProof(proofType);
        }

        function loadProof(proofType) {
            const canvas = document.getElementById('euclid-canvas');
            const stepsContent = document.getElementById('euclid-steps-content');
            const explanationContent = document.getElementById('euclid-explanation-content');
            
            switch(proofType) {
                case 'pythagorean':
                    loadPythagoreanProof(canvas, stepsContent, explanationContent);
                    break;
                case 'angles':
                    loadAnglesProof(canvas, stepsContent, explanationContent);
                    break;
                case 'parallel':
                    loadParallelProof(canvas, stepsContent, explanationContent);
                    break;
                case 'circle':
                    loadCircleProof(canvas, stepsContent, explanationContent);
                    break;
            }
        }

        function loadPythagoreanProof(canvas, stepsContent, explanationContent) {
            // Clear canvas
            canvas.innerHTML = `
                <g id="pythag-proof">
                    <!-- Background grid -->
                    <defs>
                        <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/>
                        </pattern>
                    </defs>
                    <rect width="600" height="400" fill="url(#grid)" />
                    
                    <!-- Step 1: Draw triangle -->
                    <g id="step-1" opacity="0">
                        <path d="M 150 250 L 300 250 L 300 150 Z" 
                              class="euclid-shape" 
                              fill="rgba(102, 126, 234, 0.3)" 
                              stroke="#667eea" 
                              stroke-width="2"/>
                        <circle cx="150" cy="250" class="euclid-point" />
                        <circle cx="300" cy="250" class="euclid-point" />
                        <circle cx="300" cy="150" class="euclid-point" />
                        <text x="140" y="270" class="euclid-text">A</text>
                        <text x="310" y="270" class="euclid-text">B</text>
                        <text x="310" y="145" class="euclid-text">C</text>
                    </g>
                    
                    <!-- Step 2: Square on side a -->
                    <g id="step-2" opacity="0">
                        <rect x="150" y="250" width="150" height="150" 
                              fill="rgba(102, 126, 234, 0.2)" 
                              stroke="#667eea" 
                              stroke-width="2"/>
                        <text x="225" y="330" class="euclid-text" font-size="20">a²</text>
                    </g>
                    
                    <!-- Step 3: Square on side b -->
                    <g id="step-3" opacity="0">
                        <rect x="300" y="150" width="100" height="100" 
                              fill="rgba(118, 75, 162, 0.2)" 
                              stroke="#764ba2" 
                              stroke-width="2"/>
                        <text x="340" y="205" class="euclid-text" font-size="20">b²</text>
                    </g>
                    
                    <!-- Step 4: Square on hypotenuse c -->
                    <g id="step-4" opacity="0" transform="rotate(-33.69, 225, 200)">
                        <rect x="150" y="120" width="180" height="180" 
                              fill="rgba(255, 107, 107, 0.2)" 
                              stroke="#ff6b6b" 
                              stroke-width="2"/>
                        <text x="240" y="215" class="euclid-text" font-size="20" 
                              transform="rotate(33.69, 240, 215)">c²</text>
                    </g>
                    
                    <!-- Step 5: Formula -->
                    <g id="step-5" opacity="0">
                        <text x="300" y="50" class="euclid-text" font-size="24" text-anchor="middle">
                            a² + b² = c²
                        </text>
                    </g>
                </g>
            `;
            
            // Load steps
            stepsContent.innerHTML = `
                <div class="proof-step" data-step="0">Step 1: Draw a right triangle ABC</div>
                <div class="proof-step" data-step="1">Step 2: Construct a square on side a (AB)</div>
                <div class="proof-step" data-step="2">Step 3: Construct a square on side b (BC)</div>
                <div class="proof-step" data-step="3">Step 4: Construct a square on the hypotenuse c (AC)</div>
                <div class="proof-step" data-step="4">Step 5: The sum of areas a² + b² equals c²</div>
            `;
            
            // Load explanation
            explanationContent.innerHTML = `
                <p>The <strong>Pythagorean Theorem</strong> states that in a right triangle, the square of the hypotenuse (the side opposite the right angle) is equal to the sum of the squares of the other two sides.</p>
                <p>This visual proof shows how the areas of squares constructed on each side of the triangle relate to each other. Watch as we build squares on each side and see how the two smaller squares equal the area of the largest square.</p>
                <p>This theorem is fundamental in geometry and has countless applications in mathematics, physics, and engineering.</p>
            `;
            
            // Highlight first step
            updateStepHighlight(0);
        }

        function loadAnglesProof(canvas, stepsContent, explanationContent) {
            canvas.innerHTML = `
                <g id="angles-proof">
                    <rect width="600" height="400" fill="url(#grid)" />
                    
                    <!-- Triangle -->
                    <g id="triangle-base" opacity="0">
                        <path d="M 100 300 L 400 300 L 250 100 Z" 
                              class="euclid-shape" />
                        <text x="90" y="320" class="euclid-text">A</text>
                        <text x="410" y="320" class="euclid-text">B</text>
                        <text x="250" y="90" class="euclid-text">C</text>
                    </g>
                    
                    <!-- Angles -->
                    <g id="angle-marks" opacity="0">
                        <path d="M 130 300 A 30 30 0 0 1 115 275" 
                              class="euclid-angle-arc" />
                        <path d="M 370 300 A 30 30 0 0 1 385 275" 
                              class="euclid-angle-arc" />
                        <path d="M 235 130 A 30 30 0 0 1 265 130" 
                              class="euclid-angle-arc" />
                        <text x="130" y="280" class="euclid-text">α</text>
                        <text x="360" y="280" class="euclid-text">β</text>
                        <text x="245" y="130" class="euclid-text">γ</text>
                    </g>
                    
                    <!-- Parallel line -->
                    <g id="parallel-line" opacity="0">
                        <line x1="50" y1="100" x2="450" y2="100" 
                              stroke="#4CAF50" stroke-width="2" stroke-dasharray="5,5" />
                        <text x="460" y="105" class="euclid-text">Parallel to AB</text>
                    </g>
                    
                    <!-- Formula -->
                    <g id="angle-formula" opacity="0">
                        <text x="300" y="50" class="euclid-text" font-size="24" text-anchor="middle">
                            α + β + γ = 180°
                        </text>
                    </g>
                </g>
            `;
            
            stepsContent.innerHTML = `
                <div class="proof-step" data-step="0">Step 1: Draw triangle ABC</div>
                <div class="proof-step" data-step="1">Step 2: Mark the three angles α, β, and γ</div>
                <div class="proof-step" data-step="2">Step 3: Draw a line parallel to AB through point C</div>
                <div class="proof-step" data-step="3">Step 4: Angles sum to 180° (straight angle)</div>
            `;
            
            explanationContent.innerHTML = `
                <p>This proof demonstrates that the <strong>sum of angles in any triangle equals 180°</strong>.</p>
                <p>By drawing a line parallel to one side through the opposite vertex, we can show that the three angles of the triangle form a straight angle, which measures exactly 180°.</p>
            `;
            
            updateStepHighlight(0);
        }

        function playProof() {
            if (isPlaying) return;
            
            isPlaying = true;
            proofInterval = setInterval(() => {
                if (proofStep < getMaxSteps()) {
                    stepForward();
                } else {
                    pauseProof();
                }
            }, 2000 / proofSpeed);
        }

        function pauseProof() {
            isPlaying = false;
            if (proofInterval) {
                clearInterval(proofInterval);
                proofInterval = null;
            }
        }

        function resetProof() {
            pauseProof();
            proofStep = 0;
            animateStep(0);
            updateStepHighlight(0);
        }

        function stepForward() {
            if (proofStep < getMaxSteps()) {
                proofStep++;
                animateStep(proofStep);
                updateStepHighlight(proofStep);
            }
        }

        function getMaxSteps() {
            const steps = document.querySelectorAll('.proof-step');
            return steps.length - 1;
        }

        function animateStep(step) {
            // Animate SVG elements based on step
            for (let i = 1; i <= step + 1; i++) {
                const element = document.getElementById(`step-${i}`);
                if (element) {
                    element.style.opacity = '1';
                    element.style.transition = `opacity 0.5s ease-in-out`;
                }
            }
            
            // Hide future steps
            for (let i = step + 2; i <= 5; i++) {
                const element = document.getElementById(`step-${i}`);
                if (element) {
                    element.style.opacity = '0';
                }
            }
        }

        function updateStepHighlight(step) {
            document.querySelectorAll('.proof-step').forEach((el, index) => {
                el.classList.remove('active', 'completed');
                if (index < step) {
                    el.classList.add('completed');
                } else if (index === step) {
                    el.classList.add('active');
                }
            });
        }

        // Speed control
        document.getElementById('proof-speed')?.addEventListener('input', (e) => {
            proofSpeed = parseFloat(e.target.value);
            document.getElementById('speed-display').textContent = proofSpeed + 'x';
            
            // Restart animation if playing
            if (isPlaying) {
                pauseProof();
                playProof();
            }
        });

        // Initialize with Pythagorean theorem
        if (document.getElementById('euclid-tool')) {
            setTimeout(() => {
                if (document.getElementById('euclid-canvas')) {
                    loadProof('pythagorean');
                }
            }, 100);
        }

        function loadParallelProof(canvas, stepsContent, explanationContent) {
            canvas.innerHTML = `
                <g id="parallel-proof">
                    <rect width="600" height="400" fill="url(#grid)" />
                    
                    <!-- Parallel lines -->
                    <g id="parallel-lines-base" opacity="0">
                        <line x1="100" y1="150" x2="500" y2="150" class="euclid-line" />
                        <line x1="100" y1="250" x2="500" y2="250" class="euclid-line" />
                        <text x="510" y="155" class="euclid-text">Line 1</text>
                        <text x="510" y="255" class="euclid-text">Line 2</text>
                    </g>
                    
                    <!-- Transversal -->
                    <g id="transversal" opacity="0">
                        <line x1="200" y1="50" x2="400" y2="350" stroke="#ff6b6b" stroke-width="2" />
                        <text x="410" y="355" class="euclid-text">Transversal</text>
                    </g>
                    
                    <!-- Angles -->
                    <g id="corresponding-angles" opacity="0">
                        <path d="M 270 150 A 20 20 0 0 1 285 165" class="euclid-angle-arc" />
                        <path d="M 320 250 A 20 20 0 0 1 335 265" class="euclid-angle-arc" />
                        <text x="275" y="170" class="euclid-text">α</text>
                        <text x="325" y="270" class="euclid-text">α</text>
                    </g>
                    
                    <!-- Alternate angles -->
                    <g id="alternate-angles" opacity="0">
                        <path d="M 285 135 A 20 20 0 0 1 270 150" stroke="#4CAF50" stroke-width="2" fill="none" />
                        <path d="M 320 250 A 20 20 0 0 1 305 235" stroke="#4CAF50" stroke-width="2" fill="none" />
                        <text x="260" y="140" class="euclid-text" fill="#4CAF50">β</text>
                        <text x="295" y="240" class="euclid-text" fill="#4CAF50">β</text>
                    </g>
                </g>
            `;
            
            stepsContent.innerHTML = `
                <div class="proof-step" data-step="0">Step 1: Draw two parallel lines</div>
                <div class="proof-step" data-step="1">Step 2: Draw a transversal crossing both lines</div>
                <div class="proof-step" data-step="2">Step 3: Corresponding angles are equal</div>
                <div class="proof-step" data-step="3">Step 4: Alternate angles are equal</div>
            `;
            
            explanationContent.innerHTML = `
                <p>When a transversal crosses two <strong>parallel lines</strong>, it creates several important angle relationships.</p>
                <p><strong>Corresponding angles</strong> (same position at each intersection) are equal.</p>
                <p><strong>Alternate angles</strong> (on opposite sides of the transversal) are also equal.</p>
            `;
        }

        function loadCircleProof(canvas, stepsContent, explanationContent) {
            canvas.innerHTML = `
                <g id="circle-proof">
                    <rect width="600" height="400" fill="url(#grid)" />
                    
                    <!-- Circle -->
                    <g id="circle-base" opacity="0">
                        <circle cx="300" cy="200" r="100" fill="none" stroke="#667eea" stroke-width="2" />
                        <circle cx="300" cy="200" r="3" fill="#ff6b6b" />
                        <text x="305" y="205" class="euclid-text">O</text>
                    </g>
                    
                    <!-- Inscribed angle -->
                    <g id="inscribed-angle" opacity="0">
                        <path d="M 250 120 L 300 200 L 380 180" fill="none" stroke="#4CAF50" stroke-width="2" />
                        <circle cx="250" cy="120" r="3" fill="#ff6b6b" />
                        <circle cx="380" cy="180" r="3" fill="#ff6b6b" />
                        <text x="235" y="115" class="euclid-text">A</text>
                        <text x="385" y="180" class="euclid-text">B</text>
                        <path d="M 285 185 A 15 15 0 0 1 290 170" class="euclid-angle-arc" />
                        <text x="270" y="175" class="euclid-text">θ</text>
                    </g>
                    
                    <!-- Central angle -->
                    <g id="central-angle" opacity="0">
                        <line x1="300" y1="200" x2="250" y2="120" stroke="#764ba2" stroke-width="2" />
                        <line x1="300" y1="200" x2="380" y2="180" stroke="#764ba2" stroke-width="2" />
                        <path d="M 285 190 A 20 20 0 0 1 295 185" stroke="#764ba2" stroke-width="2" fill="none" />
                        <text x="305" y="185" class="euclid-text" fill="#764ba2">2θ</text>
                    </g>
                    
                    <!-- Formula -->
                    <g id="circle-formula" opacity="0">
                        <text x="300" y="350" class="euclid-text" font-size="20" text-anchor="middle">
                            Central angle = 2 × Inscribed angle
                        </text>
                    </g>
                </g>
            `;
            
            stepsContent.innerHTML = `
                <div class="proof-step" data-step="0">Step 1: Draw a circle with center O</div>
                <div class="proof-step" data-step="1">Step 2: Draw an inscribed angle from point on circle</div>
                <div class="proof-step" data-step="2">Step 3: Draw the central angle to same arc</div>
                <div class="proof-step" data-step="3">Step 4: Central angle is twice the inscribed angle</div>
            `;
            
            explanationContent.innerHTML = `
                <p>The <strong>Inscribed Angle Theorem</strong> states that an angle inscribed in a circle is half the central angle that subtends the same arc.</p>
                <p>This is a fundamental theorem in circle geometry with many applications in construction and design.</p>
            `;
        }
    </script>

    <!-- Graphs Tool -->
    <div id="graphs-tool" class="tool-content">
        <div class="container">
            <div class="header">
                <h1>📈 Interactive Graph Plotter</h1>
                <p>Visualize linear and quadratic functions</p>
            </div>
            <div class="graphs-container">
                <div class="graph-controls">
                    <h3>Function Controls</h3>
                    <div class="function-selector">
                        <button class="func-btn active" onclick="selectFunction('linear')">Linear (y = mx + b)</button>
                        <button class="func-btn" onclick="selectFunction('quadratic')">Quadratic (y = ax² + bx + c)</button>
                    </div>
                    <div class="parameters" id="linear-params">
                        <label>Slope (m): <input type="range" id="m-value" min="-5" max="5" step="0.5" value="1" oninput="updateGraph()"><span id="m-display">1</span></label>
                        <label>Y-intercept (b): <input type="range" id="b-value" min="-10" max="10" step="1" value="0" oninput="updateGraph()"><span id="b-display">0</span></label>
                    </div>
                    <div class="parameters" id="quadratic-params" style="display:none;">
                        <label>a: <input type="range" id="a-value" min="-2" max="2" step="0.1" value="1" oninput="updateGraph()"><span id="a-display">1</span></label>
                        <label>b: <input type="range" id="b2-value" min="-5" max="5" step="0.5" value="0" oninput="updateGraph()"><span id="b2-display">0</span></label>
                        <label>c: <input type="range" id="c-value" min="-10" max="10" step="1" value="0" oninput="updateGraph()"><span id="c-display">0</span></label>
                    </div>
                    <div class="equation-display">
                        <h4>Current Equation:</h4>
                        <div id="equation-text">y = 1x + 0</div>
                    </div>
                </div>
                <div class="graph-area">
                    <canvas id="graph-canvas" width="500" height="500"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Algebra Solver Tool -->
    <div id="algebra-tool" class="tool-content">
        <div class="container">
            <div class="header">
                <h1>🔢 Algebra Equation Solver</h1>
                <p>Step-by-step solutions for algebraic equations</p>
            </div>
            <div class="algebra-container">
                <div class="equation-input">
                    <h3>Enter Your Equation</h3>
                    <input type="text" id="equation-input" placeholder="e.g., 2x + 5 = 13" value="2x + 5 = 13">
                    <button onclick="solveEquation()">Solve Step by Step</button>
                </div>
                <div class="solution-steps">
                    <h3>Solution Steps</h3>
                    <div id="steps-display"></div>
                </div>
                <div class="visual-balance">
                    <h3>Balance Scale Visualization</h3>
                    <div class="balance-viz">
                        <div class="balance-left-viz" id="left-side">2x + 5</div>
                        <div class="balance-center">⚖</div>
                        <div class="balance-right-viz" id="right-side">13</div>
                    </div>
                </div>
                <div class="practice-problems">
                    <h3>Practice Problems</h3>
                    <div class="problem-list">
                        <button onclick="loadProblem('3x - 7 = 8')">3x - 7 = 8</button>
                        <button onclick="loadProblem('5x + 2 = 17')">5x + 2 = 17</button>
                        <button onclick="loadProblem('2x + 4 = 3x - 1')">2x + 4 = 3x - 1</button>
                        <button onclick="loadProblem('4(x - 2) = 12')">4(x - 2) = 12</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Graphs Tool Styles */
        .graphs-container {
            display: flex;
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .graph-controls {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
        }
        
        .function-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .func-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .func-btn.active {
            background: linear-gradient(135deg, #00ff41, #00c832);
            border-color: transparent;
            color: #1a1a1a;
        }
        
        .parameters label {
            display: block;
            margin: 15px 0;
            color: white;
        }
        
        .parameters input[type="range"] {
            width: 60%;
            margin: 0 10px;
        }
        
        .parameters span {
            display: inline-block;
            width: 30px;
            text-align: center;
            font-weight: bold;
            color: #00ff41;
        }
        
        .equation-display {
            margin-top: 30px;
            padding: 15px;
            background: rgba(0, 255, 65, 0.1);
            border-radius: 10px;
            border: 2px solid #00ff41;
        }
        
        #equation-text {
            font-size: 1.5rem;
            color: #00ff41;
            text-align: center;
            font-family: 'Courier New', monospace;
        }
        
        .graph-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #graph-canvas {
            background: #2a2a3e;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        /* Algebra Tool Styles */
        .algebra-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .equation-input {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        #equation-input {
            padding: 15px;
            font-size: 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #9b59b6;
            color: white;
            border-radius: 10px;
            width: 300px;
            margin-right: 15px;
            font-family: 'Courier New', monospace;
        }
        
        .equation-input button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .equation-input button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }
        
        .solution-steps {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            min-height: 200px;
        }
        
        #steps-display {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            line-height: 2;
        }
        
        .step {
            padding: 10px;
            margin: 10px 0;
            background: rgba(155, 89, 182, 0.1);
            border-left: 3px solid #9b59b6;
            border-radius: 5px;
            animation: slideIn 0.5s ease-in-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .visual-balance {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .balance-viz {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            font-size: 1.8rem;
            margin: 20px 0;
        }
        
        .balance-left-viz, .balance-right-viz {
            padding: 20px 30px;
            background: linear-gradient(135deg, rgba(155, 89, 182, 0.3), rgba(142, 68, 173, 0.3));
            border: 2px solid #9b59b6;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            min-width: 150px;
            text-align: center;
        }
        
        .balance-center {
            font-size: 2.5rem;
        }
        
        .practice-problems {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
        }
        
        .problem-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .problem-list button {
            padding: 15px;
            background: rgba(155, 89, 182, 0.2);
            border: 2px solid #9b59b6;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }
        
        .problem-list button:hover {
            background: rgba(155, 89, 182, 0.4);
            transform: translateY(-2px);
        }
    </style>

    <script>
        // Graphs Tool Functions
        let currentFunction = 'linear';
        let graphCanvas, graphCtx;
        
        function initGraph() {
            graphCanvas = document.getElementById('graph-canvas');
            if (graphCanvas) {
                graphCtx = graphCanvas.getContext('2d');
                updateGraph();
            }
        }
        
        function selectFunction(type) {
            currentFunction = type;
            document.querySelectorAll('.func-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (type === 'linear') {
                document.getElementById('linear-params').style.display = 'block';
                document.getElementById('quadratic-params').style.display = 'none';
            } else {
                document.getElementById('linear-params').style.display = 'none';
                document.getElementById('quadratic-params').style.display = 'block';
            }
            updateGraph();
        }
        
        function updateGraph() {
            if (!graphCtx) return;
            
            const width = graphCanvas.width;
            const height = graphCanvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const scale = 20;
            
            // Clear canvas
            graphCtx.clearRect(0, 0, width, height);
            
            // Draw grid
            graphCtx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            graphCtx.lineWidth = 1;
            for (let i = 0; i <= width; i += scale) {
                graphCtx.beginPath();
                graphCtx.moveTo(i, 0);
                graphCtx.lineTo(i, height);
                graphCtx.stroke();
            }
            for (let i = 0; i <= height; i += scale) {
                graphCtx.beginPath();
                graphCtx.moveTo(0, i);
                graphCtx.lineTo(width, i);
                graphCtx.stroke();
            }
            
            // Draw axes
            graphCtx.strokeStyle = 'white';
            graphCtx.lineWidth = 2;
            graphCtx.beginPath();
            graphCtx.moveTo(0, centerY);
            graphCtx.lineTo(width, centerY);
            graphCtx.moveTo(centerX, 0);
            graphCtx.lineTo(centerX, height);
            graphCtx.stroke();
            
            // Draw function
            graphCtx.strokeStyle = '#00ff41';
            graphCtx.lineWidth = 3;
            graphCtx.beginPath();
            
            let equation = '';
            
            if (currentFunction === 'linear') {
                const m = parseFloat(document.getElementById('m-value').value);
                const b = parseFloat(document.getElementById('b-value').value);
                
                document.getElementById('m-display').textContent = m;
                document.getElementById('b-display').textContent = b;
                
                equation = `y = ${m}x + ${b}`;
                
                for (let x = -centerX; x <= centerX; x++) {
                    const y = m * (x / scale) + b;
                    const screenX = x + centerX;
                    const screenY = centerY - y * scale;
                    
                    if (x === -centerX) {
                        graphCtx.moveTo(screenX, screenY);
                    } else {
                        graphCtx.lineTo(screenX, screenY);
                    }
                }
            } else {
                const a = parseFloat(document.getElementById('a-value').value);
                const b = parseFloat(document.getElementById('b2-value').value);
                const c = parseFloat(document.getElementById('c-value').value);
                
                document.getElementById('a-display').textContent = a;
                document.getElementById('b2-display').textContent = b;
                document.getElementById('c-display').textContent = c;
                
                equation = `y = ${a}x² + ${b}x + ${c}`;
                
                for (let x = -centerX; x <= centerX; x += 2) {
                    const xVal = x / scale;
                    const y = a * xVal * xVal + b * xVal + c;
                    const screenX = x + centerX;
                    const screenY = centerY - y * scale;
                    
                    if (x === -centerX) {
                        graphCtx.moveTo(screenX, screenY);
                    } else {
                        graphCtx.lineTo(screenX, screenY);
                    }
                }
            }
            
            graphCtx.stroke();
            document.getElementById('equation-text').textContent = equation;
        }
        
        // Algebra Solver Functions
        function solveEquation() {
            const input = document.getElementById('equation-input').value;
            const stepsDisplay = document.getElementById('steps-display');
            
            // Simple linear equation solver
            const parts = input.split('=');
            if (parts.length !== 2) {
                stepsDisplay.innerHTML = '<div class="step">Please enter a valid equation with "="</div>';
                return;
            }
            
            let left = parts[0].trim();
            let right = parts[1].trim();
            
            document.getElementById('left-side').textContent = left;
            document.getElementById('right-side').textContent = right;
            
            let steps = [];
            steps.push(`<div class="step">Original equation: ${left} = ${right}</div>`);
            
            // Parse simple linear equations like "2x + 5 = 13"
            const leftMatch = left.match(/(-?\d*)x\s*([\+\-]\s*\d+)?/);
            if (leftMatch) {
                const coefficient = leftMatch[1] === '' ? 1 : leftMatch[1] === '-' ? -1 : parseInt(leftMatch[1]);
                const constant = leftMatch[2] ? parseInt(leftMatch[2].replace(/\s/g, '')) : 0;
                const rightValue = parseInt(right);
                
                // Subtract constant from both sides
                if (constant !== 0) {
                    const newRight = rightValue - constant;
                    steps.push(`<div class="step">Subtract ${constant > 0 ? constant : '(' + constant + ')'} from both sides: ${coefficient}x = ${newRight}</div>`);
                    
                    // Divide by coefficient
                    const solution = newRight / coefficient;
                    steps.push(`<div class="step">Divide both sides by ${coefficient}: x = ${solution}</div>`);
                    steps.push(`<div class="step" style="color: #00ff41; font-weight: bold;">Solution: x = ${solution}</div>`);
                } else {
                    const solution = rightValue / coefficient;
                    steps.push(`<div class="step">Divide both sides by ${coefficient}: x = ${solution}</div>`);
                    steps.push(`<div class="step" style="color: #00ff41; font-weight: bold;">Solution: x = ${solution}</div>`);
                }
            } else {
                steps.push(`<div class="step">Unable to solve this equation automatically. Try a simpler linear equation.</div>`);
            }
            
            stepsDisplay.innerHTML = steps.join('');
        }
        
        function loadProblem(equation) {
            document.getElementById('equation-input').value = equation;
            solveEquation();
        }
        
        // Initialize graph when tool is opened
        setTimeout(() => {
            if (document.getElementById('graphs-tool')) {
                initGraph();
            }
        }, 100);
    </script>

    <!-- 3D Shapes Tool -->
    <div id="shapes3d-tool" class="tool-content">
        <div class="container">
            <div class="header">
                <h1>3D Shapes Explorer</h1>
                <p>Explore 3D shapes, calculate volume and surface area, and transform 2D to 3D</p>
            </div>

            <div class="shapes3d-mode-selector">
                <button class="shapes3d-mode-btn active" onclick="switch3DMode('explore')">🎲 Explore</button>
                <button class="shapes3d-mode-btn" onclick="switch3DMode('calculate')">📐 Calculate</button>
                <button class="shapes3d-mode-btn" onclick="switch3DMode('transform')">🔄 2D to 3D</button>
            </div>

            <!-- Explore Mode -->
            <div id="explore-mode" class="shapes3d-mode active">
                <div class="shapes3d-main">
                    <div class="shape-selector">
                        <button class="shape-btn active" onclick="selectShape('cube')">Cube</button>
                        <button class="shape-btn" onclick="selectShape('cuboid')">Cuboid</button>
                        <button class="shape-btn" onclick="selectShape('sphere')">Sphere</button>
                        <button class="shape-btn" onclick="selectShape('cylinder')">Cylinder</button>
                        <button class="shape-btn" onclick="selectShape('cone')">Cone</button>
                        <button class="shape-btn" onclick="selectShape('pyramid')">Pyramid</button>
                        <button class="shape-btn" onclick="selectShape('prism')">Prism</button>
                    </div>

                    <div class="shape-display">
                        <div id="shape-container">
                            <div id="shape-3d" class="shape-cube">
                                <div class="face front">Front</div>
                                <div class="face back">Back</div>
                                <div class="face left">Left</div>
                                <div class="face right">Right</div>
                                <div class="face top">Top</div>
                                <div class="face bottom">Bottom</div>
                            </div>
                        </div>
                        
                        <div class="shape-controls">
                            <div class="control-group">
                                <label>Rotate X:</label>
                                <input type="range" id="rotateX" min="0" max="360" value="20" oninput="updateRotation()">
                            </div>
                            <div class="control-group">
                                <label>Rotate Y:</label>
                                <input type="range" id="rotateY" min="0" max="360" value="45" oninput="updateRotation()">
                            </div>
                            <div class="control-group">
                                <label>Rotate Z:</label>
                                <input type="range" id="rotateZ" min="0" max="360" value="0" oninput="updateRotation()">
                            </div>
                            <button class="btn" onclick="toggleAutoRotate()">🔄 Auto Rotate</button>
                        </div>
                    </div>

                    <div class="shape-info">
                        <h3 id="shape-name">Cube</h3>
                        <div id="shape-properties">
                            <p><strong>Faces:</strong> <span id="faces-count">6</span></p>
                            <p><strong>Edges:</strong> <span id="edges-count">12</span></p>
                            <p><strong>Vertices:</strong> <span id="vertices-count">8</span></p>
                            <p><strong>Properties:</strong></p>
                            <ul id="shape-facts">
                                <li>All faces are squares</li>
                                <li>All edges are equal length</li>
                                <li>All angles are 90°</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calculate Mode -->
            <div id="calculate-mode" class="shapes3d-mode">
                <div class="calc-container">
                    <div class="calc-shape-select">
                        <label>Select Shape:</label>
                        <select id="calc-shape" onchange="updateCalcInputs()">
                            <option value="cube">Cube</option>
                            <option value="cuboid">Cuboid</option>
                            <option value="sphere">Sphere</option>
                            <option value="cylinder">Cylinder</option>
                            <option value="cone">Cone</option>
                            <option value="pyramid">Square Pyramid</option>
                        </select>
                    </div>

                    <div class="calc-inputs" id="calc-inputs">
                        <div class="input-group">
                            <label>Side Length:</label>
                            <input type="number" id="side-length" value="5" min="1" oninput="calculateShape()">
                        </div>
                    </div>

                    <div class="calc-visual">
                        <canvas id="shape-canvas" width="300" height="300"></canvas>
                    </div>

                    <div class="calc-results">
                        <h3>Results</h3>
                        <div class="result-item">
                            <label>Volume:</label>
                            <span id="volume-result">125 cubic units</span>
                        </div>
                        <div class="result-item">
                            <label>Surface Area:</label>
                            <span id="surface-result">150 square units</span>
                        </div>
                        <div class="formula-display">
                            <h4>Formulas:</h4>
                            <p id="volume-formula">Volume = side³</p>
                            <p id="surface-formula">Surface Area = 6 × side²</p>
                        </div>
                    </div>

                    <div class="calc-practice">
                        <h3>Practice Problem</h3>
                        <div id="calc-problem"></div>
                        <input type="number" id="calc-answer" placeholder="Your answer">
                        <button class="btn" onclick="checkCalcAnswer()">Check</button>
                        <button class="btn" onclick="newCalcProblem()">New Problem</button>
                        <div id="calc-feedback"></div>
                    </div>
                </div>
            </div>

            <!-- 2D to 3D Transform Mode -->
            <div id="transform-mode" class="shapes3d-mode">
                <div class="transform-container">
                    <div class="transform-selector">
                        <h3>Select a 2D Shape to Transform</h3>
                        <div class="shape2d-options">
                            <button class="shape2d-btn" onclick="transform2Dto3D('square')">
                                <div class="shape2d square2d"></div>
                                <span>Square</span>
                            </button>
                            <button class="shape2d-btn" onclick="transform2Dto3D('circle')">
                                <div class="shape2d circle2d"></div>
                                <span>Circle</span>
                            </button>
                            <button class="shape2d-btn" onclick="transform2Dto3D('triangle')">
                                <div class="shape2d triangle2d"></div>
                                <span>Triangle</span>
                            </button>
                            <button class="shape2d-btn" onclick="transform2Dto3D('rectangle')">
                                <div class="shape2d rectangle2d"></div>
                                <span>Rectangle</span>
                            </button>
                        </div>
                    </div>

                    <div class="transform-actions">
                        <h3>Choose Transformation</h3>
                        <div class="transform-options">
                            <button class="transform-btn" onclick="applyTransform('extrude')">
                                ↑ Extrude (Pull Up)
                            </button>
                            <button class="transform-btn" onclick="applyTransform('rotate')">
                                ↻ Rotate Around Axis
                            </button>
                            <button class="transform-btn" onclick="applyTransform('stack')">
                                ▦ Stack Multiple
                            </button>
                        </div>
                    </div>

                    <div class="transform-result">
                        <div id="transform-visual">
                            <div class="transform-animation"></div>
                        </div>
                        <div id="transform-info">
                            <h3>Result</h3>
                            <p id="transform-description"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* 3D Shapes Tool Styles */
        .shapes3d-mode-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .shapes3d-mode-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .shapes3d-mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .shapes3d-mode-btn.active {
            background: linear-gradient(45deg, #3498db, #2980b9);
            transform: scale(1.05);
        }

        .shapes3d-mode {
            display: none;
        }

        .shapes3d-mode.active {
            display: block;
        }

        /* Explore Mode */
        .shapes3d-main {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .shape-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .shape-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .shape-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .shape-btn.active {
            background: linear-gradient(45deg, #3498db, #2980b9);
            border-color: #3498db;
        }

        .shape-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }

        #shape-container {
            width: 300px;
            height: 300px;
            perspective: 800px;
            position: relative;
        }

        #shape-3d {
            width: 200px;
            height: 200px;
            position: absolute;
            top: 50px;
            left: 50px;
            transform-style: preserve-3d;
            transition: transform 0.5s;
        }

        .face {
            position: absolute;
            width: 200px;
            height: 200px;
            background: rgba(52, 152, 219, 0.7);
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
        }

        .face.front {
            transform: translateZ(100px);
        }

        .face.back {
            transform: rotateY(180deg) translateZ(100px);
        }

        .face.left {
            transform: rotateY(-90deg) translateZ(100px);
        }

        .face.right {
            transform: rotateY(90deg) translateZ(100px);
        }

        .face.top {
            transform: rotateX(90deg) translateZ(100px);
        }

        .face.bottom {
            transform: rotateX(-90deg) translateZ(100px);
        }

        .shape-controls {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            width: 100%;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .control-group label {
            min-width: 80px;
            color: #3498db;
        }

        .control-group input[type="range"] {
            flex: 1;
        }

        .shape-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
        }

        .shape-info h3 {
            color: #e74c3c;
            margin-bottom: 15px;
        }

        #shape-properties p {
            margin: 10px 0;
        }

        #shape-properties strong {
            color: #3498db;
        }

        #shape-facts {
            margin-top: 10px;
            padding-left: 20px;
        }

        #shape-facts li {
            margin: 5px 0;
            color: #ccc;
        }

        /* Calculate Mode */
        .calc-container {
            max-width: 1000px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .calc-shape-select {
            grid-column: span 2;
            text-align: center;
            margin-bottom: 20px;
        }

        .calc-shape-select select {
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: 2px solid #3498db;
            border-radius: 5px;
            font-size: 1.1rem;
        }

        .calc-inputs {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            color: #3498db;
            margin-bottom: 5px;
        }

        .input-group input {
            width: 100%;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #3498db;
            color: white;
            border-radius: 5px;
            font-size: 1.1rem;
        }

        .calc-visual {
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
        }

        #shape-canvas {
            border: 2px solid #333;
            border-radius: 10px;
        }

        .calc-results {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
        }

        .calc-results h3 {
            color: #f39c12;
            margin-bottom: 15px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
        }

        .result-item label {
            color: #3498db;
            font-weight: bold;
        }

        .result-item span {
            color: #00ff41;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .formula-display {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .formula-display h4 {
            color: #9b59b6;
            margin-bottom: 10px;
        }

        .formula-display p {
            color: #ccc;
            margin: 5px 0;
            font-family: 'Courier New', monospace;
        }

        .calc-practice {
            grid-column: span 2;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .calc-practice h3 {
            color: #e74c3c;
            margin-bottom: 15px;
        }

        #calc-problem {
            font-size: 1.2rem;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        #calc-answer {
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #3498db;
            color: white;
            font-size: 1.2rem;
            border-radius: 5px;
            width: 200px;
            margin-right: 10px;
        }

        #calc-feedback {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        #calc-feedback.correct {
            display: block;
            background: rgba(0, 255, 65, 0.2);
            border: 2px solid #00ff41;
            color: #00ff41;
        }

        #calc-feedback.incorrect {
            display: block;
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            color: #e74c3c;
        }

        /* Transform Mode */
        .transform-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .transform-selector {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
        }

        .transform-selector h3 {
            color: #3498db;
            margin-bottom: 20px;
        }

        .shape2d-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .shape2d-btn {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .shape2d-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .shape2d {
            width: 50px;
            height: 50px;
        }

        .square2d {
            background: #3498db;
            border: 2px solid white;
        }

        .circle2d {
            background: #e74c3c;
            border: 2px solid white;
            border-radius: 50%;
        }

        .triangle2d {
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-bottom: 50px solid #f39c12;
        }

        .rectangle2d {
            width: 60px;
            height: 40px;
            background: #9b59b6;
            border: 2px solid white;
        }

        .transform-actions {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
        }

        .transform-actions h3 {
            color: #f39c12;
            margin-bottom: 20px;
        }

        .transform-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .transform-btn {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
        }

        .transform-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }

        .transform-result {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
        }

        #transform-visual {
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 600px;
            margin-bottom: 20px;
        }

        .transform-animation {
            width: 100px;
            height: 100px;
            transform-style: preserve-3d;
            transition: all 1s ease;
        }

        #transform-info h3 {
            color: #1abc9c;
            margin-bottom: 10px;
        }

        #transform-description {
            color: #ccc;
            line-height: 1.5;
        }

        /* Responsive for iPad */
        @media (max-width: 1024px) {
            .shapes3d-main,
            .calc-container,
            .transform-container {
                grid-template-columns: 1fr;
            }

            .calc-shape-select,
            .calc-practice {
                grid-column: span 1;
            }
        }

        @media (hover: none) and (pointer: coarse) {
            .shape-btn,
            .shapes3d-mode-btn,
            .transform-btn {
                min-height: 44px;
            }

            input[type="number"],
            select {
                min-height: 44px;
                font-size: 1.2rem;
            }
        }
    </style>

    <script>
        // 3D Shapes Tool Functions
        let autoRotate = false;
        let currentShape = 'cube';
        let selected2DShape = null;
        let selectedTransform = null;

        const shapeData = {
            cube: {
                name: 'Cube',
                faces: 6,
                edges: 12,
                vertices: 8,
                facts: [
                    'All faces are squares',
                    'All edges are equal length',
                    'All angles are 90°'
                ],
                volumeFormula: 'Volume = side³',
                surfaceFormula: 'Surface Area = 6 × side²'
            },
            cuboid: {
                name: 'Cuboid (Rectangular Prism)',
                faces: 6,
                edges: 12,
                vertices: 8,
                facts: [
                    'All faces are rectangles',
                    'Opposite faces are equal',
                    'All angles are 90°'
                ],
                volumeFormula: 'Volume = length × width × height',
                surfaceFormula: 'Surface Area = 2(lw + lh + wh)'
            },
            sphere: {
                name: 'Sphere',
                faces: 1,
                edges: 0,
                vertices: 0,
                facts: [
                    'Perfectly round 3D shape',
                    'All points on surface are equidistant from center',
                    'No edges or vertices'
                ],
                volumeFormula: 'Volume = (4/3) × π × r³',
                surfaceFormula: 'Surface Area = 4 × π × r²'
            },
            cylinder: {
                name: 'Cylinder',
                faces: 3,
                edges: 2,
                vertices: 0,
                facts: [
                    'Two circular faces',
                    'One curved surface',
                    'Constant cross-section'
                ],
                volumeFormula: 'Volume = π × r² × h',
                surfaceFormula: 'Surface Area = 2πr² + 2πrh'
            },
            cone: {
                name: 'Cone',
                faces: 2,
                edges: 1,
                vertices: 1,
                facts: [
                    'One circular base',
                    'One curved surface',
                    'One vertex (apex)'
                ],
                volumeFormula: 'Volume = (1/3) × π × r² × h',
                surfaceFormula: 'Surface Area = πr² + πrl'
            },
            pyramid: {
                name: 'Square Pyramid',
                faces: 5,
                edges: 8,
                vertices: 5,
                facts: [
                    'Square base',
                    'Four triangular faces',
                    'One apex vertex'
                ],
                volumeFormula: 'Volume = (1/3) × base² × height',
                surfaceFormula: 'Surface Area = base² + 2 × base × slant height'
            },
            prism: {
                name: 'Triangular Prism',
                faces: 5,
                edges: 9,
                vertices: 6,
                facts: [
                    'Two triangular faces',
                    'Three rectangular faces',
                    'Constant triangular cross-section'
                ],
                volumeFormula: 'Volume = base area × height',
                surfaceFormula: 'Surface Area = 2 × base area + perimeter × height'
            }
        };

        function switch3DMode(mode) {
            document.querySelectorAll('.shapes3d-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.shapes3d-mode').forEach(m => {
                m.classList.remove('active');
            });
            document.getElementById(`${mode}-mode`).classList.add('active');

            if (mode === 'calculate') {
                calculateShape();
                drawShapeOnCanvas();
            }
        }

        function selectShape(shape) {
            currentShape = shape;
            
            // Update buttons
            document.querySelectorAll('.shape-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update display
            updateShapeDisplay();
            updateShapeInfo();
        }

        function updateShapeDisplay() {
            const shapeElement = document.getElementById('shape-3d');
            shapeElement.className = `shape-${currentShape}`;
            
            // Create appropriate shape HTML
            if (currentShape === 'sphere') {
                shapeElement.innerHTML = '<div class="sphere-shape"></div>';
            } else if (currentShape === 'cylinder') {
                shapeElement.innerHTML = `
                    <div class="cylinder-top"></div>
                    <div class="cylinder-body"></div>
                    <div class="cylinder-bottom"></div>
                `;
            } else if (currentShape === 'cone') {
                shapeElement.innerHTML = `
                    <div class="cone-body"></div>
                    <div class="cone-base"></div>
                `;
            } else {
                // Default cube faces
                shapeElement.innerHTML = `
                    <div class="face front">Front</div>
                    <div class="face back">Back</div>
                    <div class="face left">Left</div>
                    <div class="face right">Right</div>
                    <div class="face top">Top</div>
                    <div class="face bottom">Bottom</div>
                `;
            }
            
            updateRotation();
        }

        function updateShapeInfo() {
            const data = shapeData[currentShape];
            document.getElementById('shape-name').textContent = data.name;
            document.getElementById('faces-count').textContent = data.faces;
            document.getElementById('edges-count').textContent = data.edges;
            document.getElementById('vertices-count').textContent = data.vertices;
            
            const factsList = document.getElementById('shape-facts');
            factsList.innerHTML = data.facts.map(fact => `<li>${fact}</li>`).join('');
        }

        function updateRotation() {
            const rotateX = document.getElementById('rotateX').value;
            const rotateY = document.getElementById('rotateY').value;
            const rotateZ = document.getElementById('rotateZ').value;
            
            const shape = document.getElementById('shape-3d');
            shape.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) rotateZ(${rotateZ}deg)`;
        }

        function toggleAutoRotate() {
            autoRotate = !autoRotate;
            if (autoRotate) {
                animateRotation();
            }
        }

        function animateRotation() {
            if (!autoRotate) return;
            
            const shape = document.getElementById('shape-3d');
            let rotation = 0;
            
            function rotate() {
                if (!autoRotate) return;
                rotation += 1;
                shape.style.transform = `rotateX(20deg) rotateY(${rotation}deg) rotateZ(0deg)`;
                requestAnimationFrame(rotate);
            }
            rotate();
        }

        function updateCalcInputs() {
            const shape = document.getElementById('calc-shape').value;
            const inputsDiv = document.getElementById('calc-inputs');
            
            let html = '';
            switch(shape) {
                case 'cube':
                    html = `
                        <div class="input-group">
                            <label>Side Length:</label>
                            <input type="number" id="side-length" value="5" min="1" oninput="calculateShape()">
                        </div>
                    `;
                    break;
                case 'cuboid':
                    html = `
                        <div class="input-group">
                            <label>Length:</label>
                            <input type="number" id="length" value="6" min="1" oninput="calculateShape()">
                        </div>
                        <div class="input-group">
                            <label>Width:</label>
                            <input type="number" id="width" value="4" min="1" oninput="calculateShape()">
                        </div>
                        <div class="input-group">
                            <label>Height:</label>
                            <input type="number" id="height" value="5" min="1" oninput="calculateShape()">
                        </div>
                    `;
                    break;
                case 'sphere':
                    html = `
                        <div class="input-group">
                            <label>Radius:</label>
                            <input type="number" id="radius" value="3" min="1" oninput="calculateShape()">
                        </div>
                    `;
                    break;
                case 'cylinder':
                    html = `
                        <div class="input-group">
                            <label>Radius:</label>
                            <input type="number" id="radius" value="3" min="1" oninput="calculateShape()">
                        </div>
                        <div class="input-group">
                            <label>Height:</label>
                            <input type="number" id="height" value="5" min="1" oninput="calculateShape()">
                        </div>
                    `;
                    break;
                case 'cone':
                    html = `
                        <div class="input-group">
                            <label>Radius:</label>
                            <input type="number" id="radius" value="3" min="1" oninput="calculateShape()">
                        </div>
                        <div class="input-group">
                            <label>Height:</label>
                            <input type="number" id="height" value="4" min="1" oninput="calculateShape()">
                        </div>
                    `;
                    break;
                case 'pyramid':
                    html = `
                        <div class="input-group">
                            <label>Base Side:</label>
                            <input type="number" id="base" value="4" min="1" oninput="calculateShape()">
                        </div>
                        <div class="input-group">
                            <label>Height:</label>
                            <input type="number" id="height" value="6" min="1" oninput="calculateShape()">
                        </div>
                    `;
                    break;
            }
            
            inputsDiv.innerHTML = html;
            calculateShape();
            drawShapeOnCanvas();
        }

        function calculateShape() {
            const shape = document.getElementById('calc-shape').value;
            let volume = 0;
            let surfaceArea = 0;
            
            switch(shape) {
                case 'cube':
                    const side = parseFloat(document.getElementById('side-length').value) || 0;
                    volume = Math.pow(side, 3);
                    surfaceArea = 6 * Math.pow(side, 2);
                    break;
                case 'cuboid':
                    const l = parseFloat(document.getElementById('length').value) || 0;
                    const w = parseFloat(document.getElementById('width').value) || 0;
                    const h = parseFloat(document.getElementById('height').value) || 0;
                    volume = l * w * h;
                    surfaceArea = 2 * (l*w + l*h + w*h);
                    break;
                case 'sphere':
                    const r = parseFloat(document.getElementById('radius').value) || 0;
                    volume = (4/3) * Math.PI * Math.pow(r, 3);
                    surfaceArea = 4 * Math.PI * Math.pow(r, 2);
                    break;
                case 'cylinder':
                    const rc = parseFloat(document.getElementById('radius').value) || 0;
                    const hc = parseFloat(document.getElementById('height').value) || 0;
                    volume = Math.PI * Math.pow(rc, 2) * hc;
                    surfaceArea = 2 * Math.PI * rc * (rc + hc);
                    break;
                case 'cone':
                    const rco = parseFloat(document.getElementById('radius').value) || 0;
                    const hco = parseFloat(document.getElementById('height').value) || 0;
                    const slant = Math.sqrt(Math.pow(rco, 2) + Math.pow(hco, 2));
                    volume = (1/3) * Math.PI * Math.pow(rco, 2) * hco;
                    surfaceArea = Math.PI * rco * (rco + slant);
                    break;
                case 'pyramid':
                    const base = parseFloat(document.getElementById('base').value) || 0;
                    const hp = parseFloat(document.getElementById('height').value) || 0;
                    const slantHeight = Math.sqrt(Math.pow(hp, 2) + Math.pow(base/2, 2));
                    volume = (1/3) * Math.pow(base, 2) * hp;
                    surfaceArea = Math.pow(base, 2) + 2 * base * slantHeight;
                    break;
            }
            
            document.getElementById('volume-result').textContent = volume.toFixed(2) + ' cubic units';
            document.getElementById('surface-result').textContent = surfaceArea.toFixed(2) + ' square units';
            
            // Update formulas
            const data = shapeData[shape];
            if (data) {
                document.getElementById('volume-formula').textContent = data.volumeFormula;
                document.getElementById('surface-formula').textContent = data.surfaceFormula;
            }
        }

        function drawShapeOnCanvas() {
            const canvas = document.getElementById('shape-canvas');
            const ctx = canvas.getContext('2d');
            const shape = document.getElementById('calc-shape').value;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 2;
            ctx.fillStyle = 'rgba(52, 152, 219, 0.3)';
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            switch(shape) {
                case 'cube':
                    // Draw isometric cube
                    const size = 80;
                    ctx.beginPath();
                    // Front face
                    ctx.moveTo(centerX - size/2, centerY - size/4);
                    ctx.lineTo(centerX + size/2, centerY - size/4);
                    ctx.lineTo(centerX + size/2, centerY + size*3/4);
                    ctx.lineTo(centerX - size/2, centerY + size*3/4);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    
                    // Top face
                    ctx.beginPath();
                    ctx.moveTo(centerX - size/2, centerY - size/4);
                    ctx.lineTo(centerX, centerY - size*3/4);
                    ctx.lineTo(centerX + size, centerY - size*3/4);
                    ctx.lineTo(centerX + size/2, centerY - size/4);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    
                    // Right face
                    ctx.beginPath();
                    ctx.moveTo(centerX + size/2, centerY - size/4);
                    ctx.lineTo(centerX + size, centerY - size*3/4);
                    ctx.lineTo(centerX + size, centerY + size/4);
                    ctx.lineTo(centerX + size/2, centerY + size*3/4);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    break;
                    
                case 'sphere':
                    // Draw sphere
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, 80, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.stroke();
                    
                    // Add 3D effect with ellipse
                    ctx.beginPath();
                    ctx.ellipse(centerX, centerY, 80, 30, 0, 0, 2 * Math.PI);
                    ctx.stroke();
                    break;
                    
                case 'cylinder':
                    // Draw cylinder
                    ctx.beginPath();
                    ctx.ellipse(centerX, centerY - 60, 60, 20, 0, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX - 60, centerY - 60);
                    ctx.lineTo(centerX - 60, centerY + 60);
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX + 60, centerY - 60);
                    ctx.lineTo(centerX + 60, centerY + 60);
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.ellipse(centerX, centerY + 60, 60, 20, 0, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.stroke();
                    break;
                    
                // Add more shapes as needed
            }
        }

        function newCalcProblem() {
            const shapes = ['cube', 'sphere', 'cylinder'];
            const shape = shapes[Math.floor(Math.random() * shapes.length)];
            const type = Math.random() < 0.5 ? 'volume' : 'surface area';
            
            let problem = '';
            let answer = 0;
            
            if (shape === 'cube') {
                const side = Math.floor(Math.random() * 10) + 3;
                if (type === 'volume') {
                    problem = `A cube has sides of ${side} units. What is its volume?`;
                    answer = Math.pow(side, 3);
                } else {
                    problem = `A cube has sides of ${side} units. What is its surface area?`;
                    answer = 6 * Math.pow(side, 2);
                }
            } else if (shape === 'sphere') {
                const radius = Math.floor(Math.random() * 8) + 2;
                if (type === 'volume') {
                    problem = `A sphere has a radius of ${radius} units. What is its volume? (Use π = 3.14)`;
                    answer = Math.round((4/3) * 3.14 * Math.pow(radius, 3));
                } else {
                    problem = `A sphere has a radius of ${radius} units. What is its surface area? (Use π = 3.14)`;
                    answer = Math.round(4 * 3.14 * Math.pow(radius, 2));
                }
            } else if (shape === 'cylinder') {
                const radius = Math.floor(Math.random() * 5) + 2;
                const height = Math.floor(Math.random() * 8) + 3;
                if (type === 'volume') {
                    problem = `A cylinder has radius ${radius} and height ${height}. What is its volume? (Use π = 3.14)`;
                    answer = Math.round(3.14 * Math.pow(radius, 2) * height);
                } else {
                    problem = `A cylinder has radius ${radius} and height ${height}. What is its surface area? (Use π = 3.14)`;
                    answer = Math.round(2 * 3.14 * radius * (radius + height));
                }
            }
            
            document.getElementById('calc-problem').textContent = problem;
            document.getElementById('calc-problem').dataset.answer = answer;
            document.getElementById('calc-answer').value = '';
            document.getElementById('calc-feedback').style.display = 'none';
        }

        function checkCalcAnswer() {
            const userAnswer = parseFloat(document.getElementById('calc-answer').value);
            const correctAnswer = parseFloat(document.getElementById('calc-problem').dataset.answer);
            const feedback = document.getElementById('calc-feedback');
            
            if (Math.abs(userAnswer - correctAnswer) < 0.5) {
                feedback.textContent = '✅ Correct! Well done!';
                feedback.className = 'correct';
            } else {
                feedback.textContent = `❌ Not quite. The answer is ${correctAnswer}`;
                feedback.className = 'incorrect';
            }
            
            feedback.style.display = 'block';
            setTimeout(() => {
                newCalcProblem();
            }, 3000);
        }

        function transform2Dto3D(shape) {
            selected2DShape = shape;
            document.querySelectorAll('.shape2d-btn').forEach(btn => {
                btn.style.background = 'rgba(0, 0, 0, 0.3)';
            });
            event.currentTarget.style.background = 'rgba(52, 152, 219, 0.3)';
        }

        function applyTransform(type) {
            if (!selected2DShape) {
                alert('Please select a 2D shape first!');
                return;
            }
            
            selectedTransform = type;
            const visual = document.querySelector('.transform-animation');
            const description = document.getElementById('transform-description');
            
            let result3D = '';
            let desc = '';
            
            if (selected2DShape === 'square') {
                if (type === 'extrude') {
                    result3D = 'Cube';
                    desc = 'Extruding a square creates a cube - pulling the square up adds depth.';
                } else if (type === 'rotate') {
                    result3D = 'Cylinder';
                    desc = 'Rotating a square around its center axis creates a cylinder.';
                } else if (type === 'stack') {
                    result3D = 'Rectangular Prism';
                    desc = 'Stacking multiple squares creates a tall rectangular prism.';
                }
            } else if (selected2DShape === 'circle') {
                if (type === 'extrude') {
                    result3D = 'Cylinder';
                    desc = 'Extruding a circle creates a cylinder - pulling it up adds height.';
                } else if (type === 'rotate') {
                    result3D = 'Sphere';
                    desc = 'Rotating a circle around its diameter creates a sphere.';
                } else if (type === 'stack') {
                    result3D = 'Cylinder';
                    desc = 'Stacking circles creates a cylinder with defined segments.';
                }
            } else if (selected2DShape === 'triangle') {
                if (type === 'extrude') {
                    result3D = 'Triangular Prism';
                    desc = 'Extruding a triangle creates a triangular prism.';
                } else if (type === 'rotate') {
                    result3D = 'Cone';
                    desc = 'Rotating a triangle around its height creates a cone.';
                } else if (type === 'stack') {
                    result3D = 'Pyramid';
                    desc = 'Stacking triangles of decreasing size creates a pyramid.';
                }
            } else if (selected2DShape === 'rectangle') {
                if (type === 'extrude') {
                    result3D = 'Cuboid';
                    desc = 'Extruding a rectangle creates a cuboid (rectangular prism).';
                } else if (type === 'rotate') {
                    result3D = 'Cylinder';
                    desc = 'Rotating a rectangle around its center creates a cylinder.';
                } else if (type === 'stack') {
                    result3D = 'Tall Cuboid';
                    desc = 'Stacking rectangles creates a tall cuboid.';
                }
            }
            
            // Animate transformation
            visual.style.background = 'linear-gradient(45deg, #3498db, #9b59b6)';
            visual.style.width = '120px';
            visual.style.height = '120px';
            visual.style.transform = 'rotateX(45deg) rotateY(45deg) scale(1.2)';
            
            description.innerHTML = `<strong>${result3D}</strong><br>${desc}`;
        }

        // Initialize on load
        function initialize3DShapes() {
            updateShapeInfo();
            newCalcProblem();
            drawShapeOnCanvas();
        }
    </script>

    <!-- Clock & Time Tool -->
    <div id="clock-tool" class="tool-content">
        <div class="container">
            <div class="header">
                <h1>Clock & Time</h1>
                <p>Learn to tell time and solve time problems</p>
            </div>

            <div class="clock-mode-selector">
                <button class="clock-mode-btn active" onclick="switchClockMode('read')">📖 Read Time</button>
                <button class="clock-mode-btn" onclick="switchClockMode('set')">⏰ Set Time</button>
                <button class="clock-mode-btn" onclick="switchClockMode('calculate')">🧮 Calculate</button>
            </div>

            <div class="clock-main-area">
                <div class="clock-container">
                    <svg id="clock-svg" width="300" height="300" viewBox="0 0 300 300">
                        <!-- Clock face -->
                        <circle cx="150" cy="150" r="145" fill="white" stroke="#333" stroke-width="5"/>
                        
                        <!-- Hour markers -->
                        <g id="hour-markers"></g>
                        
                        <!-- Numbers -->
                        <g id="clock-numbers"></g>
                        
                        <!-- Clock hands -->
                        <line id="hour-hand" x1="150" y1="150" x2="150" y2="90" 
                              stroke="#2c3e50" stroke-width="6" stroke-linecap="round"/>
                        <line id="minute-hand" x1="150" y1="150" x2="150" y2="50" 
                              stroke="#e74c3c" stroke-width="4" stroke-linecap="round"/>
                        
                        <!-- Center dot -->
                        <circle cx="150" cy="150" r="8" fill="#333"/>
                    </svg>
                    
                    <div class="digital-clock">
                        <span id="digital-time">12:00</span>
                        <span id="am-pm">PM</span>
                    </div>
                </div>

                <div class="clock-controls">
                    <!-- Read Time Mode -->
                    <div id="read-mode" class="clock-mode active">
                        <div class="difficulty-selector">
                            <label>Difficulty:</label>
                            <select id="time-difficulty" onchange="generateNewTime()">
                                <option value="hour">Hour only</option>
                                <option value="half">Half hours</option>
                                <option value="quarter">Quarter hours</option>
                                <option value="five">5-minute intervals</option>
                                <option value="minute">Any minute</option>
                            </select>
                        </div>
                        
                        <div class="time-question">
                            <h3>What time is shown?</h3>
                            <div class="time-input-area">
                                <input type="number" id="hour-input" min="1" max="12" placeholder="Hour">
                                <span>:</span>
                                <input type="number" id="minute-input" min="0" max="59" placeholder="Min">
                                <select id="ampm-input">
                                    <option value="AM">AM</option>
                                    <option value="PM">PM</option>
                                </select>
                            </div>
                            <button class="btn" onclick="checkTimeAnswer()">Check Answer</button>
                            <button class="btn" onclick="generateNewTime()">New Time</button>
                        </div>
                    </div>

                    <!-- Set Time Mode -->
                    <div id="set-mode" class="clock-mode">
                        <div class="set-time-challenge">
                            <h3>Set the clock to: <span id="target-time">3:45 PM</span></h3>
                            <div class="hand-controls">
                                <div class="control-group">
                                    <label>Hour:</label>
                                    <input type="range" id="hour-slider" min="0" max="719" value="0" 
                                           oninput="updateClockFromSlider()">
                                </div>
                                <div class="control-group">
                                    <label>Minute:</label>
                                    <input type="range" id="minute-slider" min="0" max="59" value="0" 
                                           oninput="updateClockFromSlider()">
                                </div>
                            </div>
                            <button class="btn" onclick="checkSetTime()">Check</button>
                            <button class="btn" onclick="newSetChallenge()">New Challenge</button>
                        </div>
                    </div>

                    <!-- Calculate Mode -->
                    <div id="calculate-mode" class="clock-mode">
                        <div class="time-problem">
                            <div id="problem-text"></div>
                            <div class="calc-input-area">
                                <input type="text" id="calc-answer" placeholder="Your answer">
                                <button class="btn" onclick="checkCalculation()">Check</button>
                            </div>
                            <button class="btn" onclick="newTimeProblem()">New Problem</button>
                        </div>
                        
                        <div class="time-helper">
                            <h4>Time Helper</h4>
                            <div class="helper-clock-row">
                                <div class="mini-helper-clock" id="start-clock"></div>
                                <div class="arrow">→</div>
                                <div class="mini-helper-clock" id="end-clock"></div>
                            </div>
                        </div>
                    </div>

                    <div id="clock-feedback" class="feedback-area"></div>
                </div>
            </div>

            <div class="clock-stats">
                <div class="stat-box">
                    <label>Score:</label>
                    <span id="clock-score">0</span>
                </div>
                <div class="stat-box">
                    <label>Streak:</label>
                    <span id="clock-streak">0</span>
                </div>
                <div class="stat-box">
                    <label>Accuracy:</label>
                    <span id="clock-accuracy">0%</span>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Clock Tool Styles */
        .clock-mode-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .clock-mode-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clock-mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .clock-mode-btn.active {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            transform: scale(1.05);
        }

        .clock-main-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
            align-items: start;
        }

        .clock-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #clock-svg {
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
            cursor: pointer;
        }

        .digital-clock {
            font-size: 3rem;
            font-weight: bold;
            color: #00ff41;
            background: #1a1a1a;
            padding: 15px 30px;
            border-radius: 10px;
            border: 2px solid #00ff41;
            font-family: 'Courier New', monospace;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #am-pm {
            font-size: 1.5rem;
            color: #f39c12;
        }

        .clock-controls {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
        }

        .clock-mode {
            display: none;
        }

        .clock-mode.active {
            display: block;
        }

        .difficulty-selector {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .difficulty-selector label {
            color: #3498db;
            font-weight: bold;
        }

        .difficulty-selector select {
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: 2px solid #3498db;
            padding: 8px;
            border-radius: 5px;
            font-size: 1rem;
        }

        .time-question h3 {
            color: #f39c12;
            margin-bottom: 20px;
            text-align: center;
        }

        .time-input-area {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .time-input-area input[type="number"] {
            width: 80px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #3498db;
            color: white;
            font-size: 1.5rem;
            text-align: center;
            border-radius: 5px;
        }

        .time-input-area span {
            font-size: 2rem;
            color: white;
        }

        .time-input-area select {
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #3498db;
            color: white;
            font-size: 1.2rem;
            border-radius: 5px;
        }

        .hand-controls {
            margin: 20px 0;
        }

        .control-group {
            margin: 15px 0;
        }

        .control-group label {
            display: inline-block;
            width: 80px;
            color: #3498db;
            font-weight: bold;
        }

        .control-group input[type="range"] {
            width: 70%;
            vertical-align: middle;
        }

        #target-time {
            color: #00ff41;
            font-size: 1.5rem;
        }

        .time-problem {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        #problem-text {
            font-size: 1.2rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .calc-input-area {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }

        #calc-answer {
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #3498db;
            color: white;
            font-size: 1.2rem;
            border-radius: 5px;
            width: 200px;
        }

        .time-helper {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .time-helper h4 {
            color: #9b59b6;
            margin-bottom: 15px;
        }

        .helper-clock-row {
            display: flex;
            align-items: center;
            justify-content: space-around;
        }

        .mini-helper-clock {
            width: 80px;
            height: 80px;
            border: 2px solid #666;
            border-radius: 50%;
            background: white;
            position: relative;
        }

        .arrow {
            font-size: 2rem;
            color: #f39c12;
        }

        .clock-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-box label {
            color: #3498db;
            display: block;
            margin-bottom: 5px;
        }

        .stat-box span {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00ff41;
        }

        #clock-feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2rem;
            display: none;
        }

        #clock-feedback.correct {
            display: block;
            background: rgba(0, 255, 65, 0.2);
            border: 2px solid #00ff41;
            color: #00ff41;
        }

        #clock-feedback.incorrect {
            display: block;
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            color: #e74c3c;
        }

        /* iPad optimizations */
        @media (hover: none) and (pointer: coarse) {
            .time-input-area input, .time-input-area select, #calc-answer {
                min-height: 44px;
                font-size: 1.3rem;
            }
            
            .clock-main-area {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .clock-main-area {
                grid-template-columns: 1fr;
            }
            
            .digital-clock {
                font-size: 2rem;
            }
        }
    </style>

    <script>
        // Clock Tool Functions
        let clockScore = 0;
        let clockStreak = 0;
        let clockAttempts = 0;
        let clockCorrect = 0;
        let currentTime = { hours: 12, minutes: 0 };
        let targetTime = null;
        let currentProblem = null;

        function initializeClock() {
            drawClockFace();
            generateNewTime();
        }

        function drawClockFace() {
            const markers = document.getElementById('hour-markers');
            const numbers = document.getElementById('clock-numbers');
            
            // Clear existing
            markers.innerHTML = '';
            numbers.innerHTML = '';
            
            // Draw hour markers and numbers
            for (let i = 1; i <= 12; i++) {
                const angle = (i * 30 - 90) * Math.PI / 180;
                
                // Hour markers
                const x1 = 150 + Math.cos(angle) * 130;
                const y1 = 150 + Math.sin(angle) * 130;
                const x2 = 150 + Math.cos(angle) * 120;
                const y2 = 150 + Math.sin(angle) * 120;
                
                const marker = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                marker.setAttribute('x1', x1);
                marker.setAttribute('y1', y1);
                marker.setAttribute('x2', x2);
                marker.setAttribute('y2', y2);
                marker.setAttribute('stroke', '#333');
                marker.setAttribute('stroke-width', '2');
                markers.appendChild(marker);
                
                // Numbers
                const numX = 150 + Math.cos(angle) * 105;
                const numY = 150 + Math.sin(angle) * 105;
                
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', numX);
                text.setAttribute('y', numY + 5);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('font-size', '20');
                text.setAttribute('font-weight', 'bold');
                text.setAttribute('fill', '#333');
                text.textContent = i;
                numbers.appendChild(text);
            }
            
            // Draw minute markers
            for (let i = 0; i < 60; i++) {
                if (i % 5 !== 0) {
                    const angle = (i * 6 - 90) * Math.PI / 180;
                    const x1 = 150 + Math.cos(angle) * 135;
                    const y1 = 150 + Math.sin(angle) * 135;
                    const x2 = 150 + Math.cos(angle) * 130;
                    const y2 = 150 + Math.sin(angle) * 130;
                    
                    const marker = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    marker.setAttribute('x1', x1);
                    marker.setAttribute('y1', y1);
                    marker.setAttribute('x2', x2);
                    marker.setAttribute('y2', y2);
                    marker.setAttribute('stroke', '#999');
                    marker.setAttribute('stroke-width', '1');
                    markers.appendChild(marker);
                }
            }
        }

        function updateClockHands(hours, minutes) {
            const hourHand = document.getElementById('hour-hand');
            const minuteHand = document.getElementById('minute-hand');
            
            // Calculate angles
            const minuteAngle = minutes * 6 - 90;
            const hourAngle = (hours % 12) * 30 + minutes * 0.5 - 90;
            
            // Update hour hand
            const hourX = 150 + Math.cos(hourAngle * Math.PI / 180) * 60;
            const hourY = 150 + Math.sin(hourAngle * Math.PI / 180) * 60;
            hourHand.setAttribute('x2', hourX);
            hourHand.setAttribute('y2', hourY);
            
            // Update minute hand
            const minuteX = 150 + Math.cos(minuteAngle * Math.PI / 180) * 90;
            const minuteY = 150 + Math.sin(minuteAngle * Math.PI / 180) * 90;
            minuteHand.setAttribute('x2', minuteX);
            minuteHand.setAttribute('y2', minuteY);
            
            // Update digital display
            const displayHours = hours === 0 ? 12 : (hours > 12 ? hours - 12 : hours);
            const displayMinutes = minutes.toString().padStart(2, '0');
            document.getElementById('digital-time').textContent = `${displayHours}:${displayMinutes}`;
            document.getElementById('am-pm').textContent = hours < 12 ? 'AM' : 'PM';
        }

        function switchClockMode(mode) {
            // Update buttons
            document.querySelectorAll('.clock-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update content
            document.querySelectorAll('.clock-mode').forEach(m => {
                m.classList.remove('active');
            });
            document.getElementById(`${mode}-mode`).classList.add('active');
            
            // Initialize the new mode
            if (mode === 'read') {
                generateNewTime();
            } else if (mode === 'set') {
                newSetChallenge();
            } else if (mode === 'calculate') {
                newTimeProblem();
            }
        }

        function generateNewTime() {
            const difficulty = document.getElementById('time-difficulty').value;
            let hours = Math.floor(Math.random() * 12) + 1;
            let minutes = 0;
            
            switch(difficulty) {
                case 'hour':
                    minutes = 0;
                    break;
                case 'half':
                    minutes = Math.random() < 0.5 ? 0 : 30;
                    break;
                case 'quarter':
                    minutes = [0, 15, 30, 45][Math.floor(Math.random() * 4)];
                    break;
                case 'five':
                    minutes = Math.floor(Math.random() * 12) * 5;
                    break;
                case 'minute':
                    minutes = Math.floor(Math.random() * 60);
                    break;
            }
            
            // Add AM/PM randomization
            const isPM = Math.random() < 0.5;
            if (isPM && hours !== 12) {
                hours += 12;
            } else if (!isPM && hours === 12) {
                hours = 0;
            }
            
            currentTime = { hours, minutes };
            updateClockHands(hours, minutes);
            
            // Clear inputs
            document.getElementById('hour-input').value = '';
            document.getElementById('minute-input').value = '';
            document.getElementById('clock-feedback').style.display = 'none';
        }

        function checkTimeAnswer() {
            const hourInput = parseInt(document.getElementById('hour-input').value);
            const minuteInput = parseInt(document.getElementById('minute-input').value) || 0;
            const ampmInput = document.getElementById('ampm-input').value;
            
            const correctHour = currentTime.hours === 0 ? 12 : (currentTime.hours > 12 ? currentTime.hours - 12 : currentTime.hours);
            const correctAMPM = currentTime.hours < 12 ? 'AM' : 'PM';
            
            const feedback = document.getElementById('clock-feedback');
            
            if (hourInput === correctHour && minuteInput === currentTime.minutes && ampmInput === correctAMPM) {
                feedback.textContent = '✅ Correct! Well done!';
                feedback.className = 'correct';
                clockScore++;
                clockStreak++;
                clockCorrect++;
            } else {
                feedback.textContent = `❌ Not quite. The time is ${correctHour}:${currentTime.minutes.toString().padStart(2, '0')} ${correctAMPM}`;
                feedback.className = 'incorrect';
                clockStreak = 0;
            }
            
            clockAttempts++;
            updateClockStats();
            feedback.style.display = 'block';
            
            setTimeout(() => {
                generateNewTime();
            }, 3000);
        }

        function updateClockFromSlider() {
            const hourValue = parseInt(document.getElementById('hour-slider').value);
            const minuteValue = parseInt(document.getElementById('minute-slider').value);
            
            const hours = Math.floor(hourValue / 60);
            const adjustedMinutes = hourValue % 60;
            
            updateClockHands(hours, minuteValue);
        }

        function newSetChallenge() {
            const hours = Math.floor(Math.random() * 12) + 1;
            const minutes = Math.floor(Math.random() * 12) * 5;
            const isPM = Math.random() < 0.5;
            
            targetTime = { hours: isPM && hours !== 12 ? hours + 12 : hours, minutes };
            
            document.getElementById('target-time').textContent = 
                `${hours}:${minutes.toString().padStart(2, '0')} ${isPM ? 'PM' : 'AM'}`;
            
            // Reset sliders
            document.getElementById('hour-slider').value = 0;
            document.getElementById('minute-slider').value = 0;
            updateClockFromSlider();
            
            document.getElementById('clock-feedback').style.display = 'none';
        }

        function checkSetTime() {
            const hourValue = parseInt(document.getElementById('hour-slider').value);
            const minuteValue = parseInt(document.getElementById('minute-slider').value);
            
            const setHours = Math.floor(hourValue / 60);
            
            const feedback = document.getElementById('clock-feedback');
            
            if (setHours === targetTime.hours && minuteValue === targetTime.minutes) {
                feedback.textContent = '✅ Perfect! You set the time correctly!';
                feedback.className = 'correct';
                clockScore++;
                clockStreak++;
                clockCorrect++;
            } else {
                feedback.textContent = '❌ Not quite right. Try again!';
                feedback.className = 'incorrect';
                clockStreak = 0;
            }
            
            clockAttempts++;
            updateClockStats();
            feedback.style.display = 'block';
            
            if (feedback.className === 'correct') {
                setTimeout(() => {
                    newSetChallenge();
                }, 2000);
            }
        }

        function newTimeProblem() {
            const problems = [
                {
                    text: "School starts at 8:30 AM. If it takes 45 minutes to get ready and 20 minutes to travel, what time should you wake up?",
                    answer: "7:25 AM"
                },
                {
                    text: "The movie starts at 2:15 PM and lasts for 1 hour and 30 minutes. What time does it end?",
                    answer: "3:45 PM"
                },
                {
                    text: "If it's 10:45 AM now, what time will it be in 2 hours and 30 minutes?",
                    answer: "1:15 PM"
                },
                {
                    text: "The train leaves at 3:20 PM. If you need to arrive 15 minutes early, what time should you be at the station?",
                    answer: "3:05 PM"
                },
                {
                    text: "Lunch break is from 12:00 PM to 12:45 PM. How long is the lunch break?",
                    answer: "45 minutes"
                }
            ];
            
            currentProblem = problems[Math.floor(Math.random() * problems.length)];
            document.getElementById('problem-text').textContent = currentProblem.text;
            document.getElementById('calc-answer').value = '';
            document.getElementById('clock-feedback').style.display = 'none';
        }

        function checkCalculation() {
            const userAnswer = document.getElementById('calc-answer').value.trim().toLowerCase();
            const correctAnswer = currentProblem.answer.toLowerCase();
            
            const feedback = document.getElementById('clock-feedback');
            
            // Flexible answer checking
            const normalizedUser = userAnswer.replace(/\s+/g, '').replace(/[:.]/g, '');
            const normalizedCorrect = correctAnswer.replace(/\s+/g, '').replace(/[:.]/g, '');
            
            if (normalizedUser === normalizedCorrect || userAnswer === correctAnswer) {
                feedback.textContent = '✅ Excellent work!';
                feedback.className = 'correct';
                clockScore++;
                clockStreak++;
                clockCorrect++;
            } else {
                feedback.textContent = `❌ The answer is ${currentProblem.answer}`;
                feedback.className = 'incorrect';
                clockStreak = 0;
            }
            
            clockAttempts++;
            updateClockStats();
            feedback.style.display = 'block';
            
            setTimeout(() => {
                newTimeProblem();
            }, 3000);
        }

        function updateClockStats() {
            document.getElementById('clock-score').textContent = clockScore;
            document.getElementById('clock-streak').textContent = clockStreak;
            const accuracy = clockAttempts > 0 ? Math.round((clockCorrect / clockAttempts) * 100) : 0;
            document.getElementById('clock-accuracy').textContent = accuracy + '%';
        }
    </script>

    <!-- Venn Diagram Tool -->
    <div id="venndiagram-tool" class="tool-content">
        <div class="container">
            <div class="header">
                <h1>Venn Diagrams</h1>
                <p>Explore relationships between sets using interactive Venn diagrams</p>
            </div>

            <div class="venn-controls">
                <button class="btn" onclick="resetVennDiagram()">🔄 Reset</button>
                <button class="btn" onclick="generateVennProblem()">🎲 New Problem</button>
                <button class="btn" onclick="toggleVennLabels()">🏷️ Toggle Labels</button>
            </div>

            <div class="venn-container">
                <svg id="venn-svg" width="600" height="400" viewBox="0 0 600 400">
                    <!-- Left circle -->
                    <circle id="venn-left-circle" cx="220" cy="200" r="120" 
                            fill="rgba(255, 99, 71, 0.5)" 
                            stroke="#ff6347" 
                            stroke-width="3"/>
                    
                    <!-- Right circle -->
                    <circle id="venn-right-circle" cx="380" cy="200" r="120" 
                            fill="rgba(100, 149, 237, 0.5)" 
                            stroke="#6495ed" 
                            stroke-width="3"/>
                    
                    <!-- Labels -->
                    <text id="venn-left-label" x="150" y="200" 
                          text-anchor="middle" 
                          font-size="20" 
                          fill="white"
                          font-weight="bold">Set A</text>
                    
                    <text id="venn-right-label" x="450" y="200" 
                          text-anchor="middle" 
                          font-size="20" 
                          fill="white"
                          font-weight="bold">Set B</text>
                    
                    <text id="venn-intersection-label" x="300" y="200" 
                          text-anchor="middle" 
                          font-size="20" 
                          fill="white"
                          font-weight="bold">A ∩ B</text>
                </svg>
            </div>

            <div class="venn-info">
                <div class="venn-stats">
                    <div class="stat-item">
                        <label>Set A:</label>
                        <input type="number" id="venn-set-a" min="0" max="100" value="10" onchange="updateVennDiagram()">
                        <span>items</span>
                    </div>
                    <div class="stat-item">
                        <label>Set B:</label>
                        <input type="number" id="venn-set-b" min="0" max="100" value="10" onchange="updateVennDiagram()">
                        <span>items</span>
                    </div>
                    <div class="stat-item">
                        <label>A ∩ B:</label>
                        <input type="number" id="venn-intersection" min="0" max="100" value="5" onchange="updateVennDiagram()">
                        <span>items</span>
                    </div>
                </div>

                <div class="venn-calculations">
                    <h3>Calculations</h3>
                    <div id="venn-calc-display">
                        <p>Only A: <span id="only-a">5</span></p>
                        <p>Only B: <span id="only-b">5</span></p>
                        <p>Both A and B: <span id="both-ab">5</span></p>
                        <p>Total (A ∪ B): <span id="union-ab">15</span></p>
                    </div>
                </div>
            </div>

            <div class="venn-problems">
                <h3>Practice Problem</h3>
                <div id="venn-problem-text"></div>
                <div class="venn-answer-area">
                    <input type="number" id="venn-answer" placeholder="Your answer">
                    <button class="btn" onclick="checkVennAnswer()">Check</button>
                </div>
                <div id="venn-feedback"></div>
            </div>
        </div>
    </div>

    <!-- Daily Drill Tool -->
    <div id="dailydrill-tool" class="tool-content">
        <div class="dailydrill-container">
            <div class="dailydrill-header">
                <h1>📝 Daily Drill</h1>
                <div class="drill-info">
                    <span class="drill-level">Level <span id="current-level">2A</span></span>
                    <span class="drill-timer">⏱ <span id="drill-time">10:00</span></span>
                    <span class="drill-score">Score: <span id="drill-score">0</span>/20</span>
                </div>
            </div>

            <div class="drill-setup" id="drill-setup">
                <h2>Select Your Level</h2>
                <div class="kumon-info">
                    <p>Following the authentic Kumon methodology - systematic progression through mastery</p>
                </div>
                <div class="level-grid">
                    <button class="level-btn" onclick="startDrill('1A')">
                        <div class="level-name">Level 1A</div>
                        <div class="level-desc">+1 and +2 (Numbers 0-10)</div>
                        <div class="level-detail">Master single-digit addition with 1 and 2</div>
                    </button>
                    <button class="level-btn" onclick="startDrill('1B')">
                        <div class="level-name">Level 1B</div>
                        <div class="level-desc">Subtraction to 10</div>
                    </button>
                    <button class="level-btn" onclick="startDrill('2A')">
                        <div class="level-name">Level 2A</div>
                        <div class="level-desc">Addition to 20</div>
                    </button>
                    <button class="level-btn" onclick="startDrill('2B')">
                        <div class="level-name">Level 2B</div>
                        <div class="level-desc">Subtraction to 20</div>
                    </button>
                    <button class="level-btn" onclick="startDrill('3A')">
                        <div class="level-name">Level 3A</div>
                        <div class="level-desc">Times Tables 2-5</div>
                    </button>
                    <button class="level-btn" onclick="startDrill('3B')">
                        <div class="level-name">Level 3B</div>
                        <div class="level-desc">Times Tables 6-9</div>
                    </button>
                    <button class="level-btn" onclick="startDrill('4A')">
                        <div class="level-name">Level 4A</div>
                        <div class="level-desc">Division Facts</div>
                    </button>
                    <button class="level-btn" onclick="startDrill('4B')">
                        <div class="level-name">Level 4B</div>
                        <div class="level-desc">Mixed Operations</div>
                    </button>
                </div>
                <div class="drill-settings">
                    <label>Time Limit:
                        <select id="time-limit">
                            <option value="5">5 minutes</option>
                            <option value="10" selected>10 minutes</option>
                            <option value="15">15 minutes</option>
                        </select>
                    </label>
                    <label>Number of Problems:
                        <select id="problem-count">
                            <option value="10">10 problems</option>
                            <option value="20" selected>20 problems</option>
                            <option value="30">30 problems</option>
                        </select>
                    </label>
                </div>
            </div>

            <div class="drill-worksheet" id="drill-worksheet" style="display: none;">
                <div class="worksheet-paper">
                    <div class="worksheet-header">
                        <div class="worksheet-title">Daily Drill - <span id="worksheet-level"></span></div>
                        <div class="worksheet-date" id="worksheet-date"></div>
                    </div>
                    <div class="problems-grid" id="problems-grid">
                        <!-- Problems will be generated here -->
                    </div>
                </div>
                <div class="drill-controls">
                    <button class="drill-btn submit-btn" onclick="submitDrill()">Submit</button>
                    <button class="drill-btn new-btn" onclick="resetDrill()">New Drill</button>
                    <button class="drill-btn print-btn" onclick="printWorksheet()">🖨️ Print PDF</button>
                </div>
            </div>

            <div class="drill-results" id="drill-results" style="display: none;">
                <h2>Results</h2>
                <div class="results-summary">
                    <div class="result-stat">
                        <div class="stat-label">Score</div>
                        <div class="stat-value" id="final-score"></div>
                    </div>
                    <div class="result-stat">
                        <div class="stat-label">Time</div>
                        <div class="stat-value" id="final-time"></div>
                    </div>
                    <div class="result-stat">
                        <div class="stat-label">Accuracy</div>
                        <div class="stat-value" id="final-accuracy"></div>
                    </div>
                </div>
                <div class="corrections" id="corrections">
                    <!-- Corrections will be shown here -->
                </div>
                <button class="drill-btn" onclick="resetDrill()">Try Another Drill</button>
            </div>

            <div class="drill-progress">
                <h3>Your Progress</h3>
                <div class="progress-stats">
                    <div class="stat-card">
                        <div class="stat-icon">🔥</div>
                        <div class="stat-info">
                            <div class="stat-number" id="streak-days">0</div>
                            <div class="stat-label">Day Streak</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">⭐</div>
                        <div class="stat-info">
                            <div class="stat-number" id="total-drills">0</div>
                            <div class="stat-label">Drills Completed</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">🎯</div>
                        <div class="stat-info">
                            <div class="stat-number" id="avg-score">0%</div>
                            <div class="stat-label">Average Score</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Daily Drill Styles */
        #dailydrill-tool {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        
        .dailydrill-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .dailydrill-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .dailydrill-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .drill-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            font-size: 1.2rem;
        }

        .drill-info span {
            padding: 8px 16px;
            background: #f0f0f0;
            border-radius: 20px;
        }

        .drill-level {
            background: #4CAF50;
            color: white;
        }

        .drill-timer {
            background: #2196F3;
            color: white;
        }

        .drill-score {
            background: #FF9800;
            color: white;
        }

        /* Level Selection */
        .drill-setup {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .drill-setup h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .level-btn {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .level-btn:hover {
            border-color: #4CAF50;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
            background: linear-gradient(135deg, #f1f8e9 0%, #ffffff 100%);
        }

        .level-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .level-desc {
            color: #666;
            font-size: 0.9rem;
        }

        .drill-settings {
            margin-top: 20px;
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .drill-settings label {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
        }

        .drill-settings select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        /* Worksheet */
        .drill-worksheet {
            margin-top: 20px;
        }

        .worksheet-paper {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .worksheet-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 2px solid #333;
        }

        .worksheet-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .worksheet-date {
            color: #666;
        }

        .problems-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        /* Kumon-specific styles */
        .kumon-info {
            text-align: center;
            color: #555;
            font-style: italic;
            margin-bottom: 20px;
            background: #f0f4f8;
            padding: 15px;
            border-radius: 10px;
        }
        
        .level-detail {
            font-size: 0.8rem;
            color: #999;
            margin-top: 5px;
            font-style: italic;
        }
        
        .kumon-instructions {
            background: #e3f2fd;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid #2196F3;
            color: #1976d2;
            border-radius: 5px;
            font-size: 1.1rem;
        }
        
        .kumon-instructions p {
            margin: 0;
            font-weight: 600;
            color: #1565c0;
        }
        
        .kumon-input {
            width: 100px;
            padding: 10px;
            font-size: 1.4rem;
            border: 2px solid #333;
            font-weight: bold;
        }
        
        /* Kumon 1A specific: problems in single column for clarity */
        .level-1a .problems-grid {
            grid-template-columns: 1fr;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .level-1a .problem-item {
            font-size: 1.6rem;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .level-1a .problem-text {
            font-size: 1.6rem;
            font-weight: 500;
        }

        .problem-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            padding: 10px;
        }

        .problem-number {
            color: #7f8c8d;
            min-width: 40px;
            font-weight: 600;
        }

        .problem-text {
            flex: 1;
            font-family: 'Courier New', monospace;
            color: #2c3e50;
            font-weight: 600;
        }

        .problem-input {
            width: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1.2rem;
            text-align: center;
        }

        .problem-input.correct {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .problem-input.incorrect {
            border-color: #f44336;
            background: #ffebee;
        }

        /* Controls */
        .drill-controls {
            margin-top: 30px;
            text-align: center;
        }

        .drill-btn {
            padding: 12px 30px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn {
            background: #4CAF50;
            color: white;
        }

        .submit-btn:hover {
            background: #45a049;
        }

        .new-btn {
            background: #2196F3;
            color: white;
        }

        .new-btn:hover {
            background: #1976D2;
        }
        
        .print-btn {
            background: #9C27B0;
            color: white;
        }
        
        .print-btn:hover {
            background: #7B1FA2;
        }

        /* Results */
        .drill-results {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .drill-results h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .results-summary {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
        }

        .result-stat {
            text-align: center;
        }

        .stat-label {
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .corrections {
            margin: 30px 0;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .corrections h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .correction-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            color: #333;
        }

        /* Progress */
        .drill-progress {
            margin-top: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }

        .drill-progress h3 {
            margin-bottom: 20px;
        }

        .progress-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .stat-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }

        .stat-icon {
            font-size: 2rem;
        }

        .stat-info {
            text-align: left;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        /* Kumon mastery styles */
        .mastery-achieved {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }
        
        .mastery-achieved h3 {
            color: white;
            margin-bottom: 10px;
        }
        
        .near-mastery {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }
        
        .near-mastery h3 {
            color: white;
            margin-bottom: 10px;
        }
        
        .needs-practice {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }
        
        .needs-practice h3 {
            color: white;
            margin-bottom: 10px;
        }
        
        .kumon-correction {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            padding: 15px;
            background: white;
            border-left: 4px solid #f44336;
            margin: 10px 0;
        }
        
        .kumon-correction .problem {
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .kumon-correction .your-answer {
            color: #f44336;
        }
        
        .kumon-correction .correct-answer {
            color: #4CAF50;
            font-weight: bold;
        }

        /* Venn Diagram Tool Styles */
        .venn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
        }

        .venn-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .venn-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .venn-stats {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .stat-item label {
            min-width: 80px;
            font-weight: bold;
            color: #3498db;
        }

        .stat-item input {
            width: 80px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #3498db;
            border-radius: 5px;
            color: white;
            font-size: 1.1rem;
            text-align: center;
        }

        .venn-calculations {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
        }

        .venn-calculations h3 {
            color: #f39c12;
            margin-bottom: 15px;
        }

        #venn-calc-display p {
            margin: 10px 0;
            font-size: 1.1rem;
        }

        #venn-calc-display span {
            color: #00ff41;
            font-weight: bold;
            font-size: 1.3rem;
        }

        .venn-problems {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .venn-problems h3 {
            color: #e74c3c;
            margin-bottom: 15px;
        }

        #venn-problem-text {
            font-size: 1.2rem;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            min-height: 60px;
        }

        .venn-answer-area {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }

        #venn-answer {
            width: 150px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #3498db;
            border-radius: 5px;
            color: white;
            font-size: 1.2rem;
            text-align: center;
        }

        #venn-feedback {
            text-align: center;
            font-size: 1.2rem;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }

        #venn-feedback.correct {
            display: block;
            background: rgba(0, 255, 65, 0.2);
            border: 2px solid #00ff41;
            color: #00ff41;
        }

        #venn-feedback.incorrect {
            display: block;
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            color: #e74c3c;
        }

        /* iPad optimizations for Venn Diagram */
        @media (hover: none) and (pointer: coarse) {
            #venn-svg {
                touch-action: none;
            }
            
            .stat-item input, #venn-answer {
                min-height: 44px;
                font-size: 1.3rem;
            }
        }
    </style>

    <script>
        // Venn Diagram Functions
        let vennProblem = null;
        let showVennLabels = true;

        function updateVennDiagram() {
            const setA = parseInt(document.getElementById('venn-set-a').value) || 0;
            const setB = parseInt(document.getElementById('venn-set-b').value) || 0;
            const intersection = parseInt(document.getElementById('venn-intersection').value) || 0;
            
            // Validate intersection
            if (intersection > setA || intersection > setB) {
                alert('Intersection cannot be larger than either set!');
                document.getElementById('venn-intersection').value = Math.min(setA, setB);
                return;
            }
            
            // Calculate values
            const onlyA = setA - intersection;
            const onlyB = setB - intersection;
            const union = setA + setB - intersection;
            
            // Update display
            document.getElementById('only-a').textContent = onlyA;
            document.getElementById('only-b').textContent = onlyB;
            document.getElementById('both-ab').textContent = intersection;
            document.getElementById('union-ab').textContent = union;
            
            // Update circle sizes (scaled)
            const maxSize = 150;
            const scale = Math.max(setA, setB) > 0 ? maxSize / Math.max(setA, setB) : 1;
            
            document.getElementById('venn-left-circle').setAttribute('r', Math.max(30, setA * scale * 0.8));
            document.getElementById('venn-right-circle').setAttribute('r', Math.max(30, setB * scale * 0.8));
        }

        function resetVennDiagram() {
            document.getElementById('venn-set-a').value = 10;
            document.getElementById('venn-set-b').value = 10;
            document.getElementById('venn-intersection').value = 5;
            updateVennDiagram();
            document.getElementById('venn-feedback').style.display = 'none';
        }

        function toggleVennLabels() {
            showVennLabels = !showVennLabels;
            const labels = ['venn-left-label', 'venn-right-label', 'venn-intersection-label'];
            labels.forEach(id => {
                document.getElementById(id).style.display = showVennLabels ? 'block' : 'none';
            });
        }

        function generateVennProblem() {
            const setA = Math.floor(Math.random() * 30) + 10;
            const setB = Math.floor(Math.random() * 30) + 10;
            const intersection = Math.floor(Math.random() * Math.min(setA, setB));
            
            document.getElementById('venn-set-a').value = setA;
            document.getElementById('venn-set-b').value = setB;
            document.getElementById('venn-intersection').value = intersection;
            updateVennDiagram();
            
            // Generate a problem
            const problemTypes = [
                {
                    text: `If Set A has ${setA} items and Set B has ${setB} items, with ${intersection} items in both sets, how many items are in total (A ∪ B)?`,
                    answer: setA + setB - intersection
                },
                {
                    text: `If Set A has ${setA} items and ${intersection} of them are also in Set B, how many items are only in Set A?`,
                    answer: setA - intersection
                },
                {
                    text: `If Set B has ${setB} items and ${intersection} of them are also in Set A, how many items are only in Set B?`,
                    answer: setB - intersection
                }
            ];
            
            vennProblem = problemTypes[Math.floor(Math.random() * problemTypes.length)];
            document.getElementById('venn-problem-text').textContent = vennProblem.text;
            document.getElementById('venn-answer').value = '';
            document.getElementById('venn-feedback').style.display = 'none';
        }

        function checkVennAnswer() {
            if (!vennProblem) {
                generateVennProblem();
                return;
            }
            
            const userAnswer = parseInt(document.getElementById('venn-answer').value);
            const feedback = document.getElementById('venn-feedback');
            
            if (userAnswer === vennProblem.answer) {
                feedback.textContent = '✅ Correct! Well done!';
                feedback.className = 'correct';
            } else {
                feedback.textContent = `❌ Not quite. The correct answer is ${vennProblem.answer}`;
                feedback.className = 'incorrect';
            }
            
            feedback.style.display = 'block';
            setTimeout(() => {
                generateVennProblem();
            }, 3000);
        }

        // Initialize Venn diagram when switching to it
        function initializeVennDiagram() {
            updateVennDiagram();
            generateVennProblem();
        }

        // Daily Drill Functions
        let drillTimer = null;
        let drillStartTime = null;
        let drillProblems = [];
        let drillLevel = '';
        let drillTimeLimit = 10;

        function startDrill(level) {
            drillLevel = level;
            document.getElementById('current-level').textContent = level;
            document.getElementById('worksheet-level').textContent = level;
            
            // Add level-specific class to worksheet
            const worksheet = document.getElementById('drill-worksheet');
            worksheet.className = 'drill-worksheet level-' + level.toLowerCase();
            
            // Set date
            const today = new Date();
            document.getElementById('worksheet-date').textContent = 
                today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Get settings (for Kumon 1A, override to standard values)
            if (level === '1A') {
                drillTimeLimit = 10; // Standard 10 minutes for Kumon
                const problemCount = 20; // Always 20 problems for 1A
                document.getElementById('time-limit').value = '10';
                document.getElementById('problem-count').value = '20';
                generateDrillProblems(level, problemCount);
            } else {
                drillTimeLimit = parseInt(document.getElementById('time-limit').value);
                const problemCount = parseInt(document.getElementById('problem-count').value);
                generateDrillProblems(level, problemCount);
            }
            
            // Show worksheet
            document.getElementById('drill-setup').style.display = 'none';
            document.getElementById('drill-worksheet').style.display = 'block';
            document.getElementById('drill-results').style.display = 'none';
            
            // Start timer
            startDrillTimer();
        }

        function generateDrillProblems(level, count) {
            drillProblems = [];
            const grid = document.getElementById('problems-grid');
            grid.innerHTML = '';
            
            // For Kumon 1A, always use 20 problems (10 of +1, 10 of +2)
            if (level === '1A') {
                count = 20;
                document.getElementById('drill-score').textContent = '0/20';
            }
            
            // Add worksheet instructions for Kumon style
            if (level === '1A') {
                const instructions = document.createElement('div');
                instructions.className = 'kumon-instructions';
                instructions.innerHTML = '<p>Write the answer in each box. Work carefully and quickly.</p>';
                grid.parentElement.insertBefore(instructions, grid);
            }
            
            for (let i = 0; i < count; i++) {
                let problem = generateProblem(level);
                drillProblems.push(problem);
                
                const problemDiv = document.createElement('div');
                problemDiv.className = 'problem-item';
                
                // Kumon style: larger, clearer formatting
                if (level === '1A') {
                    problemDiv.innerHTML = `
                        <span class="problem-number">${(i + 1).toString().padStart(2, '0')}</span>
                        <span class="problem-text">${problem.text}</span>
                        <input type="number" class="problem-input kumon-input" id="answer-${i}" 
                               min="0" max="99"
                               onkeypress="if(event.key === 'Enter') document.getElementById('answer-${i+1}')?.focus()">
                    `;
                } else {
                    problemDiv.innerHTML = `
                        <span class="problem-number">${i + 1}.</span>
                        <span class="problem-text">${problem.text}</span>
                        <input type="number" class="problem-input" id="answer-${i}" 
                               onkeypress="if(event.key === 'Enter') document.getElementById('answer-${i+1}')?.focus()">
                    `;
                }
                grid.appendChild(problemDiv);
            }
            
            // Focus first input
            setTimeout(() => document.getElementById('answer-0')?.focus(), 100);
        }

        function generateProblem(level) {
            let a, b, operation, answer, text;
            
            switch(level) {
                case '1A': // Kumon 1A: +1 and +2 only, numbers 0-10
                    // In Kumon 1A, we start with +1 problems, then progress to +2
                    // First 10 problems are +1, next 10 are +2
                    const problemIndex = drillProblems.length;
                    
                    if (problemIndex < 10) {
                        // First half: +1 problems
                        a = Math.floor(Math.random() * 10); // 0 to 9
                        b = 1;
                    } else {
                        // Second half: +2 problems
                        a = Math.floor(Math.random() * 9); // 0 to 8
                        b = 2;
                    }
                    
                    answer = a + b;
                    text = `${a} + ${b} = `;
                    break;
                case '1B': // Subtraction to 10
                    a = Math.floor(Math.random() * 11);
                    b = Math.floor(Math.random() * (a + 1));
                    answer = a - b;
                    text = `${a} - ${b} = `;
                    break;
                case '2A': // Addition to 20
                    a = Math.floor(Math.random() * 11);
                    b = Math.floor(Math.random() * (21 - a));
                    answer = a + b;
                    text = `${a} + ${b} = `;
                    break;
                case '2B': // Subtraction to 20
                    a = Math.floor(Math.random() * 21);
                    b = Math.floor(Math.random() * (a + 1));
                    answer = a - b;
                    text = `${a} - ${b} = `;
                    break;
                case '3A': // Times tables 2-5
                    a = Math.floor(Math.random() * 4) + 2;
                    b = Math.floor(Math.random() * 10) + 1;
                    answer = a * b;
                    text = `${a} × ${b} = `;
                    break;
                case '3B': // Times tables 6-9
                    a = Math.floor(Math.random() * 4) + 6;
                    b = Math.floor(Math.random() * 10) + 1;
                    answer = a * b;
                    text = `${a} × ${b} = `;
                    break;
                case '4A': // Division facts
                    b = Math.floor(Math.random() * 9) + 1;
                    answer = Math.floor(Math.random() * 10) + 1;
                    a = b * answer;
                    text = `${a} ÷ ${b} = `;
                    break;
                case '4B': // Mixed operations
                    const ops = ['+', '-', '×', '÷'];
                    operation = ops[Math.floor(Math.random() * ops.length)];
                    if (operation === '+') {
                        a = Math.floor(Math.random() * 50);
                        b = Math.floor(Math.random() * 50);
                        answer = a + b;
                    } else if (operation === '-') {
                        a = Math.floor(Math.random() * 100);
                        b = Math.floor(Math.random() * (a + 1));
                        answer = a - b;
                    } else if (operation === '×') {
                        a = Math.floor(Math.random() * 12) + 1;
                        b = Math.floor(Math.random() * 12) + 1;
                        answer = a * b;
                    } else {
                        b = Math.floor(Math.random() * 12) + 1;
                        answer = Math.floor(Math.random() * 12) + 1;
                        a = b * answer;
                        operation = '÷';
                    }
                    text = `${a} ${operation} ${b} = `;
                    break;
                default:
                    a = Math.floor(Math.random() * 10);
                    b = Math.floor(Math.random() * 10);
                    answer = a + b;
                    text = `${a} + ${b} = `;
            }
            
            return { text, answer };
        }

        function startDrillTimer() {
            drillStartTime = Date.now();
            let timeLeft = drillTimeLimit * 60;
            
            drillTimer = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('drill-time').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(drillTimer);
                    submitDrill();
                }
            }, 1000);
        }

        function submitDrill() {
            clearInterval(drillTimer);
            
            let correct = 0;
            const corrections = [];
            
            drillProblems.forEach((problem, index) => {
                const input = document.getElementById(`answer-${index}`);
                const userAnswer = parseInt(input.value);
                
                if (userAnswer === problem.answer) {
                    correct++;
                    input.classList.add('correct');
                } else {
                    input.classList.add('incorrect');
                    corrections.push({
                        problem: problem.text,
                        userAnswer: userAnswer || 'No answer',
                        correctAnswer: problem.answer
                    });
                }
            });
            
            // Calculate results
            const total = drillProblems.length;
            const accuracy = Math.round((correct / total) * 100);
            const timeTaken = Math.floor((Date.now() - drillStartTime) / 1000);
            const minutes = Math.floor(timeTaken / 60);
            const seconds = timeTaken % 60;
            
            // Display results
            document.getElementById('final-score').textContent = `${correct}/${total}`;
            document.getElementById('final-time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('final-accuracy').textContent = `${accuracy}%`;
            
            // Kumon-style mastery message
            const correctionsDiv = document.getElementById('corrections');
            if (drillLevel === '1A') {
                if (accuracy === 100) {
                    correctionsDiv.innerHTML = `
                        <div class="mastery-achieved">
                            <h3>🌟 Excellent! Perfect Score!</h3>
                            <p>You've mastered this level. Ready to progress!</p>
                            <p>Time: ${minutes}:${seconds.toString().padStart(2, '0')}</p>
                        </div>
                    `;
                } else if (accuracy >= 80) {
                    correctionsDiv.innerHTML = `
                        <div class="near-mastery">
                            <h3>Good effort! ${accuracy}% accuracy</h3>
                            <p>Keep practicing to achieve 100% mastery.</p>
                        </div>
                    `;
                } else {
                    correctionsDiv.innerHTML = `
                        <div class="needs-practice">
                            <h3>Keep practicing! ${accuracy}% accuracy</h3>
                            <p>Kumon requires consistent practice for mastery.</p>
                        </div>
                    `;
                }
                
                // Show corrections for Kumon style
                if (corrections.length > 0) {
                    correctionsDiv.innerHTML += '<h4>Review these problems:</h4>';
                    corrections.forEach(c => {
                        correctionsDiv.innerHTML += `
                            <div class="correction-item kumon-correction">
                                <span class="problem">${c.problem}</span>
                                <span class="your-answer">Your answer: ${c.userAnswer}</span>
                                <span class="correct-answer">Correct: ${c.correctAnswer}</span>
                            </div>
                        `;
                    });
                }
            } else {
                // Original correction display for other levels
                if (corrections.length > 0) {
                    correctionsDiv.innerHTML = '<h3>Corrections:</h3>';
                    corrections.forEach(c => {
                        correctionsDiv.innerHTML += `
                            <div class="correction-item">
                                ${c.problem} <span style="color: red">${c.userAnswer}</span> 
                                → Correct answer: <span style="color: green">${c.correctAnswer}</span>
                            </div>
                        `;
                    });
                } else {
                    correctionsDiv.innerHTML = '<h3>Perfect Score! 🎉</h3>';
                }
            }
            
            // Update progress (localStorage) with mastery tracking
            updateDrillProgress(correct, total, drillLevel, accuracy);
            
            // Show results
            document.getElementById('drill-worksheet').style.display = 'none';
            document.getElementById('drill-results').style.display = 'block';
        }

        function resetDrill() {
            clearInterval(drillTimer);
            document.getElementById('drill-setup').style.display = 'block';
            document.getElementById('drill-worksheet').style.display = 'none';
            document.getElementById('drill-results').style.display = 'none';
            document.getElementById('drill-time').textContent = '10:00';
            document.getElementById('drill-score').textContent = '0';
        }

        function updateDrillProgress(correct, total, level, accuracy) {
            // Get existing progress from localStorage
            let progress = JSON.parse(localStorage.getItem('drillProgress') || '{}');
            
            // Initialize level progress if not exists
            if (!progress.levels) {
                progress.levels = {};
            }
            if (!progress.levels[level]) {
                progress.levels[level] = {
                    attempts: 0,
                    mastered: false,
                    bestAccuracy: 0,
                    bestTime: null
                };
            }
            
            // Update level-specific progress
            progress.levels[level].attempts++;
            if (accuracy > progress.levels[level].bestAccuracy) {
                progress.levels[level].bestAccuracy = accuracy;
            }
            if (accuracy === 100) {
                progress.levels[level].mastered = true;
            }
            
            // Update totals
            progress.totalDrills = (progress.totalDrills || 0) + 1;
            progress.totalCorrect = (progress.totalCorrect || 0) + correct;
            progress.totalQuestions = (progress.totalQuestions || 0) + total;
            
            // Update streak
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            if (progress.lastDrillDate === yesterday || !progress.lastDrillDate) {
                progress.streak = (progress.streak || 0) + 1;
            } else if (progress.lastDrillDate !== today) {
                progress.streak = 1;
            }
            
            progress.lastDrillDate = today;
            
            // Save progress
            localStorage.setItem('drillProgress', JSON.stringify(progress));
            
            // Update display
            document.getElementById('streak-days').textContent = progress.streak || 0;
            document.getElementById('total-drills').textContent = progress.totalDrills || 0;
            document.getElementById('avg-score').textContent = 
                progress.totalQuestions ? 
                Math.round((progress.totalCorrect / progress.totalQuestions) * 100) + '%' : '0%';
        }

        // Load progress on page load
        function loadDrillProgress() {
            const progress = JSON.parse(localStorage.getItem('drillProgress') || '{}');
            document.getElementById('streak-days').textContent = progress.streak || 0;
            document.getElementById('total-drills').textContent = progress.totalDrills || 0;
            document.getElementById('avg-score').textContent = 
                progress.totalQuestions ? 
                Math.round((progress.totalCorrect / progress.totalQuestions) * 100) + '%' : '0%';
        }

        // Initialize when switching to Daily Drill
        function initializeDailyDrill() {
            loadDrillProgress();
        }
        
        // Print worksheet function
        function printWorksheet() {
            // Create print-friendly version
            const printWindow = window.open('', '_blank');
            
            // Get current date
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Build print HTML
            const printHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>4MA1 Daily Drill - Level ${drillLevel}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            line-height: 1.6;
                            color: #333;
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 20px;
                        }
                        
                        .print-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 30px;
                            padding-bottom: 15px;
                            border-bottom: 3px solid #333;
                        }
                        
                        .print-logo {
                            font-size: 28px;
                            font-weight: bold;
                            color: #2196F3;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        
                        .logo-emoji {
                            font-size: 32px;
                        }
                        
                        .print-title {
                            font-size: 22px;
                            font-weight: bold;
                            color: #333;
                        }
                        
                        .print-date {
                            font-size: 14px;
                            color: #666;
                            text-align: right;
                        }
                        
                        .student-info {
                            display: flex;
                            justify-content: space-between;
                            margin: 20px 0;
                            padding: 15px;
                            background: #f5f5f5;
                            border-radius: 8px;
                        }
                        
                        .info-field {
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        
                        .info-label {
                            font-weight: 600;
                            color: #555;
                        }
                        
                        .info-line {
                            border-bottom: 2px solid #333;
                            min-width: 150px;
                            height: 20px;
                        }
                        
                        .print-problems {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 20px 40px;
                            margin: 30px 0;
                            padding: 20px;
                        }
                        
                        .print-problem {
                            display: flex;
                            align-items: center;
                            font-size: 18px;
                            padding: 12px 0;
                            border-bottom: 1px solid #e0e0e0;
                        }
                        
                        .print-problem-number {
                            min-width: 35px;
                            color: #666;
                            font-weight: 600;
                            font-size: 16px;
                        }
                        
                        .print-problem-text {
                            flex: 1;
                            font-family: 'Courier New', monospace;
                            font-size: 22px;
                            font-weight: 600;
                            color: #000;
                            letter-spacing: 1px;
                        }
                        
                        .print-answer-box {
                            width: 90px;
                            height: 45px;
                            border: 2px solid #333;
                            background: white;
                            margin-left: 15px;
                            border-radius: 4px;
                        }
                        
                        .print-footer {
                            margin-top: 50px;
                            padding-top: 20px;
                            border-top: 2px solid #ddd;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        }
                        
                        .score-section {
                            display: flex;
                            gap: 30px;
                            align-items: center;
                        }
                        
                        .score-box {
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        
                        .score-label {
                            font-size: 16px;
                            font-weight: 600;
                            color: #333;
                        }
                        
                        .score-value {
                            width: 80px;
                            height: 40px;
                            border: 2px solid #333;
                            background: white;
                            border-radius: 4px;
                        }
                        
                        .website-info {
                            text-align: right;
                        }
                        
                        .website-url {
                            font-size: 16px;
                            color: #2196F3;
                            font-weight: 600;
                        }
                        
                        .website-tagline {
                            font-size: 12px;
                            color: #666;
                            font-style: italic;
                        }
                        
                        @media print {
                            body {
                                padding: 0;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <div class="print-logo">
                            <span class="logo-emoji">🔢</span>
                            <span>4MA1.com</span>
                        </div>
                        <div class="print-title">Daily Drill - Level ${drillLevel}</div>
                        <div class="print-date">${dateStr}</div>
                    </div>
                    
                    <div class="student-info">
                        <div class="info-field">
                            <span class="info-label">Name:</span>
                            <div class="info-line"></div>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Time:</span>
                            <div class="info-line" style="min-width: 80px;"></div>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Score:</span>
                            <div class="info-line" style="min-width: 60px;"></div>
                            <span>/ ${drillProblems.length}</span>
                        </div>
                    </div>
                    
                    <div class="print-problems">
                        ${drillProblems.map((problem, index) => `
                            <div class="print-problem">
                                <span class="print-problem-number">${(index + 1).toString().padStart(2, '0')}.</span>
                                <span class="print-problem-text">${problem.text}</span>
                                <div class="print-answer-box"></div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="print-footer">
                        <div class="score-section">
                            <div class="score-box">
                                <span class="score-label">Total Score:</span>
                                <div class="score-value"></div>
                            </div>
                            <div class="score-box">
                                <span class="score-label">Time Taken:</span>
                                <div class="score-value"></div>
                            </div>
                        </div>
                        <div class="website-info">
                            <div class="website-url">www.4MA1.com</div>
                            <div class="website-tagline">Key Stage 2 Mathematics Practice</div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            // Write to new window and print
            printWindow.document.write(printHTML);
            printWindow.document.close();
            
            // Wait for content to load then print
            printWindow.onload = function() {
                printWindow.print();
            };
        }
    </script>
</body>
</html>
